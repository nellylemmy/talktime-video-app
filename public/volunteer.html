<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TalkTime - Volunteer Dashboard</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts: Inter & Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Poppins:wght@600;700;800&display=swap" rel="stylesheet">
    
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <style>
        /* Base styles matching the landing page */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4ff;
            overflow-x: hidden;
        }
        .font-poppins {
            font-family: 'Poppins', sans-serif;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #f5f3ff, #fdf2f8);
        }
        .glass-bg {
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .modal-glass-bg {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .gradient-text {
            background-image: linear-gradient(to right, #4f46e5, #a855f7);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        .section-heading {
             background-image: linear-gradient(to right, #ec4899, #8b5cf6);
             -webkit-background-clip: text;
             background-clip: text;
             color: transparent;
        }
        .blob {
            position: fixed;
            border-radius: 50%;
            filter: blur(100px);
            opacity: 0.3;
            z-index: -1;
        }

        /* Page Transition */
        .page, .tab-pane {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        .page-hidden, .tab-pane-hidden {
            opacity: 0;
            pointer-events: none;
            position: absolute;
            transform: translateY(10px);
            top: 0;
            left: 0;
            width: 100%;
        }
        
        /* Calendar Styles */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
        }
        .calendar-day {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }
        .calendar-day.other-month {
            color: #9ca3af;
            cursor: not-allowed;
        }
        .calendar-day:not(.other-month):hover {
            background-color: rgba(139, 92, 246, 0.2);
        }
        .calendar-day.selected {
            background-color: #8b5cf6;
            color: white;
            font-weight: bold;
        }
        .calendar-day.fully-booked::after {
            content: '';
            position: absolute;
            bottom: 4px;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: #ef4444;
        }
         .calendar-day.fully-booked {
            cursor: not-allowed;
            color: #9ca3af;
            background-color: transparent !important;
        }

        /* Time Input Styles */
        .custom-select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
            background-color: rgba(255,255,255,0.8);
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 0.5rem;
            padding: 0.5rem 0.75rem;
            width: 100%;
        }
        
        /* Modal Styles */
        .modal {
            transition: opacity 300ms ease-in-out;
        }
        .modal .modal-content {
            transition: transform 300ms ease-in-out;
        }
        .profile-dropdown, .options-menu {
            transition: all 0.3s ease-in-out;
        }
        
        /* Star Rating */
        .star-rating .fa-star {
            color: #d1d5db; /* gray-300 */
            cursor: pointer;
            transition: color 0.2s ease;
        }
        .star-rating:hover .fa-star {
            color: #f59e0b; /* yellow-500 */
        }
        .star-rating .fa-star:hover ~ .fa-star {
            color: #d1d5db;
        }
        .star-rating .fa-star.selected,
        .star-rating .fa-star.selected ~ .fa-star {
             color: #d1d5db;
        }
        .star-rating .fa-star.selected {
             color: #f59e0b;
        }

        /* Live Pulse Animation */
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }
        .live-indicator {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        /* Ensure dropdown appears above other elements */
        .meeting-card {
            position: relative;
        }
        .upcoming-badge {
            position: absolute;
            top: 0.25rem; /* Adjusted position */
            right: 0.25rem; /* Adjusted position */
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background-color: #22c55e;
            color: white;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            border: 2px solid white;
        }
    </style>
</head>
<body class="gradient-bg text-gray-800">
    <!-- Background Blobs -->
    <div class="blob w-96 h-96 bg-purple-200 top-[-10rem] left-[-10rem]"></div>
    <div class="blob w-96 h-96 bg-blue-200 bottom-[-5rem] right-[-10rem]"></div>
    <div class="blob w-72 h-72 bg-pink-200 top-[10rem] right-[-5rem] md:right-[10rem]"></div>

    <!-- Header -->
    <header id="main-header" class="sticky top-0 p-4 z-30 glass-bg shadow-sm">
        <nav class="container mx-auto flex justify-between items-center">
            <a href="index.html" class="flex items-center text-2xl font-bold" aria-label="TalkTime Home">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-2" viewBox="0 0 24 24" fill="none">
                    <defs><linearGradient id="logo-gradient" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" style="stop-color:#4f46e5;"/><stop offset="100%" style="stop-color:#a855f7;"/></linearGradient></defs>
                    <path stroke="url(#logo-gradient)" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3h14a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2z"></path>
                </svg>
                <span class="gradient-text">TALK TIME</span>
            </a>
            <div class="relative">
                <button id="profile-btn" class="flex items-center gap-2">
                    <span class="font-semibold hidden sm:inline">Welcome, Volunteer!</span>
                    <img src="https://placehold.co/40x40/4f46e5/ffffff?text=V" class="w-10 h-10 rounded-full border-2 border-white object-cover">
                </button>
                <div id="profile-dropdown" class="profile-dropdown absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl p-2 hidden opacity-0 transform -translate-y-2">
                    <a href="#" class="block px-4 py-2 text-gray-800 hover:bg-gray-100 rounded">My Account</a>
                    <a href="index.html" class="block px-4 py-2 text-gray-800 hover:bg-gray-100 rounded">Logout</a>
                </div>
            </div>
        </nav>
    </header>

    <!-- Sticky Sub-Navigation Bar -->
    <div id="page-nav-sticky" class="sticky top-[72px] md:top-[80px] z-20 mb-6 hidden">
        <div class="container mx-auto p-4 glass-bg rounded-b-2xl shadow-md">
            <div id="page-nav-content" class="flex justify-between items-center">
                <!-- JS will populate this -->
            </div>
        </div>
    </div>


    <!-- Volunteer Dashboard -->
    <main class="container mx-auto p-4 md:p-8 relative min-h-[calc(100vh-180px)]">
        
        <!-- Page 1: Main Dashboard -->
        <div id="page-dashboard" class="page w-full">
            <h1 class="text-3xl md:text-4xl font-bold font-poppins mb-2 section-heading text-center">Volunteer Dashboard</h1>
            <p class="text-center text-lg text-gray-700 max-w-2xl mx-auto mb-8">Browse student profiles, learn their stories, and schedule a call to make a difference.</p>
            
            <!-- Dashboard Tabs -->
            <div class="mb-8 border-b-2 border-white/50 flex justify-center">
                <button data-tab="dashboard-students" class="tab-btn px-6 py-3 font-semibold text-blue-600 border-b-2 border-blue-600">Students</button>
                <button data-tab="dashboard-upcoming" class="tab-btn px-6 py-3 font-semibold text-gray-500 border-b-2 border-transparent relative">
                    Upcoming
                    <span id="upcoming-badge" class="upcoming-badge hidden"></span>
                </button>
                <button data-tab="dashboard-history" class="tab-btn px-6 py-3 font-semibold text-gray-500 border-b-2 border-transparent">Call History</button>
            </div>

            <!-- Tab Content -->
            <div class="relative max-w-3xl mx-auto">
                <div id="dashboard-students" class="tab-pane space-y-10">
                     <div>
                        <h2 class="text-xl font-bold mb-4 text-gray-800">Available Students</h2>
                        <div id="student-list-available" class="space-y-4"></div>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold mt-8 text-gray-800">Unavailable Students</h2>
                        <div id="student-list-unavailable" class="space-y-4"></div>
                    </div>
                </div>
                <div id="dashboard-upcoming" class="tab-pane tab-pane-hidden">
                     <h2 class="text-xl font-bold mb-4 text-gray-800 text-center">Upcoming Meetings</h2>
                     <div id="upcoming-meetings" class="space-y-4"></div>
                </div>
                <div id="dashboard-history" class="tab-pane tab-pane-hidden">
                    <h2 class="text-xl font-bold mb-4 text-gray-800 text-center">Call History & Feedback</h2>
                     <div id="call-history" class="space-y-10">
                        <div id="feedback-container"></div>
                        <div class="bg-white/60 p-6 rounded-xl shadow-sm">
                            <h4 class="text-lg font-semibold text-gray-800 mb-3"><i class="fas fa-phone-slash text-orange-500 mr-2"></i>Missed Meetings</h4>
                            <div id="history-missed" class="space-y-4"></div>
                        </div>
                        <div class="bg-white/60 p-6 rounded-xl shadow-sm">
                            <h4 class="text-lg font-semibold text-gray-800 mb-3"><i class="fas fa-ban text-red-500 mr-2"></i>Cancelled Meetings</h4>
                            <div id="history-cancelled" class="space-y-4"></div>
                        </div>
                        <div class="bg-white/60 p-6 rounded-xl shadow-sm">
                            <h4 class="text-lg font-semibold text-gray-800 mb-3"><i class="fas fa-check-circle text-green-500 mr-2"></i>Successfully Attended</h4>
                            <div id="history-successful" class="space-y-4"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page 2: Student Profile -->
        <div id="page-profile" class="page page-hidden w-full max-w-5xl mx-auto">
             <!-- JS will populate this -->
        </div>

        <!-- Page 3: Scheduler -->
        <div id="page-scheduler" class="page page-hidden w-full max-w-3xl mx-auto">
             <!-- JS will populate this -->
        </div>
    </main>
    
    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/40 backdrop-blur-sm">
        <div class="modal-content modal-glass-bg w-full max-w-md transform scale-95">
            <div class="mx-auto bg-blue-100/50 rounded-full h-16 w-16 flex items-center justify-center mb-6">
                <i class="far fa-calendar-check text-3xl text-blue-600"></i>
            </div>
            <h3 class="text-2xl font-bold mb-2 text-gray-900">Confirm Your Session</h3>
            <p id="confirm-details" class="mb-6 text-lg leading-relaxed text-gray-700"></p>
            <div class="flex justify-center gap-4">
                <button id="confirm-cancel-btn" class="px-8 py-2 rounded-lg font-semibold bg-gray-200 hover:bg-gray-300">Cancel</button>
                <button id="confirm-book-btn" class="px-8 py-2 rounded-lg font-semibold bg-blue-600 text-white hover:bg-blue-700">Book Now</button>
            </div>
        </div>
    </div>
    
    <!-- Notification Toast -->
    <div id="notification" class="hidden fixed bottom-5 right-5 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM Elements ---
        const pageDashboard = document.getElementById('page-dashboard');
        const pageProfile = document.getElementById('page-profile');
        const pageScheduler = document.getElementById('page-scheduler');
        const availableStudentsContainer = document.getElementById('student-list-available');
        const unavailableStudentsContainer = document.getElementById('student-list-unavailable');
        const upcomingMeetingsContainer = document.getElementById('upcoming-meetings');
        const historySuccessfulContainer = document.getElementById('history-successful');
        const historyMissedContainer = document.getElementById('history-missed');
        const historyCancelledContainer = document.getElementById('history-cancelled');
        const feedbackContainer = document.getElementById('feedback-container');
        const backButtonContainer = document.getElementById('page-nav-sticky');
        const pageNavContent = document.getElementById('page-nav-content');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmDetailsEl = document.getElementById('confirm-details');
        const confirmBookBtn = document.getElementById('confirm-book-btn');
        const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
        const notificationEl = document.getElementById('notification');
        const profileBtn = document.getElementById('profile-btn');
        const profileDropdown = document.getElementById('profile-dropdown');
        const upcomingBadge = document.getElementById('upcoming-badge');

        // --- State ---
        let students = [];
        let bookedSlots = {}; 
        let currentDate = new Date();
        let selectedStudent = null;
        let selectedDate = null;
        let selectedTime = null;
        let selectedTimezone = '';

        // --- Data ---
        const timezones = [
            {group: 'US/Canada', zones: [ { label: 'Eastern (ET)', value: 'America/New_York' }, { label: 'Central (CT)', value: 'America/Chicago' }, { label: 'Mountain (MT)', value: 'America/Denver' }, { label: 'Pacific (PT)', value: 'America/Los_Angeles' }, { label: 'Alaska (AKT)', value: 'America/Anchorage' }, { label: 'Hawaii (HST)', value: 'Pacific/Honolulu' } ]},
            {group: 'Europe', zones: [ { label: 'London (GMT)', value: 'Europe/London' }, { label: 'Paris (CET)', value: 'Europe/Paris' }, { label: 'Moscow (MSK)', value: 'Europe/Moscow' } ]},
            {group: 'Asia/Oceania', zones: [ { label: 'Dubai (GST)', value: 'Asia/Dubai' }, { label: 'India (IST)', value: 'Asia/Kolkata' }, { label: 'Tokyo (JST)', value: 'Asia/Tokyo' }, { label: 'Sydney (AEST)', value: 'Australia/Sydney' } ]}
        ];

        // --- Navigation ---
        function switchPage(pageId, studentId = null) {
            document.querySelectorAll('.page').forEach(p => p.classList.add('page-hidden'));
            const pageToShow = document.getElementById(pageId);
            if(pageToShow) pageToShow.classList.remove('page-hidden');
            updateStickyNav(pageId, studentId);
            window.scrollTo(0, 0);
        }

        function updateStickyNav(pageId, studentId) {
            let navHTML = '';
            if (pageId === 'page-profile') {
                navHTML = `
                    <button data-target="page-dashboard" class="page-nav-btn font-semibold flex items-center hover:text-blue-600"><i class="fas fa-arrow-left mr-2"></i>Back to Dashboard</button>
                    <div class="flex items-center gap-2">
                        <button data-student-id="${studentId}" class="call-now-btn-sticky px-4 py-2 bg-green-500 text-white text-sm rounded-lg hover:bg-green-600 font-semibold flex items-center"><i class="fas fa-phone-alt mr-2"></i>Call Now</button>
                        <button data-student-id="${studentId}" class="schedule-btn-sticky px-4 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 font-semibold flex items-center"><i class="far fa-calendar-alt mr-2"></i>Schedule</button>
                    </div>
                `;
            } else if (pageId === 'page-scheduler') {
                navHTML = `<button data-target="page-profile" class="page-nav-btn font-semibold flex items-center hover:text-blue-600"><i class="fas fa-arrow-left mr-2"></i>Back to Profile</button>`;
            }
            pageNavContent.innerHTML = navHTML;
            backButtonContainer.classList.toggle('hidden', pageId === 'page-dashboard');
        }

        // --- Page Renderers ---
        function renderDashboard(studentsData) {
            availableStudentsContainer.innerHTML = '';
            unavailableStudentsContainer.innerHTML = '';
            studentsData.forEach(student => {
                const studentCard = document.createElement('a');
                studentCard.href = student.available ? "#" : "javascript:void(0);";
                studentCard.className = `glass-bg p-4 rounded-xl flex items-center gap-4 transition-all hover:shadow-lg ${student.available ? 'cursor-pointer hover:-translate-y-1' : 'opacity-50 cursor-not-allowed'}`;
                studentCard.dataset.studentId = student.id;
                
                let statusIcon = student.available ? '<i class="fas fa-chevron-right text-gray-400"></i>' : '<i class="fas fa-lock text-gray-400"></i>';
                let statusText = student.interests;
                if (!student.available) {
                    statusText = student.status === 'On a call' 
                        ? `<span class="text-red-500 font-semibold">${student.status}</span>`
                        : `<span class="text-yellow-600 font-semibold">${student.status}</span>`;
                }

                studentCard.innerHTML = `
                    <img src="${student.profileImage}" class="w-12 h-12 rounded-full object-cover border-2 border-white/50">
                    <div class="flex-1">
                        <p class="font-semibold">${student.name}</p>
                        <p class="text-xs text-gray-600">${statusText}</p>
                    </div>
                    ${statusIcon}
                `;
                if(student.available) {
                    availableStudentsContainer.appendChild(studentCard);
                } else {
                    unavailableStudentsContainer.appendChild(studentCard);
                }
            });
            
            const meetings = [
                { studentId: 1, time: '2025-06-20T19:30:00+03:00' }, // In progress
                { studentId: 3, time: '2025-06-22T15:00:00+03:00' }  // In a few days
            ];
            
            upcomingMeetingsContainer.innerHTML = meetings.map((meet, index) => {
                const student = students.find(s => s.id === meet.studentId);
                if (!student) return ''; // Don't render if student not found

                const isStarted = new Date(meet.time) < new Date();
                const countdownId = `countdown-timer-${index}`;
                const startTimeAttribute = `data-start-time="${meet.time}"`;
                
                const joinButtonHTML = index === 0 ? `
                    <a href="call.html" class="bg-green-500 text-white px-4 py-1.5 rounded-full text-sm font-semibold hover:bg-green-600 transition-all shadow-md flex items-center gap-2">
                        <i class="fas fa-video"></i>
                        Join Meeting
                    </a>` : '';

                return `
                    <div class="bg-white/60 p-4 rounded-2xl shadow-sm flex items-center gap-4 meeting-card">
                        <img src="${student.profileImage}" alt="${student.name}" class="w-16 h-16 rounded-full border-2 border-white object-cover">
                        <div class="flex-1">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="font-bold text-lg text-gray-800">${student.name}</h3>
                                    <p class="text-sm text-gray-600">${new Date(meet.time).toLocaleString('en-US', { weekday: 'long', hour: '2-digit', minute: '2-digit', hour12: true })}</p>
                                </div>
                                <div class="relative">
                                    <button class="options-btn text-gray-500 hover:text-gray-800 w-8 h-8 rounded-full hover:bg-gray-200/50 flex items-center justify-center">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    <div class="options-menu hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl z-20 py-1">
                                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Reschedule</a>
                                        <a href="#" class="block px-4 py-2 text-sm text-red-600 hover:bg-gray-100">Cancel</a>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-2 pt-2 border-t border-gray-200/80 flex justify-between items-center">
                                <div class="text-sm text-gray-500">
                                    <i class="far fa-clock mr-1"></i>
                                    Starts in: <span id="${countdownId}" ${startTimeAttribute} class="font-semibold ${isStarted ? 'text-red-500' : 'text-green-600'}">${isStarted ? 'Started!' : 'Calculating...'}</span>
                                </div>
                                ${joinButtonHTML}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            upcomingBadge.textContent = meetings.length;
            if (meetings.length > 0) {
                upcomingBadge.classList.remove('hidden');
            }

            const history = {
                successful: [
                    { studentId: 2, time: '2025-06-11T10:00:00+03:00', feedback: { rating: 4, comment: 'Sankale was very engaging and has improved a lot since our last call. Great progress!' } }
                ],
                missed: [
                    { studentId: 4, time: '2025-06-10T14:00:00+03:00' }
                ],
                cancelled: [
                    { studentId: 5, time: '2025-06-09T11:30:00+03:00' }
                ]
            };

            historySuccessfulContainer.innerHTML = history.successful.map(call => {
                const student = students.find(s => s.id === call.studentId);
                return `
                    <div class="bg-white/60 p-6 rounded-xl shadow-sm">
                        <div class="flex items-start gap-4">
                            <img src="${student.profileImage}" class="w-16 h-16 rounded-full object-cover">
                            <div class="flex-1">
                                <p class="font-bold text-lg">Call with ${student.name}</p>
                                <p class="text-sm text-gray-600">${new Date(call.time).toLocaleString('en-US', { dateStyle: 'full', timeStyle: 'short' })}</p>
                                <div class="mt-4">
                                    <p class="font-semibold mb-2">Your Feedback:</p>
                                    <div class="flex items-center gap-2 text-yellow-400 text-xl">
                                        ${[...Array(5)].map((_, i) => `<i class="${i < call.feedback.rating ? 'fas' : 'far'} fa-star"></i>`).join('')}
                                    </div>
                                    <p class="text-sm text-gray-700 mt-2 italic bg-gray-100/50 p-3 rounded-lg">"${call.feedback.comment}"</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            historyMissedContainer.innerHTML = history.missed.map(call => {
                const student = students.find(s => s.id === call.studentId);
                return `
                    <div class="bg-white/60 p-4 rounded-xl shadow-sm flex items-center gap-4">
                        <img src="${student.profileImage}" class="w-12 h-12 rounded-full object-cover">
                        <div class="flex-1">
                            <p class="font-semibold">Call with ${student.name}</p>
                            <p class="text-sm text-gray-500">${new Date(call.time).toLocaleString('en-US', { dateStyle: 'medium', timeStyle: 'short' })}</p>
                        </div>
                        <div class="flex items-center gap-2 text-orange-500">
                            <i class="fas fa-phone-slash"></i>
                            <span class="font-semibold text-sm">Missed</span>
                        </div>
                    </div>
                `;
            }).join('');

            historyCancelledContainer.innerHTML = history.cancelled.map(call => {
                const student = students.find(s => s.id === call.studentId);
                return `
                    <div class="bg-white/60 p-4 rounded-xl shadow-sm flex items-center gap-4">
                        <img src="${student.profileImage}" class="w-12 h-12 rounded-full object-cover">
                        <div class="flex-1">
                            <p class="font-semibold">Call with ${student.name}</p>
                            <p class="text-sm text-gray-500">${new Date(call.time).toLocaleString('en-US', { dateStyle: 'medium', timeStyle: 'short' })}</p>
                        </div>
                        <div class="flex items-center gap-2 text-red-500">
                            <i class="fas fa-ban"></i>
                            <span class="font-semibold text-sm">Cancelled</span>
                        </div>
                    </div>
                `;
            }).join('');

            const feedbackStudent = students.find(s => s.id === 2);
            feedbackContainer.innerHTML = `
                <div class="bg-white/60 p-6 rounded-xl shadow-sm mt-6">
                     <div class="flex items-start gap-4">
                        <img src="${feedbackStudent.profileImage}" class="w-16 h-16 rounded-full object-cover">
                        <div class="flex-1">
                            <p class="font-bold text-lg">Rate your experience with ${feedbackStudent.name}</p>
                             <p class="text-sm text-gray-600">Help us track student progress by providing feedback.</p>
                        </div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-gray-200/80">
                         <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2 text-2xl text-gray-400 star-rating">
                                <i class="far fa-star hover:text-yellow-400 transition-colors cursor-pointer" data-value="1"></i>
                                <i class="far fa-star hover:text-yellow-400 transition-colors cursor-pointer" data-value="2"></i>
                                <i class="far fa-star hover:text-yellow-400 transition-colors cursor-pointer" data-value="3"></i>
                                <i class="far fa-star hover:text-yellow-400 transition-colors cursor-pointer" data-value="4"></i>
                                <i class="far fa-star hover:text-yellow-400 transition-colors cursor-pointer" data-value="5"></i>
                            </div>
                            <div class="text-xs text-gray-500">1: Needs practice, 5: Excellent!</div>
                         </div>
                         <div class="flex items-center gap-3 mt-3">
                             <textarea class="w-full p-3 rounded-lg border border-gray-300 bg-white/80 resize-none h-24" placeholder="Leave a detailed comment..."></textarea>
                             <div class="flex flex-col gap-2">
                                <button class="w-12 h-12 bg-green-500 text-white rounded-lg flex items-center justify-center hover:bg-green-600 shadow-md" title="Send Feedback"><i class="fas fa-paper-plane"></i></button>
                                <button class="w-12 h-12 bg-purple-500 text-white rounded-lg flex items-center justify-center hover:bg-purple-600 shadow-md" title="Record voice note"><i class="fas fa-microphone"></i></button>
                             </div>
                         </div>
                    </div>
                </div>
            `;

            // Initialize countdowns after rendering
            meetings.forEach((meet, index) => {
                const showDays = index !== 0;
                initializeCountdown(`countdown-timer-${index}`, showDays);
            });
            startUpcomingMeetingTimers();
        }
        
        function renderStudentProfile(student) {
            pageProfile.innerHTML = `
                <div class="glass-bg rounded-2xl overflow-hidden">
                    <div class="h-48 md:h-64 bg-cover bg-center" style="background-image: url('${student.gallery[0]}')"></div>
                    <div class="p-6 md:p-8 relative">
                         <div class="md:flex items-end -mt-24 md:-mt-16">
                             <img src="${student.profileImage}" class="w-32 h-32 rounded-full object-cover border-4 border-white shadow-lg">
                             <div class="md:ml-6 mt-4 md:mt-0 flex-1">
                                 <h2 class="text-4xl font-bold font-poppins section-heading">${student.name}</h2>
                                 <p class="text-lg text-gray-600 font-semibold">${student.interests}</p>
                             </div>
                        </div>
                         <div class="mt-6 text-left border-t border-white/30 pt-6">
                            <h3 class="font-bold text-xl mb-2 text-gray-800">About ${student.name}</h3>
                            <p class="text-base text-gray-700 leading-relaxed">${student.bio}</p>
                         </div>
                         <div class="mt-6 grid grid-cols-1 sm:grid-cols-2 gap-4">
                             <img src="${student.gallery[1]}" class="rounded-lg w-full h-40 object-cover">
                             <img src="${student.gallery[2]}" class="rounded-lg w-full h-40 object-cover">
                         </div>
                    </div>
                </div>
            `;
        }
        
        function renderScheduler(student) {
            pageScheduler.innerHTML = `
                <div class="glass-bg p-6 rounded-2xl">
                    <div class="text-center">
                        <h2 class="text-3xl font-bold font-poppins mb-2 section-heading">Schedule a Call</h2>
                        <p class="text-lg text-gray-700">with <span class="font-bold">${student.name}</span></p>
                    </div>
                    <div class="mt-8 grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-1">
                            <h3 class="font-bold text-lg mb-4 text-gray-800">1. Select a Date</h3>
                            <div id="calendar-container" class="p-4 bg-white/50 rounded-xl">
                                <div class="flex justify-between items-center mb-4">
                                    <button id="prev-month-btn" class="p-2 rounded-full hover:bg-gray-200/50"><i class="fas fa-chevron-left"></i></button>
                                    <h3 id="month-year" class="font-bold text-lg"></h3>
                                    <button id="next-month-btn" class="p-2 rounded-full hover:bg-gray-200/50"><i class="fas fa-chevron-right"></i></button>
                                </div>
                                <div class="grid grid-cols-7 text-center text-xs text-gray-500 mb-2">
                                    <span>Sun</span><span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span>
                                </div>
                                <div id="calendar-grid" class="calendar-grid"></div>
                            </div>
                        </div>
                        <div id="time-selection-column" class="lg:col-span-2 space-y-6 hidden">
                            <div>
                                <h3 class="font-bold text-lg mb-4 text-gray-800">2. Select Your Timezone & Time</h3>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                     <select id="timezone-select" class="custom-select"></select>
                                     <div class="grid grid-cols-3 gap-2">
                                        <select id="time-hour" class="custom-select"></select>
                                        <select id="time-minute" class="custom-select"></select>
                                        <select id="time-ampm" class="custom-select"></select>
                                     </div>
                                </div>
                            </div>
                            <div id="conversion-result" class="hidden">
                                <h3 class="font-bold text-lg mb-2 text-gray-800">3. Check Availability</h3>
                                <div class="p-2 text-sm text-gray-600 bg-blue-50 border border-blue-200 rounded-lg">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    Students are available from <strong>9:00 AM to 4:00 PM</strong> in Kenya (EAT), 7 days a week.
                                </div>
                                <div id="kenya-time-display" class="mt-4 p-4 bg-white/50 rounded-lg text-center space-y-3"></div>
                            </div>
                        </div>
                    </div>
                </div>`;
            
            document.getElementById('prev-month-btn').addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); });
            document.getElementById('next-month-btn').addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); });
            document.getElementById('timezone-select').addEventListener('change', handleTimeChange);
            document.getElementById('time-hour').addEventListener('change', handleTimeChange);
            document.getElementById('time-minute').addEventListener('change', handleTimeChange);
            document.getElementById('time-ampm').addEventListener('change', handleTimeChange);
            
            populateTimezoneSelect();
            populateTimePicker();
            renderCalendar();
        }
        
        function populateTimezoneSelect() {
            const selectEl = document.getElementById('timezone-select');
            timezones.forEach(group => {
                const optgroup = document.createElement('optgroup');
                optgroup.label = group.group;
                group.zones.forEach(tz => {
                    const option = document.createElement('option');
                    option.value = tz.value;
                    option.textContent = tz.label;
                    optgroup.appendChild(option);
                });
                selectEl.appendChild(optgroup);
            });
            const userTz = Intl.DateTimeFormat().resolvedOptions().timeZone;
            if (selectEl.querySelector(`option[value="${userTz}"]`)) {
                selectEl.value = userTz;
            }
            selectedTimezone = selectEl.value;
        }

        function populateTimePicker() {
            const hourEl = document.getElementById('time-hour');
            const minuteEl = document.getElementById('time-minute');
            const ampmEl = document.getElementById('time-ampm');
            for(let i=1; i<=12; i++) hourEl.add(new Option(String(i).padStart(2,'0'), i));
            for(let i=0; i<60; i+=15) minuteEl.add(new Option(String(i).padStart(2,'0'), i));
            ampmEl.add(new Option('AM', 'AM'));
            ampmEl.add(new Option('PM', 'PM'));
        }

        function renderCalendar() {
            const calendarGrid = document.getElementById('calendar-grid');
            const monthYearEl = document.getElementById('month-year');
            if(!calendarGrid || !monthYearEl) return;
            calendarGrid.innerHTML = '';
            const month = currentDate.getMonth();
            const year = currentDate.getFullYear();
            
            monthYearEl.textContent = `${currentDate.toLocaleString('default', { month: 'long' })} ${year}`;
            
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            for (let i = 0; i < firstDayOfMonth; i++) calendarGrid.innerHTML += `<div></div>`;
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day';
                dayEl.textContent = day;
                const dayDate = new Date(year, month, day);
                const dateKey = `${selectedStudent.id}-${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
                
                if (dayDate < new Date().setHours(0,0,0,0)) {
                    dayEl.classList.add('other-month');
                } else if (bookedSlots[dateKey] && bookedSlots[dateKey].length >= 7) {
                    dayEl.classList.add('fully-booked');
                } else {
                     dayEl.addEventListener('click', () => selectDate(dayDate));
                }
                if (selectedDate && dayDate.toDateString() === selectedDate.toDateString()) {
                     dayEl.classList.add('selected');
                }
                calendarGrid.appendChild(dayEl);
            }
        }
        
        function selectDate(date) {
            selectedDate = date;
            renderCalendar();
            document.getElementById('time-selection-column').classList.remove('hidden');
            handleTimeChange();
        }

        function handleTimeChange() {
            const tzSelect = document.getElementById('timezone-select');
            const hourSelect = document.getElementById('time-hour');
            const minuteSelect = document.getElementById('time-minute');
            const ampmSelect = document.getElementById('time-ampm');
            if(!tzSelect || !hourSelect) return;

            selectedTimezone = tzSelect.value;
            let hour24 = parseInt(hourSelect.value);
            if(ampmSelect.value === 'PM' && hour24 < 12) hour24 += 12;
            if(ampmSelect.value === 'AM' && hour24 === 12) hour24 = 0;
            
            selectedTime = `${String(hour24).padStart(2,'0')}:${minuteSelect.value.padStart(2,'0')}`;

            const conversionResultEl = document.getElementById('conversion-result');
            if (!selectedDate || !selectedTimezone || !selectedTime) {
                conversionResultEl.classList.add('hidden');
                return;
            }

            const volunteerDate = new Date(selectedDate);
            volunteerDate.setHours(hour24, parseInt(minuteSelect.value));

            const kenyaFormatter = new Intl.DateTimeFormat('en-US', { timeZone: 'Africa/Nairobi', weekday: 'long', hour: 'numeric', minute: 'numeric', hour12: true });
            const volunteerFormatter = new Intl.DateTimeFormat('en-US', { timeZone: selectedTimezone, hour: 'numeric', minute: 'numeric', hour12: true });

            const kenyaTime = kenyaFormatter.format(volunteerDate);
            const volunteerDisplayTime = volunteerFormatter.format(volunteerDate);
            
            const kenyaHour = parseInt(new Intl.DateTimeFormat('en-US', { timeZone: 'Africa/Nairobi', hour: 'numeric', hourCycle: 'h23' }).format(volunteerDate));
            
            const isAvailableTime = kenyaHour >= 9 && kenyaHour < 16;
            
            const displayEl = document.getElementById('kenya-time-display');
            let statusHTML = `<div class="grid grid-cols-2 gap-4">
                                <div class="text-center">
                                    <p class="text-sm font-semibold text-gray-600">Your Time</p>
                                    <p class="font-bold text-xl text-blue-600">${volunteerDisplayTime}</p>
                                </div>
                                <div class="text-center">
                                    <p class="text-sm font-semibold text-gray-600">Student's Time</p>
                                    <p class="font-bold text-xl text-purple-600">${kenyaTime}</p>
                                </div>
                              </div>`;
            if (isAvailableTime) {
                statusHTML += `<div class="mt-4 p-3 bg-green-100 text-green-800 rounded-lg"><i class="fas fa-check-circle mr-2"></i>Great! The student is available at this time.</div>
                               <button id="initiate-booking-btn" class="mt-4 w-full px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700">Confirm & Book This Time</button>`;
            } else {
                statusHTML += `<div class="mt-4 p-3 bg-red-100 text-red-800 rounded-lg"><i class="fas fa-times-circle mr-2"></i>The student is unavailable. Please choose a time that converts to between 9 AM and 4 PM in Kenya.</div>`;
            }
            displayEl.innerHTML = statusHTML;
            conversionResultEl.classList.remove('hidden');
        }

        function bookCall() {
            const dateKey = `${selectedStudent.id}-${selectedDate.getFullYear()}-${String(selectedDate.getMonth()+1).padStart(2,'0')}-${String(selectedDate.getDate()).padStart(2,'0')}`;
            if (!bookedSlots[dateKey]) bookedSlots[dateKey] = [];
            
            bookedSlots[dateKey].push(selectedTime);

            showNotification(`Call with ${selectedStudent.name} booked!`);
            closeModal();
            renderDashboard(students);
            switchPage('page-dashboard');
            document.querySelector('[data-tab="dashboard-upcoming"]').click();
        }
        
        function showNotification(message) {
            notificationEl.textContent = message;
            notificationEl.classList.remove('hidden');
            setTimeout(() => {
                 notificationEl.classList.add('hidden');
            }, 3000);
        }

        function closeModal() {
             confirmModal.classList.add('hidden');
        }
        
        function startUpcomingMeetingTimers() {
            document.querySelectorAll('[data-countdown]').forEach(el => {
                const targetTime = new Date(el.dataset.countdown).getTime();
                const intervalId = setInterval(() => {
                    const now = new Date().getTime();
                    const distance = targetTime - now;
                    if(distance < 0) {
                        el.textContent = "Started!";
                        clearInterval(intervalId);
                        return;
                    }
                    const d = Math.floor(distance / (1000 * 60 * 60 * 24));
                    const h = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const m = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                    const s = Math.floor((distance % (1000 * 60)) / 1000);
                    el.textContent = `${d}d ${h}h ${m}m ${s}s`;
                }, 1000);
            });
        }

        function createCallWithStudent(student) {
            const roomName = `talktime-${Math.random().toString(36).substr(2, 9)}`;
            const params = new URLSearchParams({ 
                room: roomName, 
                role: 'volunteer',
                studentName: student.name
            });
            window.location.href = `call.html?${params.toString()}`;
        }

        // --- Event Listeners ---
        document.body.addEventListener('click', (e) => {
             const studentCard = e.target.closest('#student-list-available a');
            if (studentCard) {
                e.preventDefault();
                const studentId = parseInt(studentCard.dataset.studentId);
                selectedStudent = students.find(s => s.id === studentId);
                if (selectedStudent) {
                    renderStudentProfile(selectedStudent);
                    switchPage('page-profile', studentId);
                }
            }
            const navBtn = e.target.closest('.page-nav-btn');
            if (navBtn) {
                 const targetPage = navBtn.dataset.target;
                 if(targetPage === 'page-dashboard') {
                    selectedStudent = null;
                 } else if (targetPage === 'page-profile') {
                    renderStudentProfile(selectedStudent);
                 }
                 switchPage(targetPage, selectedStudent ? selectedStudent.id : null);
            }
            
            const scheduleBtn = e.target.closest('.schedule-btn-sticky');
            if (scheduleBtn) {
                const studentId = parseInt(scheduleBtn.dataset.studentId);
                selectedStudent = students.find(s => s.id === studentId);
                renderScheduler(selectedStudent);
                switchPage('page-scheduler', studentId);
            }
            
            const callNowBtn = e.target.closest('.call-now-btn-sticky');
            if (callNowBtn) {
                const studentId = parseInt(callNowBtn.dataset.studentId);
                const student = students.find(s => s.id === studentId);
                if(student) createCallWithStudent(student);
            }

            const initiateBookingBtn = e.target.closest('#initiate-booking-btn');
            if(initiateBookingBtn) {
                const formattedDate = selectedDate.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                const volunteerTime = new Date(selectedDate).toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit', timeZone: selectedTimezone, hour12: true});
                confirmDetailsEl.textContent = `You are booking a call with ${selectedStudent.name} on ${formattedDate} at ${volunteerTime}.`;
                confirmModal.classList.remove('hidden');
            }
            
            const star = e.target.closest('.star-rating .fa-star');
            if(star) {
                star.classList.add('selected');
                let sibling = star.nextElementSibling;
                while(sibling) {
                    sibling.classList.remove('selected');
                    sibling = sibling.nextElementSibling;
                }
            }

            const tabBtn = e.target.closest('.tab-btn');
            if(tabBtn) {
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.remove('text-blue-600', 'border-blue-600');
                    btn.classList.add('text-gray-500', 'border-transparent');
                });
                tabBtn.classList.add('text-blue-600', 'border-blue-600');
                tabBtn.classList.remove('text-gray-500', 'border-transparent');
                
                document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.add('tab-pane-hidden'));
                document.getElementById(tabBtn.dataset.tab).classList.remove('tab-pane-hidden');
            }

            const optionsBtn = e.target.closest('.options-btn');
            if (optionsBtn) {
                e.preventDefault();
                const menu = optionsBtn.nextElementSibling;
                const isHidden = menu.classList.contains('hidden');
                document.querySelectorAll('.options-menu').forEach(m => m.classList.add('hidden'));
                if (isHidden) {
                    menu.classList.remove('hidden');
                }
            } else if (!e.target.closest('.options-menu')) {
                document.querySelectorAll('.options-menu').forEach(m => m.classList.add('hidden'));
            }
        });
        
        confirmBookBtn.addEventListener('click', bookCall);
        confirmCancelBtn.addEventListener('click', closeModal);

        profileBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            profileDropdown.classList.toggle('hidden');
            profileDropdown.classList.toggle('opacity-0');
            profileDropdown.classList.toggle('-translate-y-2');
        });
        document.addEventListener('click', (e) => {
            if (!profileBtn.contains(e.target) && !profileDropdown.contains(e.target)) {
                 profileDropdown.classList.add('hidden', 'opacity-0', '-translate-y-2');
            }
        });

        // --- Countdown Timer Logic ---
        function initializeCountdown(elementId, showDays) {
            const countdownElement = document.getElementById(elementId);
            if (!countdownElement) return;

            const startTime = new Date(countdownElement.dataset.startTime).getTime();
            let countdownInterval;

            const updateCountdown = () => {
                const now = new Date().getTime();
                const distance = startTime - now;

                if (distance < 0) {
                    if (elementId === 'countdown-timer-0') {
                        // For the first meeting, show "Meeting in progress"
                        const parentDiv = countdownElement.parentElement;
                        if (parentDiv) {
                            parentDiv.innerHTML = `<i class="far fa-check-circle mr-1 text-green-500"></i> <span class="font-semibold text-green-600">Meeting started <span class="text-gray-600 text-sm font-normal italic ml-2">(03 minutes ago)</span></span>`;
                        }
                    } else {
                        countdownElement.textContent = "Started!";
                        countdownElement.classList.remove('text-green-600', 'text-gray-600');
                        countdownElement.classList.add('text-red-500');
                    }
                    if (countdownInterval) clearInterval(countdownInterval);
                    return;
                }

                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                let timerString = "";
                if (showDays && days > 0) timerString += `${days}d `;
                if (hours > 0 || (showDays && days > 0)) timerString += `${hours}h `;
                timerString += `${minutes}m ${seconds}s`;
                
                countdownElement.textContent = timerString.trim();
            };

            countdownInterval = setInterval(updateCountdown, 1000);
            updateCountdown();
        }

        // --- Initial Load ---
        fetch('data.json')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                students = data.students;
                renderDashboard(students);
            })
            .catch(error => {
                console.error("Failed to load student data:", error);
                availableStudentsContainer.innerHTML = '<p class="text-red-500 text-center">Could not load student data. Please ensure data.json is present and correctly formatted.</p>';
            });
    });
    </script>

</body>
</html>
