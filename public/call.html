<!DOCTYPE html>
<html lang="en">
<head>
    <title>TalkTime - Conference Call</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter & Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Poppins:wght@700;800&display=swap" rel="stylesheet">
    
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <!-- Tone.js for sound -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }
        .gradient-bg {
            background: linear-gradient(-45deg, #e0f7fa, #d1c4e9, #f8bbd0, #bbdefb);
            background-size: 400% 400%;
            animation: gradientAnimation 15s ease infinite;
        }
        @keyframes gradientAnimation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .glass-bg {
            background: rgba(255,255,255,0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        /* Wrapper for status and timer */
        #wrapper {
            position: fixed;
            top: 1.5rem; left: 1.5rem;
            z-index: 101;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        #wrapper.inactive #timer-container,
        #wrapper.inactive #status-left-container {
            opacity: 0.5;
        }

        /* Left status icons */
        #status-left-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: white;
            padding: 0.5rem 0.75rem;
            border-radius: 1rem;
            transition: opacity 0.3s ease;
        }
        .status-icon {
            font-size: 1.25rem;
            color: black;
        }

        /* Countdown Timer */
        #timer-container {
            width: 220px; height: 48px;
            border-radius: 1.25rem;
            padding: 2px;
            background: linear-gradient(90deg, #f97316, #a855f7);
            overflow: hidden;
            transition: opacity 0.3s ease;
        }
        #timer-inner-bg {
            height: 100%;
            background-color: rgba(220,252,231,0.7);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border-radius: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 1rem;
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
            color: #1f2937;
            text-shadow: 0 1px 1px rgba(255,255,255,0.4);
        }
        #timer-text {
            display: flex;
            align-items: baseline;
            justify-content: center;
            gap: 0.25rem;
            width: 100%;
        }
        .font-monospace {
            font-family: ui-monospace, Menlo, Consolas, monospace;
        }
        #timer-icon { font-size: 1.25rem; }
        #timer-main { font-size: 1.5rem; }
        #timer-ms { font-size: 1.125rem; color: #8b5cf6; }

        /* Video Grid */
        #video-grid-container {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            display: flex; align-items: center; justify-content: center;
            padding: 1rem;
            transition: right 0.4s ease-in-out;
        }
        #video-grid {
            width: 100%; height: 100%;
            display: grid; gap: 1rem;
            transition: all 0.5s ease-in-out;
        }
        .video-participant {
            position: relative;
            background-color: #2c2c2e;
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(31,38,135,0.1);
            transition: all 0.3s ease;
        }
        .video-participant.maximized {
            position: absolute; top:0; left:0;
            width:100%; height:100%; z-index:50;
        }
        .video-participant.minimized {
            opacity:0; pointer-events:none;
        }
        .video-participant video {
            width:100%; height:100%; object-fit:cover;
        }
        .participant-overlay {
            position:absolute; top:0; left:0; right:0; bottom:0;
            opacity:0; background:rgba(0,0,0,0.3);
            transition:opacity 0.3s ease;
        }
        .video-participant:hover .participant-overlay {
            opacity:1;
        }
        .participant-name {
            position:absolute; bottom:10px; left:10px;
            background:rgba(0,0,0,0.5); color:white;
            padding:4px 12px; border-radius:9999px;
            font-size:0.875rem; font-weight:500;
        }
        .action-icon-btn {
            position:absolute; background:rgba(0,0,0,0.5);
            color:white; border:none;
            width:32px; height:32px; border-radius:50%;
            display:flex; align-items:center; justify-content:center;
            cursor:pointer; z-index:51;
        }
        .action-icon-btn:hover {
            background:rgba(0,0,0,0.8);
        }
        .maximize-btn { top:10px; right:10px; }
        .kick-btn { top:10px; right:52px; }
        .video-participant.maximized .maximize-btn {
            background:rgba(255,255,255,0.8); color:#333;
        }

        /* Call Controls */
        #call-controls {
            position:fixed; bottom:1.5rem; left:50%;
            transform:translateX(-50%);
            z-index:100; display:flex; gap:1rem;
            padding:1rem 1.5rem; border-radius:9999px;
        }
        .control-btn {
            width:55px; height:55px; border-radius:50%;
            border:none; color:#333; font-size:1.25rem;
            display:flex; align-items:center; justify-content:center;
            cursor:pointer; background:rgba(255,255,255,0.8);
            transition:all 0.2s ease;
        }
        .control-btn:hover {
            background:white; transform:translateY(-3px);
            box-shadow:0 4px 15px rgba(0,0,0,0.1);
        }
        .control-btn.active {
            background-color:#4f46e5; color:white;
        }
        .control-btn.inactive {
            background-color:#ef4444; color:white;
        }
        .control-btn.end-call {
            background-color:#ef4444; color:white;
        }
        .control-btn.end-call:hover {
            background-color:#dc2626;
        }

        /* Chat Panel */
        #chat-panel {
            position:fixed; top:0; right:-400px;
            width:100%; max-width:400px; height:100%;
            z-index:110; display:flex; flex-direction:column;
            transition:right 0.4s ease-in-out;
        }
        #chat-panel.open {
            right:0;
        }

        /* Floating UI (other) */
        .floating-ui {
            position:fixed; z-index:100;
            display:flex; gap:0.5rem;
            transition:opacity 0.5s ease-in-out;
        }
        .floating-ui.ui-hidden {
            opacity:0; pointer-events:none;
        }
        #simulation-controls {
            top:1.5rem; right:1.5rem;
        }
        .sim-btn {
            display:flex; align-items:center; gap:0.5rem;
            padding:0.5rem 1rem; border-radius:9999px;
            font-weight:600; color:#374151; cursor:pointer;
        }
        .sim-btn i { color:#6b7280; }
        .sim-btn:disabled { opacity:0.5; cursor:not-allowed; }

        /* Action Toast */
        #action-toast {
            position:fixed; top:-100px; left:50%;
            transform:translateX(-50%); z-index:1000;
            padding:0.75rem 1.5rem; border-radius:9999px;
            color:white; font-weight:600;
            box-shadow:0 4px 15px rgba(0,0,0,0.1);
            transition:top 0.5s ease-in-out;
        }
        #action-toast.show {
            top:2rem;
        }
        #action-toast.on { background-color:#22c55e; }
        #action-toast.off { background-color:#ef4444; }
        #action-toast.info { background-color:#3b82f6; }

        /* Confirmation Modal */
        #confirm-modal {
            position:fixed; inset:0; z-index:500;
            display:flex; align-items:center; justify-content:center;
            padding:1rem; background:rgba(0,0,0,0.4);
            backdrop-filter:blur(4px);
            opacity:0; pointer-events:none;
            transition:opacity 300ms ease-in-out;
        }
        #confirm-modal.show {
            opacity:1; pointer-events:auto;
        }
        #confirm-modal .modal-content {
            transform:scale(0.95);
            transition:transform 300ms ease-in-out;
        }
        #confirm-modal.show .modal-content {
            transform:scale(1);
        }
        .modal-btn-danger {
            background-color:#ef4444; color:white;
        }
        .modal-btn-danger:hover {
            background-color:#dc2626;
        }
        .modal-btn-secondary {
            background-color:#e5e7eb; color:#374151;
        }
        .modal-btn-secondary:hover {
            background-color:#d1d5db;
        }

        /* Warning Overlay */
        #warning-overlay {
            position:fixed; inset:0; z-index:-1;
            background-color:#ef4444; opacity:0;
            pointer-events:none;
        }
        #warning-overlay.active {
            animation:dimmingPulse 3s ease-in-out infinite;
        }
        @keyframes dimmingPulse {
            0%,100% { opacity:0; }
            50% { opacity:0.15; }
        }
    </style>
</head>
<body class="gradient-bg">
    <!-- Decorative Blobs -->
    <div class="blob w-96 h-96 bg-purple-300 top-[-10rem] left-[-10rem]"></div>
    <div class="blob w-96 h-96 bg-blue-300 bottom-[-5rem] right-[-10rem]"></div>
    <div id="warning-overlay"></div>

    <!-- Status & Timer Wrapper -->
    <div id="wrapper">
        <div id="status-left-container">
            <i id="status-left-mic" class="fas fa-microphone status-icon"></i>
            <i id="status-left-camera" class="fas fa-video status-icon"></i>
        </div>
        <div id="timer-container">
            <div id="timer-inner-bg">
                <div id="timer-text">
                    <i id="timer-icon" class="far fa-clock"></i>
                    <div class="font-monospace flex items-baseline">
                        <span id="timer-main">40:00</span>
                        <span id="timer-ms">.00</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Video Grid -->
    <main id="video-grid-container">
        <div id="video-grid"></div>
    </main>

    <!-- Call Controls -->
    <div id="call-controls" class="floating-ui glass-bg">
        <button id="mic-btn" class="control-btn active" title="Mute/Unmute Mic">
            <i class="fas fa-microphone"></i>
        </button>
        <button id="camera-btn" class="control-btn active" title="Start/Stop Camera">
            <i class="fas fa-video"></i>
        </button>
        <button id="chat-btn" class="control-btn" title="Open Chat">
            <i class="fas fa-comment"></i>
        </button>
        <button id="copy-meeting-link-btn" class="control-btn" title="Copy Meeting Link">
            <i class="fas fa-link"></i>
        </button>
        <button id="end-btn" class="control-btn end-call" title="End Call">
            <i class="fas fa-phone-slash"></i>
        </button>
    </div>

    <!-- Action Toast -->
    <div id="action-toast"></div>

    <!-- Chat Panel -->
    <aside id="chat-panel" class="glass-bg">
        <div class="chat-header flex justify-between items-center p-4 border-b border-gray-200/50">
            <span class="text-xl font-bold text-gray-800">Chat</span>
            <button id="close-chat-btn" class="text-gray-600 hover:text-gray-900">
                <i class="fas fa-times text-2xl"></i>
            </button>
        </div>
        <div class="chat-messages flex-1 p-4 overflow-y-auto space-y-4">
            <div class="p-3 rounded-lg bg-blue-100 max-w-xs">Hello everyone!</div>
            <div class="p-3 rounded-lg bg-gray-200 max-w-xs ml-auto">Hi there! Welcome.</div>
        </div>
        <div class="chat-input-container p-4 flex gap-2 border-t border-gray-200/50">
            <input id="chat-input" type="text"
                   class="flex-1 p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
                   placeholder="Type a message...">
            <button id="send-chat-btn" class="w-12 h-10 rounded-lg bg-blue-600 text-white flex items-center justify-center">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </aside>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="modal">
        <div class="modal-content modal-glass-bg w-full max-w-sm rounded-2xl p-8">
            <div class="mx-auto bg-yellow-100/50 rounded-full h-16 w-16 flex items-center justify-center mb-6">
                <i id="confirm-icon" class="fas fa-exclamation-triangle text-3xl text-yellow-500"></i>
            </div>
            <h3 id="confirm-title" class="text-2xl font-bold mb-2 text-gray-900">Are you sure?</h3>
            <p id="confirm-message" class="mb-6 text-base leading-relaxed text-gray-700">This action cannot be undone.</p>
            <div class="flex justify-center gap-4">
                <button id="confirm-cancel-btn" class="px-8 py-2 rounded-lg font-semibold modal-btn-secondary">
                    Cancel
                </button>
                <button id="confirm-ok-btn" class="px-8 py-2 rounded-lg font-semibold modal-btn-danger">
                    Confirm
                </button>
            </div>
        </div>
    </div>

    <!-- Core Scripts -->
    <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="js/webrtc.js"></script>
    <script src="js/call.js" defer></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const grid = document.getElementById('video-grid');
            const addUserBtn = document.getElementById('add-user-btn');
            const chatBtn = document.getElementById('chat-btn');
            const closeChatBtn = document.getElementById('close-chat-btn');
            const chatPanel = document.getElementById('chat-panel');
            const gridContainer = document.getElementById('video-grid-container');
            const micBtn = document.getElementById('mic-btn');
            const cameraBtn = document.getElementById('camera-btn');
            const endCallBtn = document.getElementById('end-call-btn');
            const actionToast = document.getElementById('action-toast');
            const statusLeftMic = document.getElementById('status-left-mic');
            const statusLeftCam = document.getElementById('status-left-camera');
            const copyLinkBtn = document.getElementById('copy-link-btn');
            const confirmModal = document.getElementById('confirm-modal');
            const confirmIcon = document.getElementById('confirm-icon');
            const confirmTitle = document.getElementById('confirm-title');
            const confirmMessage = document.getElementById('confirm-message');
            const confirmOkBtn = document.getElementById('confirm-ok-btn');
            const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
            const wrapper = document.getElementById('wrapper');
            const timerMainEl = document.getElementById('timer-main');
            const timerMsEl = document.getElementById('timer-ms');
            const warningOverlay = document.getElementById('warning-overlay');
            const floatingUIElements = document.querySelectorAll('.floating-ui');

            const MAX_PARTICIPANTS = 6;
            const TOTAL_DURATION_MS = 40 * 60 * 1000;
            const WARNING_TIME_MS = 3 * 60 * 1000;
            let participantCount = 1;
            let timeRemainingMs = TOTAL_DURATION_MS;
            let callTimerInterval, toastTimer, confirmCallback = null;
            let warningBeepPlayed = false, synth, uiHideTimeout;
            const names = ["Aisha","David","Fatima","Chen","Maria","Kwame","Yuki","Jose","Nia","Omar","Sofia","Liam"];

            function updateTimerDisplay(ms) {
                const totalSec = Math.floor(ms/1000);
                const m = Math.floor(totalSec/60);
                const s = totalSec % 60;
                const cs = Math.floor((ms%1000)/10);
                timerMainEl.textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
                timerMsEl.textContent = `.${String(cs).padStart(2,'0')}`;
            }

            function updateStatusLeftIcons() {
                statusLeftMic.className = micBtn.classList.contains('active')
                    ? 'fas fa-microphone status-icon'
                    : 'fas fa-microphone-slash status-icon';
                statusLeftCam.className = cameraBtn.classList.contains('active')
                    ? 'fas fa-video status-icon'
                    : 'fas fa-video-slash status-icon';
            }

            function startTimer() {
                if (!synth) synth = new Tone.Synth().toDestination();
                const start = Date.now();
                updateTimerDisplay(timeRemainingMs);
                callTimerInterval = setInterval(() => {
                    const elapsed = Date.now() - start;
                    timeRemainingMs = TOTAL_DURATION_MS - elapsed;
                    if (timeRemainingMs <= 0) {
                        timeRemainingMs = 0;
                        clearInterval(callTimerInterval);
                        showUI(true);
                        showConfirmation({
                            title: "Time's Up!",
                            message: "The meeting has reached its 40-minute limit and will now end.",
                            icon: "far fa-clock",
                            iconColor: "text-red-500",
                            onConfirm: () => window.location.href = 'app.html'
                        });
                    }
                    updateTimerDisplay(timeRemainingMs);
                    if (timeRemainingMs <= WARNING_TIME_MS && !warningBeepPlayed) {
                        warningBeepPlayed = true;
                        warningOverlay.classList.add('active');
                        showUI(true);
                        if (Tone.context.state === 'running') {
                            synth.triggerAttackRelease("C5", "8n");
                        }
                    }
                }, 100);
            }

            function hideUI() {
                floatingUIElements.forEach(el => el.classList.add('ui-hidden'));
                wrapper.classList.add('inactive');
            }

            function showUI(force = false) {
                floatingUIElements.forEach(el => el.classList.remove('ui-hidden'));
                wrapper.classList.remove('inactive');
                clearTimeout(uiHideTimeout);
                if (!force) {
                    uiHideTimeout = setTimeout(hideUI, 3000);
                }
            }

            function getOptimalLayout(n) {
                if (n === 0) return { cols: 1, rows: 1 };
                const ar = window.innerWidth / window.innerHeight;
                let best = { cols: n, rows: 1, waste: Infinity };
                for (let c = 1; c <= n; c++) {
                    const r = Math.ceil(n / c);
                    const w = window.innerWidth / c;
                    const h = window.innerHeight / r;
                    const ta = w / h;
                    const waste = Math.abs(ta - ar);
                    if (waste < best.waste) best = { cols: c, rows: r, waste };
                }
                return best;
            }
            function updateGridLayout() {
                const layout = getOptimalLayout(participantCount);
                grid.style.gridTemplateColumns = `repeat(${layout.cols},1fr)`;
                grid.style.gridTemplateRows = `repeat(${layout.rows},1fr)`;
                if (addUserBtn) {
                    addUserBtn.disabled = participantCount >= MAX_PARTICIPANTS;
                    addUserBtn.innerHTML = participantCount >= MAX_PARTICIPANTS
                        ? '<i class="fas fa-users-slash"></i> Limit Reached'
                        : '<i class="fas fa-user-plus"></i> Add User';
                }
            }

            function showActionToast(msg, type) {
                actionToast.textContent = msg;
                actionToast.className = `show ${type}`;
                clearTimeout(toastTimer);
                toastTimer = setTimeout(() => actionToast.classList.remove('show'), 2500);
            }
            function handleControlToggle(btn, onIcon, offIcon, name) {
                btn.classList.toggle('active');
                btn.innerHTML = `<i class="fas ${btn.classList.contains('active') ? onIcon : offIcon}"></i>`;
                btn.classList.toggle('inactive', !btn.classList.contains('active'));
                showActionToast(`${name} ${btn.classList.contains('active') ? 'ON' : 'OFF'}`, btn.classList.contains('active') ? 'on' : 'off');
                updateStatusLeftIcons();
            }
            function showConfirmation(cfg) {
                showUI(true);
                confirmTitle.textContent = cfg.title;
                confirmMessage.textContent = cfg.message;
                confirmIcon.className = `fas ${cfg.icon} text-3xl ${cfg.iconColor}`;
                confirmModal.classList.add('show');
                confirmCallback = cfg.onConfirm;
            }
            function hideConfirmation() {
                confirmModal.classList.remove('show');
                confirmCallback = null;
                showUI();
            }

            document.body.addEventListener('click', async () => {
                if (Tone.context.state !== 'running') await Tone.start();
            }, { once: true });
            document.body.addEventListener('mousemove', () => showUI());
            document.body.addEventListener('touchstart', () => showUI());

            if (addUserBtn) {
                addUserBtn.addEventListener('click', () => {
                    if (participantCount < MAX_PARTICIPANTS) {
                        participantCount++;
                        addParticipant();
                        updateGridLayout();
                    }
                });
            }

            if (copyLinkBtn) {
                copyLinkBtn.addEventListener('click', () => showActionToast('Meeting link copied!', 'info'));
            }
            if (micBtn) micBtn.addEventListener('click', () => handleControlToggle(micBtn, 'fa-microphone', 'fa-microphone-slash', 'Microphone'));
            if (cameraBtn) cameraBtn.addEventListener('click', () => handleControlToggle(cameraBtn, 'fa-video', 'fa-video-slash', 'Camera'));
            if (endCallBtn) {
                endCallBtn.addEventListener('click', () => {
                    showConfirmation({
                        title: 'End Call?',
                        message: 'Are you sure you want to leave the meeting?',
                        icon: 'fa-phone-slash',
                        iconColor: 'text-red-500',
                        onConfirm: () => window.location.href = 'app.html'
                    });
                });
            }
            if (chatBtn) {
                chatBtn.addEventListener('click', () => {
                    chatPanel.classList.add('open');
                    chatBtn.classList.add('active');
                    gridContainer.style.right = '400px';
                    showUI(true);
                });
            }
            if (closeChatBtn) {
                closeChatBtn.addEventListener('click', () => {
                    chatPanel.classList.remove('open');
                    chatBtn.classList.remove('active');
                    gridContainer.style.right = '0px';
                    showUI();
                });
            }

            if (confirmOkBtn) {
                confirmOkBtn.addEventListener('click', () => {
                    if (confirmCallback) confirmCallback();
                    hideConfirmation();
                });
            }
            if (confirmCancelBtn) confirmCancelBtn.addEventListener('click', hideConfirmation);
            if (confirmModal) {
                confirmModal.addEventListener('click', e => {
                    if (e.target === confirmModal) hideConfirmation();
                });
            }
            window.addEventListener('resize', updateGridLayout);

            // initial
            updateGridLayout();
            updateStatusLeftIcons();
            startTimer();
            showUI();
        });
    </script>
</body>
</html>
