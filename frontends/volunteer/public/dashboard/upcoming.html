<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>TalkTime - Upcoming Meetings | Volunteer Dashboard</title>
    <!-- Early auth redirect - prevents FOUC on protected pages -->
    <script>
        if (!localStorage.getItem('volunteer_talktime_access_token')) {
            window.location.replace('/volunteer/login');
        }
    </script>

    <!-- Brand Theme System -->
    <link rel="stylesheet" href="/shared/css/brand-theme.css">
    <link rel="icon" type="image/x-icon" href="/talktime.ico">
    <meta name="description" content="View and manage your upcoming TalkTime English practice sessions with Maasai students. Join calls, reschedule, or cancel meetings.">
    <link rel="canonical" href="https://talktime.adeafoundation.org/volunteer/dashboard/upcoming">
    <meta name="robots" content="index, follow">

    <!-- CSS (all sync to prevent layout shift) -->
    <link rel="stylesheet" href="/shared/css/tailwind.min.css">
    <link rel="stylesheet" href="/shared/fonts/google/fonts.css">
    <link rel="stylesheet" href="/shared/fonts/fontawesome/all.min.css">
    <link rel="stylesheet" href="/volunteer/css/main.css">
    <link rel="stylesheet" href="/volunteer/css/responsive-framework.css">
    <link rel="stylesheet" href="/volunteer/css/responsive-forms.css">
    <link rel="stylesheet" href="/volunteer/css/enhanced-mobile-nav.css">
    <link rel="stylesheet" href="/volunteer/css/volunteer-dashboard.css">

    <!-- Deferred Scripts (non-render-blocking) -->
    <script defer src="/shared/js/brand-config.js"></script>
    <script defer src="/volunteer/partials/nav-loader.js"></script>
    <script defer src="/volunteer/js/dashboard-nav.js"></script>
    <script defer src="/volunteer/js/modal-utils.js"></script>
    <script defer src="/shared/js/jwt-auth-utils.js"></script>
    <script defer src="/shared/js/newsletter-widget.js"></script>
    
    <style>
        /* Compact meeting card */
        .meeting-card {
            position: relative;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 12px 14px;
            transition: box-shadow 0.2s ease;
        }
        .meeting-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        /* Avatar: photo or initials */
        .student-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
        }
        .student-initials {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            color: white;
            background: var(--brand-primary, #D10100);
        }

        /* Card layout */
        .mc-row {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .mc-info {
            flex: 1;
            min-width: 0;
        }
        .mc-name {
            font-weight: 600;
            font-size: 15px;
            color: #111827;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .mc-meta {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 13px;
            color: #6b7280;
            margin-top: 2px;
        }
        .mc-meta i {
            font-size: 11px;
            color: #9ca3af;
            margin-right: 3px;
        }

        /* Footer row: date left, actions right */
        .mc-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #f3f4f6;
            gap: 8px;
        }
        .mc-date {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: #6b7280;
        }
        .mc-date i {
            font-size: 12px;
            color: #9ca3af;
        }

        /* Compact action buttons */
        .mc-actions {
            display: flex;
            align-items: center;
            gap: 6px;
            flex-shrink: 0;
        }
        .join-btn {
            background: var(--color-success, #116C00);
            color: white;
            padding: 7px 14px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 13px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            white-space: nowrap;
        }
        .join-btn:hover { background: #0d5200; }
        .join-btn:active { transform: scale(0.97); }

        .waiting-btn {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: #f3f4f6;
            color: #6b7280;
            padding: 7px 12px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: default;
            white-space: nowrap;
            font-variant-numeric: tabular-nums;
        }

        /* 3-dot menu */
        .menu-btn {
            width: 32px;
            height: 32px;
            min-width: 32px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            cursor: pointer;
            color: #9ca3af;
            font-size: 14px;
            transition: all 0.15s ease;
        }
        .menu-btn:hover { background: #f3f4f6; color: #6b7280; }
        .meeting-dropdown { min-width: 160px; }
        .meeting-dropdown { transition: all 0.2s ease; }

        /* Timer urgency inside waiting-btn */
        .waiting-btn.urgency-soon { background: #fef3c7; color: #92400e; }
        .waiting-btn.urgency-now { background: #fee2e2; color: #991b1b; }

        @media (max-width: 400px) {
            .mc-meta { flex-wrap: wrap; gap: 6px; }
            .mc-footer { flex-wrap: wrap; }
        }
    </style>
</head>
<body class="dashboard-page" style="opacity:0">
    <!-- Background Blobs - Hidden on mobile for performance -->
    <div class="blob bg-brand-primary w-96 h-96 top-0 left-0 -translate-x-1/2 -translate-y-1/2"></div>
    <div class="blob bg-brand-secondary w-96 h-96 bottom-0 right-0 translate-x-1/2 translate-y-1/2"></div>

    <!-- Dashboard Navigation Container -->
    <div id="dashboard-nav-container"></div>

    <!-- Main Content Area -->
    <main class="content-area">
        <div class="section-header">
            <i class="fas fa-calendar-alt text-brand-primary"></i>
            Upcoming Meetings
        </div>
        <div id="upcoming-meetings" class="meetings-grid"></div>
    </main>
    
    <!-- Notification Toast -->
    <div id="notification" class="hidden fixed bottom-5 right-5 bg-success text-white px-6 py-3 rounded-lg shadow-lg"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        document.body.classList.add('page-ready');
        // --- DOM Elements ---
        const upcomingMeetingsContainer = document.getElementById('upcoming-meetings');
        const notificationEl = document.getElementById('notification');
        const upcomingBadge = document.getElementById('upcoming-badge');

        // --- Utility Functions ---
        function showNotification(message, type = 'success') {
            notificationEl.textContent = message;
            notificationEl.className = `fixed bottom-5 right-5 px-6 py-3 rounded-lg shadow-lg ${type === 'success' ? 'bg-success text-white' : 'bg-error text-white'}`;
            notificationEl.classList.remove('hidden');
            
            setTimeout(() => {
                notificationEl.classList.add('hidden');
            }, 5000);
        }

        // Function to toggle meeting dropdown menu
        function toggleMeetingMenu(menuBtn) {
            // Close all other open dropdowns first
            document.querySelectorAll('.meeting-dropdown').forEach(dropdown => {
                if (dropdown !== menuBtn.nextElementSibling) {
                    dropdown.classList.add('hidden');
                }
            });
            
            // Toggle this dropdown
            const dropdown = menuBtn.nextElementSibling;
            dropdown.classList.toggle('hidden');
        }
        
        // Function to reschedule a meeting
        function rescheduleMeeting(meetingId, studentId, studentName, admissionNumber) {
            // Navigate directly to schedule page with proper query parameters
            window.location.href = `/volunteer/dashboard/schedule.html?id=${studentId}&admission=${admissionNumber}&name=${encodeURIComponent(studentName)}&meeting=${meetingId}`;
        }
        
        // Function to cancel a meeting
        async function cancelMeeting(meetingId, studentName) {
            const confirmed = await window.showConfirmation(
                `Are you sure you want to cancel your meeting with ${studentName}?`,
                {
                    title: 'Cancel Meeting',
                    confirmText: 'Cancel Meeting',
                    cancelText: 'Keep Meeting',
                    type: 'warning'
                }
            );
            
            if (!confirmed) {
                return;
            }
            
            console.log('Cancelling meeting:', meetingId);
            
            // Send API request to cancel the meeting
            if (!window.TalkTimeAuth.isAuthenticated()) {
                showNotification('Authentication required to cancel meeting.', 'error');
                return;
            }

            window.TalkTimeAuth.authenticatedRequest(`/api/v1/meetings/${meetingId}`, {
                method: 'DELETE'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to cancel meeting');
                }
                return response.json();
            })
            .then(data => {
                console.log('Meeting cancelled:', data);
                
                // Show success notification
                showNotification('Meeting cancelled successfully');
                
                // Refresh the dashboard by reloading data from the server
                loadDashboardData();
            })
            .catch(error => {
                console.error('Error cancelling meeting:', error);
                showNotification('Failed to cancel meeting. Please try again.', 'error');
            });
        }

        // --- Store countdown intervals for cleanup ---
        const countdownIntervals = new Map();
        const JOIN_WINDOW_MINUTES = 5;

        // --- Track which meetings have already triggered auto-launch ---
        const autoLaunchedMeetings = new Set();

        // --- Countdown Timer Logic (synced with student side) ---
        function initializeCountdown(meetingId, scheduledTime, roomId, studentName, studentId) {
            const countdownElement = document.getElementById(`countdown-timer-${meetingId}`);
            const joinBtn = document.getElementById(`join-btn-${meetingId}`);
            const waitingBtn = document.getElementById(`waiting-btn-${meetingId}`);
            if (!countdownElement) return;

            // Clear existing interval
            if (countdownIntervals.has(meetingId)) {
                clearInterval(countdownIntervals.get(meetingId));
            }

            const meetingTime = new Date(scheduledTime).getTime();

            const updateCountdown = () => {
                const now = Date.now();
                const distance = meetingTime - now;
                const minutesUntil = Math.floor(distance / (1000 * 60));

                // Meeting has started (or is past)
                if (distance <= 0) {
                    const minutesPast = Math.abs(minutesUntil);

                    if (minutesPast < 40) {
                        // Meeting is in progress
                        countdownElement.textContent = 'In progress';
                        showJoinButton();

                        // AUTO-LAUNCH: Automatically redirect volunteer to call when meeting time arrives
                        if (!autoLaunchedMeetings.has(meetingId) && minutesPast < 2) {
                            autoLaunchedMeetings.add(meetingId);
                            triggerAutoLaunch(meetingId, roomId, studentName, studentId);
                        }
                    } else {
                        // Meeting window has passed
                        countdownElement.textContent = 'Expired';
                        if (waitingBtn) waitingBtn.className = 'waiting-btn';
                        hideJoinButton();
                        clearInterval(countdownIntervals.get(meetingId));
                        countdownIntervals.delete(meetingId);
                    }
                    return;
                }

                // Calculate time components
                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                let timerString = "";
                if (days > 0) timerString += `${days}d `;
                if (hours > 0 || days > 0) timerString += `${hours}h `;
                timerString += `${minutes}m ${seconds}s`;

                countdownElement.textContent = timerString.trim();

                // Set urgency styling on the waiting button
                if (waitingBtn) {
                    waitingBtn.classList.remove('urgency-soon', 'urgency-now');
                    if (minutesUntil <= 1) {
                        waitingBtn.classList.add('urgency-now');
                    } else if (minutesUntil <= 5) {
                        waitingBtn.classList.add('urgency-soon');
                    }
                }

                // Show/hide join button based on time window
                if (minutesUntil <= JOIN_WINDOW_MINUTES) {
                    showJoinButton();
                } else {
                    hideJoinButton();
                }
            };

            function showJoinButton() {
                if (joinBtn) joinBtn.style.display = 'inline-block';
                if (waitingBtn) waitingBtn.style.display = 'none';
            }

            function hideJoinButton() {
                if (joinBtn) joinBtn.style.display = 'none';
                if (waitingBtn) waitingBtn.style.display = 'inline-block';
            }

            // Initial update
            updateCountdown();

            // Update every second
            const intervalId = setInterval(updateCountdown, 1000);
            countdownIntervals.set(meetingId, intervalId);
        }

        /**
         * AUTO-LAUNCH: Show overlay and auto-redirect volunteer to call
         * This triggers when meeting time arrives (countdown reaches 0)
         */
        function triggerAutoLaunch(meetingId, roomId, studentName, studentId) {
            console.log('ðŸš€ AUTO-LAUNCH: Meeting time reached, starting call automatically');
            console.log('ðŸ“‹ Meeting data:', { meetingId, roomId, studentName, studentId });

            // Remove any existing overlay
            const existingOverlay = document.getElementById('auto-launch-redirect-overlay');
            if (existingOverlay) existingOverlay.remove();

            // Get volunteer info from auth
            const volunteer = window.TalkTimeAuth ? window.TalkTimeAuth.getUser() : null;
            const volunteerName = volunteer ? (volunteer.fullName || volunteer.full_name || volunteer.name || 'Volunteer') : 'Volunteer';

            // Build call URL with all necessary parameters for student notification
            const callUrl = `/call/call.html?room=${roomId || meetingId}&role=volunteer&studentId=${studentId || ''}&studentName=${encodeURIComponent(studentName || 'Student')}&volunteerName=${encodeURIComponent(volunteerName)}`;

            // Create auto-launch overlay with countdown
            const overlay = document.createElement('div');
            overlay.id = 'auto-launch-redirect-overlay';
            overlay.style.cssText = `
                position: fixed; inset: 0; background: rgba(0, 0, 0, 0.85);
                z-index: 10000; display: flex; align-items: center; justify-content: center;
                animation: fadeIn 0.3s ease;
            `;
            overlay.innerHTML = `
                <div style="background: white; padding: 40px; border-radius: 24px; max-width: 420px; text-align: center; box-shadow: 0 25px 50px rgba(0,0,0,0.3);">
                    <div style="width: 90px; height: 90px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 24px; animation: pulse 1.5s ease-in-out infinite;">
                        <i class="fas fa-video" style="font-size: 40px; color: white;"></i>
                    </div>
                    <h2 style="font-size: 26px; font-weight: 700; color: #111827; margin-bottom: 12px;">Meeting Time!</h2>
                    <p style="color: #6b7280; margin-bottom: 8px; font-size: 16px;">Your meeting with <strong>${studentName || 'your student'}</strong> is starting now.</p>
                    <p style="color: #9ca3af; margin-bottom: 28px; font-size: 14px;">Connecting you automatically...</p>
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <div style="background: #f3f4f6; border-radius: 12px; padding: 16px;">
                            <div style="font-size: 14px; color: #6b7280; margin-bottom: 4px;">Joining in</div>
                            <div id="auto-launch-countdown" style="font-size: 36px; font-weight: 700; color: #10b981;">5</div>
                        </div>
                        <a href="${callUrl}" id="join-now-btn"
                           style="display: inline-block; background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 16px 32px; border-radius: 12px; font-weight: 600; text-decoration: none; font-size: 16px; transition: transform 0.2s;">
                            <i class="fas fa-video" style="margin-right: 8px;"></i>Join Now
                        </a>
                        <button onclick="document.getElementById('auto-launch-redirect-overlay').remove()"
                                style="color: #6b7280; background: none; border: none; cursor: pointer; font-size: 14px; padding: 8px;">
                            Not now
                        </button>
                    </div>
                </div>
                <style>
                    @keyframes pulse {
                        0%, 100% { transform: scale(1); }
                        50% { transform: scale(1.05); }
                    }
                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                </style>
            `;
            document.body.appendChild(overlay);

            // Play notification sound
            try {
                const audio = new Audio('/sounds/notification.mp3');
                audio.volume = 0.6;
                audio.play().catch(() => {});
            } catch (e) {}

            // Countdown and auto-redirect
            let countdown = 5;
            const countdownEl = document.getElementById('auto-launch-countdown');
            const countdownInterval = setInterval(() => {
                countdown--;
                if (countdownEl) countdownEl.textContent = countdown;

                if (countdown <= 0) {
                    clearInterval(countdownInterval);
                    // Auto-redirect to call
                    window.location.href = callUrl;
                }
            }, 1000);

            // Store interval so it can be cleared if user clicks away
            overlay.dataset.countdownInterval = countdownInterval;
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            countdownIntervals.forEach(id => clearInterval(id));
            countdownIntervals.clear();
        });

        // --- Data Loading ---
        function loadDashboardData() {
            // Check JWT authentication
            if (!window.TalkTimeAuth.isAuthenticated()) {
                console.error('Volunteer not authenticated');
                showNotification('Please log in to access your dashboard.', 'error');
                window.location.href = '/volunteer/login.html';
                return;
            }

            // Fetch volunteer dashboard data from the backend API
            window.TalkTimeAuth.authenticatedRequest('/api/v1/volunteers/dashboard-data', {
                method: 'GET'
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Dashboard data received:', data);
                    
                    // Load upcoming meetings
                    if (upcomingMeetingsContainer && data.meetings.upcoming && data.meetings.upcoming.length > 0) {
                        renderUpcomingMeetings(data.meetings.upcoming);
                        
                        // Update badge counts in the dashboard nav
                        if (window.VolunteerDashboardNav) {
                            window.VolunteerDashboardNav.updateUpcomingBadge(data.meetings.upcoming.length);
                        }
                    } else if (upcomingMeetingsContainer) {
                        upcomingMeetingsContainer.innerHTML = 
                            '<p class="text-gray-500 text-center py-4">No upcoming meetings scheduled. Book a call with a student to get started!</p>';
                    }
                })
                .catch(error => {
                    console.error('Error loading dashboard data:', error);
                    showNotification('Failed to load dashboard data. Please refresh the page.', 'error');
                });
        }
        
        // Function to get initials from a name
        function getInitials(name) {
            if (!name) return '?';
            const parts = name.trim().split(/\s+/);
            if (parts.length >= 2) return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
            return parts[0][0].toUpperCase();
        }

        // Function to render upcoming meetings
        function renderUpcomingMeetings(meetings) {
            const meetingsHtml = meetings.map(meeting => {
                const meetingDate = new Date(meeting.time);
                const dayName = meetingDate.toLocaleDateString(undefined, { weekday: 'short' });
                const day = meetingDate.getDate();
                const month = meetingDate.toLocaleDateString(undefined, { month: 'short' });
                const year = meetingDate.getFullYear();
                const friendlyTime = meetingDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                const photoUrl = meeting.profileImage || meeting.photoUrl || meeting.photo_url || '';
                const studentName = meeting.name || 'Student';
                const initials = getInitials(studentName);
                const hasPhoto = photoUrl && !photoUrl.includes('placeholder') && !photoUrl.includes('default');

                const avatarHtml = hasPhoto
                    ? `<img src="${photoUrl}" alt="${studentName}" class="student-avatar" onerror="this.outerHTML='<div class=\\'student-initials\\'>${initials}</div>'">`
                    : `<div class="student-initials">${initials}</div>`;

                return `
                    <div class="meeting-card">
                        <div class="mc-row">
                            ${avatarHtml}
                            <div class="mc-info">
                                <div class="mc-name">${studentName}</div>
                                <div class="mc-meta">
                                    <span><i class="far fa-clock"></i>${friendlyTime}</span>
                                </div>
                            </div>
                            <div class="dropdown-container" style="position:relative;">
                                <button class="menu-btn meeting-menu-btn" data-meeting-id="${meeting.id}">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <div class="meeting-dropdown hidden absolute right-0 mt-1 w-44 bg-white rounded-lg shadow-lg z-10 py-1 border border-gray-100">
                                    <button class="reschedule-btn block w-full text-left px-3 py-2 text-sm text-gray-700 hover:bg-gray-50" data-meeting-id="${meeting.id}" data-student-id="${meeting.studentId || meeting.studentid}" data-student-name="${studentName}" data-admission-number="${meeting.admissionNumber}"><i class="fas fa-calendar-alt mr-2 text-gray-400"></i>Reschedule</button>
                                    <button class="cancel-btn block w-full text-left px-3 py-2 text-sm text-error hover:bg-gray-50" data-meeting-id="${meeting.id}" data-student-name="${studentName}"><i class="fas fa-times mr-2"></i>Cancel</button>
                                </div>
                            </div>
                        </div>
                        <div class="mc-footer">
                            <div class="mc-date">
                                <i class="far fa-calendar-alt"></i>
                                <span>${dayName}, ${day} ${month} ${year}</span>
                            </div>
                            <div class="mc-actions">
                                <a href="/call/call.html?room=${meeting.roomId || meeting.id}&role=volunteer&studentId=${meeting.studentId || meeting.studentid}&studentName=${encodeURIComponent(studentName)}"
                                   class="join-btn" id="join-btn-${meeting.id}" style="display:none;">
                                    <i class="fas fa-video"></i>Join
                                </a>
                                <div class="waiting-btn" id="waiting-btn-${meeting.id}">
                                    <i class="fas fa-hourglass-half"></i>
                                    <span class="countdown-timer" id="countdown-timer-${meeting.id}" data-start-time="${meeting.time}">--</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            upcomingMeetingsContainer.innerHTML = meetingsHtml;
            
            // Initialize countdown timers for each meeting
            meetings.forEach(meeting => {
                initializeCountdown(meeting.id, meeting.time, meeting.roomId, meeting.name, meeting.studentId || meeting.studentid);
            });
        }

        // --- Event Listeners ---
        document.addEventListener('click', e => {
            // Meeting menu button click handler
            const meetingMenuBtn = e.target.closest('.meeting-menu-btn');
            if (meetingMenuBtn) {
                toggleMeetingMenu(meetingMenuBtn);
            }
            
            // Reschedule meeting button click handler
            const rescheduleBtn = e.target.closest('.reschedule-btn');
            if (rescheduleBtn) {
                const meetingId = parseInt(rescheduleBtn.dataset.meetingId);
                const studentId = parseInt(rescheduleBtn.dataset.studentId);
                const studentName = rescheduleBtn.dataset.studentName;
                const admissionNumber = rescheduleBtn.dataset.admissionNumber;
                rescheduleMeeting(meetingId, studentId, studentName, admissionNumber);
            }
            
            // Cancel meeting button click handler
            const cancelBtn = e.target.closest('.cancel-btn');
            if (cancelBtn) {
                const meetingId = parseInt(cancelBtn.dataset.meetingId);
                const studentName = cancelBtn.dataset.studentName;
                cancelMeeting(meetingId, studentName);
            }
        });
        
        // --- Initialize Authentication ---
        window.TalkTimeAuth = new TalkTimeJWTAuth('volunteer');
        
        // --- Initial Load ---
        loadDashboardData();
    });
    </script>

    <!-- Initialize Navigation -->
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // Initialize navigation with authentication requirement
            await VolunteerNavLoader.init(true);
        });
    </script>

    <!-- Socket.IO for real-time meeting notifications -->
    <script src="/socket.io/socket.io.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Socket.IO for auto-launch events
            const socket = io();

            // Get user info from auth
            const user = window.TalkTimeAuth?.getUser?.() || JSON.parse(localStorage.getItem('volunteer_talktime_user') || '{}');
            const userId = user.id || user.userId;

            if (userId) {
                // Join user-specific rooms for notifications
                socket.emit('join-user-room', {
                    userId: userId,
                    role: 'volunteer',
                    rooms: [`user_${userId}`, `volunteer_${userId}`, `notifications_volunteer_${userId}`]
                });

                console.log('âœ… Volunteer socket connected for meeting notifications');
            }

            // Handle meeting auto-launch (5-minute reminder)
            socket.on('meeting-auto-launch', (data) => {
                console.log('ðŸš€ Meeting auto-launch triggered:', data);
                showAutoLaunchOverlay(data);
            });

            // Handle meeting ready to start
            socket.on('meeting-ready-to-start', (data) => {
                console.log('ðŸ“… Meeting ready to start:', data);
                // Refresh meetings list to update UI
                if (typeof loadDashboardData === 'function') {
                    loadDashboardData();
                }
            });

            // Handle meeting ended/completed - update dashboard when volunteer returns
            socket.on('meeting-force-end', (data) => {
                console.log('ðŸ”š Meeting force-ended:', data);
                handleMeetingEnded(data);
            });

            socket.on('meeting-terminated', (data) => {
                console.log('ðŸ”š Meeting terminated:', data);
                handleMeetingEnded(data);
            });

            socket.on('meeting-completed', (data) => {
                console.log('âœ… Meeting completed:', data);
                handleMeetingEnded(data);
            });

            // Handle real-time meeting updates (scheduled, rescheduled, canceled)
            socket.on('meeting-scheduled', (data) => {
                console.log('ðŸ“… New meeting scheduled:', data);
                showToast('Meeting Scheduled', data.message || 'A new meeting has been scheduled', 'success');
                loadDashboardData();
            });

            socket.on('meeting-rescheduled', (data) => {
                console.log('ðŸ”„ Meeting rescheduled:', data);
                showToast('Meeting Rescheduled', data.message || 'A meeting has been rescheduled', 'warning');
                loadDashboardData();
            });

            socket.on('meeting-canceled', (data) => {
                console.log('âŒ Meeting canceled:', data);
                showToast('Meeting Canceled', data.message || 'A meeting has been canceled', 'error');
                loadDashboardData();
            });

            socket.on('meeting-missed', (data) => {
                console.log('â° Meeting missed:', data);
                showToast('Meeting Missed', data.message || 'A meeting was missed', 'warning');
                loadDashboardData();
            });

            socket.on('meeting-reminder', (data) => {
                console.log('â° Meeting reminder:', data);
                showToast('Meeting Reminder', data.message || `Meeting in ${data.minutesBefore} minutes`, 'info');
                loadDashboardData();
            });

            /**
             * Handle meeting ended - clear timer and refresh list
             */
            function handleMeetingEnded(data) {
                const meetingId = data.meetingId || data.meeting_id;

                // Clear the countdown timer for this meeting
                if (meetingId && countdownIntervals.has(meetingId)) {
                    clearInterval(countdownIntervals.get(meetingId));
                    countdownIntervals.delete(meetingId);
                    console.log(`â±ï¸ Cleared countdown timer for meeting ${meetingId}`);
                }

                // Remove from auto-launched set so it can be displayed differently
                if (meetingId) {
                    autoLaunchedMeetings.delete(meetingId);
                }

                // Update the meeting card UI immediately
                const countdownElement = document.getElementById(`countdown-timer-${meetingId}`);
                if (countdownElement) {
                    countdownElement.textContent = 'Meeting completed';
                    countdownElement.classList.remove('text-success', 'text-orange-500', 'text-red-500', 'animate-pulse');
                    countdownElement.classList.add('text-green-600', 'font-semibold');
                }

                // Hide join buttons
                const joinBtn = document.getElementById(`join-btn-${meetingId}`);
                const waitingBtn = document.getElementById(`waiting-btn-${meetingId}`);
                if (joinBtn) joinBtn.style.display = 'none';
                if (waitingBtn) {
                    waitingBtn.style.display = 'inline-block';
                    const waitingText = waitingBtn.querySelector('span');
                    if (waitingText) waitingText.textContent = 'Completed';
                }

                // Refresh meetings list to get updated status from server
                setTimeout(() => {
                    if (typeof loadDashboardData === 'function') {
                        loadDashboardData();
                    }
                }, 1000);
            }

            /**
             * Show auto-launch overlay when meeting is about to start
             */
            function showAutoLaunchOverlay(data) {
                // Remove any existing overlay
                const existingOverlay = document.getElementById('meeting-auto-launch-overlay');
                if (existingOverlay) existingOverlay.remove();

                const overlay = document.createElement('div');
                overlay.id = 'meeting-auto-launch-overlay';
                overlay.style.cssText = `
                    position: fixed; inset: 0; background: rgba(0,0,0,0.7);
                    z-index: 10000; display: flex; align-items: center; justify-content: center;
                    animation: fadeIn 0.3s ease;
                `;

                overlay.innerHTML = `
                    <div style="background: white; padding: 32px; border-radius: 20px; max-width: 400px; text-align: center; box-shadow: 0 25px 50px rgba(0,0,0,0.25);">
                        <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
                            <i class="fas fa-video" style="font-size: 32px; color: white;"></i>
                        </div>
                        <h2 style="font-size: 24px; font-weight: 700; color: #111827; margin-bottom: 8px;">Meeting Starting!</h2>
                        <p style="color: #6b7280; margin-bottom: 24px;">Your meeting with ${data.student?.name || 'student'} is about to begin.</p>
                        <a href="${data.actionUrl || data.meetingUrl}"
                           style="display: inline-block; background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 14px 32px; border-radius: 12px; font-weight: 600; text-decoration: none; transition: transform 0.2s;"
                           onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                            <i class="fas fa-video mr-2"></i>Join Now
                        </a>
                        <button onclick="this.closest('#meeting-auto-launch-overlay').remove()"
                                style="display: block; margin: 16px auto 0; color: #6b7280; background: none; border: none; cursor: pointer; font-size: 14px;">
                            Dismiss
                        </button>
                    </div>
                `;

                document.body.appendChild(overlay);

                // Play notification sound if available
                try {
                    const audio = new Audio('/sounds/notification.mp3');
                    audio.volume = 0.5;
                    audio.play().catch(() => {});
                } catch (e) {}

                // Auto-dismiss after 60 seconds
                setTimeout(() => {
                    if (document.getElementById('meeting-auto-launch-overlay')) {
                        overlay.remove();
                    }
                }, 60000);
            }
        });
    </script>
</body>
</html>
