<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>TalkTime - Schedule Meeting | Volunteer Dashboard</title>
    <!-- Early auth redirect - prevents FOUC on protected pages -->
    <script>
        if (!localStorage.getItem('volunteer_talktime_access_token')) {
            window.location.replace('/volunteer/login');
        }
    </script>
    <!-- Brand Theme System -->
    <link rel="stylesheet" href="/shared/css/brand-theme.css">
    <link rel="icon" type="image/x-icon" href="/talktime.ico">
    <meta name="description" content="Schedule or reschedule an English practice session with a Maasai student. Choose a date, time, and timezone for your TalkTime conversation.">
    <link rel="canonical" id="canonical-link" href="">
    <meta name="robots" content="index, follow">

    <!-- CSS (all sync to prevent layout shift) -->
    <link rel="stylesheet" href="/shared/css/tailwind.min.css">
    <link rel="stylesheet" href="/shared/fonts/google/fonts.css">
    <link rel="stylesheet" href="/shared/fonts/fontawesome/all.min.css">
    <link rel="stylesheet" href="/volunteer/css/main.css">
    <link rel="stylesheet" href="/volunteer/css/responsive-framework.css">
    <link rel="stylesheet" href="/volunteer/css/responsive-forms.css">
    <link rel="stylesheet" href="/volunteer/css/enhanced-mobile-nav.css">
    <link rel="stylesheet" href="/volunteer/css/volunteer-dashboard.css">

    <!-- Deferred Scripts (non-render-blocking) -->
    <script defer src="/shared/js/brand-config.js"></script>
    <script defer src="/volunteer/partials/nav-loader.js"></script>
    <script defer src="/volunteer/js/dashboard-nav.js"></script>
    <script defer src="/volunteer/js/modal-utils.js"></script>
    <script defer src="/shared/js/jwt-auth-utils.js"></script>
    <script defer src="/shared/js/newsletter-widget.js"></script>
    <script defer src="/shared/js/realtime-notifications.js"></script>

    <style>
        /* Page-specific styles - Calendar and time slot styling */
        /* Brand-consistent styling with clean, minimal design */

        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            background: #f9fafb;
            padding: 12px;
            border-radius: 12px;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease;
            min-height: 40px;
            font-size: 13px;
            color: #374151;
            background: white;
        }

        .calendar-day:hover:not(.day-disabled):not(.day-selected) {
            background-color: #f3f4f6;
            transform: scale(1.05);
        }

        .day-disabled {
            color: #d1d5db;
            cursor: not-allowed;
            background: transparent;
        }

        .day-selected {
            background: var(--brand-primary) !important;
            color: white !important;
            box-shadow: 0 4px 12px rgba(209, 1, 0, 0.3);
        }

        .day-today {
            border: 2px solid var(--brand-primary);
            background: rgba(209, 1, 0, 0.05);
        }

        /* Time slots - full width layout */
        .time-input {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .time-slot {
            padding: 12px 8px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.15s ease;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            min-height: 44px;
            font-size: 13px;
            font-weight: 600;
            color: #374151;
        }

        .time-slot:hover:not(.time-disabled):not(.time-selected) {
            background: #f3f4f6;
            border-color: var(--brand-primary);
            transform: scale(1.02);
        }

        .time-slot.time-selected {
            background: var(--brand-primary);
            color: white;
            border-color: var(--brand-primary);
            box-shadow: 0 4px 12px rgba(209, 1, 0, 0.3);
        }

        .time-disabled {
            color: #d1d5db;
            cursor: not-allowed;
            background: #f9fafb;
            border-color: transparent;
        }

        /* 4 columns at 400px+ for time slots */
        @media (min-width: 400px) {
            .time-input {
                grid-template-columns: repeat(4, 1fr);
            }

            .calendar {
                gap: 6px;
                padding: 16px;
            }

            .calendar-day {
                min-height: 44px;
                font-size: 14px;
                border-radius: 12px;
            }

            .time-slot {
                padding: 14px 10px;
                font-size: 14px;
            }
        }

        /* Calendar day header styling */
        .calendar-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin-bottom: 8px;
        }

        .calendar-header-day {
            text-align: center;
            font-size: 11px;
            font-weight: 600;
            color: #9ca3af;
            padding: 4px 0;
            text-transform: uppercase;
        }

        @media (min-width: 400px) {
            .calendar-header {
                gap: 6px;
            }

            .calendar-header-day {
                font-size: 11px;
            }
        }
    </style>
</head>
<body class="dashboard-page" style="opacity:0">
    <!-- Background Blobs - Hidden on mobile for performance -->
    <div class="blob bg-brand-primary w-96 h-96 top-0 left-0 -translate-x-1/2 -translate-y-1/2"></div>
    <div class="blob bg-brand-secondary w-96 h-96 bottom-0 right-0 translate-x-1/2 translate-y-1/2"></div>

    <!-- Dashboard Navigation Container -->
    <div id="dashboard-nav-container"></div>

    <!-- Main Content Area -->
    <main class="content-area">
        <!-- No Student Selected State - shown when accessed without URL params -->
        <div id="no-student-state" class="hidden w-full">
            <div class="bg-white rounded-2xl p-6 sm:p-8 text-center shadow-lg border border-gray-100">
                <div class="w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-5" style="background: linear-gradient(135deg, rgba(209,1,0,0.1), rgba(56,103,255,0.1));">
                    <i class="fas fa-calendar-plus text-2xl" style="color: var(--brand-primary);"></i>
                </div>
                <h2 class="text-xl sm:text-2xl font-bold text-gray-900 mb-2">Schedule a Meeting</h2>
                <p class="text-gray-600 mb-6 max-w-sm mx-auto text-sm sm:text-base">
                    Select a student from the Students tab to schedule a conversation session.
                </p>
                <a href="/volunteer/dashboard/students" class="inline-flex items-center justify-center gap-2 text-white px-6 py-3 rounded-xl font-semibold transition-all hover:shadow-lg" style="background: var(--brand-primary);">
                    <i class="fas fa-users"></i>
                    Browse Students
                </a>
                <div class="mt-8 pt-6 border-t border-gray-100">
                    <div class="grid gap-4 text-left max-w-xs mx-auto">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-xl flex items-center justify-center flex-shrink-0" style="background: rgba(17,108,0,0.1);">
                                <i class="fas fa-clock text-sm" style="color: #116C00;"></i>
                            </div>
                            <div>
                                <p class="text-sm font-semibold text-gray-800">40-minute sessions</p>
                                <p class="text-xs text-gray-500">Standard call duration</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-xl flex items-center justify-center flex-shrink-0" style="background: rgba(56,103,255,0.1);">
                                <i class="fas fa-users text-sm" style="color: var(--brand-secondary);"></i>
                            </div>
                            <div>
                                <p class="text-sm font-semibold text-gray-800">3 meetings max</p>
                                <p class="text-xs text-gray-500">Per volunteer-student pair</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Back Navigation - hidden when no student selected -->
        <div class="mb-4 hidden" id="back-link-container">
            <a href="/volunteer/dashboard/students" class="inline-flex items-center gap-2 text-gray-600 hover:text-gray-900 font-medium text-sm transition-colors">
                <i class="fas fa-arrow-left"></i>
                Back to Student Profile
            </a>
        </div>

        <!-- Schedule Page - hidden when no student selected -->
        <div id="page-scheduler" class="w-full hidden">
            <div class="bg-white rounded-2xl p-5 sm:p-6 shadow-lg border border-gray-100">
                <!-- Header with student info -->
                <div class="flex gap-3 mb-3" style="align-items:center;">
                    <img id="student-image" src="/volunteer/images/default-profile.svg" alt="Student" class="w-12 h-12 rounded-full object-cover flex-shrink-0" style="border: 2px solid var(--brand-primary);">
                    <div class="min-w-0 flex-1">
                        <span id="schedule-title" class="block text-sm font-bold text-gray-900" style="line-height:1.2;">Schedule Meeting with</span>
                        <span id="student-name" class="block font-semibold text-sm truncate" style="color:var(--brand-primary);line-height:1.2;margin-top:1px;"></span>
                        <p id="student-details" class="text-xs text-gray-400" style="margin-top:1px;line-height:1.2;"></p>
                    </div>
                </div>
                <hr style="border:none;border-top:1px solid #f3f4f6;margin-bottom:10px;">

                <!-- Meeting limit (populated by JS) -->
                <div id="meeting-limit-status" class="mb-4">
                    <p class="text-xs text-gray-400"><i class="fas fa-spinner fa-spin mr-1"></i>Checking availability...</p>
                </div>

                <!-- Timezone Display -->
                <div class="flex items-center justify-between mb-5">
                    <div class="flex-1 min-w-0 mr-3">
                        <span class="text-xs text-gray-400 uppercase tracking-wide font-semibold">Timezone</span>
                        <p id="volunteer-timezone-display" class="text-sm font-medium text-gray-800 truncate">Loading...</p>
                    </div>
                    <div class="flex gap-2 flex-shrink-0">
                        <button id="detect-timezone-btn" onclick="autoDetectTimezone()" class="inline-flex items-center text-xs font-medium px-3 py-1.5 rounded-lg transition-colors" style="background:#D10100;color:#fff;">
                            <i class="fas fa-location-dot mr-1"></i>Auto-detect
                        </button>
                        <a href="/volunteer/settings" class="inline-flex items-center text-xs font-medium px-3 py-1.5 rounded-lg transition-colors" style="background:#374151;color:#fff;">
                            <i class="fas fa-cog mr-1"></i>Settings
                        </a>
                    </div>
                </div>

                <!-- Calendar -->
                <div class="mb-6">
                    <hr style="border:none;border-top:1px solid #f3f4f6;margin-bottom:12px;">
                    <div class="flex justify-between items-center mb-4">
                        <button id="prev-month" class="w-9 h-9 rounded-lg flex items-center justify-center text-gray-500 hover:bg-gray-100 hover:text-gray-900 transition-colors"><i class="fas fa-chevron-left text-sm"></i></button>
                        <h4 id="calendar-month" class="font-bold text-gray-900">July 2025</h4>
                        <button id="next-month" class="w-9 h-9 rounded-lg flex items-center justify-center text-gray-500 hover:bg-gray-100 hover:text-gray-900 transition-colors"><i class="fas fa-chevron-right text-sm"></i></button>
                    </div>
                        <div class="calendar mb-2">
                            <div class="text-center text-gray-500 text-xs font-medium">Sun</div>
                            <div class="text-center text-gray-500 text-xs font-medium">Mon</div>
                            <div class="text-center text-gray-500 text-xs font-medium">Tue</div>
                            <div class="text-center text-gray-500 text-xs font-medium">Wed</div>
                            <div class="text-center text-gray-500 text-xs font-medium">Thu</div>
                            <div class="text-center text-gray-500 text-xs font-medium">Fri</div>
                            <div class="text-center text-gray-500 text-xs font-medium">Sat</div>
                        </div>
                        <div id="calendar-days" class="calendar">
                            <!-- Calendar days will be inserted here -->
                        </div>
                    </div>
                    
                <!-- Time Selection -->
                <div id="time-selection" class="mb-6 hidden">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-1 mb-3">
                        <label class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Select Time</label>
                        <span id="selected-date-display" class="text-xs font-medium" style="color: var(--brand-primary);">(July 16, 2025)</span>
                    </div>
                    <div id="time-slots" class="time-input">
                        <!-- Time slots will be inserted here -->
                    </div>
                </div>
                    
                <!-- Confirm Button -->
                <div id="confirm-container" class="hidden pt-4 border-t border-gray-100">
                    <button id="confirm-btn" class="w-full text-white py-3.5 px-6 rounded-xl font-semibold transition-all hover:shadow-lg text-base" style="background: var(--brand-primary);">
                        <i class="fas fa-check mr-2"></i>Confirm Meeting
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 hidden p-4">
        <div class="bg-white rounded-2xl p-6 max-w-sm w-full shadow-2xl">
            <div class="text-center mb-5">
                <div class="w-14 h-14 rounded-full flex items-center justify-center mx-auto mb-4" style="background: rgba(17,108,0,0.1);">
                    <i class="fas fa-calendar-check text-xl" style="color: #116C00;"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-900 mb-1">Confirm Meeting</h3>
                <p class="text-sm text-gray-600">with <span id="modal-student-name" class="font-semibold" style="color: var(--brand-primary);">Student Name</span></p>
            </div>
            <div class="p-4 bg-gray-50 rounded-xl mb-5 space-y-3">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-lg flex items-center justify-center flex-shrink-0" style="background: rgba(209,1,0,0.1);">
                        <i class="far fa-calendar text-sm" style="color: var(--brand-primary);"></i>
                    </div>
                    <div>
                        <p class="text-xs text-gray-500">Date</p>
                        <p id="modal-date" class="text-sm font-semibold text-gray-900">July 16, 2025</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-lg flex items-center justify-center flex-shrink-0" style="background: rgba(56,103,255,0.1);">
                        <i class="far fa-clock text-sm" style="color: var(--brand-secondary);"></i>
                    </div>
                    <div>
                        <p class="text-xs text-gray-500">Your Time</p>
                        <p id="modal-time" class="text-sm font-semibold text-gray-900">3:00 PM</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-lg flex items-center justify-center flex-shrink-0" style="background: rgba(17,108,0,0.1);">
                        <i class="fas fa-globe-africa text-sm" style="color: #116C00;"></i>
                    </div>
                    <div>
                        <p class="text-xs text-gray-500">Kenya Time (EAT)</p>
                        <p id="modal-time-eat" class="text-sm font-semibold text-gray-900">6:00 PM</p>
                    </div>
                </div>
            </div>
            <div class="flex gap-3">
                <button id="modal-cancel" class="flex-1 px-4 py-3 border border-gray-200 rounded-xl hover:bg-gray-50 transition-colors text-sm font-semibold text-gray-700">
                    Cancel
                </button>
                <button id="modal-confirm" class="flex-1 px-4 py-3 text-white rounded-xl transition-all hover:shadow-lg text-sm font-semibold" style="background: var(--brand-primary);">
                    Confirm
                </button>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="notification" class="hidden"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        document.body.classList.add('page-ready');
        // --- DOM Elements ---
        const backLinkContainer = document.getElementById('back-link-container');
        const scheduleTitle = document.getElementById('schedule-title');
        const studentImage = document.getElementById('student-image');
        const studentName = document.getElementById('student-name');
        const studentDetails = document.getElementById('student-details');
        const volunteerTimezoneDisplay = document.getElementById('volunteer-timezone-display');
        const calendarMonth = document.getElementById('calendar-month');
        const calendarDays = document.getElementById('calendar-days');
        const prevMonthBtn = document.getElementById('prev-month');
        const nextMonthBtn = document.getElementById('next-month');
        const timeSelection = document.getElementById('time-selection');
        const selectedDateDisplay = document.getElementById('selected-date-display');
        const timeSlots = document.getElementById('time-slots');
        const confirmContainer = document.getElementById('confirm-container');
        const confirmBtn = document.getElementById('confirm-btn');
        const confirmModal = document.getElementById('confirm-modal');
        const modalStudentName = document.getElementById('modal-student-name');
        const modalDate = document.getElementById('modal-date');
        const modalTime = document.getElementById('modal-time');
        const modalCancel = document.getElementById('modal-cancel');
        const modalConfirm = document.getElementById('modal-confirm');
        const notificationEl = document.getElementById('notification');
        
        // --- State Variables ---
        let currentDate = new Date();
        let currentMonth = currentDate.getMonth();
        let currentYear = currentDate.getFullYear();
        let selectedDate = null;
        let selectedTimeSlot = null;
        let studentData = null;
        let meetingId = null; // For rescheduling
        let isRescheduling = false;
        let volunteerTimezone = null; // Volunteer's saved timezone
        
        // --- Utility Functions ---
        function showNotification(message, type = 'success') {
            notificationEl.textContent = message;
            // Use explicit colors for visibility
            const bgColor = type === 'success' ? '#116C00' : '#D10100';
            const textColor = '#FFFFFF';
            notificationEl.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                padding: 16px 24px;
                border-radius: 12px;
                background-color: ${bgColor};
                color: ${textColor};
                font-weight: 500;
                box-shadow: 0 10px 25px rgba(0,0,0,0.2);
                z-index: 9999;
                max-width: 400px;
                word-wrap: break-word;
            `;
            notificationEl.className = '';
            notificationEl.classList.remove('hidden');
            
            setTimeout(() => {
                notificationEl.classList.add('hidden');
            }, 5000);
        }
        
        function formatDate(date) {
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            return date.toLocaleDateString(undefined, options);
        }
        
        function formatTime(hours, minutes) {
            const period = hours >= 12 ? 'PM' : 'AM';
            const formattedHours = hours % 12 || 12;
            return `${formattedHours}:${minutes.toString().padStart(2, '0')} ${period}`;
        }
        
        // Function to generate time slots for a specific date based on EAT constraints
        function generateTimeSlotsForDate(date, timezone) {
            const slots = [];
            
            // EAT constraints: 9:00 AM - 5:00 PM with 15-minute intervals
            const eatStartHour = 9; // 9:00 AM EAT
            const eatEndHour = 17;  // 5:00 PM EAT
            
            // Create a date object for the selected date at midnight
            const selectedDateObj = new Date(date);
            selectedDateObj.setHours(0, 0, 0, 0);
            
            // Check if the selected date is today
            const today = new Date();
            const isToday = selectedDateObj.toDateString() === today.toDateString();
            
            // Get current time in volunteer's timezone for filtering past slots
            const currentVolunteerTime = new Date();
            
            // Generate all possible time slots in 15-minute increments within EAT constraints
            for (let hour = eatStartHour; hour < eatEndHour; hour++) {
                for (let minute = 0; minute < 60; minute += 15) {
                    // Create a date object for this time slot in EAT
                    const eatDate = new Date(selectedDateObj);
                    eatDate.setHours(hour, minute, 0, 0);
                    
                    // Convert EAT time to the volunteer's timezone for display
                    const volunteerDate = convertEatToVolunteerTime(eatDate, timezone);
                    
                    // Skip past time slots if this is today
                    if (isToday && volunteerDate <= currentVolunteerTime) {
                        continue;
                    }
                    
                    // Get the hours and minutes in the volunteer's timezone
                    const volunteerHour = volunteerDate.getHours();
                    const volunteerMinute = volunteerDate.getMinutes();
                    
                    // Format the time for display
                    const displayTime = formatTime(volunteerHour, volunteerMinute);
                    
                    // Add the time slot
                    slots.push({
                        display: displayTime,
                        hour: volunteerHour,
                        minute: volunteerMinute,
                        eatHour: hour,
                        eatMinute: minute,
                        date: volunteerDate
                    });
                }
            }
            
            return slots;
        }
        
        // Function to convert EAT time to volunteer's timezone
        function convertEatToVolunteerTime(eatDate, volunteerTimezone) {
            // EAT is UTC+3, so we need to properly handle timezone conversion
            // First, treat the eatDate as if it's in EAT (UTC+3)
            const eatYear = eatDate.getFullYear();
            const eatMonth = eatDate.getMonth();
            const eatDay = eatDate.getDate();
            const eatHour = eatDate.getHours();
            const eatMinute = eatDate.getMinutes();
            
            // Create a date string in EAT timezone format
            const eatTimeString = `${eatYear}-${String(eatMonth + 1).padStart(2, '0')}-${String(eatDay).padStart(2, '0')}T${String(eatHour).padStart(2, '0')}:${String(eatMinute).padStart(2, '0')}:00+03:00`;
            
            // Parse this as a proper timezone-aware date
            const eatDateWithTimezone = new Date(eatTimeString);
            
            // Convert to volunteer's local timezone (browser will handle this automatically)
            return eatDateWithTimezone;
        }
        
        // Function to convert volunteer time to EAT
        function convertVolunteerTimeToEat(volunteerDate, volunteerTimezone) {
            // The volunteerDate is in the volunteer's local timezone
            // We need to convert it to EAT (UTC+3)
            
            // Get the UTC time from the volunteer's local time
            const utcTime = volunteerDate.getTime() + (volunteerDate.getTimezoneOffset() * 60000);
            
            // EAT is UTC+3 (3 hours ahead of UTC)
            const eatTime = utcTime + (3 * 60 * 60 * 1000);
            
            // Create the EAT date
            const eatDate = new Date(eatTime);
            
            return eatDate;
        }
        
        // Function to get URL parameters
        function getUrlParams() {
            // Parse query parameters from the new URL structure
            // Format: /volunteer/dashboard/schedule.html?id=1&admission=ADM0001&name=Test%20Student&meeting=123
            const searchParams = new URLSearchParams(window.location.search);
            
            const id = searchParams.get('id');
            const admission = searchParams.get('admission');
            const name = searchParams.get('name');
            const meetingParam = searchParams.get('meeting'); // For reschedule requests
            
            // Validate that we have the required parameters
            if (id && admission && name) {
                return {
                    studentId: id,
                    studentAdmission: admission,
                    studentName: decodeURIComponent(name),
                    action: meetingParam ? 'update' : 'new', // If meeting ID is present, it's a reschedule
                    meetingId: meetingParam
                };
            }
            
            // If query parameters are missing, return null (user accessed page directly from navigation)
            return null;
        }
        
        // --- Calendar Functions ---
        function renderCalendar() {
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDay = firstDay.getDay(); // 0 = Sunday, 1 = Monday, etc.
            
            // Update month display
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            calendarMonth.textContent = `${monthNames[currentMonth]} ${currentYear}`;
            
            // Clear calendar
            calendarDays.innerHTML = '';
            
            // Add empty cells for days before the first day of the month
            for (let i = 0; i < startingDay; i++) {
                const emptyDay = document.createElement('div');
                calendarDays.appendChild(emptyDay);
            }
            
            // Add days of the month
            const today = new Date();
            for (let day = 1; day <= daysInMonth; day++) {
                const dayEl = document.createElement('div');
                dayEl.textContent = day;
                dayEl.classList.add('calendar-day');
                
                const dateToCheck = new Date(currentYear, currentMonth, day);
                
                // Calculate 3-month limit from today
                const threeMonthsFromToday = new Date(today);
                threeMonthsFromToday.setMonth(today.getMonth() + 3);
                
                // Check if this day is in the past or beyond 3-month window
                if (dateToCheck < new Date(today.getFullYear(), today.getMonth(), today.getDate()) || 
                    dateToCheck > threeMonthsFromToday) {
                    dayEl.classList.add('day-disabled');
                } else {
                    // Check if this is the selected date
                    if (selectedDate && day === selectedDate.getDate() && currentMonth === selectedDate.getMonth() && currentYear === selectedDate.getFullYear()) {
                        dayEl.classList.add('day-selected');
                    }
                    
                    // Check if this is today
                    if (day === today.getDate() && currentMonth === today.getMonth() && currentYear === today.getFullYear()) {
                        dayEl.classList.add('day-today');
                    }
                    
                    // Add click event
                    dayEl.addEventListener('click', () => {
                        // Remove selected class from all days
                        document.querySelectorAll('.day-selected').forEach(el => el.classList.remove('day-selected'));
                        
                        // Add selected class to this day
                        dayEl.classList.add('day-selected');
                        
                        // Update selected date
                        selectedDate = new Date(currentYear, currentMonth, day);
                        
                        // Show time selection
                        showTimeSelection();
                    });
                }
                
                calendarDays.appendChild(dayEl);
            }
        }
        
        function showTimeSelection() {
            // Format the selected date for display
            selectedDateDisplay.textContent = `(${formatDate(selectedDate)})`;
            
            // Show time selection section
            timeSelection.classList.remove('hidden');
            
            // Generate time slots
            generateTimeSlots();
            
            // Scroll to time selection
            timeSelection.scrollIntoView({ behavior: 'smooth' });
        }
        
        function generateTimeSlots() {
            // Clear existing time slots
            timeSlots.innerHTML = '';
            
            // Use volunteer's saved timezone
            const timezone = volunteerTimezone;
            
            // Generate time slots based on EAT constraints (9:00 AM - 5:00 PM EAT)
            // with 15-minute intervals (00, 15, 30, 45)
            const slots = generateTimeSlotsForDate(selectedDate, timezone);
            
            // Show message if no slots available (all passed for today)
            if (slots.length === 0) {
                const today = new Date();
                const isToday = selectedDate.toDateString() === today.toDateString();
                const msg = document.createElement('div');
                msg.className = 'text-center py-6 col-span-full';
                msg.innerHTML = isToday
                    ? `<p class="text-xs text-gray-400"><i class="fas fa-clock mr-1"></i>All available time slots for today have passed.</p>
                       <p class="text-xs text-gray-300 mt-1">Students are available 9:00 AM – 5:00 PM EAT. Please select another date.</p>`
                    : `<p class="text-xs text-gray-400"><i class="fas fa-clock mr-1"></i>No available time slots for this date.</p>`;
                timeSlots.appendChild(msg);
                confirmContainer.classList.add('hidden');
                return;
            }

            // Add time slots to the UI
            slots.forEach(slot => {
                const timeSlot = document.createElement('div');
                timeSlot.textContent = slot.display;
                timeSlot.classList.add('time-slot');
                timeSlot.dataset.eatHour = slot.eatHour;
                timeSlot.dataset.eatMinute = slot.eatMinute;
                
                // Add click event
                timeSlot.addEventListener('click', () => {
                    // Remove selected class from all time slots
                    document.querySelectorAll('.time-selected').forEach(el => el.classList.remove('time-selected'));
                    
                    // Add selected class to this time slot
                    timeSlot.classList.add('time-selected');
                    
                    // Update selected time slot with both volunteer time and EAT time
                    selectedTimeSlot = {
                        hour: slot.hour,
                        minute: slot.minute,
                        eatHour: slot.eatHour,
                        eatMinute: slot.eatMinute
                    };
                    
                    // Show confirm button
                    confirmContainer.classList.remove('hidden');
                });
                
                timeSlots.appendChild(timeSlot);
            });
        }
        
        // --- Data Loading ---
        function loadStudentData() {
            const params = getUrlParams();

            if (!params) {
                // No student selected - show the "select student" state
                const noStudentState = document.getElementById('no-student-state');
                const pageScheduler = document.getElementById('page-scheduler');
                const backLinkContainer = document.getElementById('back-link-container');

                if (noStudentState) noStudentState.classList.remove('hidden');
                if (pageScheduler) pageScheduler.classList.add('hidden');
                if (backLinkContainer) backLinkContainer.classList.add('hidden');
                return;
            }

            // Student selected - show the scheduler
            const noStudentState = document.getElementById('no-student-state');
            const pageScheduler = document.getElementById('page-scheduler');
            const backLinkContainer = document.getElementById('back-link-container');

            if (noStudentState) noStudentState.classList.add('hidden');
            if (pageScheduler) pageScheduler.classList.remove('hidden');
            if (backLinkContainer) backLinkContainer.classList.remove('hidden');
            
            // Check if this is a reschedule
            isRescheduling = params.action === 'update';
            if (isRescheduling) {
                scheduleTitle.textContent = 'Reschedule Meeting with';
                meetingId = params.meetingId;
                
                // Update page title for reschedule
                document.title = `TalkTime - Reschedule Meeting | Volunteer Dashboard`;
            } else {
                // Update page title for new schedule
                document.title = `TalkTime - Schedule Meeting | Volunteer Dashboard`;
            }
            
            // Update canonical link
            const canonicalLink = document.getElementById('canonical-link');
            canonicalLink.href = window.location.href;
            
            // Update back link
            backLinkContainer.innerHTML = `
                <a href="/volunteer/dashboard/student-detail.html?id=${params.studentId}&admission=${params.studentAdmission}&name=${encodeURIComponent(params.studentName)}" class="text-brand-primary hover:text-brand-primary flex items-center">
                    <i class="fas fa-arrow-left mr-2"></i>
                    Back to Student Profile
                </a>
            `;
            
            // Fetch student data using JWT authentication
            TalkTimeAuth.authenticatedRequest(`/api/v1/volunteers/students/${params.studentId}/profile`, {
                method: 'GET'
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    studentData = data.student; // API returns student data wrapped in 'student' property
                    
                    // Store the numeric student ID for later use
                    console.log('Received student data with numeric ID:', studentData.id);
                    
                    // Update student info - using correct property names from API response
                    studentName.textContent = studentData.full_name || studentData.name || params.studentName;
                    // Format age/gender: "14 years · Girl"
                    const ageParts = [];
                    if (studentData.age) ageParts.push(studentData.age + ' years');
                    if (studentData.gender) {
                        const g = studentData.gender.toLowerCase();
                        ageParts.push(g === 'f' || g === 'female' ? 'Girl' : g === 'm' || g === 'male' ? 'Boy' : studentData.gender);
                    }
                    studentDetails.textContent = ageParts.join(' \u00B7 ');
                    
                    // Update profile image with fallback
                    const profileImageSrc = studentData.profileImage || '/images/placeholder-student.jpg';
                    studentImage.src = profileImageSrc;
                    studentImage.alt = studentData.full_name || 'Student';
                    
                    // Add error handler for broken images
                    studentImage.onerror = function() {
                        this.src = '/images/placeholder-student.jpg';
                    };
                    
                    // Update modal student name
                    modalStudentName.textContent = studentData.full_name || studentData.name || params.studentName;
                    
                    // If rescheduling, fetch meeting details
                    if (isRescheduling && meetingId) {
                        fetchMeetingDetails(meetingId);
                    }
                    
                    // Check meeting limit status with this student
                    checkMeetingLimitStatus(params.studentId);
                    
                    // Load volunteer's saved timezone
                    loadVolunteerTimezone();
                })
                .catch(error => {
                    console.error('Error loading student data:', error);
                    showNotification('Failed to load student data. Please try again.', 'error');
                });
        }
        
        function fetchMeetingDetails(meetingId) {
            TalkTimeAuth.authenticatedRequest(`/api/v1/meetings/${meetingId}`, {
                method: 'GET'
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // Pre-select the date and time from the meeting
                    const meetingDate = new Date(data.meeting.scheduled_time);
                    
                    // Update calendar to show the month of the meeting
                    currentMonth = meetingDate.getMonth();
                    currentYear = meetingDate.getFullYear();
                    
                    // Render calendar with the meeting month
                    renderCalendar();
                    
                    // Select the date
                    selectedDate = new Date(meetingDate);
                    
                    // Show time selection
                    showTimeSelection();
                    
                    // Pre-select the time slot
                    const hour = meetingDate.getHours();
                    const minute = meetingDate.getMinutes();
                    selectedTimeSlot = { hour, minute };
                    
                    // Find and select the time slot
                    setTimeout(() => {
                        const timeSlotElements = document.querySelectorAll('.time-slot');
                        timeSlotElements.forEach(slot => {
                            if (slot.textContent === formatTime(hour, minute)) {
                                slot.classList.add('time-selected');
                                confirmContainer.classList.remove('hidden');
                            }
                        });
                    }, 100);
                })
                .catch(error => {
                    console.error('Error loading meeting details:', error);
                    showNotification('Failed to load meeting details. Please try again.', 'error');
                });
        }
        
        function checkMeetingLimitStatus(studentId) {
            // Check meeting count with this student and display status
            TalkTimeAuth.authenticatedRequest(`/api/v1/meetings/student/${studentId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    const meetingStats = data.meetingStats || {};
                    const meetingCount = meetingStats.volunteerStudentMeetingCount || 0;
                    const limit = meetingStats.meetingLimit || 3;
                    const canScheduleMore = meetingStats.canScheduleMore !== false;
                    
                    // Update meeting limit placeholder with simple text
                    const statusEl = document.getElementById('meeting-limit-status');
                    const sFirstName = (studentName.textContent || '').trim().split(' ')[0] || 'this student';
                    if (statusEl) {
                        statusEl.innerHTML = `
                            <p class="text-xs font-medium ${canScheduleMore ? 'text-gray-500' : 'text-red-600'}">
                                <i class="fas ${canScheduleMore ? 'fa-check-circle text-green-500' : 'fa-exclamation-triangle text-red-500'} mr-1"></i>
                                Meeting Limit: ${meetingCount}/${limit} meetings with ${sFirstName}
                            </p>
                            <p class="text-xs ${canScheduleMore ? 'text-gray-400' : 'text-red-400'}" style="margin-top:2px;padding-left:18px;">
                                ${canScheduleMore
                                    ? `You can schedule ${limit - meetingCount} more meeting${limit - meetingCount === 1 ? '' : 's'}.`
                                    : 'Limit reached. Ensures equal opportunities for all students.'}
                            </p>
                        `;
                    }
                    
                    // If limit reached, disable scheduling interface
                    if (!canScheduleMore && !isRescheduling) {
                        disableSchedulingInterface();
                    }
                })
                .catch(error => {
                    console.error('Error checking meeting limit:', error);
                    // Don't block scheduling on error, just log it
                });
        }
        
        function disableSchedulingInterface() {
            // Disable calendar and time selection
            const calendarDays = document.getElementById('calendar-days');
            const timeSelection = document.getElementById('time-selection');
            const confirmContainer = document.getElementById('confirm-container');
            
            if (calendarDays) {
                calendarDays.style.pointerEvents = 'none';
                calendarDays.style.opacity = '0.5';
            }
            if (timeSelection) {
                timeSelection.style.display = 'none';
            }
            if (confirmContainer) {
                confirmContainer.style.display = 'none';
            }
            
            // Show disabled message
            const scheduleContainer = document.querySelector('.glass-bg');
            if (scheduleContainer) {
                const disabledMsg = document.createElement('div');
                disabledMsg.className = 'p-4 bg-gray-100 rounded-lg text-center mt-4';
                disabledMsg.innerHTML = `
                    <p class="text-gray-700">
                        <i class="fas fa-ban mr-2"></i>
                        Scheduling is disabled because you've reached the 3-meeting limit with this student.
                    </p>
                    <p class="text-sm text-gray-600 mt-2">
                        This policy ensures all students get equal opportunities to practice with different volunteers.
                    </p>
                `;
                scheduleContainer.appendChild(disabledMsg);
            }
        }
        
        function loadVolunteerTimezone() {
            // Fetch volunteer's profile to get their saved timezone
            TalkTimeAuth.authenticatedRequest('/api/v1/volunteers/profile', {
                method: 'GET'
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // Extract timezone from volunteer profile - handle both data structures
                    volunteerTimezone = data.timezone || data.volunteer?.timezone || Intl.DateTimeFormat().resolvedOptions().timeZone;
                    
                    // Display timezone with user-friendly format
                    const displayTimezone = formatTimezoneDisplay(volunteerTimezone);
                    volunteerTimezoneDisplay.textContent = displayTimezone;
                    
                    // Show detection hint if timezone doesn't match browser timezone
                    const browserTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                    if (volunteerTimezone !== browserTimezone) {
                        console.log(`Timezone mismatch detected. Saved: ${volunteerTimezone}, Browser: ${browserTimezone}`);
                    }
                    
                    console.log('Loaded volunteer timezone:', volunteerTimezone);
                })
                .catch(error => {
                    console.error('Error loading volunteer timezone:', error);
                    // Fallback to browser detected timezone
                    volunteerTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                    const displayTimezone = formatTimezoneDisplay(volunteerTimezone);
                    volunteerTimezoneDisplay.textContent = displayTimezone + ' (detected)';
                });
        }
        
        function formatTimezoneDisplay(timezone) {
            try {
                const now = new Date();
                const tzString = now.toLocaleString('en-US', { timeZone: timezone, timeZoneName: 'short' }).split(' ').pop();
                
                // Map common timezones to user-friendly names
                const timezoneMap = {
                    'America/New_York': 'Eastern Time (US & Canada)',
                    'America/Chicago': 'Central Time (US & Canada)',
                    'America/Denver': 'Mountain Time (US & Canada)',
                    'America/Los_Angeles': 'Pacific Time (US & Canada)',
                    'America/Toronto': 'Toronto, Montreal',
                    'Europe/London': 'London, Dublin',
                    'Europe/Paris': 'Paris, Berlin, Rome',
                    'Africa/Nairobi': 'Nairobi, Kenya (EAT)',
                    'Asia/Dubai': 'Dubai, Abu Dhabi',
                    'Asia/Tokyo': 'Tokyo, Osaka',
                    'Australia/Sydney': 'Sydney, Melbourne'
                };
                
                return timezoneMap[timezone] || `${timezone.replace('_', ' ')} (${tzString})`;
            } catch (e) {
                return timezone.replace('_', ' ');
            }
        }
        
        // --- Event Handlers ---
        prevMonthBtn.addEventListener('click', () => {
            // Don't allow going to past months
            const today = new Date();
            if (currentMonth === today.getMonth() && currentYear === today.getFullYear()) {
                return;
            }
            
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar();
        });
        
        nextMonthBtn.addEventListener('click', () => {
            // Calculate 3-month limit from today
            const today = new Date();
            const threeMonthsFromToday = new Date(today);
            threeMonthsFromToday.setMonth(today.getMonth() + 3);
            
            // Check if next month would exceed 3-month window
            let nextMonth = currentMonth + 1;
            let nextYear = currentYear;
            if (nextMonth > 11) {
                nextMonth = 0;
                nextYear++;
            }
            
            const nextMonthDate = new Date(nextYear, nextMonth, 1);
            if (nextMonthDate > threeMonthsFromToday) {
                return; // Don't allow navigation beyond 3-month window
            }
            
            currentMonth = nextMonth;
            currentYear = nextYear;
            renderCalendar();
        });
        
        confirmBtn.addEventListener('click', () => {
            if (!selectedDate || !selectedTimeSlot) {
                showNotification('Please select a date and time', 'error');
                return;
            }

            // Ensure student data is loaded before showing confirmation
            if (!studentData || !studentData.id) {
                showNotification('Loading student data... Please wait.', 'warning');
                return;
            }

            // Set the selected date and time for the meeting
            const meetingDate = new Date(selectedDate);
            meetingDate.setHours(selectedTimeSlot.hour, selectedTimeSlot.minute);
            
            // Update modal with selected date and time
            modalDate.textContent = formatDate(meetingDate);
            modalTime.textContent = formatTime(selectedTimeSlot.hour, selectedTimeSlot.minute);
            
            // Show confirmation modal
            confirmModal.classList.remove('hidden');
        });
        
        modalCancel.addEventListener('click', () => {
            confirmModal.classList.add('hidden');
        });
        
        modalConfirm.addEventListener('click', () => {
            // Hide modal
            confirmModal.classList.add('hidden');

            // Get student ID from URL
            const params = getUrlParams();
            if (!params) return;

            // Ensure student data is loaded
            if (!studentData || !studentData.id) {
                showNotification('Student data not loaded yet. Please wait and try again.', 'error');
                return;
            }

            // Set the selected date and time for the meeting
            const meetingDate = new Date(selectedDate);
            meetingDate.setHours(selectedTimeSlot.hour, selectedTimeSlot.minute);

            // Use volunteer's saved timezone
            const timezone = volunteerTimezone;

            // Format date as YYYY-MM-DD and time as HH:MM for the volunteer endpoint
            const year = selectedDate.getFullYear();
            const month = String(selectedDate.getMonth() + 1).padStart(2, '0');
            const day = String(selectedDate.getDate()).padStart(2, '0');
            const dateStr = `${year}-${month}-${day}`;
            const timeStr = `${String(selectedTimeSlot.hour).padStart(2, '0')}:${String(selectedTimeSlot.minute).padStart(2, '0')}`;

            // Prepare meeting data for volunteer endpoint
            const meetingData = {
                studentId: studentData.id, // Use the numeric ID from the API response
                date: dateStr,
                time: timeStr,
                timezone: timezone,
                scheduledTime: meetingDate.toISOString(), // Also include ISO format for compatibility
                eatTime: {
                    hour: selectedTimeSlot.eatHour,
                    minute: selectedTimeSlot.eatMinute
                }
            };

            console.log('Sending meeting data with numeric studentId:', meetingData.studentId);
            console.log('Meeting date:', dateStr, 'time:', timeStr);

            // API endpoint and method - use volunteer endpoint which handles students table IDs
            let endpoint = '/api/v1/volunteers/meetings';
            let method = 'POST';

            // If rescheduling, update the endpoint and method
            if (isRescheduling && meetingId) {
                endpoint = `/api/v1/meetings/${meetingId}`;
                method = 'PUT';
            }
            
            // Send API request to schedule or reschedule the meeting using JWT authentication
            TalkTimeAuth.authenticatedRequest(endpoint, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(meetingData)
            })
                .then(response => {
                    if (!response.ok) {
                        // Handle different error status codes
                        return response.json().then(errorData => {
                            console.log('Server error response:', errorData);
                            if (response.status === 403) {
                                if (errorData.error && errorData.error.includes('3-meeting limit')) {
                                    throw new Error(`You have reached the 3-meeting limit with this student (${errorData.meetingCount}/${errorData.limit}). This ensures all students get equal opportunities to practice with different volunteers.`);
                                } else if (errorData.error && errorData.error.includes('restricted')) {
                                    throw new Error(errorData.message || errorData.error);
                                } else {
                                    // Show actual server error instead of generic message
                                    throw new Error(errorData.message || errorData.error || 'Access denied');
                                }
                            } else if (response.status === 409) {
                                throw new Error(errorData.error || 'This student already has a meeting scheduled for this date. Please choose a different date.');
                            } else {
                                throw new Error(errorData.error || 'Failed to schedule meeting');
                            }
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    // Show success notification
                    showNotification(isRescheduling ? 'Meeting rescheduled successfully' : 'Meeting scheduled successfully');
                    
                    // If this is a reschedule, immediately trigger the reschedule sound
                    if (isRescheduling) {
                        console.log('🔊 Triggering reschedule sound manually...');
                        
                        // Method 1: Direct sound event trigger
                        if (document.dispatchEvent) {
                            document.dispatchEvent(new CustomEvent('talktimeNotificationSent', {
                                detail: {
                                    type: 'meeting_rescheduled',
                                    priority: 'high',
                                    metadata: {
                                        meeting_id: meetingId,
                                        action: 'reschedule_confirmed'
                                    },
                                    source: 'schedule_page',
                                    force_play: true
                                }
                            }));
                        }
                        
                        // Method 2: Direct sound manager call
                        if (window.talkTimeNotificationSoundManager) {
                            window.talkTimeNotificationSoundManager.playSound('meeting_rescheduled', { 
                                forcePlay: true,
                                source: 'schedule_confirmation' 
                            }).catch(err => console.log('Sound play failed:', err));
                        }
                        
                        // Method 3: Realtime notifications call
                        if (window.realtimeNotifications && window.realtimeNotifications.playNotificationSound) {
                            window.realtimeNotifications.playNotificationSound({
                                sound_type: 'meeting_rescheduled',
                                priority: 'high',
                                notification: { type: 'meeting_rescheduled' },
                                source: 'schedule_confirmation'
                            });
                        }
                        
                        console.log('🔊 Reschedule sound triggered via multiple methods');
                    }
                    
                    // Increase redirect delay to allow Socket.IO events to be received and sounds to play
                    const redirectDelay = isRescheduling ? 3000 : 1500; // 3 seconds for reschedule, 1.5 for new meetings
                    
                    setTimeout(() => {
                        window.location.href = `/volunteer/dashboard/student-detail.html?id=${params.studentId}&admission=${params.studentAdmission}&name=${encodeURIComponent(params.studentName)}`;
                    }, redirectDelay);
                })
                .catch(error => {
                    console.error('Error scheduling meeting:', error);
                    // Display the specific error message
                    showNotification(error.message || 'Failed to schedule meeting. Please try again.', 'error');
                    
                    // If it's a 403 error (student already has a meeting), redirect back to student detail page after 3 seconds
                    if (error.message && error.message.includes('already has an active meeting')) {
                        setTimeout(() => {
                            window.location.href = `/volunteer/dashboard/student-detail.html?id=${params.studentId}&admission=${params.studentAdmission}&name=${encodeURIComponent(params.studentName)}`;
                        }, 3000);
                    }
                });
        });
        
        // --- Initialize Authentication ---
        window.TalkTimeAuth = new TalkTimeJWTAuth('volunteer');
        
        // --- Initialize Real-time Notifications ---
        if (typeof RealtimeNotifications !== 'undefined') {
            window.realtimeNotifications = new RealtimeNotifications('volunteer');
            window.realtimeNotifications.initialize().then(() => {
                console.log('Real-time notifications initialized on schedule page');
                
                // Listen for meeting notifications
                window.realtimeNotifications.on('newNotification', (notification) => {
                    if (notification.type === 'meeting_scheduled' || notification.type === 'meeting_rescheduled') {
                        console.log('Meeting notification received:', notification);
                        showNotification(notification.message, 'success');
                    }
                });
                
                // Add specific listener for meeting-rescheduled Socket.IO events
                if (window.realtimeNotifications.socket) {
                    window.realtimeNotifications.socket.on('meeting-rescheduled', (data) => {
                        console.log('🔔 Schedule page received meeting-rescheduled event:', data);
                        
                        // Trigger reschedule sound
                        if (window.realtimeNotifications.playNotificationSound) {
                            window.realtimeNotifications.playNotificationSound({
                                sound_type: 'meeting_rescheduled',
                                priority: 'high',
                                notification: { type: 'meeting_rescheduled' },
                                metadata: data,
                                source: 'socket_event_schedule_page'
                            });
                        }
                        
                        // Show toast notification
                        showNotification('Meeting rescheduled successfully! 🔔', 'success');
                    });
                } else {
                    console.log('Socket.IO not available on schedule page, manual sound triggers will be used');
                }
            }).catch(error => {
                console.error('Failed to initialize real-time notifications:', error);
            });
        }
        
        // --- Initialization ---
        loadStudentData();
        renderCalendar();

        // Auto-select today's date
        const todayDate = new Date();
        const todayCell = document.querySelector('.day-today:not(.day-disabled)');
        if (todayCell) {
            todayCell.classList.add('day-selected');
            selectedDate = new Date(todayDate.getFullYear(), todayDate.getMonth(), todayDate.getDate());
            showTimeSelection();
        }
    });
    </script>

    <!-- Global Functions -->
    <script>
        // Auto-detect timezone function (must be global for onclick handler)
        function autoDetectTimezone() {
            const browserTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            console.log('Auto-detecting timezone:', browserTimezone);
            
            // Update the display immediately
            volunteerTimezone = browserTimezone;
            
            // Format timezone display
            function formatTimezoneDisplay(timezone) {
                try {
                    const now = new Date();
                    const tzString = now.toLocaleString('en-US', { timeZone: timezone, timeZoneName: 'short' }).split(' ').pop();
                    
                    // Map common timezones to user-friendly names
                    const timezoneMap = {
                        'America/New_York': 'Eastern Time (US & Canada)',
                        'America/Chicago': 'Central Time (US & Canada)',
                        'America/Denver': 'Mountain Time (US & Canada)',
                        'America/Los_Angeles': 'Pacific Time (US & Canada)',
                        'America/Toronto': 'Toronto, Montreal',
                        'Europe/London': 'London, Dublin',
                        'Europe/Paris': 'Paris, Berlin, Rome',
                        'Africa/Nairobi': 'Nairobi, Kenya (EAT)',
                        'Asia/Dubai': 'Dubai, Abu Dhabi',
                        'Asia/Tokyo': 'Tokyo, Osaka',
                        'Australia/Sydney': 'Sydney, Melbourne'
                    };
                    
                    return timezoneMap[timezone] || `${timezone.replace('_', ' ')} (${tzString})`;
                } catch (e) {
                    return timezone.replace('_', ' ');
                }
            }
            
            const displayTimezone = formatTimezoneDisplay(volunteerTimezone);
            const displayElement = document.getElementById('volunteer-timezone-display');
            if (displayElement) {
                displayElement.textContent = displayTimezone + ' (auto-detected)';
            }
            
            // Show success message
            const notification = document.getElementById('notification');
            if (notification) {
                notification.textContent = 'Timezone auto-detected and updated!';
                notification.className = 'fixed bottom-5 right-5 bg-success text-white px-6 py-3 rounded-lg shadow-lg';
                
                setTimeout(() => {
                    notification.className = 'hidden fixed bottom-5 right-5 bg-success text-white px-6 py-3 rounded-lg shadow-lg';
                }, 3000);
            }
            
            console.log('Timezone updated to:', volunteerTimezone);
        }
    </script>

    <!-- Initialize Navigation -->
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // Register notification service worker
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.register('/notification-sw.js');
                    console.log('Notification service worker registered:', registration);
                    
                    // Request notification permission if not already granted
                    if (Notification.permission === 'default') {
                        const permission = await Notification.requestPermission();
                        console.log('Notification permission:', permission);
                    }
                } catch (error) {
                    console.error('Failed to register notification service worker:', error);
                }
            }
            
            // Initialize navigation with authentication requirement
            await VolunteerNavLoader.init(true);
        });
    </script>
</body>
</html>
