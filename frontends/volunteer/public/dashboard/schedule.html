<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TalkTime - Schedule Meeting | Volunteer Dashboard</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <meta name="description" content="Schedule or reschedule an English practice session with a Maasai student. Choose a date, time, and timezone for your TalkTime conversation.">
    <link rel="canonical" id="canonical-link" href="">
    <meta name="robots" content="index, follow">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Poppins:wght@600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <!-- Navigation Loader -->
    <script src="/volunteer/partials/nav-loader.js"></script>
    
    <!-- Modal Utilities -->
    <script src="/volunteer/js/modal-utils.js"></script>
    
    <!-- JWT Authentication Utility -->
    <script src="/shared/js/jwt-auth-utils.js"></script>
    
    <!-- Newsletter Widget -->
    <script src="/shared/js/newsletter-widget.js"></script>
    
    <!-- Real-time Notifications -->
    <script src="/shared/js/realtime-notifications.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f4ff; }
        .font-poppins { font-family: 'Poppins', sans-serif; }
        .glass-bg {
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .gradient-text {
            background-image: linear-gradient(to right, #4f46e5, #a855f7);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        .blob {
            position: fixed;
            border-radius: 50%;
            filter: blur(100px);
            opacity: 0.3;
            z-index: -1;
        }
        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }
        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .calendar-day:hover:not(.day-disabled):not(.day-selected) {
            background-color: rgba(255, 255, 255, 0.7);
        }
        .day-disabled {
            color: #d1d5db;
            cursor: not-allowed;
        }
        .day-selected {
            background-color: #4f46e5;
            color: white;
        }
        .day-today {
            border: 2px solid #4f46e5;
        }
        .time-input {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }
        .time-slot {
            padding: 0.5rem;
            border-radius: 0.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            background-color: rgba(255, 255, 255, 0.5);
        }
        .time-slot:hover:not(.time-disabled) {
            background-color: rgba(255, 255, 255, 0.8);
        }
        .time-slot.time-selected {
            background-color: #4f46e5;
            color: white;
        }
        .time-disabled {
            color: #d1d5db;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <!-- Background Blobs -->
    <div class="blob bg-blue-300 w-96 h-96 top-0 left-0 -translate-x-1/2 -translate-y-1/2"></div>
    <div class="blob bg-purple-300 w-96 h-96 bottom-0 right-0 translate-x-1/2 translate-y-1/2"></div>
    
    <!-- Navigation Container -->
    <div id="nav-container">
        <!-- Navigation will be loaded dynamically -->
    </div>

    <main class="container mx-auto px-4 py-20">
        <!-- Back Navigation -->
        <div class="mb-8 flex items-center" id="back-link-container">
            <!-- Back link will be inserted here -->
        </div>
        
        <!-- Schedule Page -->
        <div id="page-scheduler" class="w-full">
            <div class="max-w-3xl mx-auto">
                <div class="glass-bg rounded-xl p-6 mb-6">
                    <h2 id="schedule-title" class="text-2xl font-bold mb-4 text-center">Schedule a Meeting</h2>
                    <div class="flex items-center mb-6">
                        <img id="student-image" src="/volunteer/images/default-profile.svg" alt="Student" class="w-16 h-16 rounded-full object-cover mr-4">
                        <div>
                            <h3 id="student-name" class="font-semibold text-lg">Student Name</h3>
                            <p id="student-details" class="text-sm text-gray-600">Age: 14 | Female</p>
                        </div>
                    </div>
                    
                    <!-- Timezone Display -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Your Timezone</label>
                        <div class="w-full p-3 bg-gray-50 rounded-lg border border-gray-200 text-gray-700">
                            <div class="flex items-center justify-between">
                                <span id="volunteer-timezone-display" class="font-medium">Loading timezone...</span>
                                <div class="flex gap-2">
                                    <button id="detect-timezone-btn" class="text-blue-600 hover:text-blue-800 text-sm underline" onclick="autoDetectTimezone()">
                                        <i class="fas fa-location-dot mr-1"></i>Auto-detect
                                    </button>
                                    <a href="/volunteer/settings" class="text-indigo-600 hover:text-indigo-800 text-sm underline">Edit in Settings</a>
                                </div>
                            </div>
                        </div>
                    </div>                    <!-- Calendar -->
                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <button id="prev-month" class="text-gray-600 hover:text-gray-900"><i class="fas fa-chevron-left"></i></button>
                            <h4 id="calendar-month" class="font-semibold">July 2025</h4>
                            <button id="next-month" class="text-gray-600 hover:text-gray-900"><i class="fas fa-chevron-right"></i></button>
                        </div>
                        <div class="calendar mb-2">
                            <div class="text-center text-gray-500 text-xs font-medium">Sunday</div>
                            <div class="text-center text-gray-500 text-xs font-medium">Monday</div>
                            <div class="text-center text-gray-500 text-xs font-medium">Tuesday</div>
                            <div class="text-center text-gray-500 text-xs font-medium">Wednesday</div>
                            <div class="text-center text-gray-500 text-xs font-medium">Thursday</div>
                            <div class="text-center text-gray-500 text-xs font-medium">Friday</div>
                            <div class="text-center text-gray-500 text-xs font-medium">Saturday</div>
                        </div>
                        <div id="calendar-days" class="calendar">
                            <!-- Calendar days will be inserted here -->
                        </div>
                    </div>
                    
                    <!-- Time Selection -->
                    <div id="time-selection" class="mb-6 hidden">
                        <h4 class="font-semibold mb-3">Select a Time <span id="selected-date-display" class="text-gray-500 font-normal">(July 16, 2025)</span></h4>
                        <div id="time-slots" class="time-input">
                            <!-- Time slots will be inserted here -->
                        </div>
                    </div>
                    
                    <!-- Confirm Button -->
                    <div id="confirm-container" class="text-center hidden">
                        <button id="confirm-btn" class="bg-indigo-600 text-white py-2 px-6 rounded-lg hover:bg-indigo-700 transition-colors">
                            Confirm Meeting
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
            <h3 class="text-xl font-bold mb-4">Confirm Your Meeting</h3>
            <p class="mb-4">You're about to schedule a meeting with <span id="modal-student-name" class="font-semibold">Student Name</span>.</p>
            <div class="p-4 bg-blue-50 rounded-lg mb-4">
                <p><i class="far fa-calendar mr-2 text-blue-600"></i><span id="modal-date">July 16, 2025</span></p>
                <p><i class="far fa-clock mr-2 text-blue-600"></i><span id="modal-time">3:00 PM</span> (Your local time)</p>
                <p><i class="far fa-clock mr-2 text-blue-600"></i><span id="modal-time-eat"></span> (Kenya time - EAT)</p>
            </div>
            <div class="flex justify-end gap-3">
                <button id="modal-cancel" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 transition-colors">Cancel</button>
                <button id="modal-confirm" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors">Confirm</button>
            </div>
        </div>
    </div>
    
    <!-- Notification Toast -->
    <div id="notification" class="hidden fixed bottom-5 right-5 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM Elements ---
        const profileBtn = document.getElementById('profile-btn');
        const profileDropdown = document.getElementById('profile-dropdown');
        const backLinkContainer = document.getElementById('back-link-container');
        const scheduleTitle = document.getElementById('schedule-title');
        const studentImage = document.getElementById('student-image');
        const studentName = document.getElementById('student-name');
        const studentDetails = document.getElementById('student-details');
        const volunteerTimezoneDisplay = document.getElementById('volunteer-timezone-display');
        const calendarMonth = document.getElementById('calendar-month');
        const calendarDays = document.getElementById('calendar-days');
        const prevMonthBtn = document.getElementById('prev-month');
        const nextMonthBtn = document.getElementById('next-month');
        const timeSelection = document.getElementById('time-selection');
        const selectedDateDisplay = document.getElementById('selected-date-display');
        const timeSlots = document.getElementById('time-slots');
        const confirmContainer = document.getElementById('confirm-container');
        const confirmBtn = document.getElementById('confirm-btn');
        const confirmModal = document.getElementById('confirm-modal');
        const modalStudentName = document.getElementById('modal-student-name');
        const modalDate = document.getElementById('modal-date');
        const modalTime = document.getElementById('modal-time');
        const modalCancel = document.getElementById('modal-cancel');
        const modalConfirm = document.getElementById('modal-confirm');
        const notificationEl = document.getElementById('notification');
        
        // --- State Variables ---
        let currentDate = new Date();
        let currentMonth = currentDate.getMonth();
        let currentYear = currentDate.getFullYear();
        let selectedDate = null;
        let selectedTimeSlot = null;
        let studentData = null;
        let meetingId = null; // For rescheduling
        let isRescheduling = false;
        let volunteerTimezone = null; // Volunteer's saved timezone
        
        // --- Utility Functions ---
        function showNotification(message, type = 'success') {
            notificationEl.textContent = message;
            notificationEl.className = `fixed bottom-5 right-5 px-6 py-3 rounded-lg shadow-lg ${type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'}`;
            notificationEl.classList.remove('hidden');
            
            setTimeout(() => {
                notificationEl.classList.add('hidden');
            }, 5000);
        }
        
        function formatDate(date) {
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            return date.toLocaleDateString(undefined, options);
        }
        
        function formatTime(hours, minutes) {
            const period = hours >= 12 ? 'PM' : 'AM';
            const formattedHours = hours % 12 || 12;
            return `${formattedHours}:${minutes.toString().padStart(2, '0')} ${period}`;
        }
        
        // Function to generate time slots for a specific date based on EAT constraints
        function generateTimeSlotsForDate(date, timezone) {
            const slots = [];
            
            // EAT constraints: 9:00 AM - 5:00 PM with 15-minute intervals
            const eatStartHour = 9; // 9:00 AM EAT
            const eatEndHour = 17;  // 5:00 PM EAT
            
            // Create a date object for the selected date at midnight
            const selectedDateObj = new Date(date);
            selectedDateObj.setHours(0, 0, 0, 0);
            
            // Check if the selected date is today
            const today = new Date();
            const isToday = selectedDateObj.toDateString() === today.toDateString();
            
            // Get current time in volunteer's timezone for filtering past slots
            const currentVolunteerTime = new Date();
            
            // Generate all possible time slots in 15-minute increments within EAT constraints
            for (let hour = eatStartHour; hour < eatEndHour; hour++) {
                for (let minute = 0; minute < 60; minute += 15) {
                    // Create a date object for this time slot in EAT
                    const eatDate = new Date(selectedDateObj);
                    eatDate.setHours(hour, minute, 0, 0);
                    
                    // Convert EAT time to the volunteer's timezone for display
                    const volunteerDate = convertEatToVolunteerTime(eatDate, timezone);
                    
                    // Skip past time slots if this is today
                    if (isToday && volunteerDate <= currentVolunteerTime) {
                        continue;
                    }
                    
                    // Get the hours and minutes in the volunteer's timezone
                    const volunteerHour = volunteerDate.getHours();
                    const volunteerMinute = volunteerDate.getMinutes();
                    
                    // Format the time for display
                    const displayTime = formatTime(volunteerHour, volunteerMinute);
                    
                    // Add the time slot
                    slots.push({
                        display: displayTime,
                        hour: volunteerHour,
                        minute: volunteerMinute,
                        eatHour: hour,
                        eatMinute: minute,
                        date: volunteerDate
                    });
                }
            }
            
            return slots;
        }
        
        // Function to convert EAT time to volunteer's timezone
        function convertEatToVolunteerTime(eatDate, volunteerTimezone) {
            // EAT is UTC+3, so we need to properly handle timezone conversion
            // First, treat the eatDate as if it's in EAT (UTC+3)
            const eatYear = eatDate.getFullYear();
            const eatMonth = eatDate.getMonth();
            const eatDay = eatDate.getDate();
            const eatHour = eatDate.getHours();
            const eatMinute = eatDate.getMinutes();
            
            // Create a date string in EAT timezone format
            const eatTimeString = `${eatYear}-${String(eatMonth + 1).padStart(2, '0')}-${String(eatDay).padStart(2, '0')}T${String(eatHour).padStart(2, '0')}:${String(eatMinute).padStart(2, '0')}:00+03:00`;
            
            // Parse this as a proper timezone-aware date
            const eatDateWithTimezone = new Date(eatTimeString);
            
            // Convert to volunteer's local timezone (browser will handle this automatically)
            return eatDateWithTimezone;
        }
        
        // Function to convert volunteer time to EAT
        function convertVolunteerTimeToEat(volunteerDate, volunteerTimezone) {
            // The volunteerDate is in the volunteer's local timezone
            // We need to convert it to EAT (UTC+3)
            
            // Get the UTC time from the volunteer's local time
            const utcTime = volunteerDate.getTime() + (volunteerDate.getTimezoneOffset() * 60000);
            
            // EAT is UTC+3 (3 hours ahead of UTC)
            const eatTime = utcTime + (3 * 60 * 60 * 1000);
            
            // Create the EAT date
            const eatDate = new Date(eatTime);
            
            return eatDate;
        }
        
        // Function to get URL parameters
        function getUrlParams() {
            // Parse query parameters from the new URL structure
            // Format: /volunteer/dashboard/schedule.html?id=1&admission=ADM0001&name=Test%20Student&meeting=123
            const searchParams = new URLSearchParams(window.location.search);
            
            const id = searchParams.get('id');
            const admission = searchParams.get('admission');
            const name = searchParams.get('name');
            const meetingParam = searchParams.get('meeting'); // For reschedule requests
            
            // Validate that we have the required parameters
            if (id && admission && name) {
                return {
                    studentId: id,
                    studentAdmission: admission,
                    studentName: decodeURIComponent(name),
                    action: meetingParam ? 'update' : 'new', // If meeting ID is present, it's a reschedule
                    meetingId: meetingParam
                };
            }
            
            // If query parameters are missing, return null
            console.error('Missing required URL parameters for schedule page:', { id, admission, name });
            return null;
        }
        
        // --- Calendar Functions ---
        function renderCalendar() {
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDay = firstDay.getDay(); // 0 = Sunday, 1 = Monday, etc.
            
            // Update month display
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            calendarMonth.textContent = `${monthNames[currentMonth]} ${currentYear}`;
            
            // Clear calendar
            calendarDays.innerHTML = '';
            
            // Add empty cells for days before the first day of the month
            for (let i = 0; i < startingDay; i++) {
                const emptyDay = document.createElement('div');
                calendarDays.appendChild(emptyDay);
            }
            
            // Add days of the month
            const today = new Date();
            for (let day = 1; day <= daysInMonth; day++) {
                const dayEl = document.createElement('div');
                dayEl.textContent = day;
                dayEl.classList.add('calendar-day');
                
                const dateToCheck = new Date(currentYear, currentMonth, day);
                
                // Calculate 3-month limit from today
                const threeMonthsFromToday = new Date(today);
                threeMonthsFromToday.setMonth(today.getMonth() + 3);
                
                // Check if this day is in the past or beyond 3-month window
                if (dateToCheck < new Date(today.getFullYear(), today.getMonth(), today.getDate()) || 
                    dateToCheck > threeMonthsFromToday) {
                    dayEl.classList.add('day-disabled');
                } else {
                    // Check if this is the selected date
                    if (selectedDate && day === selectedDate.getDate() && currentMonth === selectedDate.getMonth() && currentYear === selectedDate.getFullYear()) {
                        dayEl.classList.add('day-selected');
                    }
                    
                    // Check if this is today
                    if (day === today.getDate() && currentMonth === today.getMonth() && currentYear === today.getFullYear()) {
                        dayEl.classList.add('day-today');
                    }
                    
                    // Add click event
                    dayEl.addEventListener('click', () => {
                        // Remove selected class from all days
                        document.querySelectorAll('.day-selected').forEach(el => el.classList.remove('day-selected'));
                        
                        // Add selected class to this day
                        dayEl.classList.add('day-selected');
                        
                        // Update selected date
                        selectedDate = new Date(currentYear, currentMonth, day);
                        
                        // Show time selection
                        showTimeSelection();
                    });
                }
                
                calendarDays.appendChild(dayEl);
            }
        }
        
        function showTimeSelection() {
            // Format the selected date for display
            selectedDateDisplay.textContent = `(${formatDate(selectedDate)})`;
            
            // Show time selection section
            timeSelection.classList.remove('hidden');
            
            // Generate time slots
            generateTimeSlots();
            
            // Scroll to time selection
            timeSelection.scrollIntoView({ behavior: 'smooth' });
        }
        
        function generateTimeSlots() {
            // Clear existing time slots
            timeSlots.innerHTML = '';
            
            // Use volunteer's saved timezone
            const timezone = volunteerTimezone;
            
            // Generate time slots based on EAT constraints (9:00 AM - 5:00 PM EAT)
            // with 15-minute intervals (00, 15, 30, 45)
            const slots = generateTimeSlotsForDate(selectedDate, timezone);
            
            // Add time slots to the UI
            slots.forEach(slot => {
                const timeSlot = document.createElement('div');
                timeSlot.textContent = slot.display;
                timeSlot.classList.add('time-slot');
                timeSlot.dataset.eatHour = slot.eatHour;
                timeSlot.dataset.eatMinute = slot.eatMinute;
                
                // Add click event
                timeSlot.addEventListener('click', () => {
                    // Remove selected class from all time slots
                    document.querySelectorAll('.time-selected').forEach(el => el.classList.remove('time-selected'));
                    
                    // Add selected class to this time slot
                    timeSlot.classList.add('time-selected');
                    
                    // Update selected time slot with both volunteer time and EAT time
                    selectedTimeSlot = {
                        hour: slot.hour,
                        minute: slot.minute,
                        eatHour: slot.eatHour,
                        eatMinute: slot.eatMinute
                    };
                    
                    // Show confirm button
                    confirmContainer.classList.remove('hidden');
                });
                
                timeSlots.appendChild(timeSlot);
            });
        }
        
        // --- Data Loading ---
        function loadStudentData() {
            const params = getUrlParams();
            
            if (!params) {
                showNotification('Invalid URL', 'error');
                return;
            }
            
            // Check if this is a reschedule
            isRescheduling = params.action === 'update';
            if (isRescheduling) {
                scheduleTitle.textContent = 'Reschedule Meeting';
                meetingId = params.meetingId;
                
                // Update page title for reschedule
                document.title = `TalkTime - Reschedule Meeting | Volunteer Dashboard`;
            } else {
                // Update page title for new schedule
                document.title = `TalkTime - Schedule Meeting | Volunteer Dashboard`;
            }
            
            // Update canonical link
            const canonicalLink = document.getElementById('canonical-link');
            canonicalLink.href = window.location.href;
            
            // Update back link
            backLinkContainer.innerHTML = `
                <a href="/volunteer/dashboard/student-detail.html?id=${params.studentId}&admission=${params.studentAdmission}&name=${encodeURIComponent(params.studentName)}" class="text-blue-600 hover:text-blue-800 flex items-center">
                    <i class="fas fa-arrow-left mr-2"></i>
                    Back to Student Profile
                </a>
            `;
            
            // Fetch student data using JWT authentication
            TalkTimeAuth.authenticatedRequest(`/api/v1/volunteers/students/${params.studentId}/profile`, {
                method: 'GET'
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    studentData = data.student; // API returns student data wrapped in 'student' property
                    
                    // Store the numeric student ID for later use
                    console.log('Received student data with numeric ID:', studentData.id);
                    
                    // Update student info - using correct property names from API response
                    studentName.textContent = studentData.full_name;
                    studentDetails.textContent = `Age: ${studentData.age} | ${studentData.gender}`;
                    
                    // Update profile image with fallback
                    const profileImageSrc = studentData.profileImage || '/images/placeholder-student.jpg';
                    studentImage.src = profileImageSrc;
                    studentImage.alt = studentData.full_name || 'Student';
                    
                    // Add error handler for broken images
                    studentImage.onerror = function() {
                        this.src = '/images/placeholder-student.jpg';
                    };
                    
                    // Update modal student name
                    modalStudentName.textContent = studentData.full_name;
                    
                    // If rescheduling, fetch meeting details
                    if (isRescheduling && meetingId) {
                        fetchMeetingDetails(meetingId);
                    }
                    
                    // Check meeting limit status with this student
                    checkMeetingLimitStatus(params.studentId);
                    
                    // Load volunteer's saved timezone
                    loadVolunteerTimezone();
                })
                .catch(error => {
                    console.error('Error loading student data:', error);
                    showNotification('Failed to load student data. Please try again.', 'error');
                });
        }
        
        function fetchMeetingDetails(meetingId) {
            TalkTimeAuth.authenticatedRequest(`/api/v1/meetings/${meetingId}`, {
                method: 'GET'
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // Pre-select the date and time from the meeting
                    const meetingDate = new Date(data.meeting.scheduled_time);
                    
                    // Update calendar to show the month of the meeting
                    currentMonth = meetingDate.getMonth();
                    currentYear = meetingDate.getFullYear();
                    
                    // Render calendar with the meeting month
                    renderCalendar();
                    
                    // Select the date
                    selectedDate = new Date(meetingDate);
                    
                    // Show time selection
                    showTimeSelection();
                    
                    // Pre-select the time slot
                    const hour = meetingDate.getHours();
                    const minute = meetingDate.getMinutes();
                    selectedTimeSlot = { hour, minute };
                    
                    // Find and select the time slot
                    setTimeout(() => {
                        const timeSlotElements = document.querySelectorAll('.time-slot');
                        timeSlotElements.forEach(slot => {
                            if (slot.textContent === formatTime(hour, minute)) {
                                slot.classList.add('time-selected');
                                confirmContainer.classList.remove('hidden');
                            }
                        });
                    }, 100);
                })
                .catch(error => {
                    console.error('Error loading meeting details:', error);
                    showNotification('Failed to load meeting details. Please try again.', 'error');
                });
        }
        
        function checkMeetingLimitStatus(studentId) {
            // Check meeting count with this student and display status
            TalkTimeAuth.authenticatedRequest(`/api/v1/meetings/student/${studentId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    const meetingStats = data.meetingStats || {};
                    const meetingCount = meetingStats.volunteerStudentMeetingCount || 0;
                    const limit = meetingStats.meetingLimit || 3;
                    const canScheduleMore = meetingStats.canScheduleMore !== false;
                    
                    // Add meeting status display after student info
                    const studentDetails = document.getElementById('student-details');
                    const studentContainer = studentDetails.parentElement;
                    
                    // Remove any existing status display
                    const existingStatus = document.getElementById('meeting-limit-status');
                    if (existingStatus) {
                        existingStatus.remove();
                    }
                    
                    // Create status display
                    const statusEl = document.createElement('div');
                    statusEl.id = 'meeting-limit-status';
                    statusEl.className = `p-3 rounded-lg border mb-4 ${canScheduleMore ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}`;
                    
                    statusEl.innerHTML = `
                        <div class="flex items-center gap-3">
                            <i class="fas ${canScheduleMore ? 'fa-check-circle text-green-600' : 'fa-exclamation-triangle text-red-600'}"></i>
                            <div>
                                <h4 class="font-semibold text-sm ${canScheduleMore ? 'text-green-800' : 'text-red-800'}">
                                    Meeting Limit: ${meetingCount}/${limit} meetings with this student
                                </h4>
                                <p class="text-xs ${canScheduleMore ? 'text-green-700' : 'text-red-700'}">
                                    ${canScheduleMore 
                                        ? `You can schedule ${limit - meetingCount} more meeting${limit - meetingCount === 1 ? '' : 's'}.`
                                        : 'You have reached the limit. This ensures all students get equal opportunities.'}
                                </p>
                            </div>
                        </div>
                    `;
                    
                    // Insert after student info container
                    studentContainer.appendChild(statusEl);
                    
                    // If limit reached, disable scheduling interface
                    if (!canScheduleMore && !isRescheduling) {
                        disableSchedulingInterface();
                    }
                })
                .catch(error => {
                    console.error('Error checking meeting limit:', error);
                    // Don't block scheduling on error, just log it
                });
        }
        
        function disableSchedulingInterface() {
            // Disable calendar and time selection
            const calendarDays = document.getElementById('calendar-days');
            const timeSelection = document.getElementById('time-selection');
            const confirmContainer = document.getElementById('confirm-container');
            
            if (calendarDays) {
                calendarDays.style.pointerEvents = 'none';
                calendarDays.style.opacity = '0.5';
            }
            if (timeSelection) {
                timeSelection.style.display = 'none';
            }
            if (confirmContainer) {
                confirmContainer.style.display = 'none';
            }
            
            // Show disabled message
            const scheduleContainer = document.querySelector('.glass-bg');
            if (scheduleContainer) {
                const disabledMsg = document.createElement('div');
                disabledMsg.className = 'p-4 bg-gray-100 rounded-lg text-center mt-4';
                disabledMsg.innerHTML = `
                    <p class="text-gray-700">
                        <i class="fas fa-ban mr-2"></i>
                        Scheduling is disabled because you've reached the 3-meeting limit with this student.
                    </p>
                    <p class="text-sm text-gray-600 mt-2">
                        This policy ensures all students get equal opportunities to practice with different volunteers.
                    </p>
                `;
                scheduleContainer.appendChild(disabledMsg);
            }
        }
        
        function loadVolunteerTimezone() {
            // Fetch volunteer's profile to get their saved timezone
            TalkTimeAuth.authenticatedRequest('/api/v1/volunteer/profile', {
                method: 'GET'
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // Extract timezone from volunteer profile - handle both data structures
                    volunteerTimezone = data.timezone || data.volunteer?.timezone || Intl.DateTimeFormat().resolvedOptions().timeZone;
                    
                    // Display timezone with user-friendly format
                    const displayTimezone = formatTimezoneDisplay(volunteerTimezone);
                    volunteerTimezoneDisplay.textContent = displayTimezone;
                    
                    // Show detection hint if timezone doesn't match browser timezone
                    const browserTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                    if (volunteerTimezone !== browserTimezone) {
                        console.log(`Timezone mismatch detected. Saved: ${volunteerTimezone}, Browser: ${browserTimezone}`);
                    }
                    
                    console.log('Loaded volunteer timezone:', volunteerTimezone);
                })
                .catch(error => {
                    console.error('Error loading volunteer timezone:', error);
                    // Fallback to browser detected timezone
                    volunteerTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                    const displayTimezone = formatTimezoneDisplay(volunteerTimezone);
                    volunteerTimezoneDisplay.textContent = displayTimezone + ' (detected)';
                });
        }
        
        function formatTimezoneDisplay(timezone) {
            try {
                const now = new Date();
                const tzString = now.toLocaleString('en-US', { timeZone: timezone, timeZoneName: 'short' }).split(' ').pop();
                
                // Map common timezones to user-friendly names
                const timezoneMap = {
                    'America/New_York': 'Eastern Time (US & Canada)',
                    'America/Chicago': 'Central Time (US & Canada)',
                    'America/Denver': 'Mountain Time (US & Canada)',
                    'America/Los_Angeles': 'Pacific Time (US & Canada)',
                    'America/Toronto': 'Toronto, Montreal',
                    'Europe/London': 'London, Dublin',
                    'Europe/Paris': 'Paris, Berlin, Rome',
                    'Africa/Nairobi': 'Nairobi, Kenya (EAT)',
                    'Asia/Dubai': 'Dubai, Abu Dhabi',
                    'Asia/Tokyo': 'Tokyo, Osaka',
                    'Australia/Sydney': 'Sydney, Melbourne'
                };
                
                return timezoneMap[timezone] || `${timezone.replace('_', ' ')} (${tzString})`;
            } catch (e) {
                return timezone.replace('_', ' ');
            }
        }
        
        // --- Event Handlers ---
        prevMonthBtn.addEventListener('click', () => {
            // Don't allow going to past months
            const today = new Date();
            if (currentMonth === today.getMonth() && currentYear === today.getFullYear()) {
                return;
            }
            
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar();
        });
        
        nextMonthBtn.addEventListener('click', () => {
            // Calculate 3-month limit from today
            const today = new Date();
            const threeMonthsFromToday = new Date(today);
            threeMonthsFromToday.setMonth(today.getMonth() + 3);
            
            // Check if next month would exceed 3-month window
            let nextMonth = currentMonth + 1;
            let nextYear = currentYear;
            if (nextMonth > 11) {
                nextMonth = 0;
                nextYear++;
            }
            
            const nextMonthDate = new Date(nextYear, nextMonth, 1);
            if (nextMonthDate > threeMonthsFromToday) {
                return; // Don't allow navigation beyond 3-month window
            }
            
            currentMonth = nextMonth;
            currentYear = nextYear;
            renderCalendar();
        });
        
        confirmBtn.addEventListener('click', () => {
            if (!selectedDate || !selectedTimeSlot) {
                showNotification('Please select a date and time', 'error');
                return;
            }
            
            // Set the selected date and time for the meeting
            const meetingDate = new Date(selectedDate);
            meetingDate.setHours(selectedTimeSlot.hour, selectedTimeSlot.minute);
            
            // Update modal with selected date and time
            modalDate.textContent = formatDate(meetingDate);
            modalTime.textContent = formatTime(selectedTimeSlot.hour, selectedTimeSlot.minute);
            
            // Show confirmation modal
            confirmModal.classList.remove('hidden');
        });
        
        modalCancel.addEventListener('click', () => {
            confirmModal.classList.add('hidden');
        });
        
        modalConfirm.addEventListener('click', () => {
            // Hide modal
            confirmModal.classList.add('hidden');
            
            // Get student ID from URL
            const params = getUrlParams();
            if (!params) return;
            
            // Set the selected date and time for the meeting
            const meetingDate = new Date(selectedDate);
            meetingDate.setHours(selectedTimeSlot.hour, selectedTimeSlot.minute);
            
            // Use volunteer's saved timezone
            const timezone = volunteerTimezone;
            
            // Prepare meeting data
            const meetingData = {
                studentId: studentData.id, // Use the numeric ID from the API response
                scheduledTime: meetingDate.toISOString(),
                timezone: timezone,
                eatTime: {
                    hour: selectedTimeSlot.eatHour,
                    minute: selectedTimeSlot.eatMinute
                }
            };
            
            console.log('Sending meeting data with numeric studentId:', meetingData.studentId);
            
            // API endpoint and method
            let endpoint = '/api/v1/meetings';
            let method = 'POST';
            
            // If rescheduling, update the endpoint and method
            if (isRescheduling && meetingId) {
                endpoint = `/api/v1/meetings/${meetingId}`;
                method = 'PUT';
            }
            
            // Send API request to schedule or reschedule the meeting using JWT authentication
            TalkTimeAuth.authenticatedRequest(endpoint, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(meetingData)
            })
                .then(response => {
                    if (!response.ok) {
                        // Handle different error status codes
                        return response.json().then(errorData => {
                            if (response.status === 403) {
                                if (errorData.error && errorData.error.includes('3-meeting limit')) {
                                    throw new Error(`You have reached the 3-meeting limit with this student (${errorData.meetingCount}/${errorData.limit}). This ensures all students get equal opportunities to practice with different volunteers.`);
                                } else {
                                    throw new Error('Not authorized: This student already has an active meeting scheduled. Please cancel the existing meeting before scheduling a new one.');
                                }
                            } else if (response.status === 409) {
                                throw new Error('This student already has a meeting scheduled for this date. Please choose a different date.');
                            } else {
                                throw new Error(errorData.error || 'Failed to schedule meeting');
                            }
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    // Show success notification
                    showNotification(isRescheduling ? 'Meeting rescheduled successfully' : 'Meeting scheduled successfully');
                    
                    // If this is a reschedule, immediately trigger the reschedule sound
                    if (isRescheduling) {
                        console.log('ðŸ”Š Triggering reschedule sound manually...');
                        
                        // Method 1: Direct sound event trigger
                        if (document.dispatchEvent) {
                            document.dispatchEvent(new CustomEvent('talktimeNotificationSent', {
                                detail: {
                                    type: 'meeting_rescheduled',
                                    priority: 'high',
                                    metadata: {
                                        meeting_id: meetingId,
                                        action: 'reschedule_confirmed'
                                    },
                                    source: 'schedule_page',
                                    force_play: true
                                }
                            }));
                        }
                        
                        // Method 2: Direct sound manager call
                        if (window.talkTimeNotificationSoundManager) {
                            window.talkTimeNotificationSoundManager.playSound('meeting_rescheduled', { 
                                forcePlay: true,
                                source: 'schedule_confirmation' 
                            }).catch(err => console.log('Sound play failed:', err));
                        }
                        
                        // Method 3: Realtime notifications call
                        if (window.realtimeNotifications && window.realtimeNotifications.playNotificationSound) {
                            window.realtimeNotifications.playNotificationSound({
                                sound_type: 'meeting_rescheduled',
                                priority: 'high',
                                notification: { type: 'meeting_rescheduled' },
                                source: 'schedule_confirmation'
                            });
                        }
                        
                        console.log('ðŸ”Š Reschedule sound triggered via multiple methods');
                    }
                    
                    // Increase redirect delay to allow Socket.IO events to be received and sounds to play
                    const redirectDelay = isRescheduling ? 3000 : 1500; // 3 seconds for reschedule, 1.5 for new meetings
                    
                    setTimeout(() => {
                        window.location.href = `/volunteer/dashboard/student-detail.html?id=${params.studentId}&admission=${params.studentAdmission}&name=${encodeURIComponent(params.studentName)}`;
                    }, redirectDelay);
                })
                .catch(error => {
                    console.error('Error scheduling meeting:', error);
                    // Display the specific error message
                    showNotification(error.message || 'Failed to schedule meeting. Please try again.', 'error');
                    
                    // If it's a 403 error (student already has a meeting), redirect back to student detail page after 3 seconds
                    if (error.message && error.message.includes('already has an active meeting')) {
                        setTimeout(() => {
                            window.location.href = `/volunteer/dashboard/student-detail.html?id=${params.studentId}&admission=${params.studentAdmission}&name=${encodeURIComponent(params.studentName)}`;
                        }, 3000);
                    }
                });
        });
        
        // Profile dropdown toggle
        document.addEventListener('click', e => {
            if (profileBtn && profileBtn.contains(e.target)) {
                console.log('Profile button clicked');
                e.stopPropagation();
                
                const isHidden = profileDropdown.classList.contains('hidden');
                console.log('Dropdown is currently hidden:', isHidden);
                
                if (isHidden) {
                    // Show dropdown
                    profileDropdown.classList.remove('hidden');
                    profileDropdown.classList.remove('opacity-0');
                    profileDropdown.classList.remove('-translate-y-2');
                    console.log('Showing dropdown');
                } else {
                    // Hide dropdown
                    profileDropdown.classList.add('hidden');
                    profileDropdown.classList.add('opacity-0');
                    profileDropdown.classList.add('-translate-y-2');
                    console.log('Hiding dropdown');
                }
            } else if (profileDropdown && !profileDropdown.contains(e.target) && !profileDropdown.classList.contains('hidden')) {
                console.log('Clicking outside, closing dropdown');
                profileDropdown.classList.add('hidden');
                profileDropdown.classList.add('opacity-0');
                profileDropdown.classList.add('-translate-y-2');
            }
        });
        
        // --- Initialize Authentication ---
        window.TalkTimeAuth = new TalkTimeJWTAuth('volunteer');
        
        // --- Initialize Real-time Notifications ---
        if (typeof RealtimeNotifications !== 'undefined') {
            window.realtimeNotifications = new RealtimeNotifications('volunteer');
            window.realtimeNotifications.initialize().then(() => {
                console.log('Real-time notifications initialized on schedule page');
                
                // Listen for meeting notifications
                window.realtimeNotifications.on('newNotification', (notification) => {
                    if (notification.type === 'meeting_scheduled' || notification.type === 'meeting_rescheduled') {
                        console.log('Meeting notification received:', notification);
                        showNotification(notification.message, 'success');
                    }
                });
                
                // Add specific listener for meeting-rescheduled Socket.IO events
                if (window.realtimeNotifications.socket) {
                    window.realtimeNotifications.socket.on('meeting-rescheduled', (data) => {
                        console.log('ðŸ”” Schedule page received meeting-rescheduled event:', data);
                        
                        // Trigger reschedule sound
                        if (window.realtimeNotifications.playNotificationSound) {
                            window.realtimeNotifications.playNotificationSound({
                                sound_type: 'meeting_rescheduled',
                                priority: 'high',
                                notification: { type: 'meeting_rescheduled' },
                                metadata: data,
                                source: 'socket_event_schedule_page'
                            });
                        }
                        
                        // Show toast notification
                        showNotification('Meeting rescheduled successfully! ðŸ””', 'success');
                    });
                } else {
                    console.log('Socket.IO not available on schedule page, manual sound triggers will be used');
                }
            }).catch(error => {
                console.error('Failed to initialize real-time notifications:', error);
            });
        }
        
        // --- Initialization ---
        loadStudentData();
        renderCalendar();
    });
    </script>

    <!-- Global Functions -->
    <script>
        // Auto-detect timezone function (must be global for onclick handler)
        function autoDetectTimezone() {
            const browserTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            console.log('Auto-detecting timezone:', browserTimezone);
            
            // Update the display immediately
            volunteerTimezone = browserTimezone;
            
            // Format timezone display
            function formatTimezoneDisplay(timezone) {
                try {
                    const now = new Date();
                    const tzString = now.toLocaleString('en-US', { timeZone: timezone, timeZoneName: 'short' }).split(' ').pop();
                    
                    // Map common timezones to user-friendly names
                    const timezoneMap = {
                        'America/New_York': 'Eastern Time (US & Canada)',
                        'America/Chicago': 'Central Time (US & Canada)',
                        'America/Denver': 'Mountain Time (US & Canada)',
                        'America/Los_Angeles': 'Pacific Time (US & Canada)',
                        'America/Toronto': 'Toronto, Montreal',
                        'Europe/London': 'London, Dublin',
                        'Europe/Paris': 'Paris, Berlin, Rome',
                        'Africa/Nairobi': 'Nairobi, Kenya (EAT)',
                        'Asia/Dubai': 'Dubai, Abu Dhabi',
                        'Asia/Tokyo': 'Tokyo, Osaka',
                        'Australia/Sydney': 'Sydney, Melbourne'
                    };
                    
                    return timezoneMap[timezone] || `${timezone.replace('_', ' ')} (${tzString})`;
                } catch (e) {
                    return timezone.replace('_', ' ');
                }
            }
            
            const displayTimezone = formatTimezoneDisplay(volunteerTimezone);
            const displayElement = document.getElementById('volunteer-timezone-display');
            if (displayElement) {
                displayElement.textContent = displayTimezone + ' (auto-detected)';
            }
            
            // Show success message
            const notification = document.getElementById('notification');
            if (notification) {
                notification.textContent = 'Timezone auto-detected and updated!';
                notification.className = 'fixed bottom-5 right-5 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg';
                
                setTimeout(() => {
                    notification.className = 'hidden fixed bottom-5 right-5 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg';
                }, 3000);
            }
            
            console.log('Timezone updated to:', volunteerTimezone);
        }
    </script>

    <!-- Initialize Navigation -->
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // Register notification service worker
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.register('/notification-sw.js');
                    console.log('Notification service worker registered:', registration);
                    
                    // Request notification permission if not already granted
                    if (Notification.permission === 'default') {
                        const permission = await Notification.requestPermission();
                        console.log('Notification permission:', permission);
                    }
                } catch (error) {
                    console.error('Failed to register notification service worker:', error);
                }
            }
            
            // Initialize navigation with authentication requirement
            await VolunteerNavLoader.init(true);
        });
    </script>
</body>
</html>
