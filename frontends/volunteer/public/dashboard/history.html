<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>TalkTime - Call History | Volunteer Dashboard</title>
    <!-- Early auth redirect - prevents FOUC on protected pages -->
    <script>
        if (!localStorage.getItem('volunteer_talktime_access_token')) {
            window.location.replace('/volunteer/login');
        }
    </script>
    <!-- Brand Theme System -->
    <link rel="stylesheet" href="/shared/css/brand-theme.css">
    <link rel="icon" type="image/x-icon" href="/talktime.ico">
    <meta name="description" content="View your past TalkTime English practice sessions with Maasai students. Track your impact and review feedback from previous conversations.">
    <link rel="canonical" href="https://talktime.adeafoundation.org/volunteer/dashboard/history">
    <meta name="robots" content="index, follow">

    <!-- CSS (all sync to prevent layout shift) -->
    <link rel="stylesheet" href="/shared/css/tailwind.min.css">
    <link rel="stylesheet" href="/shared/fonts/google/fonts.css">
    <link rel="stylesheet" href="/shared/fonts/fontawesome/all.min.css">
    <link rel="stylesheet" href="/volunteer/css/main.css">
    <link rel="stylesheet" href="/volunteer/css/responsive-framework.css">
    <link rel="stylesheet" href="/volunteer/css/responsive-forms.css">
    <link rel="stylesheet" href="/volunteer/css/enhanced-mobile-nav.css">
    <link rel="stylesheet" href="/volunteer/css/volunteer-dashboard.css">

    <!-- Deferred Scripts (non-render-blocking) -->
    <script defer src="/shared/js/brand-config.js"></script>
    <script defer src="/volunteer/partials/nav-loader.js"></script>
    <script defer src="/volunteer/js/dashboard-nav.js"></script>
    <script defer src="/volunteer/js/modal-utils.js"></script>
    <script defer src="/shared/js/jwt-auth-utils.js"></script>
    <script defer src="/shared/js/newsletter-widget.js"></script>

    <style>
        /* Page-specific styles - Most styles now in volunteer-dashboard.css */

        /* History filter buttons */
        .history-filter-btn {
            min-height: 44px;
        }

        /* Star Rating */
        .star-rating .fa-star {
            color: #d1d5db;
            cursor: pointer;
            transition: color 0.2s ease;
        }
        .star-rating:hover .fa-star {
            color: #f59e0b;
        }
        .star-rating .fa-star:hover ~ .fa-star {
            color: #d1d5db;
        }
        .star-rating .fa-star.selected {
            color: #f59e0b;
        }
    </style>
</head>
<body class="dashboard-page" style="opacity:0">
    <!-- Background Blobs - Hidden on mobile for performance -->
    <div class="blob bg-brand-primary w-96 h-96 top-0 left-0 -translate-x-1/2 -translate-y-1/2"></div>
    <div class="blob bg-brand-secondary w-96 h-96 bottom-0 right-0 translate-x-1/2 translate-y-1/2"></div>

    <!-- Dashboard Navigation Container -->
    <div id="dashboard-nav-container"></div>

    <!-- Main Content Area -->
    <main class="content-area">
        <div class="section-header">
            <i class="fas fa-history text-brand-primary"></i>
            Call History & Feedback
        </div>

        <!-- Summary Cards -->
        <div class="grid grid-cols-3 gap-2 sm:gap-3 mb-4">
            <div class="glass-bg p-2 sm:p-3 rounded-xl text-center">
                <div class="text-lg sm:text-xl font-bold text-success" id="successful-count">0</div>
                <div class="text-xs text-gray-600">Successful</div>
            </div>
            <div class="glass-bg p-2 sm:p-3 rounded-xl text-center">
                <div class="text-lg sm:text-xl font-bold text-error" id="missed-count">0</div>
                <div class="text-xs text-gray-600">Missed</div>
            </div>
            <div class="glass-bg p-2 sm:p-3 rounded-xl text-center">
                <div class="text-lg sm:text-xl font-bold text-brand-primary" id="cancelled-count">0</div>
                <div class="text-xs text-gray-600">Cancelled</div>
            </div>
        </div>

        <!-- Filter Tabs -->
        <div class="glass-bg p-1.5 rounded-xl mb-4">
            <div class="flex flex-wrap gap-1">
                <button class="history-filter-btn flex-1 min-w-0 py-2 px-2 sm:px-3 rounded-lg font-medium transition-colors bg-brand-primary text-white text-sm" data-filter="successful">
                    <i class="fas fa-check-circle mr-1 hidden sm:inline"></i><span class="truncate">Successful</span> (<span id="tab-successful-count">0</span>)
                </button>
                <button class="history-filter-btn flex-1 min-w-0 py-2 px-2 sm:px-3 rounded-lg font-medium transition-colors text-gray-600 hover:bg-white/50 text-sm" data-filter="missed">
                    <i class="fas fa-phone-slash mr-1 hidden sm:inline"></i><span class="truncate">Missed</span> (<span id="tab-missed-count">0</span>)
                </button>
                <button class="history-filter-btn flex-1 min-w-0 py-2 px-2 sm:px-3 rounded-lg font-medium transition-colors text-gray-600 hover:bg-white/50 text-sm" data-filter="cancelled">
                    <i class="fas fa-ban mr-1 hidden sm:inline"></i><span class="truncate">Cancelled</span> (<span id="tab-cancelled-count">0</span>)
                </button>
            </div>
        </div>

        <!-- History Content -->
        <div id="history-content" class="flex flex-col gap-3">
            <!-- Dynamic content will be inserted here -->
        </div>

        <!-- Pagination -->
        <div id="history-pagination" class="flex flex-col items-center glass-bg p-3 sm:p-4 rounded-xl mt-4 gap-2">
            <div class="text-sm text-gray-600 text-center">
                Showing <span id="history-start">0</span>-<span id="history-end">0</span> of <span id="history-total">0</span>
            </div>
            <div class="flex items-center gap-2">
                <button id="history-prev" class="w-10 h-10 flex items-center justify-center rounded-lg bg-gray-200 text-gray-600 hover:bg-gray-300 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    <i class="fas fa-chevron-left"></i>
                </button>
                <span id="history-page-info" class="px-3 py-1 text-sm text-gray-600 whitespace-nowrap">1/1</span>
                <button id="history-next" class="w-10 h-10 flex items-center justify-center rounded-lg bg-gray-200 text-gray-600 hover:bg-gray-300 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>

        <!-- Feedback Section -->
        <div id="feedback-container" class="hidden mt-6"></div>
    </main>
    
    <!-- Notification Toast -->
    <div id="notification" class="hidden fixed bottom-5 right-5 bg-success text-white px-6 py-3 rounded-lg shadow-lg"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        document.body.classList.add('page-ready');
        // --- DOM Elements ---
        const feedbackContainer = document.getElementById('feedback-container');
        const notificationEl = document.getElementById('notification');
        const historyContent = document.getElementById('history-content');
        const historyPagination = document.getElementById('history-pagination');
        const historyPrevBtn = document.getElementById('history-prev');
        const historyNextBtn = document.getElementById('history-next');
        const historyFilterBtns = document.querySelectorAll('.history-filter-btn');
        let currentFilter = 'successful';
        let currentPage = 1;
        const itemsPerPage = 5;
        const historyState = {
            currentFilter: 'successful',
            currentPage: 1,
            itemsPerPage: 5,
            data: {
                successful: [],
                missed: [],
                cancelled: []
            }
        };

        // --- Utility Functions ---
        function showNotification(message, type = 'success') {
            notificationEl.textContent = message;
            notificationEl.className = `fixed bottom-5 right-5 px-6 py-3 rounded-lg shadow-lg ${type === 'success' ? 'bg-success text-white' : 'bg-error text-white'}`;
            notificationEl.classList.remove('hidden');
            
            setTimeout(() => {
                notificationEl.classList.add('hidden');
            }, 5000);
        }

        // Initialize TalkTime Auth for volunteers
        window.TalkTimeAuth = new TalkTimeJWTAuth('volunteer');
        
        // --- Data Loading ---
        function loadDashboardData() {
            // Check JWT authentication
            if (!window.TalkTimeAuth.isAuthenticated()) {
                console.error('Volunteer not authenticated');
                showNotification('Please log in to access your dashboard.', 'error');
                window.location.href = '/volunteer/login.html';
                return;
            }

            // Fetch volunteer dashboard data from the backend API
            window.TalkTimeAuth.authenticatedRequest('/api/v1/volunteers/dashboard-data', {
                method: 'GET'
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Dashboard data received:', data);
                    
                    // Update badge counts in the dashboard nav
                    if (window.VolunteerDashboardNav && data.meetings && data.meetings.upcoming) {
                        window.VolunteerDashboardNav.updateUpcomingBadge(data.meetings.upcoming.length);
                    }
                    
                    // Update history data and render with pagination
                    historyState.data = {
                        successful: data.meetings.past || [],
                        missed: data.meetings.missed || [],
                        cancelled: data.meetings.cancelled || []
                    };
                    
                    // Update summary counts
                    updateHistoryCounts(
                        historyState.data.successful.length,
                        historyState.data.missed.length,
                        historyState.data.cancelled.length
                    );
                    
                    // Initialize filter buttons and show default filter
                    initializeHistoryFilters();
                    showHistoryFilter(historyState.currentFilter);

                    // Load feedback if available
                    if (feedbackContainer && data.feedback && data.feedback.length > 0) {
                        renderFeedback(data.feedback);
                    }
                })
                .catch(error => {
                    console.error('Error loading dashboard data:', error);
                    showNotification('Failed to load dashboard data. Please refresh the page.', 'error');
                });
        }
        
        // New pagination and filtering functions
        function updateHistoryCounts(successful, missed, cancelled) {
            document.getElementById('successful-count').textContent = successful;
            document.getElementById('missed-count').textContent = missed;
            document.getElementById('cancelled-count').textContent = cancelled;
            
            // Update tab counts
            document.getElementById('tab-successful-count').textContent = successful;
            document.getElementById('tab-missed-count').textContent = missed;
            document.getElementById('tab-cancelled-count').textContent = cancelled;
        }
        
        function initializeHistoryFilters() {
            historyFilterBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const filter = btn.dataset.filter;
                    showHistoryFilter(filter, true);
                });
            });
            
            // Pagination event listeners
            historyPrevBtn.addEventListener('click', () => {
                if (historyState.currentPage > 1) {
                    historyState.currentPage--;
                    showHistoryFilter(historyState.currentFilter, false);
                }
            });
            
            historyNextBtn.addEventListener('click', () => {
                const totalPages = Math.ceil(historyState.data[historyState.currentFilter].length / historyState.itemsPerPage);
                if (historyState.currentPage < totalPages) {
                    historyState.currentPage++;
                    showHistoryFilter(historyState.currentFilter, false);
                }
            });
        }
        
        function showHistoryFilter(filter, resetPage = true) {
            historyState.currentFilter = filter;
            if (resetPage) {
                historyState.currentPage = 1;
            }
            
            // Update active tab
            historyFilterBtns.forEach(btn => {
                if (btn.dataset.filter === filter) {
                    btn.className = 'history-filter-btn flex-1 min-w-0 py-2 px-2 sm:px-3 rounded-lg font-medium transition-colors bg-brand-primary text-white text-sm';
                } else {
                    btn.className = 'history-filter-btn flex-1 min-w-0 py-2 px-2 sm:px-3 rounded-lg font-medium transition-colors text-gray-600 hover:bg-white/50 text-sm';
                }
            });
            
            const meetings = historyState.data[filter] || [];
            const totalItems = meetings.length;
            const totalPages = Math.ceil(totalItems / historyState.itemsPerPage);
            
            // Ensure current page is within valid range
            if (historyState.currentPage > totalPages && totalPages > 0) {
                historyState.currentPage = totalPages;
            }
            
            const startIndex = (historyState.currentPage - 1) * historyState.itemsPerPage;
            const endIndex = Math.min(startIndex + historyState.itemsPerPage, totalItems);
            const pageData = meetings.slice(startIndex, endIndex);
            
            updateHistoryContent(pageData, filter);
            updateHistoryPagination(totalItems, startIndex + 1, endIndex, historyState.currentPage, totalPages);
        }
        
        function updateHistoryContent(meetings, filter) {
            if (!meetings || meetings.length === 0) {
                const emptyMessages = {
                    successful: 'No successful meetings yet.',
                    missed: 'No missed meetings.',
                    cancelled: 'No cancelled meetings.'
                };
                historyContent.innerHTML = `<p class="text-gray-500 text-center py-8">${emptyMessages[filter]}</p>`;
                return;
            }
            
            const statusConfig = {
                successful: { icon: 'fas fa-check-circle', color: 'text-green-500', label: 'Completed' },
                missed: { icon: 'fas fa-phone-slash', color: 'text-red-500', label: 'Missed' },
                cancelled: { icon: 'fas fa-ban', color: 'text-brand-primary', label: 'Cancelled' }
            };
            
            const config = statusConfig[filter];
            
            const meetingsHtml = meetings.map(meeting => {
                const studentName = meeting.studentName || meeting.name || meeting.student_name || meeting.full_name || 'Unknown Student';
                const meetingTime = meeting.scheduledTime || meeting.scheduled_time || meeting.time;
                const meetingDate = new Date(meetingTime);

                return `
                    <div class="glass-bg p-4 rounded-xl w-full">
                        <div class="flex flex-col gap-3">
                            <div class="flex-1 min-w-0">
                                <h3 class="font-semibold text-base sm:text-lg text-gray-800 truncate">Call with ${studentName}</h3>
                                <p class="text-gray-600 text-sm mt-1">${meetingDate.toLocaleDateString()} at ${meetingDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</p>
                                <div class="mt-2 flex items-center">
                                    <i class="${config.icon} mr-2 ${config.color}"></i>
                                    <span class="text-sm text-gray-600">${config.label}</span>
                                </div>
                            </div>
                            ${filter === 'successful' ? `
                                <div class="flex">
                                    <button class="px-3 py-2 bg-brand-light text-brand-primary rounded-lg text-sm hover:bg-brand-primary hover:text-white transition-colors">
                                        <i class="fas fa-redo mr-1"></i>Reschedule
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            historyContent.innerHTML = meetingsHtml;
        }
        
        function updateHistoryPagination(totalItems, startItem, endItem, currentPage, totalPages) {
            document.getElementById('history-start').textContent = totalItems > 0 ? startItem : 0;
            document.getElementById('history-end').textContent = endItem;
            document.getElementById('history-total').textContent = totalItems;
            document.getElementById('history-page-info').textContent = `Page ${currentPage} of ${Math.max(totalPages, 1)}`;
            
            historyPrevBtn.disabled = currentPage <= 1;
            historyNextBtn.disabled = currentPage >= totalPages || totalPages === 0;
            
            if (totalItems === 0) {
                historyPagination.style.display = 'none';
            } else {
                historyPagination.style.display = 'flex';
            }
        }

        // Function to render feedback
        function renderFeedback(feedback) {
            if (!feedback || feedback.length === 0) {
                feedbackContainer.classList.add('hidden');
                return;
            }

            const feedbackHtml = `
                <div class="glass-bg p-4 sm:p-6 rounded-xl mb-6">
                    <h4 class="text-base sm:text-lg font-semibold text-gray-800 mb-3"><i class="fas fa-comment-alt text-brand-primary mr-2"></i>Your Impact</h4>
                    <div class="space-y-4">
                        <div class="p-3 sm:p-4 bg-brand-light rounded-lg">
                            <p class="text-gray-700 mb-2 text-sm sm:text-base">You've helped <strong>${feedback.length}</strong> students improve their English skills!</p>
                            <div class="flex flex-wrap items-center gap-2">
                                <div class="text-yellow-500 flex">
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star-half-alt"></i>
                                </div>
                                <span class="text-gray-700 font-semibold text-sm sm:text-base">4.5 average rating</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            feedbackContainer.innerHTML = feedbackHtml;
            feedbackContainer.classList.remove('hidden');
        }

        // --- Event Listeners ---
        
        // --- Initial Load ---
        loadDashboardData();
    });
    </script>

    <!-- Initialize Navigation -->
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // Initialize navigation with authentication requirement
            await VolunteerNavLoader.init(true);
        });
    </script>
</body>
</html>
