<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TalkTime - Call History | Volunteer Dashboard</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <meta name="description" content="View your past TalkTime English practice sessions with Maasai students. Track your impact and review feedback from previous conversations.">
    <link rel="canonical" href="/volunteer/dashboard/history">
    <meta name="robots" content="index, follow">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts: Inter & Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Poppins:wght@600;700;800&display=swap" rel="stylesheet">
    
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <!-- Navigation Loader -->
    <script src="/volunteer/partials/nav-loader.js"></script>
    
    <!-- Modal Utilities -->
    <script src="/volunteer/js/modal-utils.js"></script>
    
    <!-- JWT Authentication Utility -->
    <script src="/shared/js/jwt-auth-utils.js"></script>
    
    <style>
        /* Base styles matching the landing page */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4ff;
            overflow-x: hidden;
        }
        .font-poppins {
            font-family: 'Poppins', sans-serif;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #f5f3ff, #fdf2f8);
        }
        .glass-bg {
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .modal-glass-bg {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .gradient-text {
            background-image: linear-gradient(to right, #4f46e5, #a855f7);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        .section-heading {
             background-image: linear-gradient(to right, #ec4899, #8b5cf6);
             -webkit-background-clip: text;
             background-clip: text;
             color: transparent;
        }
        .blob {
            position: fixed;
            border-radius: 50%;
            filter: blur(100px);
            opacity: 0.3;
            z-index: -1;
        }

        /* Page Transition */
        .page, .tab-pane {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        .page-hidden, .tab-pane-hidden {
            opacity: 0;
            pointer-events: none;
            position: absolute;
            transform: translateY(10px);
            top: 0;
            left: 0;
            width: 100%;
        }
        
        /* Star Rating */
        .star-rating .fa-star {
            color: #d1d5db; /* gray-300 */
            cursor: pointer;
            transition: color 0.2s ease;
        }
        .star-rating:hover .fa-star {
            color: #f59e0b; /* yellow-500 */
        }
        .star-rating .fa-star:hover ~ .fa-star {
            color: #d1d5db;
        }
        .star-rating .fa-star.selected,
        .star-rating .fa-star.selected ~ .fa-star {
             color: #d1d5db;
        }
        .star-rating .fa-star.selected {
             color: #f59e0b;
        }
        
        /* Modal Styles */
        .modal {
            transition: opacity 300ms ease-in-out;
        }
        .modal .modal-content {
            transition: transform 300ms ease-in-out;
        }
        .profile-dropdown, .options-menu {
            transition: all 0.3s ease-in-out;
        }
        
        /* Upcoming badge */
        .upcoming-badge {
            position: absolute;
            top: 0.25rem;
            right: 0.25rem;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background-color: #22c55e;
            color: white;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            border: 2px solid white;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }
    </style>
</head>
<body>
    <!-- Background Blobs -->
    <div class="blob bg-blue-300 w-96 h-96 top-0 left-0 -translate-x-1/2 -translate-y-1/2"></div>
    <div class="blob bg-purple-300 w-96 h-96 bottom-0 right-0 translate-x-1/2 translate-y-1/2"></div>
    
    <!-- Navigation Container -->
    <div id="nav-container">
        <!-- Navigation will be loaded dynamically -->
    </div>

    <!-- Sticky Navigation Bar -->
    <div id="page-nav-sticky" class="hidden sticky top-16 z-30 glass-bg border-b border-white/20 shadow-sm">
        <div class="container mx-auto px-4 py-3">
            <div id="page-nav-content" class="flex justify-between items-center">
                <!-- Content will be dynamically inserted here -->
            </div>
        </div>
    </div>

    <main class="container mx-auto px-4 py-8">
        <!-- Dashboard Page -->
        <div id="page-dashboard" class="page w-full">

            <!-- Tab Content -->
            <div class="relative max-w-3xl mx-auto">
                <div id="dashboard-history" class="tab-pane">
                    <h1 class="text-3xl md:text-4xl font-bold mb-6 text-gray-800 text-center">Call History & Feedback</h1>
                    
                    <!-- Summary Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="glass-bg p-4 rounded-xl text-center">
                            <div class="text-2xl font-bold text-green-600" id="successful-count">0</div>
                            <div class="text-sm text-gray-600">Successful Calls</div>
                        </div>
                        <div class="glass-bg p-4 rounded-xl text-center">
                            <div class="text-2xl font-bold text-red-600" id="missed-count">0</div>
                            <div class="text-sm text-gray-600">Missed Calls</div>
                        </div>
                        <div class="glass-bg p-4 rounded-xl text-center">
                            <div class="text-2xl font-bold text-orange-600" id="cancelled-count">0</div>
                            <div class="text-sm text-gray-600">Cancelled Calls</div>
                        </div>
                    </div>
                    
                    <!-- Filter Tabs -->
                    <div class="glass-bg p-1 rounded-xl mb-6">
                        <div class="flex space-x-1">
                            <button class="history-filter-btn flex-1 py-2 px-4 rounded-lg font-medium transition-colors bg-blue-600 text-white" data-filter="successful">
                                <i class="fas fa-check-circle mr-2"></i>Successful (<span id="tab-successful-count">0</span>)
                            </button>
                            <button class="history-filter-btn flex-1 py-2 px-4 rounded-lg font-medium transition-colors text-gray-600 hover:bg-white/50" data-filter="missed">
                                <i class="fas fa-phone-slash mr-2"></i>Missed (<span id="tab-missed-count">0</span>)
                            </button>
                            <button class="history-filter-btn flex-1 py-2 px-4 rounded-lg font-medium transition-colors text-gray-600 hover:bg-white/50" data-filter="cancelled">
                                <i class="fas fa-ban mr-2"></i>Cancelled (<span id="tab-cancelled-count">0</span>)
                            </button>
                        </div>
                    </div>
                    
                    <!-- History Content -->
                    <div id="history-content" class="space-y-4 mb-6">
                        <!-- Dynamic content will be inserted here -->
                    </div>
                    
                    <!-- Pagination -->
                    <div id="history-pagination" class="flex items-center justify-between glass-bg p-4 rounded-xl">
                        <div class="text-sm text-gray-600">
                            Showing <span id="history-start">0</span> to <span id="history-end">0</span> of <span id="history-total">0</span> meetings
                        </div>
                        <div class="flex space-x-2">
                            <button id="history-prev" class="px-3 py-1 rounded-lg bg-gray-200 text-gray-600 hover:bg-gray-300 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <span id="history-page-info" class="px-3 py-1 text-sm text-gray-600">Page 1 of 1</span>
                            <button id="history-next" class="px-3 py-1 rounded-lg bg-gray-200 text-gray-600 hover:bg-gray-300 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Feedback Section -->
                    <div id="feedback-container" class="hidden mt-6"></div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Notification Toast -->
    <div id="notification" class="hidden fixed bottom-5 right-5 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg"></div>

    <script>
    // Initialize shared sticky tabs
    document.addEventListener('DOMContentLoaded', function() {
        const sticky = document.getElementById('page-nav-sticky');
        const content = document.getElementById('page-nav-content');
        if (sticky && content) {
            content.innerHTML = `
                    <!-- Center: Tabs navigation on same line as right note -->
                    <nav class="flex justify-center space-x-4 mx-auto">
                        <a href="/volunteer/dashboard/students" class="tab-btn py-1 px-3 text-sm font-medium text-gray-600 border-b-2 border-transparent hover:text-gray-700 hover:border-gray-300 transition-all">
                            <div class="flex items-center space-x-1.5">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                                </svg>
                                <span>Students</span>
                            </div>
                        </a>
                        <a href="/volunteer/dashboard/upcoming" class="tab-btn py-1 px-3 text-sm font-medium text-gray-600 border-b-2 border-transparent hover:text-gray-700 hover:border-gray-300 transition-all relative">
                            <div class="flex items-center space-x-1.5">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                </svg>
                                <span>Upcoming</span>
                                <span id="upcoming-badge" class="upcoming-badge hidden"></span>
                            </div>
                        </a>
                        <a href="/volunteer/dashboard/history" class="tab-btn py-1 px-3 text-sm font-medium text-blue-600 border-b-2 border-blue-600 bg-blue-50/40 rounded-t transition-all">
                            <div class="flex items-center space-x-1.5">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <span>Call History</span>
                            </div>
                        </a>
                    </nav>
                    <div class="hidden md:flex items-center text-sm text-gray-600 whitespace-nowrap">
                        Kenya time window: 9:00–17:00 EAT
                    </div>
            `;
            sticky.classList.remove('hidden');
        }
    });
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM Elements ---
        const feedbackContainer = document.getElementById('feedback-container');
        const notificationEl = document.getElementById('notification');
        const profileBtn = document.getElementById('profile-btn');
        const profileDropdown = document.getElementById('profile-dropdown');
        const historyContent = document.getElementById('history-content');
        const historyPagination = document.getElementById('history-pagination');
        const upcomingBadge = document.getElementById('upcoming-badge');
        const historyPrevBtn = document.getElementById('history-prev');
        const historyNextBtn = document.getElementById('history-next');
        const historyFilterBtns = document.querySelectorAll('.history-filter-btn');
        let currentFilter = 'successful';
        let currentPage = 1;
        const itemsPerPage = 5;
        const historyState = {
            currentFilter: 'successful',
            currentPage: 1,
            itemsPerPage: 5,
            data: {
                successful: [],
                missed: [],
                cancelled: []
            }
        };

        // --- Utility Functions ---
        function showNotification(message, type = 'success') {
            notificationEl.textContent = message;
            notificationEl.className = `fixed bottom-5 right-5 px-6 py-3 rounded-lg shadow-lg ${type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'}`;
            notificationEl.classList.remove('hidden');
            
            setTimeout(() => {
                notificationEl.classList.add('hidden');
            }, 5000);
        }

        // Initialize TalkTime Auth for volunteers
        window.TalkTimeAuth = new TalkTimeJWTAuth('volunteer');
        
        // --- Data Loading ---
        function loadDashboardData() {
            // Check JWT authentication
            if (!window.TalkTimeAuth.isAuthenticated()) {
                console.error('Volunteer not authenticated');
                showNotification('Please log in to access your dashboard.', 'error');
                window.location.href = '/volunteer/login.html';
                return;
            }

            // Fetch volunteer dashboard data from the backend API
            window.TalkTimeAuth.authenticatedRequest('/api/v1/volunteers/dashboard-data', {
                method: 'GET'
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Dashboard data received:', data);
                    
                    // Show badge on upcoming tab if there are upcoming meetings
                    if (upcomingBadge && data.meetings && data.meetings.upcoming && data.meetings.upcoming.length > 0) {
                        upcomingBadge.textContent = data.meetings.upcoming.length;
                        upcomingBadge.classList.remove('hidden');
                    }
                    
                    // Update history data and render with pagination
                    historyState.data = {
                        successful: data.meetings.past || [],
                        missed: data.meetings.missed || [],
                        cancelled: data.meetings.cancelled || []
                    };
                    
                    // Update summary counts
                    updateHistoryCounts(
                        historyState.data.successful.length,
                        historyState.data.missed.length,
                        historyState.data.cancelled.length
                    );
                    
                    // Initialize filter buttons and show default filter
                    initializeHistoryFilters();
                    showHistoryFilter(historyState.currentFilter);

                    // Load feedback if available
                    if (feedbackContainer && data.feedback && data.feedback.length > 0) {
                        renderFeedback(data.feedback);
                    }
                })
                .catch(error => {
                    console.error('Error loading dashboard data:', error);
                    showNotification('Failed to load dashboard data. Please refresh the page.', 'error');
                });
        }
        
        // New pagination and filtering functions
        function updateHistoryCounts(successful, missed, cancelled) {
            document.getElementById('successful-count').textContent = successful;
            document.getElementById('missed-count').textContent = missed;
            document.getElementById('cancelled-count').textContent = cancelled;
            
            // Update tab counts
            document.getElementById('tab-successful-count').textContent = successful;
            document.getElementById('tab-missed-count').textContent = missed;
            document.getElementById('tab-cancelled-count').textContent = cancelled;
        }
        
        function initializeHistoryFilters() {
            historyFilterBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const filter = btn.dataset.filter;
                    showHistoryFilter(filter, true);
                });
            });
            
            // Pagination event listeners
            historyPrevBtn.addEventListener('click', () => {
                if (historyState.currentPage > 1) {
                    historyState.currentPage--;
                    showHistoryFilter(historyState.currentFilter, false);
                }
            });
            
            historyNextBtn.addEventListener('click', () => {
                const totalPages = Math.ceil(historyState.data[historyState.currentFilter].length / historyState.itemsPerPage);
                if (historyState.currentPage < totalPages) {
                    historyState.currentPage++;
                    showHistoryFilter(historyState.currentFilter, false);
                }
            });
        }
        
        function showHistoryFilter(filter, resetPage = true) {
            historyState.currentFilter = filter;
            if (resetPage) {
                historyState.currentPage = 1;
            }
            
            // Update active tab
            historyFilterBtns.forEach(btn => {
                if (btn.dataset.filter === filter) {
                    btn.className = 'history-filter-btn flex-1 py-2 px-4 rounded-lg font-medium transition-colors bg-blue-600 text-white';
                } else {
                    btn.className = 'history-filter-btn flex-1 py-2 px-4 rounded-lg font-medium transition-colors text-gray-600 hover:bg-white/50';
                }
            });
            
            const meetings = historyState.data[filter] || [];
            const totalItems = meetings.length;
            const totalPages = Math.ceil(totalItems / historyState.itemsPerPage);
            
            // Ensure current page is within valid range
            if (historyState.currentPage > totalPages && totalPages > 0) {
                historyState.currentPage = totalPages;
            }
            
            const startIndex = (historyState.currentPage - 1) * historyState.itemsPerPage;
            const endIndex = Math.min(startIndex + historyState.itemsPerPage, totalItems);
            const pageData = meetings.slice(startIndex, endIndex);
            
            updateHistoryContent(pageData, filter);
            updateHistoryPagination(totalItems, startIndex + 1, endIndex, historyState.currentPage, totalPages);
        }
        
        function updateHistoryContent(meetings, filter) {
            if (!meetings || meetings.length === 0) {
                const emptyMessages = {
                    successful: 'No successful meetings yet.',
                    missed: 'No missed meetings.',
                    cancelled: 'No cancelled meetings.'
                };
                historyContent.innerHTML = `<p class="text-gray-500 text-center py-8">${emptyMessages[filter]}</p>`;
                return;
            }
            
            const statusConfig = {
                successful: { icon: 'fas fa-check-circle', color: 'text-green-500', label: 'Completed' },
                missed: { icon: 'fas fa-phone-slash', color: 'text-red-500', label: 'Missed' },
                cancelled: { icon: 'fas fa-ban', color: 'text-orange-500', label: 'Cancelled' }
            };
            
            const config = statusConfig[filter];
            
            const meetingsHtml = meetings.map(meeting => {
                const studentName = meeting.student_full_name || meeting.full_name || 'Unknown Student';
                const meetingTime = meeting.scheduledTime || meeting.scheduled_time || meeting.time;
                const meetingDate = new Date(meetingTime);
                
                return `
                    <div class="glass-bg p-4 rounded-xl">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <h3 class="font-semibold text-lg text-gray-800">Call with ${studentName}</h3>
                                <p class="text-gray-600 text-sm">${meetingDate.toLocaleDateString()} at ${meetingDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</p>
                                <div class="mt-2 flex items-center">
                                    <i class="${config.icon} mr-2 ${config.color}"></i>
                                    <span class="text-sm text-gray-600">${config.label}</span>
                                </div>
                            </div>
                            ${filter === 'successful' ? `
                                <div class="flex space-x-2">
                                    <button class="px-3 py-1 bg-blue-100 text-blue-600 rounded-lg text-sm hover:bg-blue-200 transition-colors">
                                        <i class="fas fa-redo mr-1"></i>Reschedule
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            historyContent.innerHTML = meetingsHtml;
        }
        
        function updateHistoryPagination(totalItems, startItem, endItem, currentPage, totalPages) {
            document.getElementById('history-start').textContent = totalItems > 0 ? startItem : 0;
            document.getElementById('history-end').textContent = endItem;
            document.getElementById('history-total').textContent = totalItems;
            document.getElementById('history-page-info').textContent = `Page ${currentPage} of ${Math.max(totalPages, 1)}`;
            
            historyPrevBtn.disabled = currentPage <= 1;
            historyNextBtn.disabled = currentPage >= totalPages || totalPages === 0;
            
            if (totalItems === 0) {
                historyPagination.style.display = 'none';
            } else {
                historyPagination.style.display = 'flex';
            }
        }

        // Function to render feedback
        function renderFeedback(feedback) {
            if (!feedback || feedback.length === 0) {
                feedbackContainer.classList.add('hidden');
                return;
            }

            const feedbackHtml = `
                <div class="bg-white/60 p-6 rounded-xl shadow-sm mb-6">
                    <h4 class="text-lg font-semibold text-gray-800 mb-3"><i class="fas fa-comment-alt text-blue-500 mr-2"></i>Your Impact</h4>
                    <div class="space-y-4">
                        <div class="p-4 bg-blue-50 rounded-lg">
                            <p class="text-gray-700 mb-2">You've helped <strong>${feedback.length}</strong> students improve their English skills!</p>
                            <div class="flex items-center">
                                <div class="text-yellow-500 mr-2">
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star-half-alt"></i>
                                </div>
                                <span class="text-gray-700 font-semibold">4.5 average rating</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            feedbackContainer.innerHTML = feedbackHtml;
            feedbackContainer.classList.remove('hidden');
        }

        // --- Event Listeners ---
        document.addEventListener('click', e => {
            // Profile dropdown toggle
            if (profileBtn && profileBtn.contains(e.target)) {
                e.stopPropagation();
                profileDropdown.classList.toggle('hidden');
                profileDropdown.classList.toggle('opacity-0');
                profileDropdown.classList.toggle('-translate-y-2');
            } else if (profileDropdown && !profileDropdown.contains(e.target)) {
                profileDropdown.classList.add('hidden', 'opacity-0', '-translate-y-2');
            }
        });
        
        // --- Initial Load ---
        loadDashboardData();
    });
    </script>

    <!-- Initialize Navigation -->
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // Initialize navigation with authentication requirement
            await VolunteerNavLoader.init(true);
        });
    </script>
</body>
</html>
