<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>TalkTime - Student Profiles | Volunteer Dashboard</title>
    <!-- Early auth redirect - prevents FOUC on protected pages -->
    <script>
        if (!localStorage.getItem('volunteer_talktime_access_token')) {
            window.location.replace('/volunteer/login');
        }
    </script>
    <!-- Brand Theme System -->
    <link rel="stylesheet" href="/shared/css/brand-theme.css">
    <link rel="icon" type="image/x-icon" href="/talktime.ico">
    <meta name="description" content="Browse Maasai student profiles, learn their stories, and schedule English language practice sessions as a TalkTime volunteer.">
    <link rel="canonical" href="https://talktime.adeafoundation.org/volunteer/dashboard/students">
    <meta name="robots" content="index, follow">

    <!-- CSS (all sync to prevent layout shift) -->
    <link rel="stylesheet" href="/shared/css/tailwind.min.css">
    <link rel="stylesheet" href="/shared/fonts/google/fonts.css">
    <link rel="stylesheet" href="/shared/fonts/fontawesome/all.min.css">
    <link rel="stylesheet" href="/volunteer/css/main.css">
    <link rel="stylesheet" href="/volunteer/css/responsive-framework.css">
    <link rel="stylesheet" href="/volunteer/css/responsive-forms.css">
    <link rel="stylesheet" href="/volunteer/css/enhanced-mobile-nav.css">
    <link rel="stylesheet" href="/volunteer/css/volunteer-dashboard.css">
    <link rel="stylesheet" href="/css/dashboard.css">

    <!-- Deferred Scripts (non-render-blocking) -->
    <script defer src="/shared/js/brand-config.js"></script>
    <script defer src="/volunteer/partials/nav-loader.js"></script>
    <script defer src="/volunteer/js/dashboard-nav.js"></script>
    <script defer src="/volunteer/js/modal-utils.js"></script>
    <script defer src="/volunteer/components/approval-status.js"></script>
    <script defer src="/shared/js/jwt-auth-utils.js"></script>
    <script defer src="/shared/js/newsletter-widget.js"></script>
    <script defer src="/shared/js/notification-enforcer.js"></script>
    <script defer src="https://cdn.socket.io/4.6.0/socket.io.min.js" integrity="sha384-c79GN5VsunZvi+Q/WObgk2in0CbZsHnjEqvFxC5DxHn9lTfNce2WW6h2pH6u/kF+" crossorigin="anonymous"></script>


    <style>
        /* Base styles matching the landing page */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4ff;
            overflow-x: hidden;
        }
        .font-poppins {
            font-family: 'Poppins', sans-serif;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #f5f3ff, #fdf2f8);
        }
        .glass-bg {
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .modal-glass-bg {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .gradient-text {
            background-image: var(--brand-gradient-primary);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        .section-heading {
             background-image: linear-gradient(to right, #ec4899, #8b5cf6);
             -webkit-background-clip: text;
             background-clip: text;
             color: transparent;
        }
        .blob {
            position: fixed;
            border-radius: 50%;
            filter: blur(100px);
            opacity: 0.3;
            z-index: -1;
        }

        /* Page Transition */
        .page, .tab-pane {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        .page-hidden, .tab-pane-hidden {
            opacity: 0;
            pointer-events: none;
            position: absolute;
            transform: translateY(10px);
            top: 0;
            left: 0;
            width: 100%;
        }
        
        /* Calendar Styles */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
        }
        .calendar-day {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }
        .calendar-day.other-month {
            color: #9ca3af;
            cursor: not-allowed;
        }
        .calendar-day:not(.other-month):hover {
            background-color: rgba(139, 92, 246, 0.2);
        }
        .calendar-day.selected {
            background-color: #8b5cf6;
            color: white;
            font-weight: bold;
        }
        .calendar-day.fully-booked::after {
            content: '';
            position: absolute;
            bottom: 4px;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: #ef4444;
        }
         .calendar-day.fully-booked {
            cursor: not-allowed;
            color: #9ca3af;
            background-color: transparent !important;
        }

        /* Time Input Styles */
        .custom-select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
            background-color: rgba(255,255,255,0.8);
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 0.5rem;
            padding: 0.5rem 0.75rem;
            width: 100%;
        }
        
        /* Modal Styles */
        .modal {
            transition: opacity 300ms ease-in-out;
        }
        .modal .modal-content {
            transition: transform 300ms ease-in-out;
        }
        .profile-dropdown, .options-menu {
            transition: all 0.3s ease-in-out;
        }
        
        /* Star Rating */
        .star-rating .fa-star {
            color: #d1d5db; /* gray-300 */
            cursor: pointer;
            transition: color 0.2s ease;
        }
        .star-rating:hover .fa-star {
            color: #f59e0b; /* yellow-500 */
        }
        .star-rating .fa-star:hover ~ .fa-star {
            color: #d1d5db;
        }
        .star-rating .fa-star.selected,
        .star-rating .fa-star.selected ~ .fa-star {
             color: #d1d5db;
        }
        .star-rating .fa-star.selected {
             color: #f59e0b;
        }

        /* Live Pulse Animation */
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }
        .live-indicator {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        /* Ensure dropdown appears above other elements */
        .meeting-card {
            position: relative;
        }
        .upcoming-badge {
            position: absolute;
            top: 0.25rem; /* Adjusted position */
            right: 0.25rem; /* Adjusted position */
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background-color: #22c55e;
            color: white;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            border: 2px solid white;
        }
        .green-border {
            border-color: #22c55e !important;
        }
        
        /* Newsletter Widget Protection - Preserve Original Styling */
        #newsletter-widget,
        #newsletter-minimized,
        #newsletter-expanded,
        .newsletter-widget,
        .newsletter-minimized,
        .newsletter-expanded {
            /* Reset any conflicts and preserve original newsletter styling */
            background: revert !important;
            color: revert !important;
            border: revert !important;
            box-shadow: revert !important;
            animation: revert !important;
        }
        
        /* Ensure newsletter minimized button keeps its gradient and styling */
        #newsletter-minimized .pulse-zoom {
            background: var(--brand-gradient-primary) !important;
            color: white !important;
            border-radius: 9999px !important;
            padding: 1rem !important;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25), 0 20px 25px -5px rgba(0, 0, 0, 0.1) !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
            transform: translateZ(0) !important;
        }
        
        #newsletter-minimized .pulse-zoom:hover {
            background: linear-gradient(to right, #2563eb, #4338ca) !important;
            color: white !important;
            transform: scale(1.05) translateZ(0) !important;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.35), 0 20px 25px -5px rgba(0, 0, 0, 0.15) !important;
        }
        
        /* Newsletter expanded popup styling */
        #newsletter-expanded .glass-card {
            background: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(16px) !important;
            -webkit-backdrop-filter: blur(16px) !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
            border-radius: 1rem !important;
            padding: 1.5rem !important;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25) !important;
            max-width: 24rem !important;
        }
        
        /* Preserve newsletter button gradients */
        #newsletter-submit {
            background: linear-gradient(to right, #f97316, #ea580c) !important;
            color: white !important;
        }
        
        #newsletter-submit:hover {
            background: linear-gradient(to right, #ea580c, #dc2626) !important;
            color: white !important;
        }
        
        /* Student card - ensure full width in grid */
        .student-card {
            width: 100%;
            box-sizing: border-box;
        }

        /* Unavailable/Scheduled students - cannot be clicked */
        .student-card.student-unavailable {
            pointer-events: none !important;
            cursor: not-allowed !important;
            user-select: none;
            opacity: 0.5;
        }

        /* Prevent any hover effects on unavailable students */
        .student-card.student-unavailable:hover {
            border-color: rgba(0, 0, 0, 0.04) !important;
            transform: none !important;
            box-shadow: none !important;
        }

        /* Hide date input text selection highlight */
        .date-input-no-select::selection {
            background: transparent;
            color: inherit;
        }
        .date-input-no-select::-moz-selection {
            background: transparent;
            color: inherit;
        }

        /* ===== ESSENTIAL RESPONSIVE STYLES ===== */

        /* Date filter container - smooth transitions */
        #date-filter-container {
            transition: width 0.2s ease;
        }


        /* Touch Targets and Buttons - Mobile Responsive */
        @media (max-width: 768px) {
            /* Ensure all buttons meet minimum touch target size */
            button, .btn, [role="button"], input[type="button"], input[type="submit"] {
                min-height: 44px !important;
                min-width: 44px !important;
                padding: 0.75rem 1rem !important;
                font-size: 16px !important; /* Prevents zoom on iOS */
            }
            
            /* Specific button classes */
            .tt-btn-primary, .enable-btn, .dismiss-btn, .info-btn {
                min-height: 48px !important;
                padding: 0.875rem 1.25rem !important;
                font-size: 16px !important;
                border-radius: 0.5rem !important;
            }
            
            /* Close buttons */
            .close-btn {
                min-height: 44px !important;
                min-width: 44px !important;
                padding: 0.5rem !important;
            }
            
            /* FAB buttons */
            #upcoming-fab-btn {
                min-height: 56px !important;
                min-width: 56px !important;
                padding: 1rem !important;
            }
            
            /* Interactive cards and elements */
            .student-card, .meeting-card {
                min-height: 48px !important;
            }
            
            /* Form inputs */
            input, select, textarea {
                font-size: 16px !important; /* Prevents zoom on iOS */
                min-height: 44px !important;
                padding: 0.75rem !important;
            }
        }

        @media (max-width: 480px) {
            button, .btn, [role="button"], input[type="button"], input[type="submit"] {
                min-height: 48px !important;
                padding: 0.875rem 1.25rem !important;
            }
            
            .tt-btn-primary, .enable-btn, .dismiss-btn, .info-btn {
                min-height: 52px !important;
                padding: 1rem 1.5rem !important;
            }
            
            .close-btn {
                min-height: 48px !important;
                min-width: 48px !important;
                padding: 0.625rem !important;
            }
            
        /* Modals and Notifications - Mobile Responsive */
        @media (max-width: 768px) {
            /* Notification warning banner */
            .notification-warning-banner {
                top: 80px !important;
                width: 95% !important;
                max-width: 100% !important;
                margin: 0 2.5% !important;
                border-radius: 12px !important;
            }
            
            .warning-content {
                padding: 1.25rem !important;
            }
            
            .warning-content h3 {
                font-size: 1.25rem !important;
                margin-bottom: 0.75rem !important;
            }
            
            .warning-content p {
                font-size: 0.9rem !important;
                line-height: 1.5 !important;
                margin-bottom: 1rem !important;
            }
            
            .flex.flex-wrap.gap-3 {
                flex-direction: column !important;
                gap: 0.75rem !important;
            }
            
            .enable-btn, .dismiss-btn, .info-btn {
                width: 100% !important;
                padding: 0.875rem 1rem !important;
                font-size: 16px !important;
                text-align: center !important;
            }
            
            /* Modal dialogs */
            .modal .modal-content {
                margin: 1rem !important;
                max-width: calc(100vw - 2rem) !important;
                border-radius: 12px !important;
            }
            
            /* Newsletter modal */
            #newsletter-expanded .glass-card {
                margin: 1rem !important;
                max-width: calc(100vw - 2rem) !important;
                padding: 1.5rem !important;
            }
            
            /* FAB panel */
            #upcoming-fab-panel {
                width: calc(100vw - 2rem) !important;
                max-width: 380px !important;
                margin: 0 1rem !important;
            }

        }

        @media (max-width: 480px) {
            .notification-warning-banner {
                top: 75px !important;
                width: 92% !important;
                margin: 0 4% !important;
                border-radius: 10px !important;
            }
            
            .warning-content {
                padding: 1rem !important;
            }
            
            .warning-content h3 {
                font-size: 1.1rem !important;
                margin-bottom: 0.625rem !important;
            }
            
            .warning-content p {
                font-size: 0.85rem !important;
                margin-bottom: 0.875rem !important;
            }
            
            .enable-btn, .dismiss-btn, .info-btn {
                padding: 1rem 1.25rem !important;
                font-size: 15px !important;
            }
            
            .modal .modal-content {
                margin: 0.75rem !important;
                max-width: calc(100vw - 1.5rem) !important;
            }
            
            #newsletter-expanded .glass-card {
                margin: 0.75rem !important;
                max-width: calc(100vw - 1.5rem) !important;
                padding: 1.25rem !important;
            }
            
            #upcoming-fab-panel {
                width: calc(100vw - 1.5rem) !important;
                margin: 0 0.75rem !important;
            }
        }

        /* Overall Layout and Container - Mobile Responsive */
        @media (max-width: 768px) {
            /* Main container adjustments - Use full width on mobile */
            main.container {
                max-width: 100% !important;
                width: 100% !important;
                padding-left: 1rem !important;
                padding-right: 1rem !important;
                padding-top: 1.5rem !important;
                padding-bottom: 1.5rem !important;
            }
            
            /* Page dashboard - full width */
            #page-dashboard.page {
                width: 100% !important;
                max-width: 100% !important;
            }
            
            /* Main content container - use full available width */
            .max-w-6xl.mx-auto {
                /* max-width: 100% !important;
                width: 100% !important;
                padding-left: 0 !important;
                padding-right: 0 !important; */
            }
            
            /* Sticky navigation improvements */
            #page-nav-sticky {
                /* padding: 0.75rem 1rem !important; */
            }
            
            #page-nav-sticky .container.mx-auto {
                /* padding-left: 0 !important;
                padding-right: 0 !important; */
            }
            
            
            /* Space-y adjustments for mobile */
            .space-y-8 > * + * {
                margin-top: 1.5rem !important;
            }
            
            .space-y-3 > * + * {
                margin-top: 0.75rem !important;
            }
        }

        @media (max-width: 480px) {
            /* Further mobile optimizations */
            #page-nav-sticky {
                padding: 0.625rem 0.75rem !important;
            }
            
            
            .space-y-8 > * + * {
                margin-top: 1.25rem !important;
            }
            
            .space-y-3 > * + * {
                margin-top: 0.625rem !important;
            }
            
            /* Make date filter responsive on mobile */
            #date-filter-container {
                width: 100% !important;
                max-width: calc(100vw - 1.5rem) !important;
            }
            
            /* Main container - optimize for small screens */
            main.container {
                padding-left: 1rem !important;
                padding-right: 1rem !important;
                padding-top: 1.5rem !important;
                padding-bottom: 1.5rem !important;
            }
            
            /* Ensure all content sections use full width */
            section {
                width: 100% !important;
                max-width: 100% !important;
            }
            
            /* Student grid - responsive */
            .students-grid {
                width: 100% !important;
                grid-template-columns: 1fr !important;
                gap: 0.5rem !important;
                margin-top: 0.75rem !important;
            }
        }

        /* Notification Permission Warning Banner */
        .notification-warning-banner {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            width: 95%;
            max-width: 800px;
            z-index: 1000;
            background: linear-gradient(135deg, #ff6b6b, #ffa500, #ff6b6b);
            background-size: 200% 200%;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(255, 107, 107, 0.4), 0 10px 20px rgba(0, 0, 0, 0.1);
            animation: gradientShift 3s ease-in-out infinite, slideInDown 0.6s ease-out, pulseGlow 2s ease-in-out infinite;
            border: 2px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
        }

        .warning-content {
            padding: 24px;
            position: relative;
            overflow: hidden;
        }

        .warning-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2.5s infinite;
        }

        .notification-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s infinite;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .enable-btn {
            background: rgba(255, 255, 255, 0.9);
            color: #ff6b6b;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid rgba(255, 255, 255, 0.5);
        }

        .enable-btn:hover {
            background: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            color: #ff4757;
        }

        .dismiss-btn, .info-btn {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.5);
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .dismiss-btn:hover, .info-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
            border-color: rgba(255, 255, 255, 0.8);
        }

        .close-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        /* Animations */
        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-100px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        @keyframes pulseGlow {
            0%, 100% {
                box-shadow: 0 20px 40px rgba(255, 107, 107, 0.4), 0 10px 20px rgba(0, 0, 0, 0.1);
            }
            50% {
                box-shadow: 0 25px 50px rgba(255, 107, 107, 0.6), 0 15px 30px rgba(0, 0, 0, 0.15);
            }
        }

        /* Responsive for notification banner */
        @media (max-width: 768px) {
            .notification-warning-banner {
                top: 70px;
                width: 90%;
                margin: 0 5%;
            }
            
            .warning-content {
                padding: 20px;
            }
            
            .enable-btn, .dismiss-btn, .info-btn {
                padding: 8px 16px;
                font-size: 13px;
            }
        }
    }
    }

    /* Cultural Notice Dismiss Button Styles */
    #dismiss-cultural-notice {
        opacity: 0.7;
        transition: all 0.2s ease;
    }

    #dismiss-cultural-notice:hover {
        opacity: 1;
        transform: scale(1.1);
    }

    #cultural-exchange-notice {
        animation: fadeInUp 0.5s ease-out;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    /* Brand color classes */
    .bg-brand-primary { background-color: var(--brand-primary) !important; }
    .bg-brand-secondary { background-color: var(--brand-secondary) !important; }
    .bg-brand-primary-dark { background-color: var(--brand-primary-dark) !important; }
    .bg-brand-secondary-dark { background-color: var(--brand-secondary-dark) !important; }
    .bg-brand-light { background-color: rgba(209, 1, 0, 0.1) !important; }
    .bg-brand-light-secondary { background-color: rgba(56, 103, 255, 0.1) !important; }
    .text-brand-primary { color: var(--brand-primary) !important; }
    .text-brand-secondary { color: var(--brand-secondary) !important; }
    .text-brand-primary-dark { color: var(--brand-primary-dark) !important; }
    .border-brand { border-color: var(--brand-primary) !important; }
    .hover\:bg-brand-primary-dark:hover { background-color: var(--brand-primary-dark) !important; }
    .hover\:bg-brand-light:hover { background-color: rgba(209, 1, 0, 0.05) !important; }
    .hover\:text-brand-primary:hover { color: var(--brand-primary) !important; }
    .focus\:ring-brand-primary:focus { --tw-ring-color: var(--brand-primary) !important; }
    .focus\:border-brand:focus { border-color: var(--brand-primary) !important; }
    /* Semantic colors */
    .bg-success { background-color: var(--color-success) !important; }
    .bg-success-light { background-color: rgba(17, 108, 0, 0.1) !important; }
    .bg-error { background-color: var(--color-error) !important; }
    .bg-error-light { background-color: rgba(125, 0, 0, 0.1) !important; }
    .bg-warning { background-color: var(--color-warning) !important; }
    .bg-warning-light { background-color: rgba(255, 224, 6, 0.1) !important; }
    .text-success { color: var(--color-success) !important; }
    .text-error { color: var(--color-error) !important; }
    .text-warning { color: var(--color-warning) !important; }
    </style>
</head>
<body class="dashboard-page" style="opacity:0">
    <!-- Background Blobs - Hidden on mobile for performance -->
    <div class="blob bg-brand-primary w-96 h-96 top-0 left-0 -translate-x-1/2 -translate-y-1/2"></div>
    <div class="blob bg-brand-secondary w-96 h-96 bottom-0 right-0 translate-x-1/2 translate-y-1/2"></div>

    <!-- Dashboard Navigation Container -->
    <div id="dashboard-nav-container"></div>

    <main class="content-area">
        
        <!-- Notification Permission Warning Banner -->
        <div id="notification-permission-warning" class="notification-warning-banner" style="display: none;">
            <div class="warning-content">
                <div class="flex items-start gap-4">
                    <div class="flex-shrink-0">
                        <div class="notification-icon">
                            <i class="fas fa-bell text-white text-2xl"></i>
                        </div>
                    </div>
                    <div class="flex-1">
                        <h3 class="text-white font-bold text-lg mb-2">
                            ðŸš¨ Enable Browser Notifications for TalkTime
                        </h3>
                        <p class="text-white/90 text-sm mb-4 leading-relaxed">
                            Stay connected with your students! Enable browser notifications to receive:
                            <br>â€¢ Meeting reminders (1 hour, 30 minutes, and 5 minutes before)
                            <br>â€¢ Instant call notifications from students
                            <br>â€¢ Important meeting updates and reschedule alerts
                        </p>
                        <div class="flex flex-wrap gap-3">
                            <button onclick="requestNotificationPermission()" class="enable-btn">
                                <i class="fas fa-bell mr-2"></i>Enable Notifications
                            </button>
                            <button onclick="hideNotificationWarning()" class="dismiss-btn">
                                <i class="fas fa-times mr-2"></i>Dismiss
                            </button>
                            <button onclick="showNotificationInfo()" class="info-btn">
                                <i class="fas fa-info-circle mr-2"></i>Why This Matters
                            </button>
                        </div>
                    </div>
                    <button onclick="hideNotificationWarning()" class="close-btn">
                        <i class="fas fa-times text-white text-xl hover:text-red-200 transition-colors"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Dashboard Page -->
        <div id="page-dashboard" class="page w-full">
            <!-- Scheduling Tips Section -->
            <div class="scheduling-tips-section mb-4">
                <div class="bg-white/90 backdrop-blur-sm rounded-xl p-3 md:p-4 shadow-sm" style="border: 1px solid rgba(209, 1, 0, 0.4);">
                    <div class="flex items-center gap-2">
                        <div class="w-7 h-7 md:w-8 md:h-8 rounded-full bg-yellow-100 flex items-center justify-center flex-shrink-0">
                            <i class="fas fa-lightbulb text-yellow-500 text-xs md:text-sm"></i>
                        </div>
                        <span class="text-base md:text-lg font-semibold text-gray-800">Scheduling Tips</span>
                    </div>
                    <div id="rotating-tip" class="text-gray-600 text-xs md:text-sm leading-tight pl-9 md:pl-10 -mt-0.5">
                        Click on any student card to view their profile and schedule a meeting
                    </div>

                    <!-- Dual Timezone Display -->
                    <div class="mt-3 pt-3 border-t border-gray-200/60 pl-9 md:pl-10">
                        <div class="flex flex-wrap items-center gap-x-4 gap-y-2 text-xs md:text-sm">
                            <!-- Kenya Time -->
                            <div class="flex items-center gap-2">
                                <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-green-100">
                                    <i class="fas fa-globe-africa text-green-600 text-[10px]"></i>
                                </span>
                                <span class="text-gray-500">Kenya:</span>
                                <span id="kenya-time" class="font-semibold text-gray-700">--:-- --</span>
                            </div>
                            <!-- Volunteer's Local Time -->
                            <div class="flex items-center gap-2">
                                <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-blue-100">
                                    <i class="fas fa-user-clock text-blue-600 text-[10px]"></i>
                                </span>
                                <span class="text-gray-500">Your time:</span>
                                <span id="local-time" class="font-semibold text-gray-700">--:-- --</span>
                            </div>
                            <!-- Time Difference -->
                            <div class="flex items-center gap-1 text-gray-400 text-[11px]">
                                <i class="fas fa-exchange-alt text-[9px]"></i>
                                <span id="time-difference">--</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cultural Exchange Warning Card (Dismissible) -->
            <div id="cultural-exchange-notice" class="text-center mb-6 hidden">
                <div class="rounded-2xl p-6 border border-amber-200 mb-6 relative" style="background:linear-gradient(to right,#fffbeb,#eff6ff);">
                    <button
                        id="dismiss-cultural-notice"
                        class="absolute top-4 right-4 text-amber-600 hover:text-amber-800 transition-colors duration-200"
                        aria-label="Dismiss cultural exchange notice"
                        title="Dismiss (won't show again)">
                        <i class="fas fa-times text-lg"></i>
                    </button>
                    <div class="flex items-start gap-4">
                        <div class="flex-shrink-0 mt-1">
                            <i class="fas fa-exclamation-triangle text-amber-600 text-xl"></i>
                        </div>
                        <div class="text-left pr-8">
                            <h3 class="text-lg font-semibold text-amber-800 mb-3">
                                Cultural Exchange Notice
                            </h3>
                            <p class="text-amber-700 text-sm leading-relaxed">
                                Our students may initially appear shy or reserved - this is normal! Please be patient and understanding as they come from diverse backgrounds and may need time to feel comfortable speaking.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content Container -->
            <div class="max-w-6xl mx-auto">
                <!-- Sticky tabs are rendered in #page-nav-sticky -->
                <div id="dashboard-students" class="tab-pane">
                    <!-- Date Selection Section removed per request -->
                    
                    <!-- Students Grid -->
                    <div class="space-y-8">
                        <!-- Available Students Section -->
                        <section class="mb-8 md:mb-12">
                            <div class="flex items-center justify-between gap-3 sm:gap-4 mb-4 md:mb-6">
                                <h2 class="text-base sm:text-lg md:text-xl lg:text-2xl font-bold section-heading whitespace-nowrap flex-shrink-0">Available Students</h2>
                                <div class="flex items-center gap-2 sm:gap-3 flex-shrink min-w-0">
                                    <!-- Native Date Filter - Click anywhere to open picker -->
                                    <input
                                        id="sticky-student-date"
                                        type="date"
                                        onclick="this.showPicker()"
                                        class="bg-white/80 backdrop-blur-sm border border-gray-200 rounded-lg px-3 py-2 text-sm font-medium text-gray-700 hover:border-gray-300 focus:outline-none focus:ring-2 focus:ring-brand-primary/20 focus:border-brand-primary cursor-pointer date-input-no-select"
                                    />
                                </div>
                            </div>
                            <div id="student-list-available" class="student-list mt-3 sm:mt-4 w-full">
                                <!-- Cards injected by JS -->
                            </div>
                        </section>

                        <!-- Unavailable/Scheduled Students Section -->
                        <section class="mb-8 md:mb-12">
                            <div class="flex items-center justify-between mb-4 md:mb-6">
                                <h2 class="text-base sm:text-lg md:text-xl lg:text-2xl font-bold text-gray-800">Scheduled / Unavailable</h2>
                            </div>
                            <div id="student-list-unavailable" class="student-list mt-2 w-full">
                                <!-- Cards injected by JS -->
                            </div>
                        </section>
                    </div>
                </div>

            </div>
        </div>
    </main>
    
    <!-- Notification Toast -->
    <div id="notification" class="hidden fixed bottom-5 left-1/2 transform -translate-x-1/2 bg-success text-white px-6 py-3 rounded-lg shadow-lg"></div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        document.body.classList.add('page-ready');
        // ============================================
        // CHECK FOR INSTANT CALL MESSAGE FROM STUDENT
        // ============================================
        const storedMessage = sessionStorage.getItem('instantCallMessage');
        if (storedMessage) {
            try {
                const messageData = JSON.parse(storedMessage);
                console.log('ðŸ’¬ Found instant call message from student:', messageData);

                // Clear it immediately so it doesn't show again on refresh
                sessionStorage.removeItem('instantCallMessage');

                // Show the modal with a slight delay to ensure page is fully loaded
                setTimeout(() => {
                    showStudentMessageModal(messageData);
                }, 300);
            } catch (e) {
                console.error('Error parsing stored message:', e);
                sessionStorage.removeItem('instantCallMessage');
            }
        }

        // Handle Cultural Exchange Notice
        const culturalNotice = document.getElementById('cultural-exchange-notice');
        const dismissBtn = document.getElementById('dismiss-cultural-notice');

        // Check if notice has been dismissed before
        const isNoticeDismissed = localStorage.getItem('culturalExchangeNoticeDismissed') === 'true';

        if (culturalNotice && !isNoticeDismissed) {
            // Show the notice if it hasn't been dismissed
            culturalNotice.classList.remove('hidden');
        }

        // Handle dismiss button click
        if (dismissBtn) {
            dismissBtn.addEventListener('click', function() {
                // Add smooth fade out animation
                culturalNotice.style.transition = 'opacity 0.3s ease-out';
                culturalNotice.style.opacity = '0';

                setTimeout(() => {
                    culturalNotice.classList.add('hidden');
                    culturalNotice.style.opacity = '1'; // Reset for potential future use
                }, 300);

                // Save dismissal state to localStorage
                localStorage.setItem('culturalExchangeNoticeDismissed', 'true');

                console.log('Cultural exchange notice dismissed permanently');
            });
        }

        // ============================================
        // DUAL TIMEZONE DISPLAY (Kenya + Volunteer Local)
        // ============================================
        function updateTimezoneDisplay() {
            const kenyaTimeEl = document.getElementById('kenya-time');
            const localTimeEl = document.getElementById('local-time');
            const timeDiffEl = document.getElementById('time-difference');

            if (!kenyaTimeEl || !localTimeEl) return;

            const now = new Date();

            // Kenya time (always UTC+3, no DST)
            const kenyaTime = now.toLocaleTimeString('en-US', {
                timeZone: 'Africa/Nairobi',
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            });

            // Volunteer's local time (browser timezone)
            const localTime = now.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            });

            // Get timezone names for display
            const kenyaTzName = 'EAT';
            const localTzName = Intl.DateTimeFormat().resolvedOptions().timeZone.split('/').pop().replace(/_/g, ' ');

            // Calculate time difference
            const kenyaOffset = 3; // Kenya is always UTC+3
            const localOffset = -now.getTimezoneOffset() / 60; // Browser's offset in hours
            const diff = kenyaOffset - localOffset;
            let diffText = '';
            if (diff > 0) {
                diffText = `Kenya is ${Math.abs(diff)}h ahead`;
            } else if (diff < 0) {
                diffText = `Kenya is ${Math.abs(diff)}h behind`;
            } else {
                diffText = 'Same time';
            }

            // Update display
            kenyaTimeEl.textContent = `${kenyaTime} ${kenyaTzName}`;
            localTimeEl.textContent = `${localTime}`;
            if (timeDiffEl) {
                timeDiffEl.textContent = diffText;
            }
        }

        // Update immediately and then every minute
        updateTimezoneDisplay();
        setInterval(updateTimezoneDisplay, 60000);

        // Initialize Socket.IO connection
        const socket = io();
        
        // Listen for instant call notifications
        socket.on('instant-call-notification', function(data) {
            console.log('Received instant call notification:', data);
            
            if (data.type === 'incoming') {
                // Show notification for incoming call
                showNotification(`Incoming call from ${data.senderName || 'a volunteer'}. Redirecting...`, 'info');
                
                // Store sender name if available
                if (data.senderName) {
                    sessionStorage.setItem('callerName', data.senderName);
                }

                // (Removed) runtime mount for date controls â€” controls are now in static HTML
                
                // Redirect volunteer to call page after a short delay
                // FIXED: Changed role=student to role=volunteer - this is the volunteer's redirect
                setTimeout(() => {
                    window.location.href = `/call/call.html?room=${data.meetingId}&role=volunteer&instant=true`;
                }, 2000);
            }
        });
        
        // Connect event - log when successfully connected to socket server
        socket.on('connect', function() {
            console.log('Connected to socket server with ID:', socket.id);
        });
        
        // Error handling
        socket.on('connect_error', function(error) {
            console.error('Socket connection error:', error);
        });
        
        // --- DOM Elements ---
        const pageDashboard = document.getElementById('page-dashboard');
        const availableStudentsContainer = document.getElementById('student-list-available');
        const unavailableStudentsContainer = document.getElementById('student-list-unavailable');
        const notificationEl = document.getElementById('notification');

        // --- Global Variables ---
        let students = [];
        let selectedStudent = null;

        // --- Notification Functions ---
        
        // Check if notifications are enabled for critical actions
        function checkNotificationPermissionForCriticalAction(actionName = 'critical action') {
            if (!('Notification' in window)) {
                console.log('âŒ Browser does not support notifications');
                return false;
            }

            if (Notification.permission === 'granted') {
                console.log(`âœ… Notifications enabled - allowing ${actionName}`);
                return true;
            } else {
                console.log(`ðŸš« Notifications not enabled - blocking ${actionName}`);
                // Force show the notification banner if it's hidden
                const warningBanner = document.getElementById('notification-permission-warning');
                if (warningBanner) {
                    warningBanner.style.display = 'block';
                }
                return false;
            }
        }

        // Show message that notifications are required for critical actions
        function showNotificationRequiredMessage() {
            const existingMessage = document.getElementById('notification-required-message');
            if (existingMessage) {
                existingMessage.remove();
            }

            const message = document.createElement('div');
            message.id = 'notification-required-message';
            message.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 bg-error text-white px-6 py-3 rounded-lg shadow-lg z-50';
            message.innerHTML = 'âš ï¸ Notifications must be enabled for scheduling and critical actions';
            document.body.appendChild(message);

            setTimeout(() => {
                if (message && message.parentNode) {
                    message.remove();
                }
            }, 4000);
        }
        let bookedSlots = {};

        // --- Native Date Filter Initialization ---
        const stickyDateEl = document.getElementById('sticky-student-date');

        // Calculate date range (today to 3 months ahead)
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const maxDate = new Date(today);
        maxDate.setMonth(today.getMonth() + 3);

        // Format as YYYY-MM-DD for native date input
        const formatISO = (date) => date.toISOString().split('T')[0];

        if (stickyDateEl) {
            // Set min/max constraints and default to today
            stickyDateEl.min = formatISO(today);
            stickyDateEl.max = formatISO(maxDate);
            stickyDateEl.value = formatISO(today);

            // Handle date change - load data when user selects a date
            stickyDateEl.addEventListener('change', function() {
                const selectedDate = this.value;
                if (selectedDate) {
                    loadDashboardData(selectedDate);
                }
            });
        }

        // --- Event Listeners ---
        document.addEventListener('click', e => {
            // Student card click
            if (e.target.closest('.student-card')) {
                const studentCard = e.target.closest('.student-card');

                // CRITICAL: Block clicks on unavailable/scheduled students
                if (studentCard.classList.contains('student-unavailable')) {
                    console.log('[TalkTime] Student is unavailable - already scheduled for today');
                    e.preventDefault();
                    e.stopPropagation();
                    return; // Do nothing - student is not available
                }

                const studentId = studentCard.dataset.studentId;
                const studentAdmission = studentCard.dataset.studentAdmission;
                const studentName = studentCard.dataset.studentName || 'Student';

                // ðŸš¨ CRITICAL ACTION ENFORCEMENT: Check notifications before scheduling
                if (!checkNotificationPermissionForCriticalAction('scheduling a meeting')) {
                    console.log('ðŸš« Blocking student detail navigation - notifications not enabled');
                    showNotificationRequiredMessage();
                    return; // Prevent navigation
                }

                // Navigate to student detail page with parameters
                window.location.href = `/volunteer/dashboard/student-detail.html?id=${studentId}&admission=${studentAdmission}&name=${encodeURIComponent(studentName)}`;
            }
            
            // Date filter button click
            if (e.target.closest('#apply-date-filter')) {
                const dateSelector = document.getElementById('student-date-selector');
                const selectedDate = dateSelector ? dateSelector.value : '';
                if (selectedDate) {
                    loadDashboardData(selectedDate);
                    showNotification(`Showing students for ${new Date(selectedDate).toLocaleDateString()}`, 'success');
                } else {
                    // Fallback to sticky date if present
                    const stickyEl = document.getElementById('sticky-student-date');
                    const fallbackDate = stickyEl ? stickyEl.value : '';
                    if (fallbackDate) {
                        loadDashboardData(fallbackDate);
                        showNotification(`Showing students for ${new Date(fallbackDate).toLocaleDateString()}`, 'success');
                    } else {
                        showNotification('Please select a date first', 'error');
                    }
                }
            }
        });
        
        // Date selector enter key press
        (function(){
            const mainDateInput = document.getElementById('student-date-selector');
            if (!mainDateInput) return;
            mainDateInput.addEventListener('keyup', function(event) {
                if (event.key === 'Enter') {
                    const selectedDate = this.value;
                    if (selectedDate) {
                        loadDashboardData(selectedDate);
                        showNotification(`Showing students for ${new Date(selectedDate).toLocaleDateString()}`, 'success');
                    } else {
                        showNotification('Please select a date first', 'error');
                    }
                }
            });
        })();

        // --- Utility Functions ---
        
        // Helper function to convert MM/DD/YYYY to YYYY-MM-DD
        function convertToISODate(dateStr) {
            if (!dateStr) return '';
            try {
                const dateObj = new Date(dateStr);
                return dateObj.toISOString().split('T')[0];
            } catch (e) {
                console.error('Error converting date:', e);
                return '';
            }
        }
        
        function showNotification(message, type = 'success') {
            notificationEl.textContent = message;
            notificationEl.className = `fixed bottom-5 right-5 px-6 py-3 rounded-lg shadow-lg ${type === 'success' ? 'bg-success text-white' : 'bg-error text-white'}`;
            notificationEl.classList.remove('hidden');
            
            setTimeout(() => {
                notificationEl.classList.add('hidden');
            }, 5000);
        }

        // Convert date from MM/DD/YYYY or MM-DD-YYYY format to YYYY-MM-DD (ISO format)
        function convertToISODate(dateStr) {
            if (!dateStr) return null;
            
            // If already in YYYY-MM-DD format, return as-is
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
                return dateStr;
            }
            
            // Handle MM/DD/YYYY or MM-DD-YYYY format
            let parts = dateStr.split(/[\/\-]/);
            if (parts.length === 3) {
                const [month, day, year] = parts;
                return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
            }
            
            // Fallback: try to parse as Date and format
            try {
                const date = new Date(dateStr);
                return date.toISOString().split('T')[0];
            } catch (e) {
                console.error('Failed to convert date:', dateStr, e);
                return null;
            }
        }

        // --- Data Loading ---
        // Add recursion prevention with timeout fallback
        let isLoadingDashboard = false;
        let loadingTimeout = null;
        
        function loadDashboardData(selectedDate = null) {
            // Prevent recursive calls
            if (isLoadingDashboard) {
                console.warn('loadDashboardData already in progress, skipping duplicate call');
                return Promise.resolve();
            }
            
            isLoadingDashboard = true;
            
            // Safety timeout in case the finally block doesn't execute
            if (loadingTimeout) clearTimeout(loadingTimeout);
            loadingTimeout = setTimeout(() => {
                console.warn('Loading timeout exceeded, resetting flag');
                isLoadingDashboard = false;
            }, 10000);
            
            // Set date selector to today if not already set
            if (!selectedDate) {
                const today = new Date().toISOString().split('T')[0]; // Format: YYYY-MM-DD
                const mainDate = document.getElementById('student-date-selector');
                if (mainDate) mainDate.value = today;
                selectedDate = today;
            } else {
                // Convert date from MM/DD/YYYY (datepicker format) to YYYY-MM-DD (API format)
                selectedDate = convertToISODate(selectedDate);
            }
            
            console.log('=== DATE FILTER DEBUG ===');
            console.log('Selected date for API:', selectedDate);
            
            // Debug JWT token details
            const token = window.TalkTimeAuth.getAccessToken();
            const user = window.TalkTimeAuth.getUser();
            console.log('=== JWT DEBUG INFO ===');
            console.log('Token available:', !!token);
            console.log('Token length:', token ? token.length : 0);
            console.log('Token preview:', token ? token.substring(0, 50) + '...' : 'No token');
            console.log('User info:', user);
            console.log('Is authenticated:', window.TalkTimeAuth.isAuthenticated());
            // Update dashboard header to "Welcome, [Volunteer Name]" using available auth data
            try {
                const headerEl = document.querySelector('#page-dashboard h1');

                // Meeting scheduling tips rotation state
                const schedulingTips = [
                    'Click on any student card to view their profile and schedule a meeting',
                    'Each student can only have one meeting per day to ensure quality time',
                    'Meetings are automatically set to 40 minutes for optimal learning',
                    'All times sync to Kenya timezone to match students\' local schedule',
                    'Choose a time that works for both you and the student\'s timezone',
                    'You\'ll receive email and SMS reminders before your scheduled meetings',
                    'Students get notified immediately when you schedule a meeting with them',
                    'You can reschedule or cancel meetings up to 1 hour before start time',
                    'All meetings include a secure video room that\'s ready when you are',
                    'Consider the student\'s school hours when picking meeting times',
                    'Your impact grows with each conversation - every meeting matters!',
                    'Browse student profiles to find those who match your interests',
                    'Instant calls are available when students are online and ready'
                ];
                let tipIndex = 0;
                let tipInterval = null;

                function ensureTipAnimationSetup(tipElement) {
                    if (!tipElement) return;
                    tipElement.classList.add('greeting-fade', 'show');
                    // Remove previous styling that was applied to h1
                    tipElement.style.fontSize = '';
                    tipElement.style.lineHeight = '';
                    tipElement.style.fontWeight = '';
                }

                function animateTipChange(tipElement, nextText) {
                    if (!tipElement) return;
                    tipElement.classList.remove('show');
                    tipElement.classList.add('enter');
                    setTimeout(() => {
                        // Just use text content since we have a separate icon in the header
                        tipElement.textContent = nextText;
                        tipElement.classList.remove('enter');
                        tipElement.classList.add('show');
                    }, 400);
                }

                function startTipRotation(name) {
                    // Prevent multiple intervals
                    if (tipInterval) return;
                    const tipElement = document.getElementById('rotating-tip');
                    if (!tipElement) return;
                    
                    // Set initial tip and styling
                    ensureTipAnimationSetup(tipElement);
                    tipElement.textContent = schedulingTips[0];
                    
                    tipInterval = setInterval(() => {
                        tipIndex = (tipIndex + 1) % schedulingTips.length;
                        const nextTip = schedulingTips[tipIndex];
                        animateTipChange(tipElement, nextTip);
                    }, 8000); // Show each tip for 8 seconds - more time to read
                    
                    // Clear on unload
                    window.addEventListener('beforeunload', () => {
                        if (tipInterval) clearInterval(tipInterval);
                    });
                }

                // Ensure date picker defaults to current date in EAT (Africa/Nairobi)
                function getTodayInEATISODate() {
                    // Returns YYYY-MM-DD for Africa/Nairobi
                    const now = new Date();
                    const parts = new Intl.DateTimeFormat('en-CA', {
                        timeZone: 'Africa/Nairobi',
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit'
                    }).formatToParts(now);
                    const map = Object.fromEntries(parts.map(p => [p.type, p.value]));
                    return `${map.year}-${map.month}-${map.day}`;
                }

                function syncDateInputToEATToday() {
                    const dateEl = document.getElementById('sticky-student-date');
                    if (!dateEl) return;
                    const eatToday = getTodayInEATISODate();
                    // If empty or behind EAT day rollover, set to EAT today
                    if (!dateEl.value || dateEl.value !== eatToday) {
                        dateEl.value = eatToday;
                        if (typeof selectedDate !== 'undefined') {
                            selectedDate = eatToday;
                        }
                    }
                }

                // Compute ms until next midnight in EAT (UTC+3, no DST)
                function msUntilNextEATMidnight() {
                    const now = new Date();
                    const parts = new Intl.DateTimeFormat('en-CA', {
                        timeZone: 'Africa/Nairobi',
                        year: 'numeric', month: '2-digit', day: '2-digit',
                        hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
                    }).formatToParts(now);
                    const map = Object.fromEntries(parts.map(p => [p.type, p.value]));
                    const y = Number(map.year);
                    const m = Number(map.month);
                    const d = Number(map.day);
                    // EAT midnight next day => UTC time is previous day 21:00 (UTC) or Date.UTC with hour -3
                    const nextEatMidnightUTC = Date.UTC(y, m - 1, d + 1, -3, 0, 0);
                    const diff = nextEatMidnightUTC - now.getTime();
                    return diff > 0 ? diff : 0;
                }

                function scheduleEATMidnightRollover() {
                    try { if (window.__eatMidnightTimer) clearTimeout(window.__eatMidnightTimer); } catch (_) {}
                    const delay = msUntilNextEATMidnight();
                    window.__eatMidnightTimer = setTimeout(() => {
                        // Update the date input to EAT today and reload data
                        try { syncDateInputToEATToday(); } catch (_) {}
                        try { if (typeof loadDashboardData === 'function') loadDashboardData(); } catch (_) {}
                        // Reschedule for the following midnight
                        scheduleEATMidnightRollover();
                    }, delay);
                }

                // Ensure we apply EAT date at load (DISABLED TO PREVENT RECURSION)
                // document.addEventListener('DOMContentLoaded', () => {
                //     // This was causing recursion issues - removed
                // });

                function setWelcomeHeader(fromUser) {
                    // Since we removed the welcome header, just start the tips rotation
                    if (!fromUser) return false;
                    let volunteerName = fromUser.fullName || fromUser.full_name || fromUser.name || fromUser.firstName || fromUser.given_name || fromUser.username || fromUser.email || null;
                    if (!volunteerName || typeof volunteerName !== 'string') return false;
                    let displayName = volunteerName;
                    if (displayName.includes(' ')) displayName = displayName.split(' ')[0];
                    else if (displayName.includes('@')) displayName = displayName.split('@')[0];
                    
                    console.log('[Dashboard] Starting tips rotation for:', displayName);
                    
                    // Start showing tips immediately
                    startTipRotation(displayName);
                    
                    return true;
                }

                // 1) Try immediate JWT user
                if (!setWelcomeHeader(user)) {
                    // 2) Try nav loader user (may be set shortly)
                    const navUser = (window.VolunteerNavLoader && window.VolunteerNavLoader.userInfo) || null;
                    if (!setWelcomeHeader(navUser)) {
                        // 3) Verify via API to fetch canonical user
                        window.TalkTimeAuth.authenticatedRequest('/api/v1/jwt-auth/verify', { method: 'GET' })
                          .then(r => r.ok ? r.json() : null)
                          .then(v => {
                              if (v && v.user) setWelcomeHeader(v.user);
                          })
                          .catch(() => {});

                        // 4) Retry after nav initialization (timing-safe)
                        setTimeout(() => {
                            const lateNavUser = (window.VolunteerNavLoader && window.VolunteerNavLoader.userInfo) || null;
                            setWelcomeHeader(lateNavUser);
                        }, 600);

                        // 5) Short-lived retry loop to handle late DOM/user
                        let attempts = 0;
                        const maxAttempts = 10; // ~5 seconds if 500ms interval
                        const retryTimer = setInterval(() => {
                            attempts++;
                            const tryUser = window.TalkTimeAuth.getUser() || (window.VolunteerNavLoader && window.VolunteerNavLoader.userInfo) || null;
                            if (setWelcomeHeader(tryUser) || attempts >= maxAttempts) {
                                clearInterval(retryTimer);
                                if (attempts >= maxAttempts) {
                                    console.log('[Dashboard Header] Gave up after retries.');
                                }
                            }
                        }, 500);
                    }
                }
            } catch (e) {
                console.warn('Failed to personalize dashboard header:', e);
            }
            
            // Show loading state
            if (availableStudentsContainer) {
                availableStudentsContainer.innerHTML = '<div class="text-center py-4"><p class="text-gray-500">Loading available students...</p></div>';
            }
            if (document.getElementById('student-list-unavailable')) {
                document.getElementById('student-list-unavailable').innerHTML = '<div class="text-center py-4"><p class="text-gray-500">Loading unavailable students...</p></div>';
            }
            
            // First, get volunteer dashboard data
            window.TalkTimeAuth.authenticatedRequest('/api/v1/volunteers/dashboard-data', {
                method: 'GET'
            })
            .then(response => {
                console.log('Dashboard API response status:', response.status);
                if (!response.ok) {
                    throw new Error(`Failed to load dashboard data: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Dashboard data loaded:', data);
                
                // Update badge counts in the dashboard nav
                if (window.VolunteerDashboardNav && data.meetings && data.meetings.upcoming) {
                    window.VolunteerDashboardNav.updateUpcomingBadge(data.meetings.upcoming.length);
                }
                
                // Sidebar removed - using FAB widget only for upcoming sessions

                // Floating mini-widget (FAB) for Upcoming
                // Create container once
                let fabRoot = document.getElementById('upcoming-fab');
                if (!fabRoot && data.meetings && data.meetings.upcoming && data.meetings.upcoming.length > 0) {
                    const upcoming = data.meetings.upcoming.slice(0, 3);
                    fabRoot = document.createElement('div');
                    fabRoot.id = 'upcoming-fab';
                    fabRoot.className = 'fixed bottom-6 right-6 z-40';
                    fabRoot.innerHTML = `
                              <div class="relative">
                                <button id="upcoming-fab-btn" aria-label="Open upcoming sessions" aria-expanded="false"
                                  class="group flex items-center gap-2 rounded-full px-4 h-12 shadow-lg bg-brand-primary text-white hover:bg-brand-primary-dark focus:outline-none focus:ring-4 focus:ring-brand-primary transition">
                                  <i class="fas fa-calendar-check"></i>
                                  <span class="text-sm font-semibold">Upcoming</span>
                                  <span id="upcoming-fab-count" class="ml-1 inline-flex items-center justify-center w-6 h-6 rounded-full bg-white/20 text-xs">0</span>
                                </button>
                                <div id="upcoming-fab-panel" role="dialog" aria-label="Upcoming sessions"
                                  class="absolute bottom-16 right-0 w-80 max-w-[90vw] rounded-xl border border-white/40 bg-white/70 backdrop-blur shadow-xl p-3 opacity-0 scale-95 pointer-events-none transition duration-200">
                                  <div class="flex items-center justify-between px-1 pb-2">
                                    <h4 class="text-sm font-semibold text-gray-800">Your Upcoming</h4>
                                    <button id="upcoming-fab-close" aria-label="Close" class="text-gray-500 hover:text-gray-700">
                                      <i class="fas fa-times"></i>
                                    </button>
                                  </div>
                                  <div id="upcoming-fab-list" class="space-y-2 max-h-72 overflow-auto pr-1"></div>
                                  <div class="pt-2 flex justify-end">
                                    <a href="/volunteer/dashboard/upcoming" class="text-xs font-medium text-brand-primary hover:text-brand-primary">View all</a>
                                  </div>
                                </div>
                              </div>`;
                    document.body.appendChild(fabRoot);

                    // Toggle logic
                    const btn = document.getElementById('upcoming-fab-btn');
                    const panel = document.getElementById('upcoming-fab-panel');
                    const closeBtn = document.getElementById('upcoming-fab-close');
                    function openPanel() {
                        panel.classList.remove('opacity-0', 'scale-95', 'pointer-events-none');
                        btn.setAttribute('aria-expanded', 'true');
                    }
                    function closePanel() {
                        panel.classList.add('opacity-0', 'scale-95', 'pointer-events-none');
                        btn.setAttribute('aria-expanded', 'false');
                    }
                    btn.addEventListener('click', () => {
                        const expanded = btn.getAttribute('aria-expanded') === 'true';
                        if (expanded) closePanel(); else openPanel();
                    });
                    closeBtn.addEventListener('click', closePanel);
                    document.addEventListener('keydown', (e) => {
                        if (e.key === 'Escape') closePanel();
                    });
                    document.addEventListener('click', (e) => {
                        const within = fabRoot.contains(e.target);
                        const panelEl = document.getElementById('upcoming-fab-panel');
                        if (!within && panelEl && !panelEl.classList.contains('pointer-events-none')) closePanel();
                    });

                    // Render list into FAB
                    const fabCount = document.getElementById('upcoming-fab-count');
                    if (fabCount) fabCount.textContent = String(upcoming.length);
                    const fabList = document.getElementById('upcoming-fab-list');
                    if (fabList) {
                        const fabItems = upcoming.map(item => {
                            const when = new Date(item.time || item.start_time || item.scheduled_for || item.meeting_time || Date.now());
                            const localTime = when.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                            const localDate = when.toLocaleDateString();
                            const studentName = (item.student && (item.student.full_name || item.student.name)) || item.student_name || 'Student';
                            const avatar = (item.student && item.student.photo_url) || item.student_photo_url || '';
                            return `
                              <a href="/volunteer/dashboard/upcoming" class="flex items-center gap-3 p-2 rounded-lg border border-white/40 bg-white/60 hover:bg-white/80 transition" aria-label="Upcoming session with ${studentName} on ${localDate} at ${localTime}">
                                <div class="w-9 h-9 rounded-full overflow-hidden bg-gray-100 ring-2 ring-brand flex items-center justify-center">
                                  <img src="${avatar || '/images/default-profile.svg'}" alt="${studentName}" loading="lazy" class="w-full h-full object-cover upc-avatar-img" />
                                  <svg class="w-5 h-5 text-brand-primary ${avatar ? 'hidden' : ''} upc-avatar-fallback" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
                                    <path d="M10 10a4 4 0 100-8 4 4 0 000 8zM2 16a8 8 0 1116 0v1H2v-1z" />
                                  </svg>
                                </div>
                                <div class="flex-1 min-w-0">
                                  <p class="text-sm font-semibold text-gray-800 truncate">${studentName}</p>
                                  <p class="text-xs text-gray-500">${localDate} â€¢ ${localTime}</p>
                                </div>
                                <div class="shrink-0 text-gray-400"><i class="fas fa-video"></i></div>
                              </a>`;
                        }).join('');
                        fabList.innerHTML = fabItems || '<p class="text-xs text-gray-500 px-1">No upcoming sessions.</p>';
                        // Attach avatar fallback handlers (FAB)
                        fabList.querySelectorAll('.upc-avatar-img').forEach(img => {
                            img.addEventListener('error', function () {
                                this.classList.add('hidden');
                                const fallback = this.parentElement.querySelector('.upc-avatar-fallback');
                                if (fallback) fallback.classList.remove('hidden');
                            }, { once: true });
                        });
                    }
                }

                console.log('=== MAKING STUDENT CARDS API CALL ===');
                console.log('API URL:', `/api/v1/volunteers/students/cards?date=${selectedDate}`);
                return window.TalkTimeAuth.authenticatedRequest(`/api/v1/volunteers/students/cards?date=${selectedDate}`, {
                    method: 'GET'
                });
            })
            .then(response => {
                console.log('Student cards API response status:', response.status);
                if (!response.ok) {
                    throw new Error(`Failed to load students: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('=== STUDENT CARDS DATA RECEIVED ===');
                console.log('Full API response:', data);
                console.log('Available students count:', data.data?.available?.length || 0);
                console.log('Unavailable students count:', data.data?.unavailable?.length || 0);
                console.log('Available students:', data.data?.available?.map(s => s.full_name) || []);
                console.log('Unavailable students with meetings:', data.data?.unavailable?.map(s => ({
                    name: s.full_name,
                    isOwner: s.meeting?.isOwner,
                    meetingTime: s.meeting?.time
                })) || []);
                
                // Update the available students section
                if (availableStudentsContainer) {
                    // Backend returns data in data.available format
                    const availableStudents = data.data?.available || [];
                    if (!availableStudents || availableStudents.length === 0) {
                        // Check if this is an empty database vs no students for this date
                        const emptyMessage = data.isEmpty ? 
                            '<div class="text-center py-8"><div class="bg-brand-primary border border-brand rounded-lg p-6"><div class="flex items-center justify-center w-16 h-16 mx-auto mb-4 bg-brand-light rounded-full"><svg class="w-8 h-8 text-brand-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg></div><h3 class="text-lg font-semibold text-brand-primary mb-2">No Students Found</h3><p class="text-brand-primary-dark mb-4">The database appears to be empty. Please contact an administrator to add student profiles.</p><p class="text-sm text-brand-primary">Once students are added, they will appear here for scheduling.</p></div></div>' :
                            '<div class="text-center py-8"><p class="text-gray-500">No students available for this date.</p></div>';
                        availableStudentsContainer.innerHTML = emptyMessage;
                    } else {
                        // Generate HTML for student cards from JSON data
                        const studentCardsHtml = availableStudents.map((student, index) => {
                            // Capitalize each word in the name
                            const rawName = student.full_name || 'Student';
                            const studentName = rawName.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()).join(' ');
                            // Generate initials from full name (first letter of first and last name)
                            const nameParts = studentName.trim().split(' ').filter(p => p);
                            const initials = nameParts.length >= 2
                                ? (nameParts[0].charAt(0) + nameParts[nameParts.length - 1].charAt(0)).toUpperCase()
                                : studentName.charAt(0).toUpperCase();

                            // Check if photo exists and is valid
                            const hasValidPhoto = student.photo_url &&
                                student.photo_url !== '/images/default-profile.svg' &&
                                student.photo_url.trim() !== '';

                            // Build age and gender line (Boy/Girl)
                            const agePart = student.age ? `${student.age} years` : '';
                            const genderRaw = student.gender ? student.gender.toLowerCase() : '';
                            const genderPart = genderRaw === 'm' || genderRaw === 'male' ? 'Boy' : genderRaw === 'f' || genderRaw === 'female' ? 'Girl' : student.gender || '';
                            const ageGenderLine = [agePart, genderPart].filter(Boolean).join(' Â· ');

                            // Availability status
                            const availabilityText = student.is_available !== false ? 'Available' : 'Unavailable';

                            // Show divider except for last item
                            const isLast = index === availableStudents.length - 1;

                            return `
                            <div class="student-card cursor-pointer" data-student-id="${student.id}" data-student-admission="${student.admission_number || student.id}" data-student-name="${studentName}" style="padding:12px 16px;border:1px solid rgba(0,0,0,0.06);transition:border-color 0.15s ease" onmouseenter="this.style.borderColor='rgba(0,0,0,0.15)'" onmouseleave="this.style.borderColor='rgba(0,0,0,0.06)'">
                                <div style="display:flex;align-items:center;gap:16px">
                                    <div style="width:70px;height:70px;border-radius:50%;background:rgba(22,163,74,0.1);display:flex;align-items:center;justify-content:center;overflow:hidden;flex-shrink:0">
                                        ${hasValidPhoto
                                            ? `<img src="${student.photo_url}" alt="${studentName}" loading="lazy" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'" style="width:100%;height:100%;object-fit:cover;border-radius:50%"><span style="display:none;font-size:26px;font-weight:700;color:#16a34a">${initials}</span>`
                                            : `<span style="font-size:26px;font-weight:700;color:#16a34a">${initials}</span>`}
                                    </div>
                                    <div style="flex:1;min-width:0">
                                        <div style="font-weight:600;font-size:22px;color:#111827;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;line-height:1.2">${studentName}</div>
                                        <div style="font-size:18px;color:#6b7280;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;line-height:1.2">${ageGenderLine || 'Student'}</div>
                                    </div>
                                    <div style="flex-shrink:0;text-align:right;">
                                        <div style="font-size:18px;color:#9ca3af">${availabilityText}</div>
                                        <div id="online-status-${student.id}" style="font-size:11px;color:#9ca3af;margin-top:2px;"></div>
                                    </div>
                                    <svg style="width:30px;height:30px;color:#9ca3af;flex-shrink:0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                                </div>
                            </div>
                            ${!isLast ? '<div style="height:1px;background:#f3f4f6;margin-left:102px"></div>' : ''}
                            `;
                        }).join('');
                        availableStudentsContainer.innerHTML = studentCardsHtml;
                    }
                }

                // Toggle visibility of the 'Scheduled / Unavailable' section based on real data
                const unavailableContainer = document.getElementById('student-list-unavailable');
                const unavailableSection = unavailableContainer ? unavailableContainer.closest('section') : null;
                const unavailableStudents = (data.data && Array.isArray(data.data.unavailable)) ? data.data.unavailable : [];
                
                console.log('=== UNAVAILABLE SECTION DEBUG ===');
                console.log('Unavailable students data:', unavailableStudents);
                console.log('Unavailable students count:', unavailableStudents.length);
                console.log('Unavailable container exists:', !!unavailableContainer);
                console.log('Unavailable section exists:', !!unavailableSection);
                
                if (unavailableSection) {
                    if (!unavailableStudents || unavailableStudents.length === 0) {
                        // Hide section entirely if truly empty
                        console.log('Hiding unavailable section - no students');
                        unavailableSection.classList.add('hidden');
                        unavailableSection.setAttribute('aria-hidden', 'true');
                    } else {
                        // Ensure visible when data exists
                        console.log('Showing unavailable section - has students:', unavailableStudents.length);
                        unavailableSection.classList.remove('hidden');
                        unavailableSection.removeAttribute('aria-hidden');
                    }
                }
                
                // Update the unavailable students section
                const unavailableStudentsContainer = document.getElementById('student-list-unavailable');
                if (unavailableStudentsContainer) {
                    // Backend returns data in data.unavailable format
                    const unavailableStudents = data.data?.unavailable || [];
                    if (!unavailableStudents || unavailableStudents.length === 0) {
                        unavailableStudentsContainer.innerHTML = '<div class="text-center py-4"><p class="text-xs text-gray-500">No unavailable students for this date.</p></div>';
                    } else {
                        // Generate HTML for unavailable student cards with owner-specific UI
                        const unavailableCardsHtml = unavailableStudents.map((student, index) => {
                            // Capitalize each word in the name
                            const rawName = student.full_name || 'Student';
                            const studentName = rawName.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()).join(' ');
                            // Generate initials from full name
                            const nameParts = studentName.trim().split(' ').filter(p => p);
                            const initials = nameParts.length >= 2
                                ? (nameParts[0].charAt(0) + nameParts[nameParts.length - 1].charAt(0)).toUpperCase()
                                : studentName.charAt(0).toUpperCase();

                            const hasValidPhoto = student.photo_url &&
                                student.photo_url !== '/images/default-profile.svg' &&
                                student.photo_url.trim() !== '';

                            const isOwner = student.meeting && student.meeting.isOwner;
                            const meetingTime = student.meeting ? new Date(student.meeting.time) : null;

                            // Build age and gender line (Boy/Girl)
                            const agePart = student.age ? `${student.age} years` : '';
                            const genderRaw = student.gender ? student.gender.toLowerCase() : '';
                            const genderPart = genderRaw === 'm' || genderRaw === 'male' ? 'Boy' : genderRaw === 'f' || genderRaw === 'female' ? 'Girl' : student.gender || '';
                            const ageGenderLine = [agePart, genderPart].filter(Boolean).join(' Â· ');

                            // Show divider except for last item
                            const isLast = index === unavailableStudents.length - 1;

                            if (isOwner) {
                                // Owner UI: Show "Your Meeting" status
                                const timeUntilMeeting = meetingTime ? Math.max(0, meetingTime.getTime() - Date.now()) : 0;
                                const hoursUntil = Math.floor(timeUntilMeeting / (1000 * 60 * 60));
                                const minutesUntil = Math.floor((timeUntilMeeting % (1000 * 60 * 60)) / (1000 * 60));
                                const timeDisplay = hoursUntil > 0 ? `${hoursUntil}h ${minutesUntil}m` : `${minutesUntil}m`;

                                return `
                                <div class="student-card cursor-pointer" data-student-id="${student.id}" data-student-admission="${student.admission_number || student.id}" data-student-name="${studentName}" style="padding:12px 16px;border:1px solid rgba(22,163,74,0.15);transition:border-color 0.15s ease" onmouseenter="this.style.borderColor='rgba(22,163,74,0.4)'" onmouseleave="this.style.borderColor='rgba(22,163,74,0.15)'">
                                    <div style="display:flex;align-items:center;gap:16px">
                                        <div style="width:70px;height:70px;border-radius:50%;background:rgba(22,163,74,0.15);display:flex;align-items:center;justify-content:center;overflow:hidden;flex-shrink:0">
                                            ${hasValidPhoto
                                                ? `<img src="${student.photo_url}" alt="${studentName}" loading="lazy" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'" style="width:100%;height:100%;object-fit:cover;border-radius:50%"><span style="display:none;font-size:26px;font-weight:700;color:#16a34a">${initials}</span>`
                                                : `<span style="font-size:26px;font-weight:700;color:#16a34a">${initials}</span>`}
                                        </div>
                                        <div style="flex:1;min-width:0">
                                            <div style="font-weight:600;font-size:22px;color:#111827;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;line-height:1.2">${studentName}</div>
                                            <div style="font-size:18px;color:#6b7280;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;line-height:1.2">${ageGenderLine || 'Student'}</div>
                                        </div>
                                        <div style="flex-shrink:0;text-align:right;">
                                            <div style="font-size:18px;color:#16a34a;font-weight:500">${timeDisplay}</div>
                                            <div id="online-status-${student.id}" style="font-size:11px;color:#9ca3af;margin-top:2px;"></div>
                                        </div>
                                        <svg style="width:30px;height:30px;color:#9ca3af;flex-shrink:0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                                    </div>
                                </div>
                                ${!isLast ? '<div style="height:1px;background:#f3f4f6;margin-left:102px"></div>' : ''}
                                `;
                            } else {
                                // Non-owner UI: Show "Scheduled" status (muted) - DISABLED, cannot click
                                return `
                                <div class="student-card student-unavailable" data-student-id="${student.id}" data-student-admission="${student.admission_number || student.id}" data-student-name="${studentName}" style="padding:12px 16px;border:1px solid rgba(0,0,0,0.04);opacity:0.5;pointer-events:none;cursor:not-allowed">
                                    <div style="display:flex;align-items:center;gap:16px">
                                        <div style="width:70px;height:70px;border-radius:50%;background:rgba(22,163,74,0.08);display:flex;align-items:center;justify-content:center;overflow:hidden;flex-shrink:0">
                                            ${hasValidPhoto
                                                ? `<img src="${student.photo_url}" alt="${studentName}" loading="lazy" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'" style="width:100%;height:100%;object-fit:cover;border-radius:50%;filter:grayscale(1)"><span style="display:none;font-size:26px;font-weight:700;color:#9ca3af">${initials}</span>`
                                                : `<span style="font-size:26px;font-weight:700;color:#9ca3af">${initials}</span>`}
                                        </div>
                                        <div style="flex:1;min-width:0">
                                            <div style="font-weight:600;font-size:22px;color:#6b7280;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;line-height:1.2">${studentName}</div>
                                            <div style="font-size:18px;color:#9ca3af;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;line-height:1.2">${ageGenderLine || 'Student'}</div>
                                        </div>
                                        <div style="flex-shrink:0;text-align:right;">
                                            <div style="font-size:18px;color:#9ca3af">Scheduled</div>
                                            <div id="online-status-${student.id}" style="font-size:11px;color:#9ca3af;margin-top:2px;"></div>
                                        </div>
                                        <svg style="width:30px;height:30px;color:#d1d5db;flex-shrink:0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                                    </div>
                                </div>
                                ${!isLast ? '<div style="height:1px;background:#f3f4f6;margin-left:102px"></div>' : ''}
                                `;
                            }
                        }).join('');
                        unavailableStudentsContainer.innerHTML = unavailableCardsHtml;

                        // Start countdown timers for owner meetings
                        startCountdownTimers();
                    }
                }

                // Fetch online status for all students
                fetchOnlineStatus(data);
            })
            .catch(error => {
                console.error('Error loading dashboard data:', error);
                
                // Only show error notification for real errors (not 404 which might be empty database)
                if (!error.message.includes('404')) {
                    showNotification('Failed to load student data: ' + error.message, 'error');
                }
                
                // Show user-friendly empty state messages instead of error messages
                if (availableStudentsContainer) {
                    availableStudentsContainer.innerHTML = '<div class="text-center py-8"><div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6"><div class="flex items-center justify-center w-16 h-16 mx-auto mb-4 bg-warning-light rounded-full"><svg class="w-8 h-8 text-warning" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.5 0L4.232 16.5c-.77.833.192 2.5 1.732 2.5z"></path></svg></div><h3 class="text-lg font-semibold text-yellow-900 mb-2">Unable to Load Students</h3><p class="text-yellow-700 mb-4">There might be a connection issue or the database is empty.</p><button onclick="loadDashboardData()" class="bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700 transition-colors">Try Again</button></div></div>';
                }
                if (document.getElementById('student-list-unavailable')) {
                    document.getElementById('student-list-unavailable').innerHTML = '<div class="text-center py-8"><p class="text-gray-500">Unable to load unavailable students.</p></div>';
                }
            })
            .finally(() => {
                // Reset the loading flag and clear timeout
                if (loadingTimeout) clearTimeout(loadingTimeout);
                isLoadingDashboard = false;
                console.log('loadDashboardData completed, flag reset');
            });
        }

        // Fetch online status for all students and update indicators
        function fetchOnlineStatus(data) {
            const allStudents = [
                ...(data.data?.available || []),
                ...(data.data?.unavailable || [])
            ];
            const studentIds = allStudents.map(s => s.id);
            if (studentIds.length === 0) return;

            window.TalkTimeAuth.authenticatedRequest('/api/v1/volunteers/students/online-status', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ studentIds: studentIds })
            })
            .then(function(response) { return response.json(); })
            .then(function(result) {
                var online = result.online || {};
                studentIds.forEach(function(id) {
                    var el = document.getElementById('online-status-' + id);
                    if (!el) return;
                    if (online[id]) {
                        el.innerHTML = '<span style="display:inline-block;width:6px;height:6px;border-radius:50%;background:#16a34a;margin-right:3px;vertical-align:middle;"></span>online';
                        el.style.color = '#16a34a';
                    } else {
                        el.innerHTML = '<span style="display:inline-block;width:6px;height:6px;border-radius:50%;background:#9ca3af;margin-right:3px;vertical-align:middle;"></span>offline';
                        el.style.color = '#9ca3af';
                    }
                });
            })
            .catch(function(err) {
                console.error('Failed to fetch online status:', err);
            });
        }

        // Function to start and update countdown timers for owner meetings
        function startCountdownTimers() {
            // Clear any existing timers
            if (window.countdownInterval) {
                clearInterval(window.countdownInterval);
            }
            
            // Update timers every minute
            window.countdownInterval = setInterval(() => {
                const ownerCards = document.querySelectorAll('.student-card.bg-green-50');
                ownerCards.forEach(card => {
                    const timerElement = card.querySelector('.text-success-dark');
                    if (timerElement && timerElement.textContent.includes('Your Meeting:')) {
                        // Extract meeting time from data attributes or re-calculate
                        // For now, we'll refresh the entire section when timers need updating
                        // This ensures accuracy and prevents drift
                    }
                });
            }, 60000); // Update every minute
        }

        // Clear timers when page unloads
        window.addEventListener('beforeunload', () => {
            if (window.countdownInterval) {
                clearInterval(window.countdownInterval);
            }
        });
        
        // Function to handle instant call button clicks
        function setupEventListeners() {
            // Event delegation for student cards
            document.addEventListener('click', function(event) {
                // Handle student card clicks (for viewing details)
                if (event.target.closest('.student-card')) {
                    const card = event.target.closest('.student-card');

                    // CRITICAL: Block clicks on unavailable/scheduled students
                    if (card.classList.contains('student-unavailable')) {
                        console.log('[TalkTime] Student is unavailable - already scheduled by another volunteer');
                        event.preventDefault();
                        event.stopPropagation();
                        return; // Do nothing - student is not available
                    }

                    const studentId = card.dataset.studentId;
                    const studentAdmission = card.dataset.studentAdmission;
                    const studentName = card.querySelector('h3')?.textContent || card.dataset.studentName || 'Student';

                    // ðŸš¨ CRITICAL ACTION ENFORCEMENT: Check notifications before scheduling
                    if (!checkNotificationPermissionForCriticalAction('viewing student for scheduling')) {
                        console.log('ðŸš« Blocking student detail navigation - notifications not enabled');
                        showNotificationRequiredMessage();
                        return; // Prevent navigation
                    }

                    window.location.href = `/volunteer/dashboard/student-detail.html?id=${studentId}&admission=${studentAdmission}&name=${encodeURIComponent(studentName)}`;
                }
            });

            // Global click interceptor for critical action links
            document.addEventListener('click', function(event) {
                const target = event.target.closest('a');
                if (target && target.href) {
                    const href = target.getAttribute('href');
                    
                    // Intercept navigation to upcoming meetings (where cancellation/rescheduling happens)
                    if (href && href.includes('/volunteer/dashboard/upcoming')) {
                        // ðŸš¨ CRITICAL ACTION ENFORCEMENT: Check notifications before accessing meeting management
                        if (!checkNotificationPermissionForCriticalAction('managing scheduled meetings')) {
                            console.log('ðŸš« Blocking upcoming meetings navigation - notifications not enabled');
                            event.preventDefault();
                            event.stopPropagation();
                            showNotificationRequiredMessage();
                            return false;
                        }
                    }
                }
            });
        }
        

        
        // Initialize TalkTime Auth for volunteers FIRST
        window.TalkTimeAuth = new TalkTimeJWTAuth('volunteer');

        // --- Initial Load ---
        loadDashboardData();
        setupEventListeners();
        
        // Initialize approval status component using JWT authentication
        // --- Notification Permission Functions ---
        
        // Check and show notification permission warning on page load
        function checkAndShowNotificationWarning() {
            if ('Notification' in window) {
                const permission = Notification.permission;
                console.log('Current notification permission:', permission);
                
                // Show warning if permission is not granted
                if (permission === 'default' || permission === 'denied') {
                    const warningBanner = document.getElementById('notification-permission-warning');
                    if (warningBanner) {
                        warningBanner.style.display = 'block';
                        
                        // Auto-hide after 30 seconds if not interacted with
                        setTimeout(() => {
                            if (warningBanner.style.display !== 'none') {
                                warningBanner.style.display = 'none';
                            }
                        }, 30000);
                    }
                } else if (permission === 'granted') {
                    console.log('âœ… Notifications already enabled');
                    hideNotificationWarning();
                }
            } else {
                console.log('âŒ Browser does not support notifications');
            }
        }

        // Enhanced notification request with better messaging
        function requestNotificationPermission() {
            console.log('ðŸ“± Requesting enhanced notification permission...');
            
            if ('Notification' in window) {
                Notification.requestPermission().then(function(permission) {
                    console.log('Permission result:', permission);
                    
                    if (permission === 'granted') {
                        console.log('âœ… Enhanced notification permission granted!');
                        showNotification('ðŸŽ‰ Perfect! You\'ll now receive rich notifications for meetings, reminders, and instant calls with action buttons and persistence.', 'success');
                        hideNotificationWarning();
                        
                        // Send an enhanced test notification
                        setTimeout(() => {
                            sendEnhancedTestNotification();
                        }, 1000);
                        
                        // Set up notification event listeners
                        setupNotificationEventListeners();
                        
                        // Track permission granted for analytics
                        trackNotificationPermission('granted');
                    } else {
                        console.log('âŒ Notification permission denied');
                        showNotification('Notifications were blocked. You can enable them in your browser settings to get meeting reminders and instant call alerts.', 'error');
                        
                        // Track permission denied for analytics  
                        trackNotificationPermission('denied');
                        
                        // Keep the banner visible but update the message
                        updateWarningForDeniedPermission();
                    }
                });
            } else {
                console.log('âŒ Browser does not support notifications');
                showNotification('Your browser doesn\'t support notifications. Please update your browser for the best experience.', 'error');
            }
        }

        // Send an enhanced test notification with action buttons
        function sendEnhancedTestNotification() {
            if (Notification.permission === 'granted') {
                console.log('ðŸ”” Sending enhanced test notification...');
                
                const notification = new Notification('ðŸŽ‰ TalkTime Enhanced Notifications Enabled!', {
                    body: 'You\'ll receive rich notifications like this with action buttons for meetings, reminders, and instant calls. Notifications will persist until you interact with them.',
                    icon: '/talktime.ico',
                    badge: '/talktime.ico',
                    tag: 'talktime-enhanced-test',
                    requireInteraction: false,
                    actions: [
                        {
                            action: 'view_dashboard',
                            title: 'ðŸ‘€ View Dashboard'
                        },
                        {
                            action: 'settings',
                            title: 'âš™ï¸ Settings'
                        },
                        {
                            action: 'dismiss',
                            title: 'âœ• Dismiss'
                        }
                    ],
                    data: {
                        url: '/volunteer/dashboard/students.html',
                        timestamp: new Date().toISOString(),
                        type: 'test'
                    }
                });

                notification.onclick = function(event) {
                    console.log('âœ… Enhanced test notification clicked');
                    window.focus();
                    window.location.href = '/volunteer/dashboard/students.html';
                    notification.close();
                };

                // Auto-close after 8 seconds for test
                setTimeout(() => {
                    notification.close();
                }, 8000);
            }
        }

        // Function removed - now defined inside DOMContentLoaded handler

        // Function removed - now defined inside DOMContentLoaded handler

        // Function removed - now defined inside DOMContentLoaded handler

        // Function removed - now defined inside DOMContentLoaded handler

        // Function removed - now defined inside DOMContentLoaded handler

        // Function removed - now defined inside DOMContentLoaded handler

        // Function removed - now defined inside DOMContentLoaded handler

        // Show notification info modal
        function showNotificationInfo() {
            const infoModal = `
                <div id="notification-info-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="closeNotificationInfo()">
                    <div class="bg-white rounded-xl p-8 max-w-lg mx-4 relative" onclick="event.stopPropagation()">
                        <button onclick="closeNotificationInfo()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                        
                        <div class="text-center mb-6">
                            <div class="w-16 h-16 bg-brand-light rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-bell text-brand-primary text-2xl"></i>
                            </div>
                            <h3 class="text-xl font-bold text-gray-800 mb-2">Why Enable Notifications?</h3>
                        </div>
                        
                        <div class="space-y-4 text-sm text-gray-600">
                            <div class="flex items-start gap-3">
                                <i class="fas fa-clock text-brand-primary mt-1"></i>
                                <div>
                                    <strong>Meeting Reminders:</strong> Get notified 1 hour, 30 minutes, and 5 minutes before your scheduled meetings.
                                </div>
                            </div>
                            
                            <div class="flex items-start gap-3">
                                <i class="fas fa-phone text-green-500 mt-1"></i>
                                <div>
                                    <strong>Instant Calls:</strong> Receive immediate alerts when students initiate instant calls with you.
                                </div>
                            </div>
                            
                            <div class="flex items-start gap-3">
                                <i class="fas fa-calendar-alt text-brand-secondary mt-1"></i>
                                <div>
                                    <strong>Schedule Changes:</strong> Get notified about meeting reschedules, cancellations, and confirmations.
                                </div>
                            </div>
                            
                            <div class="flex items-start gap-3">
                                <i class="fas fa-shield-alt text-brand-primary mt-1"></i>
                                <div>
                                    <strong>Always Secure:</strong> Notifications only show basic info and never include personal details.
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-6 flex gap-3">
                            <button onclick="requestNotificationPermission(); closeNotificationInfo();" 
                                    class="flex-1 bg-brand-primary text-white py-3 rounded-lg font-medium hover:bg-brand-primary-dark transition-colors">
                                <i class="fas fa-bell mr-2"></i>Enable Now
                            </button>
                            <button onclick="closeNotificationInfo()" 
                                    class="px-6 py-3 border border-gray-300 rounded-lg text-gray-600 hover:bg-gray-50 transition-colors">
                                Maybe Later
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', infoModal);
        }

        // Close notification info modal
        function closeNotificationInfo() {
            const modal = document.getElementById('notification-info-modal');
            if (modal) {
                modal.remove();
            }
        }

        // Update warning message for denied permission
        function updateWarningForDeniedPermission() {
            const warningBanner = document.getElementById('notification-permission-warning');
            if (warningBanner) {
                const content = warningBanner.querySelector('.warning-content');
                if (content) {
                    content.innerHTML = `
                        <div class="flex items-start gap-4">
                            <div class="flex-shrink-0">
                                <div class="notification-icon">
                                    <i class="fas fa-exclamation-triangle text-white text-2xl"></i>
                                </div>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-white font-bold text-lg mb-2">
                                    ðŸš« Notifications Blocked
                                </h3>
                                <p class="text-white/90 text-sm mb-4 leading-relaxed">
                                    Notifications are currently blocked. To enable them:
                                    <br>â€¢ Click the ðŸ”’ lock icon in your browser's address bar
                                    <br>â€¢ Look for "Notifications" and change it to "Allow"
                                    <br>â€¢ Refresh the page and try again
                                </p>
                                <div class="flex flex-wrap gap-3">
                                    <button onclick="hideNotificationWarning()" class="dismiss-btn">
                                        <i class="fas fa-times mr-2"></i>Got It
                                    </button>
                                </div>
                            </div>
                            <button onclick="hideNotificationWarning()" class="close-btn">
                                <i class="fas fa-times text-white text-xl hover:text-red-200 transition-colors"></i>
                            </button>
                        </div>
                    `;
                }
            }
        }

        // Function removed - now defined inside DOMContentLoaded handler

        // Function removed - now defined inside DOMContentLoaded handler

        // Notification initialization moved to main DOMContentLoaded handler

        // Global functions now defined inside DOMContentLoaded handlers

        // ============================================
        // SHOW STUDENT MESSAGE MODAL
        // Called when student sends a message in response to instant call
        // ============================================
        function showStudentMessageModal(data) {
            const senderName = data.senderName || 'Student';
            const senderId = data.senderId;
            const messageContent = data.message || '';

            // Remove any existing modal
            const existingModal = document.getElementById('student-message-modal');
            if (existingModal) existingModal.remove();

            const modalHtml = `
                <div id="student-message-modal" class="fixed inset-0 z-[9999] flex items-center justify-center p-4" style="background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);">
                    <div class="bg-white rounded-2xl max-w-md w-full overflow-hidden transform transition-all animate-modal-in" style="box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);">
                        <!-- Header - Primary Red Background -->
                        <div class="p-6 text-center" style="background: #D10100;">
                            <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center mx-auto mb-3" style="box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
                                <svg class="w-8 h-8" style="color: #D10100;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path>
                                </svg>
                            </div>
                            <h2 class="text-xl font-bold" style="color: #ffffff; font-family: 'Poppins', sans-serif;">Message from ${senderName}</h2>
                            <p class="text-sm mt-1" style="color: rgba(255,255,255,0.9);">The student replied to your call</p>
                        </div>

                        <!-- Message Content - White Background -->
                        <div class="p-6" style="background: #ffffff;">
                            <div class="rounded-xl p-4 mb-5" style="background: #f9fafb; border: 1px solid #e5e7eb;">
                                <p class="text-center text-lg" style="color: #111827; font-family: 'Poppins', sans-serif;">"${messageContent}"</p>
                            </div>

                            <div class="rounded-lg p-3 mb-5" style="background: rgba(209,1,0,0.05); border: 1px solid rgba(209,1,0,0.2);">
                                <div class="flex items-start gap-2">
                                    <svg class="w-5 h-5 mt-0.5 flex-shrink-0" style="color: #D10100;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <p class="text-sm" style="color: #374151;">You can continue this conversation in the Messages section.</p>
                                </div>
                            </div>

                            <div class="flex flex-col gap-3">
                                <a href="/volunteer/dashboard/messages.html${senderId ? '?openConversation=' + senderId : ''}"
                                   class="w-full py-3.5 px-4 font-semibold rounded-xl transition-all text-center flex items-center justify-center gap-2"
                                   style="background: #D10100; color: #ffffff; font-family: 'Poppins', sans-serif; box-shadow: 0 4px 6px -1px rgba(209, 1, 0, 0.2);"
                                   onmouseover="this.style.background='#7d0000'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 10px 15px -3px rgba(209, 1, 0, 0.3)';"
                                   onmouseout="this.style.background='#D10100'; this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px -1px rgba(209, 1, 0, 0.2)';">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                                    </svg>
                                    Open Full Chat
                                </a>
                                <button id="close-student-message-modal"
                                        class="w-full py-3.5 px-4 font-semibold rounded-xl transition-all"
                                        style="background: #f9fafb; color: #374151; border: 1px solid #e5e7eb; font-family: 'Poppins', sans-serif;"
                                        onmouseover="this.style.background='#e5e7eb';"
                                        onmouseout="this.style.background='#f9fafb';">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);

            // Add close button handler
            document.getElementById('close-student-message-modal').addEventListener('click', () => {
                const modal = document.getElementById('student-message-modal');
                if (modal) modal.remove();
            });

            // Close on backdrop click
            document.getElementById('student-message-modal').addEventListener('click', (e) => {
                if (e.target.id === 'student-message-modal') {
                    e.target.remove();
                }
            });

            // Add animation styles if not already present
            if (!document.getElementById('modal-animation-styles')) {
                const styleEl = document.createElement('style');
                styleEl.id = 'modal-animation-styles';
                styleEl.textContent = `
                    @keyframes modal-in {
                        from { opacity: 0; transform: scale(0.95) translateY(-10px); }
                        to { opacity: 1; transform: scale(1) translateY(0); }
                    }
                    .animate-modal-in {
                        animation: modal-in 0.3s ease-out forwards;
                    }
                `;
                document.head.appendChild(styleEl);
            }
        }

        async function initializeApprovalStatus() {
            try {
                // Use the new JWT authentication utility
                if (!window.TalkTimeAuth.isAuthenticated()) {
                    console.log('Volunteer not authenticated');
                    return;
                }

                // Get user info using JWT auth utility
                const response = await window.TalkTimeAuth.authenticatedRequest('/api/v1/jwt-auth/verify');
                
                if (response.ok) {
                    const userInfo = await response.json();
                    

                }
            } catch (error) {
                console.error('Error initializing volunteer approval status:', error);
            }
        }
        initializeApprovalStatus();
    });
    </script>

    <!-- Initialize Navigation -->
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // Initialize navigation with authentication requirement
            await VolunteerNavLoader.init(true);

            // Initialize enhanced notification system
            console.log('ðŸš€ Initializing enhanced notification system...');
            
            // Initialize notification enforcer for critical actions
            if (typeof window.talkTimeNotificationEnforcer !== 'undefined') {
                console.log('ðŸ”’ Initializing notification enforcement for critical actions');
                window.talkTimeNotificationEnforcer.init();
            } else if (typeof NotificationEnforcer !== 'undefined') {
                console.log('ðŸ”’ Using NotificationEnforcer instance');
                // NotificationEnforcer auto-initializes, no need to call init manually
            }
            
            // Define notification event listeners function
            function setupNotificationEventListeners() {
                // Listen for push notification requests from server
                if (window.socket) {
                    window.socket.on('push-notification-request', function(data) {
                        handleServerPushNotification(data);
                    });
                    
                    window.socket.on('notification-update', function(data) {
                        handleNotificationUpdate(data);
                    });
                }
            }
            
            // Handle server-sent push notification requests
            function handleServerPushNotification(data) {
                if (Notification.permission !== 'granted') return;
                
                console.log('ðŸ”” Received server push notification request:', data);
                
                const { notificationData, metadata, priority } = data;
                
                const notification = new Notification(notificationData.title, {
                    body: notificationData.body,
                    icon: notificationData.icon || '/favicon.ico',
                    badge: notificationData.badge || '/favicon.ico',
                    tag: notificationData.tag || 'talktime-notification',
                    requireInteraction: notificationData.requireInteraction || false,
                    actions: notificationData.actions || [
                        { action: 'view', title: 'ðŸ‘€ View' },
                        { action: 'dismiss', title: 'âœ• Dismiss' }
                    ],
                    data: metadata || {},
                    renotify: priority === 'urgent'
                });
                
                notification.onclick = function(event) {
                    console.log('ðŸ–±ï¸ Notification clicked:', event);
                    event.notification.close();
                    
                    // Handle click action
                    if (notificationData.url) {
                        window.open(notificationData.url, '_blank');
                    }
                };
                
                notification.onclose = function(event) {
                    console.log('ðŸ”’ Notification closed:', event);
                };
                
                notification.onerror = function(event) {
                    console.error('âŒ Notification error:', event);
                };
            }
            
            // Handle notification updates (read status, etc.)
            function handleNotificationUpdate(data) {
                console.log('ðŸ“® Notification update received:', data);
                
                // Update notification badge if nav-loader is available
                if (window.VolunteerNavLoader && window.VolunteerNavLoader.loadNotificationCount) {
                    window.VolunteerNavLoader.loadNotificationCount();
                }
            }
            
            // Helper functions for notification warnings
            function hideNotificationWarning() {
                const warning = document.getElementById('notification-permission-warning');
                if (warning) {
                    warning.style.display = 'none';
                }
            }
            
            function updateWarningForDeniedPermission() {
                const warning = document.getElementById('notification-permission-warning');
                if (warning) {
                    warning.innerHTML = `
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
                            <div class="flex items-center">
                                <div class="flex-shrink-0">
                                    <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <h3 class="text-sm font-medium text-red-800">
                                        Notifications Blocked
                                    </h3>
                                    <div class="mt-2 text-sm text-error-dark">
                                        <p>Browser notifications are blocked. To enable them:</p>
                                        <ol class="list-decimal list-inside mt-2 space-y-1">
                                            <li>Click the lock icon in your browser's address bar</li>
                                            <li>Change notifications from "Block" to "Allow"</li>
                                            <li>Refresh this page</li>
                                        </ol>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }
            
            // Check notification permission status
            if ('Notification' in window) {
                if (Notification.permission === 'granted') {
                    console.log('âœ… Enhanced notifications already enabled');
                    hideNotificationWarning();
                    setupNotificationEventListeners();
                } else if (Notification.permission === 'denied') {
                    console.log('âŒ Notifications denied - showing help message');
                    updateWarningForDeniedPermission();
                } else {
                    console.log('ðŸ“± Notification permission not set - showing request banner');
                    // Banner is shown by default in HTML - ensure it stays visible
                    const warningBanner = document.getElementById('notification-permission-warning');
                    if (warningBanner) {
                        warningBanner.style.display = 'block';
                    }
                }
            } else {
                console.log('âŒ Browser does not support notifications');
            }
            
            // Set up periodic notification cleanup
            setInterval(() => {
                if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                    navigator.serviceWorker.controller.postMessage({
                        type: 'cleanup-old-notifications'
                    });
                }
            }, 300000); // Clean up every 5 minutes
        });
    </script>
</body>
</html>
