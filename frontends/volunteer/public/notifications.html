<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notifications - TalkTime by ADEA Foundation</title>
    <meta name="description" content="View and manage your TalkTime notifications">
    <link rel="canonical" href="/volunteer/notifications.html">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <!-- Main Styles -->
    <link rel="stylesheet" href="css/main.css" />
    
    <!-- Nav Loader for consistent navigation -->
    <script src="/volunteer/partials/nav-loader.js"></script>
    
    <!-- JWT Authentication Utility -->
    <script src="/shared/js/jwt-auth-utils.js"></script>
    
    <!-- Newsletter Widget -->
    <script src="/shared/js/newsletter-widget.js"></script>
    
    <!-- Socket.IO for real-time notifications -->
        <!-- Socket.IO Client -->
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js" integrity="sha384-c79GN5VsunZvi+Q/WObgk2in0CbZsHnjEqvFxC5DxHn9lTfNce2WW6h2pH6u/kF+" crossorigin="anonymous"></script>
    
    <!-- Google Fonts: Inter & Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Poppins:wght@600;700;800&display=swap" rel="stylesheet">
    
    <style>
        .notification-item {
            transition: all 0.2s ease-in-out;
        }
        .notification-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .unread {
            border-left: 4px solid #3b82f6;
            background: linear-gradient(90deg, rgba(59, 130, 246, 0.05) 0%, transparent 50%);
        }
        .priority-high {
            border-left-color: #ef4444;
        }
        .priority-medium {
            border-left-color: #f59e0b;
        }
        .priority-low {
            border-left-color: #10b981;
        }
        .loading {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="gradient-bg text-gray-800 min-h-screen">
    <!-- Background Blobs -->
    <div class="blob w-96 h-96 bg-purple-300 top-[-10rem] left-[-10rem]"></div>
    <div class="blob w-96 h-96 bg-blue-300 bottom-[-5rem] right-[-10rem]"></div>
    <div class="blob w-72 h-72 bg-pink-300 top-[10rem] right-[-5rem] md:right-[10rem]"></div>

    <!-- Navigation will be loaded by nav-loader.js -->
    <div id="nav-container"></div>

    <!-- Main Content -->
    <div class="pt-24 pb-12 px-4">
        <div class="container mx-auto max-w-6xl py-20">
            <!-- Page Header -->
            <div class="glass-card rounded-2xl p-8 mb-8 fade-in-up">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800 mb-2">
                            <i class="fas fa-bell text-blue-500 mr-3"></i>
                            Notifications
                        </h1>
                        <p class="text-gray-600">Stay updated with your TalkTime activities</p>
                    </div>
                    <div class="mt-4 sm:mt-0 flex space-x-3">
                        <button id="mark-all-read-btn" class="inline-flex items-center px-6 py-3 border border-gray-300 rounded-lg shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition-colors">
                            <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            Mark All Read
                        </button>
                        <button id="refresh-btn" class="inline-flex items-center px-6 py-3 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 transition-all">
                            <svg id="refresh-icon" class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            Refresh
                        </button>
                    </div>
                </div>
            </div>

            <!-- Filters -->
            <div class="glass-card rounded-2xl p-6 mb-8">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label for="status-filter" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                    <select id="status-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="all">All</option>
                        <option value="unread">Unread</option>
                        <option value="read">Read</option>
                    </select>
                </div>
                <div>
                    <label for="priority-filter" class="block text-sm font-medium text-gray-700 mb-1">Priority</label>
                    <select id="priority-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="all">All</option>
                        <option value="high">High</option>
                        <option value="medium">Medium</option>
                        <option value="low">Low</option>
                    </select>
                </div>
                <div>
                    <label for="type-filter" class="block text-sm font-medium text-gray-700 mb-1">Type</label>
                    <select id="type-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="all">All</option>
                        <option value="meeting">Meeting</option>
                        <option value="reminder">Reminder</option>
                        <option value="system">System</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button id="clear-filters-btn" class="w-full px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
                        Clear Filters
                    </button>
                </div>
            </div>
        </div>

            <!-- Notifications List -->
            <div class="glass-card rounded-2xl">
            <div id="notifications-container">
                <!-- Loading State -->
                <div id="loading-state" class="p-8 text-center">
                    <svg class="loading w-8 h-8 mx-auto text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    <p class="mt-2 text-gray-600">Loading notifications...</p>
                </div>

                <!-- Empty State -->
                <div id="empty-state" class="hidden p-8 text-center">
                    <svg class="w-16 h-16 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-5 5v-5zM11.293 7.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414l4-4z"></path>
                    </svg>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">No notifications</h3>
                    <p class="text-gray-600">You're all caught up! Check back later for new notifications.</p>
                </div>

                <!-- Notifications will be populated here -->
                <div id="notifications-list"></div>
            </div>

            <!-- Pagination -->
            <div id="pagination-container" class="hidden border-t border-gray-200 px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="text-sm text-gray-700">
                        Showing <span id="pagination-info"></span>
                    </div>
                    <div class="flex space-x-2">
                        <button id="prev-page-btn" class="px-3 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                            Previous
                        </button>
                        <button id="next-page-btn" class="px-3 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                            Next
                        </button>
                    </div>
                </div>
            </div>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toast-container" class="fixed top-4 right-4 z-50"></div>

    <script src="/shared/js/realtime-notifications.js"></script>
    <script>
        // Real-time notifications will be initialized by nav-loader
        
        let currentPage = 1;
        let totalPages = 1;
        let currentFilters = {
            status: 'all',
            priority: 'all',
            type: 'all'
        };

        // Initialize page
        document.addEventListener('DOMContentLoaded', async () => {
            // Wait for nav-loader to initialize, then load notifications
            setTimeout(async () => {
                if (window.TalkTimeAuth) {
                    await loadNotifications();
                    setupEventListeners();
                } else {
                    console.error('TalkTimeAuth not available after nav-loader initialization');
                }
            }, 2000); // Increased wait time
        });

        // Real-time notifications handled by nav-loader

        // Authentication handled by nav-loader

        async function loadNotifications() {
            try {
                showLoading(true);
                
                const queryParams = new URLSearchParams({
                    page: currentPage,
                    limit: 20,
                    ...currentFilters
                });

                const response = await window.TalkTimeAuth.authenticatedRequest(`/api/v1/notifications?${queryParams}`);
                
                if (!response.ok) {
                    throw new Error('Failed to load notifications');
                }

                const data = await response.json();
                displayNotifications(data.notifications);
                updatePagination(data.pagination);
                updateUnreadCount(data.unread_count);
                
            } catch (error) {
                console.error('Error loading notifications:', error);
                showToast('Failed to load notifications', 'error');
            } finally {
                showLoading(false);
            }
        }

        function displayNotifications(notifications) {
            const container = document.getElementById('notifications-list');
            const emptyState = document.getElementById('empty-state');
            
            if (!notifications || notifications.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            
            container.innerHTML = notifications.map(notification => `
                <div class="notification-item ${!notification.is_read ? 'unread' : ''} priority-${notification.priority} border-l-4 p-6 border-b border-gray-200 last:border-b-0" data-id="${notification.id}">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="flex items-center space-x-2 mb-2">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getPriorityBadgeClass(notification.priority)}">
                                    ${notification.priority}
                                </span>
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getTypeBadgeClass(notification.type)}">
                                    ${notification.type}
                                </span>
                                ${!notification.is_read ? '<span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">Unread</span>' : ''}
                            </div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">${notification.title}</h3>
                            <p class="text-gray-600 mb-3">${notification.message}</p>
                            <p class="text-sm text-gray-500">${formatDate(notification.created_at)}</p>
                        </div>
                        <div class="flex items-center space-x-2 ml-4">
                            ${!notification.is_read ? `<button class="mark-read-btn text-blue-600 hover:text-blue-800 text-sm font-medium" data-id="${notification.id}">Mark as Read</button>` : ''}
                            <button class="delete-btn text-red-600 hover:text-red-800" data-id="${notification.id}">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function getPriorityBadgeClass(priority) {
            switch (priority) {
                case 'high': return 'bg-red-100 text-red-800';
                case 'medium': return 'bg-yellow-100 text-yellow-800';
                case 'low': return 'bg-green-100 text-green-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function getTypeBadgeClass(type) {
            switch (type) {
                case 'meeting': return 'bg-blue-100 text-blue-800';
                case 'reminder': return 'bg-purple-100 text-purple-800';
                case 'system': return 'bg-indigo-100 text-indigo-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function updatePagination(pagination) {
            const container = document.getElementById('pagination-container');
            const info = document.getElementById('pagination-info');
            const prevBtn = document.getElementById('prev-page-btn');
            const nextBtn = document.getElementById('next-page-btn');

            if (pagination.total_pages <= 1) {
                container.classList.add('hidden');
                return;
            }

            container.classList.remove('hidden');
            totalPages = pagination.total_pages;
            
            const start = ((pagination.current_page - 1) * pagination.per_page) + 1;
            const end = Math.min(start + pagination.per_page - 1, pagination.total_count);
            
            info.textContent = `${start}-${end} of ${pagination.total_count} notifications`;
            
            prevBtn.disabled = !pagination.has_prev_page;
            nextBtn.disabled = !pagination.has_next_page;
        }

        function updateUnreadCount(count) {
            // Update notification badge in navigation if it exists
            const badge = document.getElementById('notification-badge');
            if (badge) {
                badge.textContent = count > 0 ? count : '';
                badge.classList.toggle('hidden', count === 0);
            }
        }

        function setupEventListeners() {
            // Filter changes
            ['status-filter', 'priority-filter', 'type-filter'].forEach(id => {
                document.getElementById(id).addEventListener('change', (e) => {
                    currentFilters[id.replace('-filter', '')] = e.target.value;
                    currentPage = 1;
                    loadNotifications();
                });
            });

            // Clear filters
            document.getElementById('clear-filters-btn').addEventListener('click', () => {
                currentFilters = { status: 'all', priority: 'all', type: 'all' };
                document.getElementById('status-filter').value = 'all';
                document.getElementById('priority-filter').value = 'all';
                document.getElementById('type-filter').value = 'all';
                currentPage = 1;
                loadNotifications();
            });

            // Pagination
            document.getElementById('prev-page-btn').addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    loadNotifications();
                }
            });

            document.getElementById('next-page-btn').addEventListener('click', () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    loadNotifications();
                }
            });

            // Mark all as read
            document.getElementById('mark-all-read-btn').addEventListener('click', async () => {
                try {
                    const response = await window.TalkTimeAuth.authenticatedRequest('/api/v1/notifications/read-all', {
                        method: 'PUT'
                    });

                    if (response.ok) {
                        showToast('All notifications marked as read', 'success');
                        loadNotifications();
                    }
                } catch (error) {
                    console.error('Error marking all as read:', error);
                    showToast('Failed to mark notifications as read', 'error');
                }
            });

            // Refresh
            document.getElementById('refresh-btn').addEventListener('click', () => {
                const icon = document.getElementById('refresh-icon');
                icon.classList.add('loading');
                
                loadNotifications().finally(() => {
                    setTimeout(() => icon.classList.remove('loading'), 500);
                });
            });

            // Individual notification actions
            document.addEventListener('click', async (e) => {
                if (e.target.classList.contains('mark-read-btn') || e.target.closest('.mark-read-btn')) {
                    const btn = e.target.classList.contains('mark-read-btn') ? e.target : e.target.closest('.mark-read-btn');
                    const id = btn.dataset.id;
                    await markAsRead(id);
                } else if (e.target.classList.contains('delete-btn') || e.target.closest('.delete-btn')) {
                    const btn = e.target.classList.contains('delete-btn') ? e.target : e.target.closest('.delete-btn');
                    const id = btn.dataset.id;
                    await deleteNotification(id);
                }
            });

            // Profile dropdown
            setupProfileDropdown();

            // Logout handlers
            const logoutLink = document.getElementById('logout-link');
            const mobileLogoutBtn = document.getElementById('mobile-logout-btn');
            
            if (logoutLink) {
                logoutLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    window.TalkTimeAuth.logout();
                    window.location.href = '/volunteer/login.html';
                });
            }
            
            if (mobileLogoutBtn) {
                mobileLogoutBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    window.TalkTimeAuth.logout();
                    window.location.href = '/volunteer/login.html';
                });
            }
        }

        async function markAsRead(id) {
            try {
                const response = await window.TalkTimeAuth.authenticatedRequest(`/api/v1/notifications/${id}/read`, {
                    method: 'PUT'
                });

                if (response.ok) {
                    showToast('Notification marked as read', 'success');
                    loadNotifications();
                }
            } catch (error) {
                console.error('Error marking as read:', error);
                showToast('Failed to mark notification as read', 'error');
            }
        }

        async function deleteNotification(id) {
            if (!confirm('Are you sure you want to delete this notification?')) {
                return;
            }

            try {
                const response = await window.TalkTimeAuth.authenticatedRequest(`/api/v1/notifications/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showToast('Notification deleted', 'success');
                    loadNotifications();
                }
            } catch (error) {
                console.error('Error deleting notification:', error);
                showToast('Failed to delete notification', 'error');
            }
        }

        function setupProfileDropdown() {
            const profileBtn = document.getElementById('profile-btn');
            const dropdown = document.getElementById('profile-dropdown');

            profileBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                dropdown.classList.toggle('hidden');
                dropdown.classList.toggle('opacity-0');
                dropdown.classList.toggle('-translate-y-2');
            });

            document.addEventListener('click', () => {
                dropdown.classList.add('hidden');
                dropdown.classList.add('opacity-0');
                dropdown.classList.add('-translate-y-2');
            });
        }

        function showLoading(show) {
            document.getElementById('loading-state').classList.toggle('hidden', !show);
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const bgColor = type === 'error' ? 'bg-red-500' : type === 'success' ? 'bg-green-500' : 'bg-blue-500';
            
            toast.className = `${bgColor} text-white px-6 py-3 rounded-lg shadow-lg mb-2 transform translate-x-full transition-transform duration-300`;
            toast.textContent = message;
            
            container.appendChild(toast);
            
            setTimeout(() => toast.classList.remove('translate-x-full'), 100);
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => container.removeChild(toast), 300);
            }, 3000);
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays === 1) {
                return `Today at ${date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
            } else if (diffDays === 2) {
                return `Yesterday at ${date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
            } else if (diffDays <= 7) {
                return `${diffDays - 1} days ago`;
            } else {
                return date.toLocaleDateString();
            }
        }
    </script>

    <!-- Initialize Navigation -->
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // Initialize navigation with authentication requirement
            await VolunteerNavLoader.init(true);
        });
    </script>
</body>
</html>
