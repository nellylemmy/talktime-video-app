<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>My Profile - TalkTime by ADEA Foundation</title>
    <!-- Early auth redirect - prevents FOUC on protected pages -->
    <script>
        if (!localStorage.getItem('volunteer_talktime_access_token')) {
            window.location.replace('/volunteer/login');
        }
    </script>

    <!-- Brand Theme System -->
    <link rel="stylesheet" href="/shared/css/brand-theme.css">
    <meta name="description" content="Manage your TalkTime volunteer profile, view your community service hours, and download official certificates.">
    <link rel="canonical" href="https://talktime.adeafoundation.org/volunteer/profile">

    <!-- CSS (all sync to prevent layout shift) -->
    <link rel="stylesheet" href="/shared/css/tailwind.min.css">
    <link rel="stylesheet" href="/shared/fonts/google/fonts.css">
    <link rel="stylesheet" href="/shared/fonts/fontawesome/all.min.css">
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/responsive-framework.css">
    <link rel="stylesheet" href="css/responsive-forms.css">
    <link rel="stylesheet" href="css/enhanced-mobile-nav.css">
    <link rel="stylesheet" href="css/volunteer-dashboard.css">

    <!-- Deferred Scripts (non-render-blocking) -->
    <script defer src="/shared/js/brand-config.js"></script>
    <script defer src="js/dashboard-nav.js"></script>
    
    <style>
        /* Page-specific styles only - framework styles in main.css */
        .profile-tab.active {
            border-color: var(--brand-primary) !important;
            color: var(--brand-primary) !important;
        }

        .tab-panel {
            display: block !important;
        }

        .tab-panel.hidden {
            display: none !important;
        }

        /* Mobile-scrollable tabs */
        .profile-tabs-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }
        .profile-tabs-container::-webkit-scrollbar {
            display: none;
        }

        @media (max-width: 640px) {
            .profile-tab {
                white-space: nowrap;
                padding: 12px 16px;
                font-size: 14px;
            }
        }

        .profile-field:disabled {
            background-color: #f9fafb;
            cursor: default;
            opacity: 0.8;
        }
        .profile-field:not(:disabled) {
            background-color: #fff;
        }
    </style>
    <!-- JWT Authentication Utility -->
    <script src="/shared/js/jwt-auth-utils.js"></script>

    <!-- Newsletter Widget -->
    <script src="/shared/js/newsletter-widget.js"></script>
    <!-- Enhanced Mobile Navigation -->
    <script src="/volunteer/js/enhanced-mobile-nav.js"></script>
    
    <!-- Initialize TalkTimeAuth -->
    <script>
        if (typeof TalkTimeJWTAuth !== 'undefined') {
            window.TalkTimeAuth = new TalkTimeJWTAuth('volunteer');
        }
    </script>
</head>
<body class="dashboard-page" style="opacity:0">
    <!-- Dashboard Navigation -->
    <div id="dashboard-nav-container"></div>

    <!-- Main Content -->
    <main class="content-area">
        <div class="w-full">
            <!-- Loading State -->
            <div id="loading-spinner" class="flex justify-center items-center min-h-screen">
                <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-brand-secondary"></div>
            </div>

            <!-- Profile Content -->
            <div id="profile-content" class="hidden">
                <!-- Profile Header -->
                <div class="glass-card rounded-2xl p-4 sm:p-6 mb-6 fade-in-up">
                    <div class="flex flex-col gap-6">
                        <!-- Profile Info Section -->
                        <div class="flex flex-col sm:flex-row items-center gap-4 sm:gap-6">
                            <div class="relative cursor-pointer group" id="avatar-upload-trigger">
                                <div id="profile-picture" class="w-24 h-24 rounded-full flex items-center justify-center text-white text-3xl font-bold shadow-lg group-hover:shadow-xl transition-all duration-200" style="background:#3867FF;">
                                    V
                                </div>
                                <img id="profile-image" alt="Profile" class="w-24 h-24 rounded-full shadow-lg object-cover hidden group-hover:shadow-xl transition-all duration-200">
                                
                                <!-- Edit indicator overlay -->
                                <div class="absolute inset-0 bg-black bg-opacity-40 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                                    <i class="fas fa-camera text-white text-xl"></i>
                                </div>
                                
                                <!-- Edit badge -->
                                <div class="absolute -bottom-1 -right-1 w-8 h-8 bg-brand-primary rounded-full flex items-center justify-center border-2 border-white shadow-lg">
                                    <i class="fas fa-pencil-alt text-white text-xs"></i>
                                </div>
                            </div>
                            <div class="text-center sm:text-left flex-1 min-w-0">
                                <h1 id="profile-name" class="text-2xl sm:text-3xl font-bold text-gray-800 mb-1 truncate">Loading...<i id="profile-complete-check" class="fas fa-check-circle text-green-500 text-lg ml-2 hidden" title="Profile complete"></i></h1>
                                <p id="profile-email" class="text-gray-600 mb-3 text-sm sm:text-base truncate">Loading...</p>
                                <div id="volunteer-type-badge" class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-slate-100 text-slate-700">
                                    <i class="fas fa-user mr-2"></i>
                                    <span id="volunteer-type-text">Volunteer</span>
                                </div>

                                <!-- Profile Completion Section (hidden when 100%) -->
                                <div class="mt-3 w-full" id="completion-section">
                                    <div class="flex items-center gap-3">
                                        <div class="flex-1 bg-gray-200 rounded-full h-2" id="completion-progress-container">
                                            <div id="completion-progress-bar" class="h-2 rounded-full transition-all duration-500" style="width: 0%;background:#D10100;"></div>
                                        </div>
                                        <div class="text-sm font-bold text-brand-primary whitespace-nowrap" id="completion-percentage">0%</div>
                                    </div>
                                    <div id="completion-fields-container" class="mt-1">
                                        <span class="text-gray-600 text-xs" id="fields-completed">0 of 0 fields completed</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- Profile Settings Section -->
                    <div class="mt-6 pt-6 border-t border-gray-200">
                        <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-4">
                            <i class="fas fa-user-edit text-gray-500 mr-2"></i>
                            Profile Settings
                        </h2>
                        <!-- Tab Navigation -->
                        <div class="border-b border-gray-200 mb-6">
                            <nav class="profile-tabs-container -mb-px flex space-x-4 sm:space-x-8">
                                <button id="tab-basic" class="profile-tab active py-2 px-1 border-b-2 border-brand font-medium text-sm text-brand-primary whitespace-nowrap">
                                    <i class="fas fa-user mr-2"></i>Basic Info
                                </button>
                                <button id="tab-about" class="profile-tab py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap">
                                    <i class="fas fa-heart mr-2"></i>About Me
                                </button>
                                <button id="tab-account" class="profile-tab py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap">
                                    <i class="fas fa-lock mr-2"></i>Account
                                </button>
                                <button id="tab-security" class="profile-tab py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap">
                                    <i class="fas fa-shield-alt mr-2"></i>Security
                                </button>
                                <button id="tab-student" class="profile-tab py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap hidden">
                                    <i class="fas fa-graduation-cap mr-2"></i>Student Info
                                </button>
                            </nav>
                        </div>
                        <!-- Tab Content -->
                        <div class="tab-content active">
                            <!-- Basic Info Tab -->
                            <div id="content-basic" class="tab-panel active">
                                <div class="py-2">
                                    <div class="space-y-4">
                                        <div>
                                            <label for="edit-name" class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                                            <input type="text" id="edit-name" name="fullName" disabled
                                                   class="profile-field w-full px-3 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-secondary focus:border-transparent text-gray-900">
                                        </div>
                                        <div>
                                            <label for="edit-username" class="block text-sm font-medium text-gray-700 mb-1">How would you like to be called?</label>
                                            <input type="text" id="edit-username" name="username" disabled
                                                   class="profile-field w-full px-3 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-secondary focus:border-transparent text-gray-900">
                                        </div>
                                        <div>
                                            <label for="edit-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                            <input type="email" id="edit-email" name="email" disabled
                                                   class="profile-field w-full px-3 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-secondary focus:border-transparent text-gray-900">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
                                            <input id="edit-phone" type="tel" disabled
                                                   class="profile-field w-full px-3 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-secondary focus:border-transparent text-gray-900">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Timezone</label>
                                            <select id="edit-timezone" disabled class="profile-field w-full px-3 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-secondary focus:border-transparent text-gray-900">
                                                    <option value="">Select timezone</option>
                                                    <option value="America/New_York">Eastern Time (ET)</option>
                                                    <option value="America/Chicago">Central Time (CT)</option>
                                                    <option value="America/Denver">Mountain Time (MT)</option>
                                                    <option value="America/Los_Angeles">Pacific Time (PT)</option>
                                                    <option value="Europe/London">London (GMT)</option>
                                                    <option value="Europe/Paris">Central Europe (CET)</option>
                                                    <option value="Africa/Nairobi">East Africa Time (EAT)</option>
                                                    <option value="Asia/Tokyo">Japan (JST)</option>
                                                    <option value="Australia/Sydney">Australia Eastern (AET)</option>
                                                </select>
                                            </div>
                                    </div>
                                </div>
                            </div>

                            <!-- About Me Tab -->
                            <div id="content-about" class="tab-panel hidden">
                                    <div class="space-y-4 py-2">
                                        <div class="grid grid-cols-2 gap-3">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">Age</label>
                                                <input id="edit-age" type="number" min="13" max="100" disabled class="profile-field w-full px-3 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-secondary focus:border-transparent text-gray-900">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">Gender</label>
                                                <select id="edit-gender" disabled class="profile-field w-full px-3 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-secondary focus:border-transparent text-gray-900">
                                                    <option value="">Select gender</option>
                                                    <option value="male">Male</option>
                                                    <option value="female">Female</option>
                                                    <option value="other">Other</option>
                                                    <option value="prefer_not_to_say">Prefer not to say</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                            </div>

                            <!-- Account Tab -->
                            <div id="content-account" class="tab-panel hidden">
                                    <div class="space-y-4 py-2">
                                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                                            <div class="flex">
                                                <i class="fas fa-info-circle text-yellow-400 mr-2 mt-0.5 flex-shrink-0"></i>
                                                <div>
                                                    <h4 class="text-sm font-medium text-yellow-800">Password Change</h4>
                                                    <p class="text-xs text-yellow-700 mt-0.5">Leave password fields empty if you don't want to change your password</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Current Password</label>
                                            <input id="edit-current-password" type="password" placeholder="Enter current password" disabled class="profile-field w-full px-3 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-secondary focus:border-transparent">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">New Password</label>
                                            <input id="edit-new-password" type="password" placeholder="Enter new password (min 8 characters)" disabled class="profile-field w-full px-3 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-secondary focus:border-transparent">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Confirm New Password</label>
                                            <input id="edit-confirm-password" type="password" placeholder="Confirm new password" disabled class="profile-field w-full px-3 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-secondary focus:border-transparent">
                                        </div>
                                    </div>
                            </div>

                            <!-- Security Tab -->
                            <div id="content-security" class="tab-panel hidden">
                                    <div class="space-y-4 py-2">
                                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                                            <div class="flex">
                                                <i class="fas fa-shield-alt text-blue-500 mr-2 mt-0.5 flex-shrink-0"></i>
                                                <div>
                                                    <h4 class="text-sm font-medium text-blue-800">Security Questions</h4>
                                                    <p class="text-xs text-blue-700 mt-0.5">These help secure your account and assist with password recovery</p>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Security Question 1 -->
                                        <div class="space-y-2">
                                            <label class="block text-sm font-medium text-gray-700">Security Question 1</label>
                                            <select id="edit-security-question-1" disabled class="profile-field w-full px-3 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-secondary focus:border-transparent text-sm">
                                                <option value="">Select a question</option>
                                                <option value="What is your mother's maiden name?">What is your mother's maiden name?</option>
                                                <option value="What was the name of your first pet?">What was the name of your first pet?</option>
                                                <option value="What is your favorite book?">What is your favorite book?</option>
                                                <option value="In what city were you born?">In what city were you born?</option>
                                                <option value="What is your favorite food?">What is your favorite food?</option>
                                            </select>
                                            <input id="edit-security-answer-1" type="text" placeholder="Your answer" disabled class="profile-field w-full px-3 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-secondary focus:border-transparent">
                                        </div>

                                        <!-- Security Question 2 -->
                                        <div class="space-y-2">
                                            <label class="block text-sm font-medium text-gray-700">Security Question 2</label>
                                            <select id="edit-security-question-2" disabled class="profile-field w-full px-3 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-secondary focus:border-transparent text-sm">
                                                <option value="">Select a question</option>
                                                <option value="What was your childhood nickname?">What was your childhood nickname?</option>
                                                <option value="What is the name of your best friend?">What is the name of your best friend?</option>
                                                <option value="What was your first car?">What was your first car?</option>
                                                <option value="What is your favorite movie?">What is your favorite movie?</option>
                                                <option value="What street did you live on in third grade?">What street did you live on in third grade?</option>
                                            </select>
                                            <input id="edit-security-answer-2" type="text" placeholder="Your answer" disabled class="profile-field w-full px-3 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-secondary focus:border-transparent">
                                        </div>

                                        <!-- Security Question 3 -->
                                        <div class="space-y-2">
                                            <label class="block text-sm font-medium text-gray-700">Security Question 3</label>
                                            <select id="edit-security-question-3" disabled class="profile-field w-full px-3 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-secondary focus:border-transparent text-sm">
                                                <option value="">Select a question</option>
                                                <option value="What is your favorite color?">What is your favorite color?</option>
                                                <option value="What was the model of your first phone?">What was the model of your first phone?</option>
                                                <option value="What is your dream destination?">What is your dream destination?</option>
                                                <option value="What was your first job?">What was your first job?</option>
                                                <option value="What is your favorite season?">What is your favorite season?</option>
                                            </select>
                                            <input id="edit-security-answer-3" type="text" placeholder="Your answer" disabled class="profile-field w-full px-3 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-secondary focus:border-transparent">
                                        </div>
                                    </div>
                            </div>

                            <!-- Student Info Tab -->
                            <div id="content-student" class="tab-panel hidden">
                                    <div class="space-y-4 py-2">
                                        <div class="bg-purple-50 border border-purple-200 rounded-lg p-3">
                                            <div class="flex">
                                                <i class="fas fa-graduation-cap text-purple-500 mr-2 mt-0.5 flex-shrink-0"></i>
                                                <div>
                                                    <h4 class="text-sm font-medium text-purple-800">Student Volunteer Information</h4>
                                                    <p class="text-xs text-purple-700 mt-0.5">Additional information for student volunteers</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">School Name</label>
                                            <input id="edit-school-name" type="text" disabled class="profile-field w-full px-3 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-secondary focus:border-transparent">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Parent Email</label>
                                            <input id="edit-parent-email" type="email" disabled class="profile-field w-full px-3 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-secondary focus:border-transparent">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Parent Phone</label>
                                            <input id="edit-parent-phone" type="tel" disabled class="profile-field w-full px-3 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-secondary focus:border-transparent">
                                        </div>
                                    </div>
                            </div>

                            <div class="mt-6 pt-4 border-t border-gray-200">
                                <!-- Edit Mode Button (shown by default) -->
                                <button id="edit-profile-btn" class="w-full sm:w-auto bg-brand-secondary text-white px-6 py-2.5 rounded-lg font-semibold hover:bg-brand-secondary-dark transition-colors">
                                    <i class="fas fa-edit mr-2"></i>Edit Profile
                                </button>

                                <!-- Save/Cancel Buttons (hidden by default) -->
                                <div class="hidden flex-col sm:flex-row gap-3" id="save-cancel-buttons">
                                    <button id="save-profile-btn" class="w-full sm:w-auto bg-brand-secondary text-white px-6 py-2.5 rounded-lg font-semibold hover:bg-brand-secondary-dark transition-colors">
                                        <i class="fas fa-save mr-2"></i>Save All Changes
                                    </button>
                                    <button id="cancel-profile-btn" class="w-full sm:w-auto bg-gray-200 text-gray-700 px-6 py-2.5 rounded-lg font-semibold hover:bg-gray-300 transition-colors">
                                        <i class="fas fa-times mr-2"></i>Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Volunteer Performance Dashboard -->
                <div class="glass-card rounded-2xl p-4 sm:p-6 mb-6 fade-in-up">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg sm:text-xl font-bold text-gray-800">Performance</h2>
                        <div id="performance-trend" class="flex items-center space-x-1">
                            <i id="trend-icon" class="fas fa-arrow-up text-green-500 text-sm"></i>
                            <span id="trend-text" class="text-xs font-medium text-success">Improving</span>
                        </div>
                    </div>

                    <!-- Loading -->
                    <div id="performance-dashboard-loading" class="flex justify-center items-center py-12">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-brand"></div>
                    </div>

                    <!-- Content -->
                    <div id="performance-dashboard-content" class="hidden">
                        <!-- Score + Success rate -->
                        <div class="flex items-center justify-between mb-1">
                            <div class="flex items-baseline gap-2">
                                <span id="reputation-score-large" class="text-2xl font-bold text-gray-800">—</span>
                                <span class="text-xs text-gray-400">/ 100</span>
                            </div>
                            <span id="success-rate-display" class="text-sm font-semibold text-gray-600">—</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-1.5 mb-5">
                            <div id="success-rate-bar" class="h-1.5 rounded-full transition-all duration-500" style="width:0%;background:#D10100;"></div>
                        </div>

                        <!-- Warning (hidden by default) -->
                        <div id="warning-system" class="mb-5 hidden">
                            <div id="warning-card" class="rounded-lg p-3">
                                <div class="flex items-start space-x-2">
                                    <i id="warning-icon" class="fas fa-exclamation-triangle text-sm flex-shrink-0 mt-0.5"></i>
                                    <div class="flex-1 min-w-0">
                                        <p id="warning-message-full" class="text-xs leading-relaxed"></p>
                                        <div id="restriction-notice" class="hidden mt-2 text-xs text-red-700 font-medium">
                                            Account restricted — cannot schedule new calls until performance improves.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- All-time breakdown -->
                        <div class="space-y-2 mb-5">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <div class="w-2 h-2 bg-success rounded-sm mr-2"></div>
                                    <span class="text-gray-600 text-sm">Completed</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span id="completed-calls-detail" class="font-semibold text-sm text-gray-800">—</span>
                                    <div class="w-16 h-1.5 bg-gray-200 rounded">
                                        <div id="completed-bar" class="h-1.5 bg-success rounded transition-all duration-500" style="width:0%"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <div class="w-2 h-2 bg-warning rounded-sm mr-2"></div>
                                    <span class="text-gray-600 text-sm">Cancelled</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span id="cancelled-calls-detail" class="font-semibold text-sm text-gray-800">—</span>
                                    <div class="w-16 h-1.5 bg-gray-200 rounded">
                                        <div id="cancelled-bar" class="h-1.5 bg-warning rounded transition-all duration-500" style="width:0%"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <div class="w-2 h-2 bg-error rounded-sm mr-2"></div>
                                    <span class="text-gray-600 text-sm">Missed</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span id="missed-calls-detail" class="font-semibold text-sm text-gray-800">—</span>
                                    <div class="w-16 h-1.5 bg-gray-200 rounded">
                                        <div id="missed-bar" class="h-1.5 bg-error rounded transition-all duration-500" style="width:0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Last 30 days -->
                        <div class="border-t border-gray-100 pt-4">
                            <p class="text-xs text-gray-400 mb-3">Last 30 days</p>
                            <div class="grid grid-cols-3 gap-2 text-center">
                                <div>
                                    <div id="recent-completed" class="text-base font-bold text-success">—</div>
                                    <div class="text-xs text-gray-500">Completed</div>
                                </div>
                                <div>
                                    <div id="recent-cancelled" class="text-base font-bold text-warning">—</div>
                                    <div class="text-xs text-gray-500">Cancelled</div>
                                </div>
                                <div>
                                    <div id="recent-missed" class="text-base font-bold text-error">—</div>
                                    <div class="text-xs text-gray-500">Missed</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Student Volunteer Credits Section -->
                <div id="student-volunteer-section" class="hidden mb-6">
                    <div class="glass-card rounded-2xl p-4 sm:p-6 fade-in-up">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
                            <h2 class="text-lg sm:text-xl font-bold text-gray-800">
                                <i class="fas fa-certificate text-yellow-500 mr-2"></i>
                                Community Service Credits
                            </h2>
                            <div class="flex items-center space-x-2">
                                <i class="fas fa-award text-yellow-500"></i>
                                <span id="total-credits" class="text-xl font-bold text-warning">0</span>
                                <span class="text-gray-600 text-sm">Hours</span>
                            </div>
                        </div>

                        <!-- Community Service Credits Explanation -->
                        <div class="bg-gradient-to-r from-yellow-50 to-orange-50 border border-yellow-200 rounded-xl p-4 mb-4">
                            <div class="mb-3">
                                <h3 class="text-base font-semibold text-gray-800 mb-2 flex items-center">
                                    <i class="fas fa-graduation-cap text-brand-primary mr-2 text-sm"></i>
                                    What are Community Service Credits?
                                </h3>
                                <p class="text-gray-700 text-sm leading-relaxed mb-3">
                                    Community Service Credits are official recognition of your volunteer contributions to help students improve their English skills. These credits are calculated based on your completed calls and are widely accepted by educational institutions, scholarship programs, and universities worldwide.
                                </p>

                                <div class="space-y-3">
                                    <div class="bg-white bg-opacity-70 rounded-lg p-3">
                                        <h4 class="font-semibold text-gray-800 mb-1.5 flex items-center text-sm">
                                            <i class="fas fa-check-circle text-green-500 mr-2 text-xs"></i>
                                            How Credits are Earned
                                        </h4>
                                        <ul class="text-xs text-gray-600 space-y-0.5">
                                            <li>Complete scheduled calls with students</li>
                                            <li>Each completed call = credit hours based on duration</li>
                                            <li>Consistent participation increases impact score</li>
                                            <li>Quality interactions boost overall rating</li>
                                        </ul>
                                    </div>

                                    <div class="bg-white bg-opacity-70 rounded-lg p-3">
                                        <h4 class="font-semibold text-gray-800 mb-1.5 flex items-center text-sm">
                                            <i class="fas fa-star text-yellow-500 mr-2 text-xs"></i>
                                            Credit Recognition
                                        </h4>
                                        <ul class="text-xs text-gray-600 space-y-0.5">
                                            <li>Official certificates for college applications</li>
                                            <li>Verified community service hours</li>
                                            <li>International recognition by institutions</li>
                                            <li>Personal development portfolio building</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <!-- Important Data Display -->
                            <div class="border-t border-yellow-200 pt-3">
                                <div class="grid grid-cols-2 gap-3">
                                    <div class="bg-white bg-opacity-80 rounded-lg p-2.5 text-center">
                                        <div class="text-xl font-bold text-brand-primary" id="total-minutes">0</div>
                                        <div class="text-xs text-gray-600">Minutes Contributed</div>
                                    </div>
                                    <div class="bg-white bg-opacity-80 rounded-lg p-2.5 text-center">
                                        <div class="text-xl font-bold text-brand-secondary" id="impact-score">0</div>
                                        <div class="text-xs text-gray-600">Impact Score</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Certificate Download Section -->
                        <div class="border-t border-gray-200 pt-4">
                            <h3 class="text-base font-semibold text-gray-800 mb-2">
                                <i class="fas fa-download text-brand-primary mr-2 text-sm"></i>
                                Official Service Certificates
                            </h3>
                            <p class="text-gray-600 mb-4 text-sm">
                                Download your official community service certificate recognized by educational institutions worldwide.
                            </p>
                            <div class="flex flex-col gap-3">
                                <button id="download-certificate-btn" class="w-full text-white px-4 py-2.5 rounded-lg font-semibold hover:opacity-90 transition-all flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed text-sm" style="background:#D10100;">
                                    <i class="fas fa-file-pdf mr-2"></i>
                                    Download Certificate (PDF)
                                </button>
                                <button id="preview-certificate-btn" class="w-full bg-white border-2 border-gray-300 text-gray-700 px-4 py-2.5 rounded-lg font-semibold hover:bg-gray-50 transition-all flex items-center justify-center text-sm">
                                    <i class="fas fa-eye mr-2"></i>
                                    Preview Certificate
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

            </div>



        </div>
    </main>

    <!-- Certificate Preview Modal -->
    <div id="certificate-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-2 sm:p-4">
        <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-auto">
            <div class="p-4 sm:p-6">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-lg sm:text-xl font-bold text-gray-800">Certificate Preview</h3>
                    <button id="close-modal-btn" class="text-gray-500 hover:text-gray-700 p-1">
                        <i class="fas fa-times text-lg"></i>
                    </button>
                </div>
                <div id="certificate-preview" class="border border-gray-200 rounded-lg p-4 sm:p-8 bg-gray-50">
                    <!-- Certificate content will be rendered here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Image Upload Modal -->
    <div id="imageUploadModal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center p-3 sm:p-4 hidden z-50">
        <div class="modal-glass-bg rounded-2xl max-w-md w-full p-4 sm:p-6 transform transition-all duration-300 scale-95" id="imageUploadModalContent">
            <div class="flex justify-between items-center mb-3">
                <h3 class="text-lg sm:text-xl font-semibold text-gray-800">Update Profile Photo</h3>
                <button id="closeImageModal" class="text-gray-400 hover:text-gray-600 transition-colors p-1">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>

            <!-- Current Avatar Preview -->
            <div class="flex justify-center mb-4">
                <div class="relative">
                    <div id="modalCurrentAvatar" class="w-20 h-20 sm:w-24 sm:h-24 rounded-full flex items-center justify-center text-white text-xl sm:text-2xl font-bold" style="background:#3867FF;">
                        V
                    </div>
                    <img id="modalProfileImage" class="w-20 h-20 sm:w-24 sm:h-24 rounded-full object-cover hidden" alt="Profile">
                </div>
            </div>

            <!-- Upload Area -->
            <div id="modalImageDropZone" class="border-2 border-dashed border-gray-300 rounded-lg p-4 sm:p-6 text-center hover:border-brand transition-colors cursor-pointer bg-gray-50 hover:bg-gray-100">
                <div id="modalDropZoneContent">
                    <i class="fas fa-cloud-upload-alt text-2xl sm:text-3xl text-gray-400 mb-2"></i>
                    <p class="text-gray-600 mb-1 text-sm">Drop your photo here or <span class="text-brand-primary font-medium">browse</span></p>
                    <p class="text-xs text-gray-500">PNG, JPG, WEBP up to 5MB</p>
                </div>
                <div id="modalUploadProgress" class="hidden">
                    <i class="fas fa-spinner fa-spin text-brand-primary text-xl sm:text-2xl mb-2"></i>
                    <p class="text-brand-primary text-sm">Uploading...</p>
                </div>
            </div>
            <input type="file" id="modalProfileImageInput" accept=".jpg,.jpeg,.png,.webp" class="hidden">

            <!-- Action buttons -->
            <div class="flex justify-between items-center mt-4">
                <button id="modalRemoveImageBtn" type="button" class="text-red-500 hover:text-error text-sm font-medium transition-colors hidden">
                    <i class="fas fa-trash mr-1"></i>Remove
                </button>
                <div class="flex gap-2">
                    <button id="modalCancelBtn" type="button" class="px-3 py-2 text-gray-600 hover:text-gray-800 font-medium transition-colors text-sm">
                        Cancel
                    </button>
                </div>
            </div>

            <div id="modalUploadStatus" class="text-xs mt-2 text-center"></div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // Initialize authentication and load profile data
        let currentUser = null;
        let profileData = null;

        async function initializePage() {
            console.log('Initializing profile page...');
            
            // Wait for TalkTimeAuth to be available
            let attempts = 0;
            while (!window.TalkTimeAuth && attempts < 50) {
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }
            
            if (!window.TalkTimeAuth) {
                console.error('TalkTimeAuth not available');
                window.location.href = '/volunteer/login';
                return;
            }
            
            // Check authentication
            if (!window.TalkTimeAuth.isAuthenticated()) {
                window.location.href = '/volunteer/login';
                return;
            }
            
            try {
                // Verify token and load profile data
                const isValid = await window.TalkTimeAuth.verifyToken();
                if (!isValid) {
                    window.location.href = '/volunteer/login';
                    return;
                }
                
                currentUser = window.TalkTimeAuth.getUser();
                await loadProfileData();
                
            } catch (error) {
                console.error('Authentication error:', error);
                window.location.href = '/volunteer/login';
            }
        }

        async function loadProfileData() {
            try {
                // Load basic profile data
                const response = await window.TalkTimeAuth.authenticatedRequest('/api/v1/volunteers/profile', {
                    method: 'GET'
                });

                if (!response.ok) {
                    throw new Error('Failed to load profile data');
                }

                const responseData = await response.json();

                // Extract profile from response - backend returns { success: true, profile: {...} }
                profileData = responseData.profile || responseData;

                // Fix field name mismatch - backend returns profileImage, frontend expects profile_image
                profileData.profile_image = profileData.profileImage;

                console.log('Profile data loaded:', profileData);
                console.log('Profile image URL:', profileData.profile_image);

                // Load credit data for student volunteers
                if (profileData.isStudentVolunteer) {
                    await loadCreditData();
                }
                
                renderProfile();
                
                // Load profile completion data
                await loadProfileCompletion();
                
                // Load performance data
                await loadPerformanceData();
                
            } catch (error) {
                console.error('Error loading profile data:', error);
                showErrorMessage('Failed to load profile data');
            }
        }

        async function loadCreditData() {
            try {
                const response = await window.TalkTimeAuth.authenticatedRequest('/api/v1/volunteer/credits', {
                    method: 'GET'
                });

                if (response.ok) {
                    const creditData = await response.json();
                    profileData.credits = creditData;
                }
            } catch (error) {
                console.error('Error loading credit data:', error);
            }
        }

        async function loadPerformanceData() {
            try {
                const response = await window.TalkTimeAuth.authenticatedRequest('/api/v1/volunteers/performance', {
                    method: 'GET'
                });

                if (response.ok) {
                    const performanceData = await response.json();
                    profileData.performance = performanceData.performance;
                    renderPerformanceData();
                } else {
                    console.error('Failed to load performance data');
                    document.getElementById('performance-dashboard-loading').style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading performance data:', error);
                document.getElementById('performance-dashboard-loading').style.display = 'none';
            }
        }

        function renderPerformanceData() {
            const performance = profileData.performance;
            if (!performance) return;

            document.getElementById('performance-dashboard-loading').classList.add('hidden');
            document.getElementById('performance-dashboard-content').classList.remove('hidden');

            // Score + success rate
            document.getElementById('reputation-score-large').textContent = performance.reputationScore;
            document.getElementById('success-rate-display').textContent = performance.successRate + '% success';
            document.getElementById('success-rate-bar').style.width = performance.successRate + '%';

            // All-time breakdown
            document.getElementById('completed-calls-detail').textContent = performance.completedCalls;
            document.getElementById('cancelled-calls-detail').textContent = performance.cancelledCalls;
            document.getElementById('missed-calls-detail').textContent = performance.missedCalls;

            const total = Math.max(performance.totalScheduled, 1);
            document.getElementById('completed-bar').style.width = (performance.completedCalls / total * 100) + '%';
            document.getElementById('cancelled-bar').style.width = (performance.cancelledCalls / total * 100) + '%';
            document.getElementById('missed-bar').style.width = (performance.missedCalls / total * 100) + '%';

            // Last 30 days
            document.getElementById('recent-completed').textContent = performance.recentCompleted;
            document.getElementById('recent-cancelled').textContent = performance.recentCancelled;
            document.getElementById('recent-missed').textContent = performance.recentMissed;

            // Trend
            const trendIcon = document.getElementById('trend-icon');
            const trendText = document.getElementById('trend-text');
            switch (performance.performanceTrend) {
                case 'improving':
                    trendIcon.className = 'fas fa-arrow-up text-green-500 text-sm';
                    trendText.textContent = 'Improving';
                    trendText.className = 'text-xs font-medium text-success';
                    break;
                case 'declining':
                    trendIcon.className = 'fas fa-arrow-down text-red-500 text-sm';
                    trendText.textContent = 'Declining';
                    trendText.className = 'text-xs font-medium text-error';
                    break;
                default:
                    trendIcon.className = 'fas fa-arrow-right text-gray-400 text-sm';
                    trendText.textContent = 'Stable';
                    trendText.className = 'text-xs font-medium text-gray-500';
            }

            // Warning
            if (performance.warningStatus !== 'none') {
                document.getElementById('warning-system').classList.remove('hidden');
                let cardClass;
                switch (performance.warningStatus) {
                    case 'critical':
                    case 'severe':
                        cardClass = 'bg-red-50 border border-red-200'; break;
                    case 'moderate':
                        cardClass = 'bg-yellow-50 border border-yellow-200'; break;
                    case 'minor':
                        cardClass = 'bg-blue-50 border border-blue-200'; break;
                }
                document.getElementById('warning-card').className = `rounded-lg p-3 ${cardClass}`;
                document.getElementById('warning-message-full').textContent = performance.warningMessage;
                if (performance.isRestricted) {
                    document.getElementById('restriction-notice').classList.remove('hidden');
                }
            }
        }

        function renderProfile() {
            // Hide loading spinner and show content
            document.getElementById('loading-spinner').classList.add('hidden');
            document.getElementById('profile-content').classList.remove('hidden');
            
            // Update profile header
            const fullName = profileData.fullName || profileData.full_name || currentUser.full_name || currentUser.fullName || 'Volunteer';
            const email = profileData.volunteer?.email || profileData.email || currentUser.email || '';
            const volunteer = profileData.volunteer || profileData;
            
            // Populate Basic Info tab fields with null checks
            const setElementValue = (id, value) => {
                const element = document.getElementById(id);
                if (element) {
                    element.value = value || '';
                } else {
                    console.warn(`Element with ID '${id}' not found`);
                }
            };
            
            setElementValue('edit-username', profileData.username || volunteer.username);
            setElementValue('edit-name', fullName);
            setElementValue('edit-email', email);
            setElementValue('edit-age', volunteer.age);
            setElementValue('edit-gender', volunteer.gender);
            setElementValue('edit-phone', volunteer.phone);
            setElementValue('edit-timezone', volunteer.timezone);
            
            // Populate Security tab fields (questions only, not answers)
            setElementValue('edit-security-question-1', volunteer.securityQuestion1);
            setElementValue('edit-security-question-2', volunteer.securityQuestion2);
            setElementValue('edit-security-question-3', volunteer.securityQuestion3);
            
            // Clear password fields
            setElementValue('edit-current-password', '');
            setElementValue('edit-new-password', '');
            setElementValue('edit-confirm-password', '');
            
            // Show placeholder for security answers if they exist (for privacy)
            const answer1Field = document.getElementById('edit-security-answer-1');
            const answer2Field = document.getElementById('edit-security-answer-2');
            const answer3Field = document.getElementById('edit-security-answer-3');
            
            if (answer1Field) {
                if (profileData.hasSecurityAnswer1) {
                    answer1Field.placeholder = "Answer saved (hidden for security)";
                    answer1Field.value = "";
                } else {
                    answer1Field.placeholder = "Your answer";
                    answer1Field.value = "";
                }
            }
            
            if (answer2Field) {
                if (profileData.hasSecurityAnswer2) {
                    answer2Field.placeholder = "Answer saved (hidden for security)";
                    answer2Field.value = "";
                } else {
                    answer2Field.placeholder = "Your answer";
                    answer2Field.value = "";
                }
            }
            
            if (answer3Field) {
                if (profileData.hasSecurityAnswer3) {
                    answer3Field.placeholder = "Answer saved (hidden for security)";
                    answer3Field.value = "";
                } else {
                    answer3Field.placeholder = "Your answer";
                    answer3Field.value = "";
                }
            }
            
            // Update avatar display
            updateAvatarDisplay();
            
            console.log('Profile loaded - Avatar display updated with image:', profileData.profile_image);
            
            // Show/hide student volunteer tab and populate fields if applicable
            const studentTab = document.getElementById('tab-student');
            if (volunteer.schoolName || volunteer.parentEmail || volunteer.parentPhone) {
                if (studentTab) studentTab.classList.remove('hidden');
                setElementValue('edit-school-name', volunteer.schoolName);
                setElementValue('edit-parent-email', volunteer.parentEmail);
                setElementValue('edit-parent-phone', volunteer.parentPhone);
            } else {
                if (studentTab) studentTab.classList.add('hidden');
            }
            
            // Update profile header display
            const profileNameEl = document.getElementById('profile-name');
            const profileEmailEl = document.getElementById('profile-email');
            
            if (profileNameEl) {
                profileNameEl.firstChild.textContent = fullName;
            }
            if (profileEmailEl) {
                profileEmailEl.textContent = email;
            }
            
            // Update navigation greeting
            const volunteerGreeting = document.getElementById('volunteer-greeting');
            if (volunteerGreeting) {
                const displayName = currentUser.username || fullName.split(' ')[0] || 'Volunteer';
                volunteerGreeting.textContent = `Welcome, ${displayName}!`;
            }
            
            
            // Show/hide student volunteer section
            if (profileData?.isStudentVolunteer || profileData?.credits) {
                const studentSection = document.getElementById('student-volunteer-section');
                if (studentSection) {
                    studentSection.classList.remove('hidden');
                }
                const volunteerTypeText = document.getElementById('volunteer-type-text');
                if (volunteerTypeText) {
                    volunteerTypeText.textContent = 'Student Volunteer';
                }
                const volunteerTypeBadge = document.getElementById('volunteer-type-badge');
                if (volunteerTypeBadge) {
                    volunteerTypeBadge.className = 'inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-warning-light text-yellow-800';
                }
                
                // Render credits data if available
                renderCredits();
            }
        }

        function renderCredits() {
            if (!profileData.credits) return;
            
            const credits = profileData.credits;
            document.getElementById('total-credits').textContent = Math.floor(credits.totalMinutes / 60) || 0;
            
            // Only update elements that still exist after UI changes
            const totalMinutesEl = document.getElementById('total-minutes');
            const impactScoreEl = document.getElementById('impact-score');
            
            if (totalMinutesEl) {
                totalMinutesEl.textContent = credits.totalMinutes || 0;
            }
            if (impactScoreEl) {
                impactScoreEl.textContent = credits.impactScore || 0;
            }
            
            // Enable certificate download if user has credits
            const downloadBtn = document.getElementById('download-certificate-btn');
            if (downloadBtn) {
                if (credits.completedCalls > 0) {
                    downloadBtn.disabled = false;
                } else {
                    downloadBtn.disabled = true;
                    downloadBtn.innerHTML = '<i class="fas fa-lock mr-2"></i>Complete calls to unlock';
                }
            }
        }

        function renderRecentActivity() {
            const activityList = document.getElementById('recent-activity-list');
            
            // Placeholder activity data
            const activities = [
                {
                    type: 'call_completed',
                    description: 'Completed call with student',
                    time: '2 hours ago',
                    icon: 'fas fa-phone text-green-500'
                },
                {
                    type: 'profile_updated',
                    description: 'Updated profile information',
                    time: '1 day ago',
                    icon: 'fas fa-user-edit text-brand-primary'
                }
            ];
            
            activityList.innerHTML = activities.map(activity => `
                <div class="flex items-center space-x-4 p-4 bg-white bg-opacity-50 rounded-lg">
                    <div class="flex-shrink-0">
                        <i class="${activity.icon}"></i>
                    </div>
                    <div class="flex-1">
                        <p class="text-gray-800 font-medium">${activity.description}</p>
                        <p class="text-gray-600 text-sm">${activity.time}</p>
                    </div>
                </div>
            `).join('');
        }

        // Certificate functionality
        document.getElementById('preview-certificate-btn').addEventListener('click', async () => {
            await showCertificatePreview();
        });

        document.getElementById('download-certificate-btn').addEventListener('click', async () => {
            await downloadCertificate();
        });

        async function showCertificatePreview() {
            try {
                const response = await window.TalkTimeAuth.authenticatedRequest('/api/v1/volunteer/certificate/preview', {
                    method: 'GET'
                });

                if (!response.ok) {
                    throw new Error('Failed to generate certificate preview');
                }

                const certificateHtml = await response.text();
                document.getElementById('certificate-preview').innerHTML = certificateHtml;
                document.getElementById('certificate-modal').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error previewing certificate:', error);
                showErrorMessage('Failed to preview certificate');
            }
        }

        async function downloadCertificate() {
            try {
                const response = await window.TalkTimeAuth.authenticatedRequest('/api/v1/volunteer/certificate/download', {
                    method: 'GET'
                });

                if (!response.ok) {
                    throw new Error('Failed to download certificate');
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `TalkTime_Certificate_${currentUser.full_name || 'Volunteer'}_${new Date().getFullYear()}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                
            } catch (error) {
                console.error('Error downloading certificate:', error);
                showErrorMessage('Failed to download certificate');
            }
        }

        // Modal controls
        document.getElementById('close-modal-btn').addEventListener('click', () => {
            document.getElementById('certificate-modal').classList.add('hidden');
        });

        // Profile management
        document.getElementById('save-profile-btn').addEventListener('click', async () => {
            // Collect all form data
            const formData = {
                username: document.getElementById('edit-username').value.trim(),
                fullName: document.getElementById('edit-name').value.trim(),
                age: document.getElementById('edit-age').value,
                gender: document.getElementById('edit-gender').value,
                phone: document.getElementById('edit-phone').value.trim(),
                timezone: document.getElementById('edit-timezone').value
            };
            
            // Add student volunteer fields if visible
            const studentVolunteerFields = document.getElementById('content-student');
            if (studentVolunteerFields && !studentVolunteerFields.classList.contains('hidden')) {
                const schoolNameField = document.getElementById('edit-school-name');
                const parentEmailField = document.getElementById('edit-parent-email');
                const parentPhoneField = document.getElementById('edit-parent-phone');
                
                if (schoolNameField) formData.schoolName = schoolNameField.value.trim();
                if (parentEmailField) formData.parentEmail = parentEmailField.value.trim();
                if (parentPhoneField) formData.parentPhone = parentPhoneField.value.trim();
            }
            
            // Add security questions and answers
            const securityQ1Element = document.getElementById('edit-security-question-1');
            const securityA1Element = document.getElementById('edit-security-answer-1');
            const securityQ2Element = document.getElementById('edit-security-question-2');
            const securityA2Element = document.getElementById('edit-security-answer-2');
            const securityQ3Element = document.getElementById('edit-security-question-3');
            const securityA3Element = document.getElementById('edit-security-answer-3');
            
            const securityQ1 = securityQ1Element ? securityQ1Element.value : '';
            const securityA1 = securityA1Element ? securityA1Element.value.trim() : '';
            const securityQ2 = securityQ2Element ? securityQ2Element.value : '';
            const securityA2 = securityA2Element ? securityA2Element.value.trim() : '';
            const securityQ3 = securityQ3Element ? securityQ3Element.value : '';
            const securityA3 = securityA3Element ? securityA3Element.value.trim() : '';
            
            if (securityQ1) {
                formData.securityQuestion1 = securityQ1;
                if (securityA1) formData.securityAnswer1 = securityA1;
            }
            if (securityQ2) {
                formData.securityQuestion2 = securityQ2;
                if (securityA2) formData.securityAnswer2 = securityA2;
            }
            if (securityQ3) {
                formData.securityQuestion3 = securityQ3;
                if (securityA3) formData.securityAnswer3 = securityA3;
            }
            
            // Handle password change validation
            const currentPassword = document.getElementById('edit-current-password').value;
            const newPassword = document.getElementById('edit-new-password').value;
            const confirmPassword = document.getElementById('edit-confirm-password').value;
            
            if (newPassword || currentPassword || confirmPassword) {
                if (!currentPassword) {
                    showErrorMessage('Current password is required to change password');
                    return;
                }
                if (!newPassword) {
                    showErrorMessage('New password is required');
                    return;
                }
                if (newPassword !== confirmPassword) {
                    showErrorMessage('New passwords do not match');
                    return;
                }
                if (newPassword.length < 8) {
                    showErrorMessage('New password must be at least 8 characters long');
                    return;
                }
                
                formData.currentPassword = currentPassword;
                formData.newPassword = newPassword;
            }
            
            // Validate required fields (compulsory fields that cannot be blank)
            const requiredFields = [
                { field: 'fullName', name: 'Full name' },
                { field: 'age', name: 'Age' },
                { field: 'gender', name: 'Gender' }
            ];
            
            for (const { field, name } of requiredFields) {
                if (!formData[field] || formData[field].toString().trim() === '') {
                    showErrorMessage(`${name} is required and cannot be left blank`);
                    return;
                }
            }
            
            // Validate age is a number and within reasonable range
            const age = parseInt(formData.age);
            if (isNaN(age) || age < 13 || age > 100) {
                showErrorMessage('Please enter a valid age between 13 and 100');
                return;
            }
            
            // Validate email format if provided (optional field but must be valid if filled)
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (formData.parentEmail && !emailRegex.test(formData.parentEmail)) {
                showErrorMessage('Please enter a valid parent email address');
                return;
            }
            
            // Validate phone format if provided (optional but must be valid if filled)
            const phoneRegex = /^[\d\s\+\-\(\)]+$/;
            if (formData.phone && formData.phone.length > 0 && !phoneRegex.test(formData.phone)) {
                showErrorMessage('Please enter a valid phone number');
                return;
            }
            if (formData.parentPhone && formData.parentPhone.length > 0 && !phoneRegex.test(formData.parentPhone)) {
                showErrorMessage('Please enter a valid parent phone number');
                return;
            }
            
            try {
                const response = await window.TalkTimeAuth.authenticatedRequest('/api/v1/volunteers/profile', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    const updatedProfile = await response.json();
                    console.log('Profile update successful, exiting edit mode...');
                    
                    showSuccessMessage('Profile updated successfully');
                    
                    // Update local data
                    Object.assign(profileData, updatedProfile.volunteer);
                    currentUser.full_name = formData.fullName;
                    
                    // Reload profile completion to reflect changes
                    await loadProfileCompletion();
                    
                    // Exit edit mode
                    const editBtn = document.getElementById('edit-profile-btn');
                    const container = document.getElementById('save-cancel-buttons');

                    if (editBtn && container) {
                        editBtn.classList.remove('hidden');
                        container.classList.add('hidden');
                        container.classList.remove('flex');
                        setFormEditable(false);
                    }
                    
                    // Update the display name (preserve the check icon child)
                    const profileNameElement = document.getElementById('profile-name');
                    if (profileNameElement) {
                        profileNameElement.firstChild.textContent = formData.fullName;
                    }
                    
                    // Update navigation greeting if it exists
                    const volunteerGreeting = document.getElementById('volunteer-greeting');
                    if (volunteerGreeting) {
                        const displayName = formData.fullName.split(' ')[0] || 'Volunteer';
                        volunteerGreeting.textContent = `Welcome, ${displayName}!`;
                    }
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to update profile');
                }
                
            } catch (error) {
                console.error('Error updating profile:', error);
                showErrorMessage(error.message || 'Failed to update profile');
            }
        });

        // Toggle all form fields enabled/disabled
        function setFormEditable(enabled) {
            document.querySelectorAll('.profile-field').forEach(field => {
                field.disabled = !enabled;
            });
        }

        // Edit Profile button functionality
        document.getElementById('edit-profile-btn').addEventListener('click', () => {
            const editBtn = document.getElementById('edit-profile-btn');
            const container = document.getElementById('save-cancel-buttons');

            if (editBtn && container) {
                editBtn.classList.add('hidden');
                container.classList.remove('hidden');
                container.classList.add('flex');
                setFormEditable(true);
            }
        });

        // Cancel button functionality
        document.getElementById('cancel-profile-btn').addEventListener('click', () => {
            const editBtn = document.getElementById('edit-profile-btn');
            const container = document.getElementById('save-cancel-buttons');

            if (editBtn && container) {
                editBtn.classList.remove('hidden');
                container.classList.add('hidden');
                container.classList.remove('flex');
                setFormEditable(false);
            }

            // Reset form to original values
            renderProfile();
            showSuccessMessage('Changes cancelled');
        });

        function showErrorMessage(message) {
            // Simple toast notification
            const toast = document.createElement('div');
            toast.className = 'fixed top-4 right-4 bg-error text-white px-6 py-3 rounded-lg shadow-lg z-50';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                document.body.removeChild(toast);
            }, 3000);
        }

        function showSuccessMessage(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed top-4 right-4 bg-success text-white px-6 py-3 rounded-lg shadow-lg z-50';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                document.body.removeChild(toast);
            }, 3000);
        }

        // Profile Completion Functionality
        async function loadProfileCompletion() {
            try {
                const response = await window.TalkTimeAuth.authenticatedRequest('/api/v1/volunteers/profile/completion', {
                    method: 'GET'
                });

                if (response.ok) {
                    const completionData = await response.json();
                    renderProfileCompletion(completionData);
                } else {
                    console.error('Failed to load profile completion');
                }
            } catch (error) {
                console.error('Error loading profile completion:', error);
            }
        }

        function renderProfileCompletion(data) {
            const percentage = data.completionPercentage || 0;
            const completionSection = document.getElementById('completion-section');
            const checkIcon = document.getElementById('profile-complete-check');

            if (percentage === 100) {
                // 100% — hide entire completion section, show green check next to name
                if (completionSection) completionSection.style.display = 'none';
                if (checkIcon) checkIcon.classList.remove('hidden');
            } else {
                // < 100% — show progress bar, hide check icon
                if (completionSection) completionSection.style.display = '';
                if (checkIcon) checkIcon.classList.add('hidden');

                const percentageEl = document.getElementById('completion-percentage');
                if (percentageEl) {
                    percentageEl.textContent = `${percentage}%`;
                    percentageEl.className = percentage >= 75
                        ? 'text-sm font-bold text-brand-primary whitespace-nowrap'
                        : percentage >= 50
                            ? 'text-sm font-bold text-warning whitespace-nowrap'
                            : 'text-sm font-bold text-gray-600 whitespace-nowrap';
                }

                const progressBar = document.getElementById('completion-progress-bar');
                if (progressBar) {
                    progressBar.style.width = `${percentage}%`;
                    if (percentage >= 75) {
                        progressBar.style.background = '#D10100';
                    } else if (percentage >= 50) {
                        progressBar.style.background = '#eab308';
                    } else {
                        progressBar.style.background = '#9ca3af';
                    }
                }

                const fieldsCompleted = document.getElementById('fields-completed');
                if (fieldsCompleted) {
                    fieldsCompleted.textContent = `${data.completedFields || 0} of ${data.totalFields || 0} fields completed`;
                }
            }
        }

        function getCategoryColor(category) {
            const colors = {
                'required': 'red',
                'basic': 'blue', 
                'profile': 'purple',
                'security': 'green',
                'student': 'yellow'
            };
            return colors[category] || 'gray';
        }

        // Modal Image Upload Functionality
        function initializeImageUploadModal() {
            const avatarTrigger = document.getElementById('avatar-upload-trigger');
            const modal = document.getElementById('imageUploadModal');
            const modalContent = document.getElementById('imageUploadModalContent');
            const closeBtn = document.getElementById('closeImageModal');
            const cancelBtn = document.getElementById('modalCancelBtn');
            const dropZone = document.getElementById('modalImageDropZone');
            const fileInput = document.getElementById('modalProfileImageInput');
            const removeBtn = document.getElementById('modalRemoveImageBtn');
            
            // Open modal when avatar is clicked
            avatarTrigger.addEventListener('click', (e) => {
                e.preventDefault();
                openImageUploadModal();
            });
            
            // Close modal handlers
            closeBtn.addEventListener('click', closeImageUploadModal);
            cancelBtn.addEventListener('click', closeImageUploadModal);
            
            // Close modal when clicking outside
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeImageUploadModal();
                }
            });
            
            // Prevent modal content click from closing modal
            modalContent.addEventListener('click', (e) => {
                e.stopPropagation();
            });
            
            // Drop zone click to browse
            dropZone.addEventListener('click', () => {
                fileInput.click();
            });
            
            // Drag and drop handlers
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('border-brand', 'bg-brand-primary');
            });
            
            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('border-brand', 'bg-brand-primary');
            });
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('border-brand', 'bg-brand-primary');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleModalImageUpload(files[0]);
                }
            });
            
            // File input change
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleModalImageUpload(e.target.files[0]);
                }
            });
            
            // Remove image
            removeBtn.addEventListener('click', () => {
                removeProfileImageModal();
            });
        }
        
        function openImageUploadModal() {
            const modal = document.getElementById('imageUploadModal');
            const modalContent = document.getElementById('imageUploadModalContent');
            
            // Update modal avatar to match current profile
            updateModalAvatar();
            
            // Show modal
            modal.classList.remove('hidden');
            setTimeout(() => {
                modalContent.style.transform = 'scale(1)';
            }, 10);
        }
        
        function closeImageUploadModal() {
            const modal = document.getElementById('imageUploadModal');
            const modalContent = document.getElementById('imageUploadModalContent');
            
            modalContent.style.transform = 'scale(0.95)';
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 200);
        }
        
        function updateModalAvatar() {
            const modalCurrentAvatar = document.getElementById('modalCurrentAvatar');
            const modalProfileImage = document.getElementById('modalProfileImage');
            const removeBtn = document.getElementById('modalRemoveImageBtn');

            if (profileData && profileData.profile_image) {
                // Use the full path returned by backend
                // Backend returns: /uploads/profiles/filename.jpg
                modalProfileImage.src = profileData.profile_image;
                modalProfileImage.classList.remove('hidden');
                modalCurrentAvatar.classList.add('hidden');
                removeBtn.classList.remove('hidden');
            } else {
                modalProfileImage.classList.add('hidden');
                modalCurrentAvatar.classList.remove('hidden');
                removeBtn.classList.add('hidden');
                
                // Get avatar letter from current user data
                const userName = profileData?.fullName || profileData?.full_name || currentUser?.full_name || 'V';
                const avatarLetter = userName.charAt(0).toUpperCase();
                modalCurrentAvatar.textContent = avatarLetter;
            }
        }
        
        async function handleModalImageUpload(file) {
            // Validate file
            if (!file.type.match(/^image\/(jpeg|jpg|png|webp)$/)) {
                showModalError('Please upload a valid image file (JPEG, PNG, or WebP)');
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) { // 5MB
                showModalError('Image size must be less than 5MB');
                return;
            }
            
            try {
                // Show upload progress
                document.getElementById('modalDropZoneContent').classList.add('hidden');
                document.getElementById('modalUploadProgress').classList.remove('hidden');
                
                // Create FormData
                const formData = new FormData();
                formData.append('profileImage', file);
                
                // Upload image - don't set Content-Type for FormData
                const token = window.TalkTimeAuth.getAccessToken();
                const response = await fetch('/api/v1/volunteers/profile/image', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                        // Don't set Content-Type - let browser set it with boundary for FormData
                    },
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showModalSuccess('Profile image uploaded successfully!');
                    
                    // Update profile data
                    profileData.profile_image = result.profileImage;
                    
                    // Update main avatar displays
                    updateAvatarDisplay();
                    
                    // Update modal avatar
                    updateModalAvatar();
                    
                    // Reload profile completion to update percentage
                    await loadProfileCompletion();
                    
                    // Auto-close modal after success
                    setTimeout(() => {
                        closeImageUploadModal();
                    }, 1500);
                    
                } else {
                    throw new Error('Upload failed');
                }
                
            } catch (error) {
                console.error('Upload error:', error);
                showModalError(error.message || 'Failed to upload image');
            } finally {
                // Reset upload UI
                document.getElementById('modalDropZoneContent').classList.remove('hidden');
                document.getElementById('modalUploadProgress').classList.add('hidden');
            }
        }
        
        async function removeProfileImageModal() {
            const confirmed = window.showConfirmation
                ? await window.showConfirmation('Are you sure you want to remove your profile photo?', { title: 'Remove Photo', confirmText: 'Remove', cancelText: 'Keep Photo', type: 'warning' })
                : confirm('Are you sure you want to remove your profile photo?');

            if (confirmed) {
                try {
                    showModalLoading('Removing photo...');
                    
                    const response = await window.TalkTimeAuth.authenticatedRequest('/api/v1/volunteers/profile/image', {
                        method: 'DELETE'
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Failed to delete image');
                    }
                    
                    // Update local data and UI
                    profileData.profile_image = null;
                    profileData.profileImage = null; // Also clear backend field
                    updateAvatarDisplay();
                    updateModalAvatar();
                    showModalSuccess('Profile photo removed successfully');
                    
                    // Reload profile completion to update percentage
                    await loadProfileCompletion();
                    
                    console.log('✅ Profile image deleted from server and database');
                    
                    // Auto-close modal after removal
                    setTimeout(() => {
                        closeImageUploadModal();
                    }, 1000);
                    
                } catch (error) {
                    console.error('Error removing profile image:', error);
                    showModalError('Failed to remove profile photo: ' + error.message);
                }
            }
        }
        
        function showModalLoading(message) {
            const statusDiv = document.getElementById('modalUploadStatus');
            statusDiv.textContent = message;
            statusDiv.className = 'text-sm mt-3 text-center text-brand-primary';
        }
        
        function showModalSuccess(message) {
            const statusDiv = document.getElementById('modalUploadStatus');
            statusDiv.textContent = message;
            statusDiv.className = 'text-sm mt-3 text-center text-success';
        }
        
        function showModalError(message) {
            const statusDiv = document.getElementById('modalUploadStatus');
            statusDiv.textContent = message;
            statusDiv.className = 'text-sm mt-3 text-center text-error';
        }
        
        
        function updateAvatarDisplay() {
            const profilePicture = document.getElementById('profile-picture');
            const profileImage = document.getElementById('profile-image');

            console.log('updateAvatarDisplay called with profileData:', profileData);
            console.log('profile_image value:', profileData?.profile_image);

            if (profileData && profileData.profile_image) {
                // Show profile image - use the full path returned by backend
                // Backend returns: /uploads/profiles/filename.jpg
                console.log('Setting image src to:', profileData.profile_image);
                profileImage.src = profileData.profile_image;
                profileImage.onerror = function() {
                    console.error('Failed to load image from:', profileData.profile_image);
                    // Fallback to letter avatar on error
                    profileImage.classList.add('hidden');
                    profilePicture.classList.remove('hidden');
                };
                profileImage.onload = function() {
                    console.log('Image loaded successfully from:', profileData.profile_image);
                };
                profileImage.classList.remove('hidden');
                profilePicture.classList.add('hidden');
            } else {
                // Show avatar letter
                profileImage.classList.add('hidden');
                profilePicture.classList.remove('hidden');
                
                // Get avatar letter from nickname/username or full name
                const userName = profileData?.fullName || profileData?.full_name || currentUser?.full_name || 'V';
                const avatarLetter = userName.charAt(0).toUpperCase();
                profilePicture.textContent = avatarLetter;
            }
        }

        // Header scroll behavior - uses mobile-header from dashboard-nav
        const header = document.querySelector('.mobile-header');
        if (header) {
            const handleScroll = () => {
                if (window.scrollY > 50) {
                    header.classList.add('scrolled');
                } else {
                    header.classList.remove('scrolled');
                }
            };
            window.addEventListener('scroll', handleScroll);
        }

        // Navigation dropdown and logout are handled by dashboard-nav.js

        // Initialize tabs functionality
        function initializeTabs() {
            const tabs = document.querySelectorAll('.profile-tab');
            const panels = document.querySelectorAll('.tab-panel');

            console.log('initializeTabs called, found tabs:', tabs.length, 'panels:', panels.length);

            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    console.log('Tab clicked:', this.id);
                    // Remove active from all tabs
                    tabs.forEach(t => {
                        t.classList.remove('active', 'border-brand-secondary', 'text-brand-secondary');
                        t.classList.add('border-transparent', 'text-gray-500');
                    });
                    
                    // Hide all panels
                    panels.forEach(p => {
                        p.classList.add('hidden');
                        p.classList.remove('active');
                        p.style.display = 'none';
                    });
                    
                    // Activate clicked tab
                    this.classList.add('active');
                    this.classList.remove('border-transparent', 'text-gray-500');
                    this.classList.add('border-brand-secondary', 'text-brand-secondary');
                    
                    // Show corresponding panel
                    const tabId = this.id.replace('tab-', 'content-');
                    const panel = document.getElementById(tabId);
                    console.log('Looking for panel:', tabId, 'Found:', !!panel);
                    if (panel) {
                        panel.classList.remove('hidden');
                        panel.classList.add('active');
                        panel.style.display = 'block';
                        console.log('Panel classes after show:', panel.className);
                    }
                });
            });
        }

        // Initialize page when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            document.body.classList.add('page-ready');
            initializePage();
            initializeTabs();
            initializeImageUploadModal();
        });
    </script>
</body>
</html>