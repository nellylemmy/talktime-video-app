<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Meeting Flow Test - TalkTime</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .panel {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .panel h2 {
            margin: 0 0 20px 0;
            color: #2d3748;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
        }
        
        .volunteer-panel {
            border-top: 4px solid #4299e1;
        }
        
        .student-panel {
            border-top: 4px solid #38a169;
        }
        
        .test-button {
            background: #4299e1;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px 5px 5px 0;
            transition: all 0.3s;
            width: 100%;
            margin-bottom: 10px;
        }
        
        .test-button:hover {
            background: #3182ce;
            transform: translateY(-1px);
        }
        
        .test-button.volunteer {
            background: #4299e1;
        }
        
        .test-button.student {
            background: #38a169;
        }
        
        .test-button.danger {
            background: #e53e3e;
        }
        
        .test-button.warning {
            background: #d69e2e;
        }
        
        .status-box {
            margin: 15px 0;
            padding: 12px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
        }
        
        .status-box.connected {
            background: #c6f6d5;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }
        
        .status-box.disconnected {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #fc8181;
        }
        
        .status-box.info {
            background: #bee3f8;
            color: #2a4365;
            border: 1px solid #90cdf4;
        }
        
        .activity-log {
            background: #1a202c;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            height: 200px;
            overflow-y: auto;
            margin-top: 15px;
        }
        
        .flow-section {
            margin-bottom: 25px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 8px;
            border-left: 4px solid #4299e1;
        }
        
        .flow-section h4 {
            margin: 0 0 10px 0;
            color: #2d3748;
        }
        
        .flow-step {
            margin: 10px 0;
            padding: 8px 12px;
            background: white;
            border-radius: 4px;
            border: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .step-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .step-status.pending {
            background: #fbb6ce;
            color: #742a2a;
        }
        
        .step-status.completed {
            background: #c6f6d5;
            color: #22543d;
        }
        
        .step-status.active {
            background: #fde68a;
            color: #744210;
        }
        
        /* Meeting simulation styles */
        .meeting-room {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        
        .meeting-container {
            background: #1a202c;
            border-radius: 12px;
            padding: 20px;
            max-width: 800px;
            width: 90%;
            color: white;
            text-align: center;
        }
        
        .meeting-timer-display {
            font-size: 48px;
            font-weight: 600;
            color: #4299e1;
            margin: 20px 0;
        }
        
        .meeting-timer-display.warning {
            color: #e53e3e;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .participants {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin: 30px 0;
        }
        
        .participant {
            text-align: center;
        }
        
        .participant-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4299e1, #38a169);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            margin: 0 auto 10px;
        }
        
        .meeting-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }
        
        .control-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            font-size: 20px;
            color: white;
        }
        
        .control-btn.end {
            background: #e53e3e;
        }
        
        .control-btn.mute {
            background: #4299e1;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Volunteer Panel -->
        <div class="panel volunteer-panel">
            <h2>üë®‚Äçüè´ Volunteer Simulation</h2>
            
            <div class="flow-section">
                <h4>Connection & Setup</h4>
                <button class="test-button volunteer" onclick="connectVolunteer()">Connect as Volunteer</button>
                <div id="volunteer-status" class="status-box info">Not connected</div>
            </div>
            
            <div class="flow-section">
                <h4>Meeting Flow</h4>
                <div class="flow-step">
                    <span>1. Schedule Meeting (5 min from now)</span>
                    <span id="step1-status" class="step-status pending">Pending</span>
                </div>
                <div class="flow-step">
                    <span>2. Wait for Auto-Launch Notification</span>
                    <span id="step2-status" class="step-status pending">Pending</span>
                </div>
                <div class="flow-step">
                    <span>3. Join Meeting Room</span>
                    <span id="step3-status" class="step-status pending">Pending</span>
                </div>
                <div class="flow-step">
                    <span>4. Send Call to Student</span>
                    <span id="step4-status" class="step-status pending">Pending</span>
                </div>
                <div class="flow-step">
                    <span>5. Start 40-Min Timer</span>
                    <span id="step5-status" class="step-status pending">Pending</span>
                </div>
                
                <button class="test-button volunteer" onclick="simulateScheduleMeeting()">1. Schedule Test Meeting</button>
                <button class="test-button volunteer" onclick="simulateVolunteerJoinRoom()">3. Join Meeting Room</button>
                <button class="test-button volunteer" onclick="sendCallToStudent()">4. Call Student</button>
            </div>
            
            <div class="activity-log" id="volunteer-log">Volunteer ready...</div>
        </div>
        
        <!-- Student Panel -->
        <div class="panel student-panel">
            <h2>üë®‚Äçüéì Student Simulation</h2>
            
            <div class="flow-section">
                <h4>Connection & Setup</h4>
                <button class="test-button student" onclick="connectStudent()">Connect as Student</button>
                <div id="student-status" class="status-box info">Not connected</div>
            </div>
            
            <div class="flow-section">
                <h4>Meeting Experience</h4>
                <div class="flow-step">
                    <span>1. Receive Auto-Launch Notification</span>
                    <span id="student-step1-status" class="step-status pending">Pending</span>
                </div>
                <div class="flow-step">
                    <span>2. Get Incoming Call from Volunteer</span>
                    <span id="student-step2-status" class="step-status pending">Pending</span>
                </div>
                <div class="flow-step">
                    <span>3. Accept Call & Join Meeting</span>
                    <span id="student-step3-status" class="step-status pending">Pending</span>
                </div>
                <div class="flow-step">
                    <span>4. Experience 40-Min Session</span>
                    <span id="student-step4-status" class="step-status pending">Pending</span>
                </div>
                <div class="flow-step">
                    <span>5. Receive Timer Warnings</span>
                    <span id="student-step5-status" class="step-status pending">Pending</span>
                </div>
                
                <button class="test-button student" onclick="simulateAcceptCall()">3. Accept Incoming Call</button>
                <button class="test-button warning" onclick="simulateTimerWarning()">5. Simulate Timer Warning</button>
            </div>
            
            <div class="activity-log" id="student-log">Student ready...</div>
        </div>
    </div>
    
    <!-- Full Controls Panel -->
    <div class="panel" style="grid-column: 1 / -1; margin-top: 20px;">
        <h2>üé¨ Complete Flow Control</h2>
        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
            <button class="test-button" onclick="runCompleteFlow()" style="flex: 1; min-width: 200px;">üöÄ Run Complete Meeting Flow</button>
            <button class="test-button danger" onclick="resetFlow()" style="flex: 1; min-width: 200px;">üîÑ Reset All</button>
            <button class="test-button warning" onclick="skipToMeeting()" style="flex: 1; min-width: 200px;">‚è≠Ô∏è Skip to Meeting</button>
            <button class="test-button" onclick="testNotificationScheduler()" style="flex: 1; min-width: 200px;">‚è∞ Test Scheduler</button>
        </div>
    </div>
    
    <!-- Meeting Room Simulation -->
    <div id="meeting-room" class="meeting-room">
        <div class="meeting-container">
            <h2>üìπ TalkTime Meeting Session</h2>
            <div class="meeting-timer-display" id="meeting-timer-display">40:00</div>
            
            <div class="participants">
                <div class="participant">
                    <div class="participant-avatar">üë®‚Äçüè´</div>
                    <div>John Volunteer</div>
                </div>
                <div class="participant">
                    <div class="participant-avatar">üë®‚Äçüéì</div>
                    <div>Test Student</div>
                </div>
            </div>
            
            <div id="meeting-messages">
                <p>Meeting in progress...</p>
            </div>
            
            <div class="meeting-controls">
                <button class="control-btn mute" title="Mute">üé§</button>
                <button class="control-btn end" onclick="endMeeting()" title="End Meeting">üìû</button>
                <button class="control-btn mute" title="Camera">üìπ</button>
            </div>
        </div>
    </div>
    
    <script>
        let volunteerSocket = null;
        let studentSocket = null;
        let meetingTimer = null;
        let meetingTimeLeft = 40 * 60; // 40 minutes in seconds
        let currentMeetingId = null;
        
        function logVolunteer(message) {
            const log = document.getElementById('volunteer-log');
            const timestamp = new Date().toLocaleTimeString();
            log.innerHTML += `[${timestamp}] ${message}\n`;
            log.scrollTop = log.scrollHeight;
        }
        
        function logStudent(message) {
            const log = document.getElementById('student-log');
            const timestamp = new Date().toLocaleTimeString();
            log.innerHTML += `[${timestamp}] ${message}\n`;
            log.scrollTop = log.scrollHeight;
        }
        
        function updateStepStatus(stepId, status) {
            const element = document.getElementById(stepId);
            if (element) {
                element.className = `step-status ${status}`;
                element.textContent = status.charAt(0).toUpperCase() + status.slice(1);
            }
        }
        
        // Volunteer Functions
        function connectVolunteer() {
            volunteerSocket = io();
            
            volunteerSocket.on('connect', () => {
                logVolunteer('‚úÖ Connected as volunteer');
                document.getElementById('volunteer-status').textContent = 'Connected as Volunteer';
                document.getElementById('volunteer-status').className = 'status-box connected';
                
                volunteerSocket.emit('join-user-room', {
                    userId: 'volunteer-test-123',
                    role: 'volunteer',
                    rooms: ['user_volunteer-test-123', 'volunteer_volunteer-test-123']
                });
            });
            
            volunteerSocket.on('meeting-auto-launch', (data) => {
                logVolunteer(`üöÄ AUTO-LAUNCH: Meeting ${data.meetingId} is starting!`);
                updateStepStatus('step2-status', 'completed');
                currentMeetingId = data.meetingId;
            });
            
            volunteerSocket.on('student-joined-meeting', (data) => {
                logVolunteer(`üë®‚Äçüéì Student joined meeting ${data.meetingId}`);
                updateStepStatus('step5-status', 'active');
                startMeetingTimer();
            });
            
            volunteerSocket.on('disconnect', () => {
                logVolunteer('‚ùå Disconnected');
                document.getElementById('volunteer-status').textContent = 'Disconnected';
                document.getElementById('volunteer-status').className = 'status-box disconnected';
            });
        }
        
        function simulateScheduleMeeting() {
            if (!volunteerSocket) {
                logVolunteer('‚ùå Please connect first');
                return;
            }
            
            const meetingId = 'test-meeting-' + Date.now();
            const scheduledTime = new Date(Date.now() + 5 * 60 * 1000); // 5 minutes from now
            
            logVolunteer(`üìÖ Scheduling meeting ${meetingId} for ${scheduledTime.toLocaleTimeString()}`);
            logVolunteer(`‚è∞ Meeting will auto-launch in 5 minutes`);
            
            updateStepStatus('step1-status', 'completed');
            
            // Simulate the notification scheduler picking this up
            setTimeout(() => {
                updateStepStatus('step2-status', 'active');
                logVolunteer(`üîî Auto-launch notification would be sent now`);
                
                // Simulate auto-launch after 5 minutes (compressed to 10 seconds for testing)
                setTimeout(() => {
                    volunteerSocket.emit('meeting-auto-launch', {
                        meetingId: meetingId,
                        roomId: `room-${meetingId}`,
                        studentId: 'student-test-456',
                        volunteerId: 'volunteer-test-123',
                        scheduledTime: scheduledTime.toISOString()
                    });
                }, 10000);
            }, 2000);
            
            currentMeetingId = meetingId;
        }
        
        function simulateVolunteerJoinRoom() {
            if (!currentMeetingId) {
                logVolunteer('‚ùå Please schedule a meeting first');
                return;
            }
            
            logVolunteer(`üè† Joining meeting room for ${currentMeetingId}`);
            updateStepStatus('step3-status', 'completed');
            
            volunteerSocket.emit('user-joined-call', {
                roomId: currentMeetingId,
                userId: 'volunteer-test-123',
                userType: 'volunteer'
            });
        }
        
        function sendCallToStudent() {
            if (!currentMeetingId) {
                logVolunteer('‚ùå Please join meeting room first');
                return;
            }
            
            logVolunteer(`üìû Sending call notification to student`);
            updateStepStatus('step4-status', 'completed');
            
            // Send call to student
            if (studentSocket) {
                studentSocket.emit('volunteer-joined-meeting', {
                    meetingId: currentMeetingId,
                    roomId: `room-${currentMeetingId}`,
                    volunteerId: 'volunteer-test-123',
                    volunteerName: 'John Volunteer',
                    message: 'Volunteer has joined and is calling you'
                });
            }
            
            volunteerSocket.emit('volunteer-joined-meeting', {
                meetingId: currentMeetingId,
                roomId: `room-${currentMeetingId}`,
                volunteerId: 'volunteer-test-123',
                volunteerName: 'John Volunteer',
                studentId: 'student-test-456'
            });
        }
        
        // Student Functions
        function connectStudent() {
            studentSocket = io();
            
            studentSocket.on('connect', () => {
                logStudent('‚úÖ Connected as student');
                document.getElementById('student-status').textContent = 'Connected as Student';
                document.getElementById('student-status').className = 'status-box connected';
                
                studentSocket.emit('join-user-room', {
                    userId: 'student-test-456',
                    role: 'student',
                    rooms: ['user_student-test-456', 'student_student-test-456']
                });
            });
            
            studentSocket.on('meeting-auto-launch', (data) => {
                logStudent(`üöÄ AUTO-LAUNCH: Your meeting is starting!`);
                logStudent(`üìù Meeting ID: ${data.meetingId}`);
                updateStepStatus('student-step1-status', 'completed');
                
                if (Notification.permission === 'granted') {
                    new Notification('Meeting Starting Now!', {
                        body: 'Your English practice session is beginning.',
                        icon: '/favicon.ico'
                    });
                }
            });
            
            studentSocket.on('volunteer-joined-meeting', (data) => {
                logStudent(`üìû INCOMING CALL: ${data.volunteerName} is calling!`);
                updateStepStatus('student-step2-status', 'completed');
                
                // Show incoming call notification
                if (Notification.permission === 'granted') {
                    new Notification('Incoming Call', {
                        body: `${data.volunteerName} is calling you for your English session`,
                        icon: '/favicon.ico'
                    });
                }
            });
            
            studentSocket.on('meeting-timer-start', (data) => {
                logStudent(`‚è±Ô∏è Meeting timer started: 40 minutes`);
                updateStepStatus('student-step4-status', 'active');
            });
            
            studentSocket.on('meeting-timer-warning', (data) => {
                logStudent(`‚ö†Ô∏è Timer warning: ${data.minutesLeft} minutes remaining`);
                updateStepStatus('student-step5-status', 'completed');
            });
            
            studentSocket.on('disconnect', () => {
                logStudent('‚ùå Disconnected');
                document.getElementById('student-status').textContent = 'Disconnected';
                document.getElementById('student-status').className = 'status-box disconnected';
            });
        }
        
        function simulateAcceptCall() {
            if (!studentSocket) {
                logStudent('‚ùå Please connect first');
                return;
            }
            
            logStudent(`‚úÖ Accepting call and joining meeting`);
            updateStepStatus('student-step3-status', 'completed');
            
            studentSocket.emit('user-joined-call', {
                roomId: currentMeetingId,
                userId: 'student-test-456',
                userType: 'student'
            });
            
            // Notify volunteer that student joined
            if (volunteerSocket) {
                volunteerSocket.emit('student-joined-meeting', {
                    meetingId: currentMeetingId,
                    studentId: 'student-test-456',
                    studentName: 'Test Student'
                });
            }
            
            // Show meeting room
            document.getElementById('meeting-room').style.display = 'flex';
            startMeetingTimer();
        }
        
        // Meeting Timer Functions
        function startMeetingTimer() {
            if (meetingTimer) clearInterval(meetingTimer);
            
            meetingTimeLeft = 40 * 60; // 40 minutes
            
            meetingTimer = setInterval(() => {
                meetingTimeLeft--;
                
                const minutes = Math.floor(meetingTimeLeft / 60);
                const seconds = meetingTimeLeft % 60;
                const timeDisplay = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                document.getElementById('meeting-timer-display').textContent = timeDisplay;
                
                // 5-minute warning
                if (meetingTimeLeft === 5 * 60) {
                    simulateTimerWarning();
                }
                
                // 2-minute critical warning
                if (meetingTimeLeft === 2 * 60) {
                    document.getElementById('meeting-timer-display').classList.add('warning');
                    logVolunteer('‚ö†Ô∏è CRITICAL: 2 minutes remaining!');
                    logStudent('‚ö†Ô∏è CRITICAL: 2 minutes remaining!');
                }
                
                // Auto-end at 0
                if (meetingTimeLeft <= 0) {
                    endMeeting();
                }
                
            }, 1000);
            
            logVolunteer('‚è±Ô∏è 40-minute timer started');
            logStudent('‚è±Ô∏è 40-minute meeting session started');
            
            // Emit timer start event
            if (volunteerSocket) {
                volunteerSocket.emit('meeting-timer-start', {
                    meetingId: currentMeetingId,
                    duration: 40
                });
            }
            if (studentSocket) {
                studentSocket.emit('meeting-timer-start', {
                    meetingId: currentMeetingId,
                    duration: 40
                });
            }
        }
        
        function simulateTimerWarning() {
            logVolunteer('‚ö†Ô∏è WARNING: 5 minutes remaining!');
            logStudent('‚ö†Ô∏è WARNING: 5 minutes remaining!');
            
            if (Notification.permission === 'granted') {
                new Notification('Meeting Ending Soon', {
                    body: 'Your session will end in 5 minutes.',
                    icon: '/favicon.ico'
                });
            }
            
            // Emit warning event
            if (volunteerSocket) {
                volunteerSocket.emit('meeting-timer-warning', {
                    meetingId: currentMeetingId,
                    minutesLeft: 5
                });
            }
            if (studentSocket) {
                studentSocket.emit('meeting-timer-warning', {
                    meetingId: currentMeetingId,
                    minutesLeft: 5
                });
            }
        }
        
        function endMeeting() {
            if (meetingTimer) {
                clearInterval(meetingTimer);
                meetingTimer = null;
            }
            
            document.getElementById('meeting-room').style.display = 'none';
            document.getElementById('meeting-timer-display').classList.remove('warning');
            
            logVolunteer('üèÅ Meeting ended');
            logStudent('üèÅ Meeting ended');
            
            // Reset steps
            resetFlow();
        }
        
        // Complete Flow Functions
        function runCompleteFlow() {
            logVolunteer('üöÄ Starting complete meeting flow...');
            logStudent('üöÄ Starting complete meeting flow...');
            
            // Step 1: Connect both participants
            if (!volunteerSocket) connectVolunteer();
            if (!studentSocket) connectStudent();
            
            setTimeout(() => {
                // Step 2: Schedule meeting
                simulateScheduleMeeting();
                
                setTimeout(() => {
                    // Step 3: Volunteer joins room
                    simulateVolunteerJoinRoom();
                    
                    setTimeout(() => {
                        // Step 4: Send call to student
                        sendCallToStudent();
                        
                        setTimeout(() => {
                            // Step 5: Student accepts call
                            simulateAcceptCall();
                        }, 2000);
                    }, 2000);
                }, 3000);
            }, 2000);
        }
        
        function resetFlow() {
            // Reset all step statuses
            ['step1-status', 'step2-status', 'step3-status', 'step4-status', 'step5-status',
             'student-step1-status', 'student-step2-status', 'student-step3-status', 
             'student-step4-status', 'student-step5-status'].forEach(id => {
                updateStepStatus(id, 'pending');
            });
            
            if (meetingTimer) {
                clearInterval(meetingTimer);
                meetingTimer = null;
            }
            
            document.getElementById('meeting-room').style.display = 'none';
            currentMeetingId = null;
            
            logVolunteer('üîÑ Flow reset');
            logStudent('üîÑ Flow reset');
        }
        
        function skipToMeeting() {
            currentMeetingId = 'test-meeting-skip-' + Date.now();
            
            // Set all preliminary steps as completed
            updateStepStatus('step1-status', 'completed');
            updateStepStatus('step2-status', 'completed');
            updateStepStatus('step3-status', 'completed');
            updateStepStatus('step4-status', 'completed');
            updateStepStatus('student-step1-status', 'completed');
            updateStepStatus('student-step2-status', 'completed');
            updateStepStatus('student-step3-status', 'completed');
            
            logVolunteer('‚è≠Ô∏è Skipped to meeting phase');
            logStudent('‚è≠Ô∏è Skipped to meeting phase');
            
            // Show meeting and start timer
            document.getElementById('meeting-room').style.display = 'flex';
            startMeetingTimer();
        }
        
        function testNotificationScheduler() {
            logVolunteer('‚è∞ Testing notification scheduler...');
            logStudent('‚è∞ Testing notification scheduler...');
            
            // This would test the actual backend scheduler
            fetch('/api/v1/notifications/test-scheduler', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ test: true })
            })
            .then(response => response.json())
            .then(data => {
                logVolunteer(`üìä Scheduler test result: ${JSON.stringify(data)}`);
            })
            .catch(error => {
                logVolunteer(`‚ùå Scheduler test failed: ${error.message}`);
            });
        }
        
        // Request notification permission on load
        window.addEventListener('load', () => {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission().then((permission) => {
                    console.log(`Notification permission: ${permission}`);
                });
            }
        });
    </script>
</body>
</html>
