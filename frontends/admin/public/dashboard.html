<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TalkTime Admin Dashboard</title>
    <!-- Brand Theme System -->
    <link rel="stylesheet" href="/shared/css/brand-theme.css">
    <script src="/shared/js/brand-config.js"></script>
    <link rel="icon" type="image/x-icon" href="/talktime.ico">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://unpkg.com/htmx.org@1.9.2"></script>
    <script src="/shared/js/jwt-auth-utils.js"></script>
    <!-- Modal Utilities -->
    <script src="/volunteer/js/modal-utils.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        .btn-primary {
            background: linear-gradient(to right, #f56565, #ed8936);
        }
        .btn-secondary {
            background-color: #4CAF50;
        }
        .btn-danger {
            background-color: #EF4444;
        }
        body {
            padding-top: 72px;
        }
        /* ── Edit modal: scrollable ── */
        .edit-modal-overlay {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center; justify-content: center;
            z-index: 50;
            padding: 16px;
        }
        .edit-modal-overlay.show {
            display: flex;
        }
        .edit-modal-box {
            background: #fff;
            border-radius: 12px;
            width: 100%;
            max-width: 520px;
            max-height: calc(100vh - 32px);
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
        }
        .edit-modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }
        .edit-modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
            -webkit-overflow-scrolling: touch;
        }
        .edit-modal-footer {
            padding: 12px 20px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
            gap: 12px;
        }

        /* ── Image upload zones ── */
        .upload-zone {
            border: 2px dashed #e5e7eb;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.2s, background 0.2s;
        }
        .upload-zone:hover {
            border-color: #f56565;
            background: #fef2f2;
        }
        .upload-zone input[type="file"] {
            display: none;
        }
        .preview-thumb {
            position: relative;
            display: inline-block;
            width: 64px;
            height: 64px;
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid #e5e7eb;
        }
        .preview-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .preview-thumb .remove-btn {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 18px;
            height: 18px;
            background: rgba(0,0,0,0.6);
            color: #fff;
            border: none;
            border-radius: 50%;
            font-size: 10px;
            line-height: 18px;
            text-align: center;
            cursor: pointer;
            padding: 0;
        }
        .preview-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        /* ── Upload progress bar ── */
        .upload-status {
            display: none;
            padding: 8px 12px;
            border-radius: 8px;
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            font-size: 13px;
            color: #0369a1;
            align-items: center;
            gap: 8px;
        }
        .upload-status.active {
            display: flex;
        }
        .upload-status.success {
            background: #f0fdf4;
            border-color: #bbf7d0;
            color: #15803d;
        }
        .upload-status.error {
            background: #fef2f2;
            border-color: #fecaca;
            color: #b91c1c;
        }
        .upload-status .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            flex-shrink: 0;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Header Navigation -->
    <header id="main-header" class="fixed top-0 left-0 right-0 z-40" style="background: rgba(255,255,255,0.98); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-bottom: 1px solid rgba(0,0,0,0.08); height: 56px;">
        <div class="w-full h-full px-4 flex items-center justify-between" style="max-width: 100%; margin: 0 auto;">
            <!-- Logo (non-clickable) -->
            <div class="flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none">
                    <path stroke="#111827" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 3h14a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2z"></path>
                </svg>
                <span class="font-bold text-gray-900 tracking-tight" style="font-size: 14px;">TALKTIME</span>
            </div>

            <!-- Profile Section -->
            <div class="relative">
                <button id="profile-btn" class="flex items-center gap-2 p-2 rounded-lg hover:bg-gray-50 transition-colors focus:outline-none">
                    <span id="admin-greeting" class="text-sm font-medium text-gray-700 hidden sm:inline">Admin</span>
                    <div id="admin-initial" class="w-9 h-9 rounded-full bg-red-100 flex items-center justify-center text-red-700 font-bold text-sm">A</div>
                </button>
                <div id="profile-dropdown" class="absolute right-0 top-full mt-2 w-56 bg-white rounded-xl shadow-lg py-2 hidden opacity-0 transform -translate-y-2 transition-all border border-gray-100" style="z-index: 9999">
                    <div class="px-4 py-3 border-b border-gray-100">
                        <div class="font-semibold text-gray-900" id="dropdown-admin-name">Admin</div>
                        <div class="text-sm text-gray-500">Administrator</div>
                    </div>
                    <a href="/admin/dashboard" class="flex items-center gap-3 px-4 py-2.5 text-gray-700 hover:bg-gray-50 transition-colors">
                        <i class="fas fa-tachometer-alt text-gray-400"></i>
                        <span>Dashboard</span>
                    </a>
                    <a href="/admin/analytics" class="flex items-center gap-3 px-4 py-2.5 text-gray-700 hover:bg-gray-50 transition-colors">
                        <i class="fas fa-chart-bar text-gray-400"></i>
                        <span>Analytics</span>
                    </a>
                    <a href="/admin/settings" class="flex items-center gap-3 px-4 py-2.5 text-gray-700 hover:bg-gray-50 transition-colors">
                        <i class="fas fa-cog text-gray-400"></i>
                        <span>Settings</span>
                    </a>
                    <hr class="my-1 border-gray-100">
                    <a href="#" id="logout-link" class="flex items-center gap-3 px-4 py-2.5 text-red-600 hover:bg-red-50 transition-colors">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Logout</span>
                    </a>
                </div>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <div class="px-4 py-6 sm:px-0">
            <div class="border-b border-gray-200 pb-5 mb-5">
                <h1 class="text-2xl font-bold text-gray-900">Welcome, <span id="dashboard-welcome-name">Admin</span></h1>
                <p class="mt-2 text-sm text-gray-500">Manage students, view meetings, and oversee the TalkTime platform.</p>
            </div>
            
            <!-- Dashboard Navigation Tabs -->
            <div class="mb-6">
                <nav class="flex space-x-8" aria-label="Tabs">
                    <button id="students-tab" class="tab-button active border-b-2 border-pink-500 py-2 px-1 text-sm font-medium text-pink-600" onclick="switchTab('students')">
                        <i class="fas fa-users mr-2"></i>Students
                    </button>
                    <button id="meetings-tab" class="tab-button border-b-2 border-transparent py-2 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300" onclick="switchTab('meetings')">
                        <i class="fas fa-calendar-alt mr-2"></i>Meetings
                    </button>
                    <button id="volunteers-tab" class="tab-button border-b-2 border-transparent py-2 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300" onclick="switchTab('volunteers')">
                        <i class="fas fa-hand-holding-heart mr-2"></i>Volunteers
                    </button>
                </nav>
            </div>

            <!-- Students Tab Content -->
            <div id="students-content" class="tab-content">
                <div class="border-b border-gray-200 pb-3 mb-5">
                    <h2 class="text-xl font-semibold text-gray-900">Student Management</h2>
                    <p class="mt-1 text-sm text-gray-500">Create, view, edit, and delete student records.</p>
                </div>
                <div class="flex flex-col md:flex-row gap-6">
                <!-- Student Creation Form -->
                <div class="w-full md:w-1/3 bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-lg font-medium text-gray-900 mb-4">Add New Student</h2>
                    <form id="add-student-form" class="space-y-4">
                        <div class="flex flex-col md:flex-row gap-4">
                            <div class="w-full md:w-1/2">
                                <label for="firstName" class="block text-sm font-medium text-gray-700">First Name *</label>
                                <input type="text" id="firstName" name="firstName" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-pink-500 focus:border-pink-500 sm:text-sm">
                            </div>
                            <div class="w-full md:w-1/2">
                                <label for="lastName" class="block text-sm font-medium text-gray-700">Last Name *</label>
                                <input type="text" id="lastName" name="lastName" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-pink-500 focus:border-pink-500 sm:text-sm">
                            </div>
                        </div>
                        <div>
                            <label for="admissionNumber" class="block text-sm font-medium text-gray-700">Admission Number *</label>
                            <div class="flex">
                                <span class="inline-flex items-center px-3 rounded-l-md border border-r-0 border-gray-300 bg-gray-50 text-gray-500 sm:text-sm">ADM</span>
                                <input type="text" id="admissionNumber" name="admissionNumber" required placeholder="0000" maxlength="4" pattern="\d{4}" class="flex-1 min-w-0 block w-full px-3 py-2 rounded-r-md border border-gray-300 focus:outline-none focus:ring-pink-500 focus:border-pink-500 sm:text-sm">
                            </div>
                            <p class="mt-1 text-xs text-gray-500">Enter exactly 4 digits (e.g., 0002)</p>
                        </div>
                        <div>
                            <label for="age" class="block text-sm font-medium text-gray-700">Age</label>
                            <input type="number" id="age" name="age" min="1" max="100" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-pink-500 focus:border-pink-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="gender" class="block text-sm font-medium text-gray-700">Gender</label>
                            <select id="gender" name="gender" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-pink-500 focus:border-pink-500 sm:text-sm">
                                <option value="">Select Gender</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div>
                            <label for="bio" class="block text-sm font-medium text-gray-700">Bio</label>
                            <textarea id="bio" name="bio" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-pink-500 focus:border-pink-500 sm:text-sm"></textarea>
                            <p class="mt-1 text-xs text-gray-500">Brief description of the student (1-2 sentences)</p>
                        </div>
                        <div>
                            <label for="story" class="block text-sm font-medium text-gray-700">Student Story</label>
                            <textarea id="story" name="story" rows="5" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-pink-500 focus:border-pink-500 sm:text-sm"></textarea>
                            <p class="mt-1 text-xs text-gray-500">Detailed background story about the student</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Profile Picture</label>
                            <input type="hidden" id="profileImage" name="profileImage">
                            <div class="upload-zone mt-1" id="profile-upload-zone" onclick="document.getElementById('profile-file-input').click()">
                                <input type="file" id="profile-file-input" accept="image/*">
                                <div id="profile-preview" class="preview-grid"></div>
                                <p id="profile-upload-label" class="text-sm text-gray-500 py-2"><i class="fas fa-cloud-upload-alt mr-1"></i> Click to select profile picture</p>
                            </div>
                            <p class="mt-1 text-xs text-gray-500">Will be optimized and converted to .webp</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Gallery Images</label>
                            <input type="hidden" id="gallery" name="gallery">
                            <div class="upload-zone mt-1" id="gallery-upload-zone" onclick="document.getElementById('gallery-file-input').click()">
                                <input type="file" id="gallery-file-input" accept="image/*" multiple>
                                <div id="gallery-preview" class="preview-grid"></div>
                                <p id="gallery-upload-label" class="text-sm text-gray-500 py-2"><i class="fas fa-images mr-1"></i> Click to select gallery images (up to 5)</p>
                            </div>
                            <p class="mt-1 text-xs text-gray-500">Will be optimized and converted to .webp</p>
                        </div>
                        <!-- Upload status indicator -->
                        <div id="create-upload-status" class="upload-status">
                            <div class="spinner"></div>
                            <span id="create-upload-status-text">Uploading images...</span>
                        </div>
                        <div>
                            <button type="submit" id="create-submit-btn" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white btn-primary hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-pink-500">
                                Create Student
                            </button>
                        </div>
                    </form>
                    <div id="form-message" class="mt-4 text-sm hidden"></div>
                </div>

                <!-- Student List -->
                <div class="w-full md:w-2/3 bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-medium text-gray-900">Student List</h2>
                        <div class="flex space-x-2">
                            <button id="refresh-students" class="inline-flex items-center px-3 py-1 border border-transparent text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                                <i class="fas fa-sync-alt mr-1"></i> Refresh
                            </button>
                            <button id="delete-all-students" class="inline-flex items-center px-3 py-1 border border-transparent text-sm font-medium rounded-md text-white bg-red-800 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                                <i class="fas fa-trash-alt mr-1"></i> Delete All
                            </button>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Admission #</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Age</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Gender</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="student-list" class="bg-white divide-y divide-gray-200">
                                <!-- Student rows will be inserted here -->
                                <tr>
                                    <td colspan="6" class="px-6 py-4 text-center text-sm text-gray-500">
                                        Loading students...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                </div>
            </div>
            
            <!-- Meetings Tab Content -->
            <div id="meetings-content" class="tab-content hidden">
                <div class="border-b border-gray-200 pb-3 mb-5">
                    <h2 class="text-xl font-semibold text-gray-900">Meeting Management</h2>
                    <p class="mt-1 text-sm text-gray-500">View all meetings, reschedules, and manage meeting schedules.</p>
                </div>
                
                <!-- Meeting Filters -->
                <div class="bg-white p-4 rounded-lg shadow-md mb-6">
                    <div class="flex flex-wrap gap-4 items-center">
                        <div>
                            <label for="meeting-status-filter" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                            <select id="meeting-status-filter" class="border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-pink-500 focus:border-pink-500">
                                <option value="all">All Meetings</option>
                                <option value="scheduled">Scheduled</option>
                                <option value="completed">Completed</option>
                                <option value="canceled">Canceled</option>
                            </select>
                        </div>
                        <div>
                            <label for="reschedule-filter" class="block text-sm font-medium text-gray-700 mb-1">Reschedule Status</label>
                            <select id="reschedule-filter" class="border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-pink-500 focus:border-pink-500">
                                <option value="all">All</option>
                                <option value="rescheduled">Rescheduled Only</option>
                                <option value="original">Original Only</option>
                            </select>
                        </div>
                        <div>
                            <button id="refresh-meetings" class="bg-red-600 text-white px-4 py-2 rounded-md text-sm hover:bg-red-700 transition-colors">
                                <i class="fas fa-sync-alt mr-2"></i>Refresh
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Meetings List -->
                <div class="bg-white rounded-lg shadow-md">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-medium text-gray-900">All Meetings</h3>
                        <p class="text-sm text-gray-500 mt-1">Complete overview of all scheduled meetings and their status</p>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Meeting ID</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Volunteer</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Scheduled Time</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reschedule Info</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="meetings-list" class="bg-white divide-y divide-gray-200">
                                <!-- Meeting rows will be inserted here -->
                                <tr>
                                    <td colspan="7" class="px-6 py-4 text-center text-sm text-gray-500">
                                        Loading meetings...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Volunteers Tab Content -->
            <div id="volunteers-content" class="tab-content hidden">
                <div class="border-b border-gray-200 pb-3 mb-5">
                    <h2 class="text-xl font-semibold text-gray-900">Volunteer Oversight</h2>
                    <p class="mt-1 text-sm text-gray-500">View volunteer performance and manage restrictions. Volunteer decisions are respected — admin intervenes only when necessary.</p>
                </div>

                <!-- Restriction Alert -->
                <div id="restriction-alert" class="hidden bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                    <div class="flex items-center">
                        <i class="fas fa-exclamation-circle text-red-600 mr-3 text-lg"></i>
                        <div>
                            <h3 class="text-sm font-medium text-red-800"><span id="restricted-count">0</span> volunteer(s) currently restricted</h3>
                            <p class="text-sm text-red-600 mt-1">These volunteers cannot schedule new meetings due to high cancellation or missed call rates.</p>
                        </div>
                    </div>
                </div>

                <!-- Volunteers List -->
                <div class="bg-white rounded-lg shadow-md">
                    <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-medium text-gray-900">All Volunteers</h3>
                            <p class="text-sm text-gray-500 mt-1">Performance metrics and restriction status</p>
                        </div>
                        <button onclick="loadVolunteers()" class="bg-red-600 text-white px-4 py-2 rounded-md text-sm hover:opacity-90 transition-opacity">
                            <i class="fas fa-sync-alt mr-2"></i>Refresh
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Volunteer</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Completed</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cancelled</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Missed</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Score</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="volunteers-list" class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td colspan="7" class="px-6 py-4 text-center text-sm text-gray-500">
                                        Loading volunteers...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Meeting Detail Modal -->
    <div id="meeting-detail-modal" class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg max-w-lg mx-auto w-full mx-4 overflow-hidden">
            <!-- Header -->
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900" id="meeting-modal-title">Meeting Details</h3>
                <button onclick="closeMeetingModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>
            <!-- Body -->
            <div id="meeting-modal-body" class="px-6 py-5">
                <p class="text-gray-500 text-sm">Loading...</p>
            </div>
            <!-- Footer -->
            <div id="meeting-modal-footer" class="px-6 py-3 border-t border-gray-100 bg-gray-50 flex justify-end">
                <button onclick="closeMeetingModal()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 transition-colors">Close</button>
            </div>
        </div>
    </div>

    <!-- Volunteer Detail Modal (expanded with tabs) -->
    <div id="volunteer-performance-modal" class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg max-w-4xl mx-auto w-full max-h-[90vh] overflow-hidden flex flex-col">
            <div class="flex items-center justify-between p-6 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">Volunteer Details</h3>
                <button onclick="closeVolunteerModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <!-- Modal Tabs -->
            <div class="border-b border-gray-200 px-6">
                <nav class="flex space-x-6" aria-label="Modal Tabs">
                    <button id="modal-tab-profile" class="modal-tab-btn py-3 text-sm font-medium border-b-2 border-red-600 text-red-700" onclick="switchModalTab('profile')">
                        <i class="fas fa-user mr-1"></i>Profile
                    </button>
                    <button id="modal-tab-meetings" class="modal-tab-btn py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700" onclick="switchModalTab('meetings')">
                        <i class="fas fa-calendar-alt mr-1"></i>Meetings
                    </button>
                    <button id="modal-tab-activity" class="modal-tab-btn py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700" onclick="switchModalTab('activity')">
                        <i class="fas fa-stream mr-1"></i>Activity
                    </button>
                </nav>
            </div>
            <div id="volunteer-modal-content" class="p-6 overflow-y-auto flex-1">
                <p class="text-sm text-gray-500">Loading...</p>
            </div>
            <!-- Delete footer -->
            <div id="volunteer-modal-footer" class="hidden border-t border-gray-200 p-4 bg-gray-50">
                <button id="delete-volunteer-btn" class="w-full bg-red-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-red-700 transition-colors">
                    <i class="fas fa-trash-alt mr-2"></i>Delete Volunteer Account
                </button>
            </div>
        </div>
    </div>

    <!-- Delete Volunteer Confirmation Modal -->
    <div id="delete-volunteer-modal" class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center hidden" style="z-index: 60">
        <div class="bg-white rounded-lg p-6 max-w-md mx-auto">
            <div class="flex items-center mb-4">
                <div class="w-10 h-10 rounded-full bg-red-100 flex items-center justify-center mr-3">
                    <i class="fas fa-exclamation-triangle text-red-600"></i>
                </div>
                <h3 class="text-lg font-medium text-gray-900">Delete Volunteer Account</h3>
            </div>
            <p id="delete-volunteer-message" class="text-sm text-gray-600 mb-4">Are you sure you want to permanently delete this volunteer? This action cannot be undone.</p>
            <div class="flex justify-end space-x-3">
                <button onclick="document.getElementById('delete-volunteer-modal').classList.add('hidden')" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">
                    Cancel
                </button>
                <button id="confirm-delete-volunteer" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">
                    Delete Permanently
                </button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg p-6 max-w-md mx-auto">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Confirm Deletion</h3>
            <p class="text-sm text-gray-500 mb-4">Are you sure you want to delete all students? This action cannot be undone.</p>
            <div class="flex justify-end space-x-3">
                <button id="cancel-delete" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                    Cancel
                </button>
                <button id="confirm-delete" class="px-4 py-2 bg-red-800 text-white rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                    Delete All
                </button>
            </div>
        </div>
    </div>
    
    <!-- Edit Student Modal -->
    <div id="edit-modal" class="edit-modal-overlay">
        <div class="edit-modal-box">
            <!-- Header — fixed -->
            <div class="edit-modal-header">
                <h3 class="text-lg font-semibold text-gray-900">Edit Student</h3>
                <button type="button" id="cancel-edit" class="text-gray-400 hover:text-gray-600 transition-colors" title="Close">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>

            <!-- Scrollable body -->
            <div class="edit-modal-body">
                <form id="edit-student-form" class="space-y-4">
                    <input type="hidden" id="edit-id">

                    <!-- Name row -->
                    <div class="flex gap-3">
                        <div class="flex-1">
                            <label for="edit-firstName" class="block text-xs font-medium text-gray-500 mb-1">First Name *</label>
                            <input type="text" id="edit-firstName" name="firstName" required class="block w-full border border-gray-300 rounded-lg py-2 px-3 text-sm focus:outline-none focus:ring-1 focus:ring-pink-500 focus:border-pink-500">
                        </div>
                        <div class="flex-1">
                            <label for="edit-lastName" class="block text-xs font-medium text-gray-500 mb-1">Last Name *</label>
                            <input type="text" id="edit-lastName" name="lastName" required class="block w-full border border-gray-300 rounded-lg py-2 px-3 text-sm focus:outline-none focus:ring-1 focus:ring-pink-500 focus:border-pink-500">
                        </div>
                    </div>

                    <!-- ADM + Age + Gender row -->
                    <div class="flex gap-3">
                        <div class="flex-1">
                            <label for="edit-admissionNumber" class="block text-xs font-medium text-gray-500 mb-1">ADM # *</label>
                            <div class="flex">
                                <span class="inline-flex items-center px-2 rounded-l-lg border border-r-0 border-gray-300 bg-gray-50 text-gray-500 text-xs">ADM</span>
                                <input type="text" id="edit-admissionNumber" name="admissionNumber" required pattern="\d{4}" maxlength="4" placeholder="0000" class="block w-full border border-gray-300 rounded-r-lg py-2 px-2 text-sm focus:outline-none focus:ring-1 focus:ring-pink-500 focus:border-pink-500">
                            </div>
                        </div>
                        <div style="width: 70px;">
                            <label for="edit-age" class="block text-xs font-medium text-gray-500 mb-1">Age</label>
                            <input type="number" id="edit-age" name="age" min="1" max="100" class="block w-full border border-gray-300 rounded-lg py-2 px-2 text-sm focus:outline-none focus:ring-1 focus:ring-pink-500 focus:border-pink-500">
                        </div>
                        <div style="width: 100px;">
                            <label for="edit-gender" class="block text-xs font-medium text-gray-500 mb-1">Gender</label>
                            <select id="edit-gender" name="gender" class="block w-full border border-gray-300 rounded-lg py-2 px-2 text-sm focus:outline-none focus:ring-1 focus:ring-pink-500 focus:border-pink-500">
                                <option value="">--</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>

                    <!-- Bio -->
                    <div>
                        <label for="edit-bio" class="block text-xs font-medium text-gray-500 mb-1">Bio</label>
                        <textarea id="edit-bio" name="bio" rows="2" class="block w-full border border-gray-300 rounded-lg py-2 px-3 text-sm focus:outline-none focus:ring-1 focus:ring-pink-500 focus:border-pink-500" placeholder="Brief description (1-2 sentences)"></textarea>
                    </div>

                    <!-- Story -->
                    <div>
                        <label for="edit-story" class="block text-xs font-medium text-gray-500 mb-1">Story</label>
                        <textarea id="edit-story" name="story" rows="3" class="block w-full border border-gray-300 rounded-lg py-2 px-3 text-sm focus:outline-none focus:ring-1 focus:ring-pink-500 focus:border-pink-500" placeholder="Detailed background story"></textarea>
                    </div>

                    <!-- Images section -->
                    <div style="border-top: 1px solid #e5e7eb; padding-top: 12px; margin-top: 4px;">
                        <p class="text-xs font-medium text-gray-500 mb-3"><i class="fas fa-camera mr-1"></i> IMAGES <span class="font-normal text-gray-400">&mdash; auto-optimized to .webp</span></p>

                        <!-- Profile picture -->
                        <div class="mb-3">
                            <div class="flex items-center gap-3">
                                <div id="edit-profile-preview" class="preview-grid" style="min-width:64px;"></div>
                                <div class="upload-zone flex-1" id="edit-profile-upload-zone" onclick="document.getElementById('edit-profile-file-input').click()" style="padding:8px;">
                                    <input type="file" id="edit-profile-file-input" accept="image/*">
                                    <input type="hidden" id="edit-profileImage" name="profileImage">
                                    <p id="edit-profile-upload-label" class="text-xs text-gray-500"><i class="fas fa-cloud-upload-alt mr-1"></i> Profile picture</p>
                                </div>
                            </div>
                        </div>

                        <!-- Gallery -->
                        <div>
                            <div class="upload-zone" id="edit-gallery-upload-zone" onclick="document.getElementById('edit-gallery-file-input').click()" style="padding:8px;">
                                <input type="file" id="edit-gallery-file-input" accept="image/*" multiple>
                                <input type="hidden" id="edit-gallery" name="gallery">
                                <div id="edit-gallery-preview" class="preview-grid"></div>
                                <p id="edit-gallery-upload-label" class="text-xs text-gray-500"><i class="fas fa-images mr-1"></i> Gallery images (up to 5)</p>
                            </div>
                        </div>
                    </div>

                    <!-- Upload status indicator -->
                    <div id="edit-upload-status" class="upload-status">
                        <div class="spinner"></div>
                        <span id="edit-upload-status-text">Uploading images...</span>
                    </div>
                </form>
            </div>

            <!-- Footer — fixed -->
            <div class="edit-modal-footer">
                <div id="edit-form-message" class="text-sm hidden flex-1"></div>
                <div class="flex gap-2 flex-shrink-0">
                    <button type="button" id="cancel-edit-footer" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-200 transition-colors focus:outline-none">
                        Cancel
                    </button>
                    <button type="submit" form="edit-student-form" id="edit-submit-btn" class="px-5 py-2 btn-primary text-white rounded-lg text-sm font-medium hover:opacity-90 transition-opacity focus:outline-none">
                        Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize admin authentication
            window.TalkTimeAuth = new TalkTimeJWTAuth('admin');
            
            // Check authentication on page load
            checkAdminAuth();
            
            // Add token validation check
            function validateToken() {
                const token = window.TalkTimeAuth.getToken();
                if (!token) {
                    console.log('No token found, redirecting to login');
                    window.location.href = '/admin/login.html';
                    return false;
                }
                
                // Test token validity with a simple API call
                return window.TalkTimeAuth.makeAuthenticatedRequest('/api/v1/admin/me', {
                    method: 'GET'
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Token validation failed: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('✅ Token validation successful:', data);
                    return true;
                })
                .catch(error => {
                    console.error('❌ Token validation failed:', error);
                    // Clear invalid tokens
                    window.TalkTimeAuth.logout();
                    showNotification('Session expired. Please log in again.', 'error');
                    setTimeout(() => {
                        window.location.href = '/admin/login.html';
                    }, 2000);
                    return false;
                });
            }
            
            // Load students on page load
            loadStudents();
            
            // Add event listeners
            document.getElementById('add-student-form').addEventListener('submit', createStudent);
            document.getElementById('edit-student-form').addEventListener('submit', updateStudent);
            document.getElementById('refresh-students').addEventListener('click', loadStudents);
            document.getElementById('delete-all-students').addEventListener('click', showDeleteModal);
            document.getElementById('cancel-delete').addEventListener('click', hideDeleteModal);
            document.getElementById('cancel-edit').addEventListener('click', hideEditModal);
            document.getElementById('cancel-edit-footer').addEventListener('click', hideEditModal);
            document.getElementById('confirm-delete').addEventListener('click', deleteAllStudents);
            // Logout buttons are handled separately below

            // File upload preview handlers
            setupFilePreview('profile-file-input', 'profile-preview', 'profile-upload-label', false);
            setupFilePreview('gallery-file-input', 'gallery-preview', 'gallery-upload-label', true);
            setupFilePreview('edit-profile-file-input', 'edit-profile-preview', 'edit-profile-upload-label', false);
            setupFilePreview('edit-gallery-file-input', 'edit-gallery-preview', 'edit-gallery-upload-label', true);
        });

        // Authentication check with personalized greeting
        function checkAdminAuth() {
            window.TalkTimeAuth.makeAuthenticatedRequest('/api/v1/jwt-auth/verify', {
                method: 'GET'
            })
            .then(response => {
                if (!response.ok) {
                    window.location.href = '/admin/login.html';
                    return;
                }
                return response.json();
            })
            .then(data => {
                if (!data.success || !data.authenticated || data.user.role !== 'admin') {
                    window.location.href = '/admin/login.html';
                    return;
                }
                // Personalized greeting
                const fullName = data.user.full_name || data.user.fullName || data.user.name || 'Admin';
                const firstName = fullName.split(' ')[0];
                const greetingEl = document.getElementById('admin-greeting');
                const initialEl = document.getElementById('admin-initial');
                if (greetingEl) greetingEl.textContent = firstName;
                if (initialEl) initialEl.textContent = fullName.charAt(0).toUpperCase();
                const welcomeEl = document.getElementById('dashboard-welcome-name');
                if (welcomeEl) welcomeEl.textContent = firstName;
                const dropdownNameEl = document.getElementById('dropdown-admin-name');
                if (dropdownNameEl) dropdownNameEl.textContent = fullName;
            })
            .catch(error => {
                console.error('Auth check error:', error);
                window.location.href = '/admin/login.html';
            });
        }

        // ── Upload Status Helpers ──

        function showUploadStatus(prefix, text, type) {
            const el = document.getElementById(prefix + '-upload-status');
            const textEl = document.getElementById(prefix + '-upload-status-text');
            if (!el) return;
            el.className = 'upload-status active' + (type ? ' ' + type : '');
            textEl.textContent = text;
            // Hide spinner on success/error
            const spinner = el.querySelector('.spinner');
            if (spinner) spinner.style.display = (type === 'success' || type === 'error') ? 'none' : '';
        }

        function hideUploadStatus(prefix) {
            const el = document.getElementById(prefix + '-upload-status');
            if (el) { el.className = 'upload-status'; }
        }

        function setSubmitLoading(btnId, loading) {
            const btn = document.getElementById(btnId);
            if (!btn) return;
            if (loading) {
                btn.disabled = true;
                btn.dataset.origText = btn.textContent;
                btn.innerHTML = '<i class="fas fa-circle-notch fa-spin mr-1"></i> Saving...';
                btn.style.opacity = '0.7';
            } else {
                btn.disabled = false;
                btn.textContent = btn.dataset.origText || 'Save Changes';
                btn.style.opacity = '';
            }
        }

        // ── Image Upload Helpers ──

        /**
         * Set up file input change → thumbnail preview
         * @param {string} inputId - file input element ID
         * @param {string} previewId - preview container ID
         * @param {string} labelId - label text element ID
         * @param {boolean} multi - allow multiple files
         */
        /**
         * Max gallery images allowed
         */
        const MAX_GALLERY_IMAGES = 5;

        function setupFilePreview(inputId, previewId, labelId, multi) {
            const input = document.getElementById(inputId);
            if (!input) return;
            input.addEventListener('change', function(e) {
                e.stopPropagation();
                const previewEl = document.getElementById(previewId);
                const labelEl = document.getElementById(labelId);
                const files = Array.from(this.files);
                if (!files.length) return;

                // Enforce gallery limit for multi-file inputs
                if (multi) {
                    const existingCount = previewEl.querySelectorAll('.preview-thumb[data-existing-url]').length;
                    const totalAfter = existingCount + files.length;
                    if (totalAfter > MAX_GALLERY_IMAGES) {
                        const allowed = MAX_GALLERY_IMAGES - existingCount;
                        const msg = existingCount > 0
                            ? 'Maximum ' + MAX_GALLERY_IMAGES + ' gallery images. You have ' + existingCount + ' existing — you can add ' + Math.max(0, allowed) + ' more.'
                            : 'Maximum ' + MAX_GALLERY_IMAGES + ' gallery images. You selected ' + files.length + '.';
                        if (typeof showNotification === 'function') {
                            showNotification(msg, 'error', { title: 'Too many images', autoClose: true, duration: 5000 });
                        } else {
                            alert(msg);
                        }
                        input.value = '';
                        return;
                    }
                }

                // For single-file inputs, clear all previews; for multi, clear only non-existing (new) thumbs
                if (multi) {
                    previewEl.querySelectorAll('.preview-thumb:not([data-existing-url])').forEach(el => el.remove());
                } else {
                    previewEl.innerHTML = '';
                }

                if (labelEl) {
                    labelEl.style.display = 'none';
                }

                files.forEach((file, idx) => {
                    if (!file.type.startsWith('image/')) return;
                    const reader = new FileReader();
                    reader.onload = function(ev) {
                        const thumb = document.createElement('div');
                        thumb.className = 'preview-thumb';
                        thumb.innerHTML = '<img src="' + ev.target.result + '" alt="Preview">' +
                            '<button type="button" class="remove-btn" title="Remove">&times;</button>';
                        thumb.querySelector('.remove-btn').addEventListener('click', function(e2) {
                            e2.stopPropagation();
                            thumb.remove();
                            // If no previews left, show label again and clear input
                            if (!previewEl.children.length) {
                                if (labelEl) labelEl.style.display = '';
                                input.value = '';
                            }
                        });
                        previewEl.appendChild(thumb);
                    };
                    reader.readAsDataURL(file);
                });
            });
        }

        /**
         * Show an existing image URL as a preview thumbnail
         * @param {string} url - image URL
         * @param {string} previewId - preview container ID
         * @param {string} labelId - label element ID
         */
        function showExistingPreview(url, previewId, labelId) {
            if (!url) return;
            const previewEl = document.getElementById(previewId);
            const labelEl = document.getElementById(labelId);
            if (!previewEl) return;

            const thumb = document.createElement('div');
            thumb.className = 'preview-thumb';
            thumb.dataset.existingUrl = url;
            thumb.innerHTML = '<img src="' + url + '" alt="Current">' +
                '<button type="button" class="remove-btn" title="Remove">&times;</button>';
            thumb.querySelector('.remove-btn').addEventListener('click', function(e) {
                e.stopPropagation();
                thumb.remove();
                if (!previewEl.children.length && labelEl) {
                    labelEl.style.display = '';
                }
            });
            previewEl.appendChild(thumb);
            if (labelEl) labelEl.style.display = 'none';
        }

        /**
         * Upload images to backend, return { profilePicture, gallery }
         * Uses raw fetch (not makeAuthenticatedRequest) because multipart needs browser-set Content-Type
         * @param {HTMLInputElement} profileFileInput
         * @param {HTMLInputElement} galleryFileInput
         * @param {Object} oldUrls - { profilePicture: string|null, gallery: string[]|null } to delete on backend
         */
        async function uploadImages(profileFileInput, galleryFileInput, oldUrls) {
            const profileFiles = profileFileInput ? profileFileInput.files : null;
            const galleryFiles = galleryFileInput ? galleryFileInput.files : null;
            const hasProfile = profileFiles && profileFiles.length > 0;
            const hasGallery = galleryFiles && galleryFiles.length > 0;

            if (!hasProfile && !hasGallery) return null;

            const formData = new FormData();
            if (hasProfile) {
                formData.append('profilePicture', profileFiles[0]);
                // Tell backend which old profile image to delete
                if (oldUrls && oldUrls.profilePicture) {
                    formData.append('oldProfilePicture', oldUrls.profilePicture);
                }
            }
            if (hasGallery) {
                for (let i = 0; i < galleryFiles.length; i++) {
                    formData.append('gallery', galleryFiles[i]);
                }
                // Tell backend which old gallery images to delete
                if (oldUrls && oldUrls.gallery && oldUrls.gallery.length > 0) {
                    formData.append('oldGallery', oldUrls.gallery.join(','));
                }
            }

            const token = window.TalkTimeAuth.getToken() || window.TalkTimeAuth.getAccessToken();
            const response = await fetch('/api/v1/admin/upload/student-images', {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + token },
                body: formData
            });

            if (!response.ok) {
                const errText = await response.text().catch(() => '');
                let errMsg = 'Image upload failed (HTTP ' + response.status + ')';
                try {
                    const errData = JSON.parse(errText);
                    if (errData.error) errMsg = errData.error;
                    else if (errData.message) errMsg = errData.message;
                } catch(e) {
                    if (errText) errMsg += ': ' + errText.substring(0, 200);
                }
                throw new Error(errMsg);
            }
            return response.json();
        }

        /**
         * Collect existing image URLs from preview thumbnails that have data-existingUrl
         */
        function getExistingUrls(previewId) {
            const previewEl = document.getElementById(previewId);
            if (!previewEl) return [];
            return Array.from(previewEl.querySelectorAll('.preview-thumb[data-existing-url]'))
                .map(el => el.dataset.existingUrl)
                .filter(Boolean);
        }

        // Load all students
        function loadStudents() {
            window.TalkTimeAuth.makeAuthenticatedRequest('/api/v1/admin/students', {
                method: 'GET',
                credentials: 'include'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch students');
                }
                return response.json();
            })
            .then(data => {
                const studentList = document.getElementById('student-list');
                
                if (data.students && data.students.length > 0) {
                    studentList.innerHTML = '';
                    
                    data.students.forEach(student => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${student.id}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${student.fullName}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${student.admissionNumber}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${student.age || '-'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${student.gender || '-'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <button class="text-red-700 hover:text-red-800 mr-2" onclick="viewStudent(${student.id})">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="text-red-700 hover:text-red-800 mr-2" onclick="editStudent(${student.id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="text-red-700 hover:text-red-900" onclick="deleteStudent(${student.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        `;
                        studentList.appendChild(row);
                    });
                } else {
                    studentList.innerHTML = `
                        <tr>
                            <td colspan="6" class="px-6 py-4 text-center text-sm text-gray-500">
                                No students found. Add a new student to get started.
                            </td>
                        </tr>
                    `;
                }
            })
            .catch(error => {
                console.error('Error loading students:', error);
                document.getElementById('student-list').innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-4 text-center text-sm text-red-500">
                            Error loading students. Please try again.
                        </td>
                    </tr>
                `;
            });
        }

        // View student details (placeholder)
        function viewStudent(id) {
            window.showNotification(`Viewing student with ID: ${id}`, 'info', {
                title: 'Student Details',
                autoClose: true,
                duration: 3000
            });
            // Implement view functionality
        }

        // Delete a student
        async function deleteStudent(id) {
            // Use professional modal instead of browser confirm
            const confirmed = await window.showConfirmation(
                'Are you sure you want to delete this student? This action cannot be undone.',
                {
                    title: 'Delete Student',
                    confirmText: 'Delete',
                    cancelText: 'Cancel',
                    type: 'warning'
                }
            );
            
            if (confirmed) {
                // First, try to delete any past/cancelled meetings for this student
                window.TalkTimeAuth.makeAuthenticatedRequest(`/api/v1/admin/reset-student-meetings/${id}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ action: 'delete_past_meetings' })
                })
                .then(response => {
                    // Now try to delete the student
                    return window.TalkTimeAuth.makeAuthenticatedRequest(`/api/v1/admin/students/${id}`, {
                        method: 'DELETE'
                    });
                })
                .then(response => {
                    if (response.ok) {
                        loadStudents();
                        return;
                    }
                    
                    // Handle specific error cases
                    return response.json()
                        .then(async (data) => {
                            if (data.error && data.error.includes('meetings')) {
                                const deleteMeetings = await window.showConfirmation(
                                    'This student has scheduled future meetings. Would you like to delete these meetings and then delete the student?',
                                    {
                                        title: 'Delete Student with Meetings',
                                        confirmText: 'Delete All',
                                        cancelText: 'Cancel',
                                        type: 'warning'
                                    }
                                );
                                
                                if (deleteMeetings) {
                                    // Delete all meetings for this student first
                                    return window.TalkTimeAuth.makeAuthenticatedRequest(`/api/v1/admin/reset-student-meetings/${id}`, {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json'
                                        },
                                        body: JSON.stringify({ action: 'delete_all_meetings' })
                                    })
                                    .then(response => {
                                        if (response.ok) {
                                            // Now try to delete the student again
                                            return window.TalkTimeAuth.makeAuthenticatedRequest(`/api/v1/admin/students/${id}`, {
                                                method: 'DELETE'
                                            });
                                        }
                                        throw new Error('Failed to delete meetings');
                                    })
                                    .then(response => {
                                        if (response.ok) {
                                            loadStudents();
                                        } else {
                                            window.showNotification('Failed to delete student after deleting meetings.', 'error', {
                                                title: 'Deletion Failed',
                                                autoClose: false
                                            });
                                        }
                                    });
                                }
                            } else {
                                window.showNotification('Failed to delete student: ' + (data.error || 'Unknown error'), 'error', {
                                    title: 'Deletion Failed',
                                    autoClose: false
                                });
                            }
                        })
                        .catch(err => {
                            console.error('Error parsing response:', err);
                            window.showNotification('Failed to delete student. Please try again later.', 'error', {
                                title: 'Deletion Failed',
                                autoClose: false
                            });
                        });
                })
                .catch(error => {
                    console.error('Delete request failed:', error);
                    window.showNotification('Network error while trying to delete student. Please check your connection and try again.', 'error', {
                        title: 'Network Error',
                        autoClose: false
                    });
                });
            }
        }

        // Show delete confirmation modal
        function showDeleteModal() {
            document.getElementById('delete-modal').classList.remove('hidden');
        }

        // Hide delete confirmation modal
        function hideDeleteModal() {
            document.getElementById('delete-modal').classList.add('hidden');
        }
        
        // Hide edit student modal
        function hideEditModal() {
            document.getElementById('edit-modal').classList.remove('show');
        }
        
        // Edit student
        function editStudent(id) {
            // Fetch student details
            window.TalkTimeAuth.makeAuthenticatedRequest(`/api/v1/admin/students/${id}`, {
                method: 'GET'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                // Handle both direct student data and wrapped response
                const student = data.student || data;
                
                if (!student || !student.id) {
                    throw new Error('Invalid student data received from server');
                }
                
                // Populate form fields
                document.getElementById('edit-id').value = student.id;
                
                // Split fullName into firstName and lastName since backend only returns fullName
                const nameParts = (student.fullName || '').split(' ');
                const firstName = nameParts[0] || '';
                const lastName = nameParts.slice(1).join(' ') || '';
                
                document.getElementById('edit-firstName').value = firstName;
                document.getElementById('edit-lastName').value = lastName;
                
                // Extract the 4-digit part from the admission number - handle undefined safely
                if (student.admissionNumber) {
                    const admissionMatch = student.admissionNumber.match(/ADM(\d{4})/i);
                    if (admissionMatch && admissionMatch[1]) {
                        document.getElementById('edit-admissionNumber').value = admissionMatch[1];
                    } else {
                        // Try to extract just the numeric part if no ADM prefix
                        const numericMatch = student.admissionNumber.match(/(\d{4})/);
                        document.getElementById('edit-admissionNumber').value = numericMatch ? numericMatch[1] : '';
                    }
                } else {
                    document.getElementById('edit-admissionNumber').value = '';
                }
                
                document.getElementById('edit-age').value = student.age || '';
                document.getElementById('edit-gender').value = student.gender || '';
                document.getElementById('edit-bio').value = student.bio || '';
                document.getElementById('edit-story').value = student.story || '';
                // Show existing profile picture as preview
                const existingPhoto = student.profileImage || student.photoUrl || '';
                document.getElementById('edit-profileImage').value = existingPhoto;
                document.getElementById('edit-profile-preview').innerHTML = '';
                document.getElementById('edit-profile-upload-label').style.display = '';
                document.getElementById('edit-profile-file-input').value = '';
                if (existingPhoto) {
                    showExistingPreview(existingPhoto, 'edit-profile-preview', 'edit-profile-upload-label');
                }

                // Show existing gallery images as previews
                document.getElementById('edit-gallery-preview').innerHTML = '';
                document.getElementById('edit-gallery-upload-label').style.display = '';
                document.getElementById('edit-gallery-file-input').value = '';
                document.getElementById('edit-gallery').value = '';
                if (student.gallery && Array.isArray(student.gallery)) {
                    student.gallery.forEach(url => {
                        showExistingPreview(url, 'edit-gallery-preview', 'edit-gallery-upload-label');
                    });
                }
                
                // Show edit modal
                document.getElementById('edit-modal').classList.add('show');
            })
            .catch(error => {
                console.error('Error fetching student:', error);
                
                // Show user-friendly error modal
                let errorMessage = 'Failed to load student details. Please try again.';
                
                if (error.message.includes('401') || error.message.includes('403')) {
                    errorMessage = 'Authentication expired. Please log in again.';
                    // Redirect to login after showing error
                    setTimeout(() => {
                        window.location.href = '/admin/login.html';
                    }, 2000);
                } else if (error.message.includes('404')) {
                    errorMessage = 'Student not found. The student may have been deleted.';
                } else if (error.message.includes('500')) {
                    errorMessage = 'Server error occurred. Please try again later.';
                }
                
                showNotification(errorMessage, 'error');
            });
        }

        // Update student (two-phase: upload images first, then submit JSON)
        async function updateStudent(event) {
            event.preventDefault();

            const id = document.getElementById('edit-id').value;
            const firstName = document.getElementById('edit-firstName').value;
            const lastName = document.getElementById('edit-lastName').value;
            const admissionNumberDigits = document.getElementById('edit-admissionNumber').value;
            const age = document.getElementById('edit-age').value;
            const gender = document.getElementById('edit-gender').value;
            const bio = document.getElementById('edit-bio').value;
            const story = document.getElementById('edit-story').value;

            // Validate required fields
            if (!firstName || !lastName || !admissionNumberDigits) {
                const messageEl = document.getElementById('edit-form-message');
                messageEl.textContent = 'First name, last name, and admission number are required';
                messageEl.classList.remove('text-green-500', 'hidden');
                messageEl.classList.add('text-red-500');
                return;
            }

            // Validate admission number format (4 digits only)
            const digitFormat = /^\d{4}$/;
            if (!digitFormat.test(admissionNumberDigits)) {
                const messageEl = document.getElementById('edit-form-message');
                messageEl.textContent = 'Admission number must be exactly 4 digits';
                messageEl.classList.remove('text-green-500', 'hidden');
                messageEl.classList.add('text-red-500');
                return;
            }

            // Construct full name and complete admission number
            const fullName = `${firstName} ${lastName}`;
            const paddedDigits = admissionNumberDigits.padStart(4, '0');
            const admissionNumber = `ADM${paddedDigits}-${firstName.toLowerCase()}-${lastName.toLowerCase()}`;

            // Phase 1: Upload new images if any were selected
            let profileImage = document.getElementById('edit-profileImage').value || null;
            let gallery = null;

            const profileFileInput = document.getElementById('edit-profile-file-input');
            const galleryFileInput = document.getElementById('edit-gallery-file-input');

            const hasNewFiles = (profileFileInput.files && profileFileInput.files.length > 0) ||
                                (galleryFileInput.files && galleryFileInput.files.length > 0);

            setSubmitLoading('edit-submit-btn', true);
            hideUploadStatus('edit');

            try {
                const messageEl = document.getElementById('edit-form-message');
                messageEl.classList.add('hidden');

                // Upload new files if selected
                if (hasNewFiles) {
                    showUploadStatus('edit', 'Uploading & optimizing images...');
                    try {
                        // Collect old URLs so backend can delete them after successful processing
                        const oldUrls = {};
                        if (profileFileInput.files && profileFileInput.files.length > 0) {
                            const oldProfile = document.getElementById('edit-profileImage').value;
                            if (oldProfile && oldProfile.startsWith('/uploads/')) oldUrls.profilePicture = oldProfile;
                        }
                        if (galleryFileInput.files && galleryFileInput.files.length > 0) {
                            const oldGallery = getExistingUrls('edit-gallery-preview')
                                .filter(u => u.startsWith('/uploads/'));
                            if (oldGallery.length > 0) oldUrls.gallery = oldGallery;
                        }

                        const uploadResult = await uploadImages(profileFileInput, galleryFileInput, oldUrls);
                        if (uploadResult) {
                            if (uploadResult.profilePicture) {
                                profileImage = uploadResult.profilePicture;
                            }
                            if (uploadResult.gallery) {
                                // New gallery replaces old — don't concat since old ones are deleted
                                gallery = uploadResult.gallery;
                            }
                        }
                        showUploadStatus('edit', 'Images optimized', 'success');
                    } catch (uploadErr) {
                        showUploadStatus('edit', 'Image upload failed — saving without new images', 'error');
                        profileFileInput.value = '';
                        galleryFileInput.value = '';
                    }
                }

                // Collect remaining existing URLs
                if (!gallery) {
                    const existingGalleryUrls = getExistingUrls('edit-gallery-preview');
                    gallery = existingGalleryUrls.length > 0 ? existingGalleryUrls : null;
                }
                if (!profileImage) {
                    const existingProfileUrls = getExistingUrls('edit-profile-preview');
                    profileImage = existingProfileUrls.length > 0 ? existingProfileUrls[0] : null;
                }

                // Submit student data
                if (hasNewFiles) showUploadStatus('edit', 'Saving student record...');
                const response = await window.TalkTimeAuth.makeAuthenticatedRequest(`/api/v1/admin/students/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        firstName,
                        lastName,
                        admissionNumber,
                        age: age || null,
                        gender: gender || '',
                        bio: bio || '',
                        story: story || null,
                        photoUrl: profileImage,
                        gallery
                    })
                });

                if (!response.ok) {
                    const text = await response.text().catch(() => '');
                    let errMsg = 'Failed to update student (HTTP ' + response.status + ')';
                    try { const d = JSON.parse(text); errMsg = d.error || d.message || errMsg; } catch(e) {}
                    throw new Error(errMsg);
                }

                showUploadStatus('edit', 'Saved', 'success');
                loadStudents();

                setTimeout(() => {
                    hideEditModal();
                    hideUploadStatus('edit');
                    messageEl.classList.add('hidden');
                }, 1200);
            } catch (error) {
                console.error('Error updating student:', error);
                showUploadStatus('edit', error.message || 'An error occurred', 'error');
            } finally {
                setSubmitLoading('edit-submit-btn', false);
            }
        }

        // Delete all students
        function deleteAllStudents() {
            window.TalkTimeAuth.makeAuthenticatedRequest('/api/v1/admin/students', {
                method: 'DELETE'
            })
            .then(response => {
                hideDeleteModal();
                
                if (response.ok) {
                    loadStudents();
                    window.showNotification('All students have been deleted successfully', 'success', {
                        title: 'Deletion Complete',
                        autoClose: true,
                        duration: 4000
                    });
                } else {
                    window.showNotification('Failed to delete all students', 'error', {
                        title: 'Deletion Failed',
                        autoClose: false
                    });
                }
            })
            .catch(error => {
                console.error('Error deleting all students:', error);
                hideDeleteModal();
                window.showNotification('An error occurred while deleting all students', 'error', {
                    title: 'Error',
                    autoClose: false
                });
            });
        }

        // Create student function (two-phase: upload images first, then submit JSON)
        async function createStudent(event) {
            event.preventDefault();

            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const admissionNumberDigits = document.getElementById('admissionNumber').value.trim();
            const age = document.getElementById('age').value.trim();
            const gender = document.getElementById('gender').value;
            const bio = document.getElementById('bio').value.trim();
            const story = document.getElementById('story').value.trim();

            // Validate required fields
            if (!firstName || !lastName || !admissionNumberDigits) {
                const messageEl = document.getElementById('form-message');
                messageEl.textContent = 'First name, last name, and admission number are required';
                messageEl.classList.remove('text-green-500', 'hidden');
                messageEl.classList.add('text-red-500');
                return;
            }

            // Validate admission number format (4 digits only)
            const digitFormat = /^\d{4}$/;
            if (!digitFormat.test(admissionNumberDigits)) {
                const messageEl = document.getElementById('form-message');
                messageEl.textContent = 'Admission number must be exactly 4 digits';
                messageEl.classList.remove('text-green-500', 'hidden');
                messageEl.classList.add('text-red-500');
                return;
            }

            // Construct full name and complete admission number
            const fullName = `${firstName} ${lastName}`;
            const admissionNumber = `ADM${admissionNumberDigits}-${firstName.toLowerCase()}-${lastName.toLowerCase()}`;

            const profileFileInput = document.getElementById('profile-file-input');
            const galleryFileInput = document.getElementById('gallery-file-input');
            const hasNewFiles = (profileFileInput.files && profileFileInput.files.length > 0) ||
                                (galleryFileInput.files && galleryFileInput.files.length > 0);

            setSubmitLoading('create-submit-btn', true);
            hideUploadStatus('create');

            try {
                const messageEl = document.getElementById('form-message');
                messageEl.classList.add('hidden');

                let profileImage = null;
                let gallery = null;

                if (hasNewFiles) {
                    showUploadStatus('create', 'Uploading & optimizing images...');
                    const uploadResult = await uploadImages(profileFileInput, galleryFileInput);
                    if (uploadResult) {
                        if (uploadResult.profilePicture) profileImage = uploadResult.profilePicture;
                        if (uploadResult.gallery) gallery = uploadResult.gallery;
                    }
                    showUploadStatus('create', 'Images optimized', 'success');
                }

                if (hasNewFiles) showUploadStatus('create', 'Creating student record...');
                const response = await window.TalkTimeAuth.makeAuthenticatedRequest('/api/v1/admin/students', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        firstName,
                        lastName,
                        admissionNumber,
                        age: age || null,
                        gender: gender || '',
                        bio: bio || '',
                        story: story || null,
                        photoUrl: profileImage,
                        gallery
                    })
                });

                if (!response.ok) {
                    const text = await response.text().catch(() => '');
                    let errMsg = 'Failed to create student (HTTP ' + response.status + ')';
                    try { const d = JSON.parse(text); errMsg = d.error || d.message || errMsg; } catch(e) {}
                    throw new Error(errMsg);
                }

                showUploadStatus('create', 'Student created', 'success');
                messageEl.textContent = 'Student created successfully!';
                messageEl.classList.remove('text-red-500', 'hidden');
                messageEl.classList.add('text-green-500');

                document.getElementById('add-student-form').reset();
                document.getElementById('profile-preview').innerHTML = '';
                document.getElementById('gallery-preview').innerHTML = '';
                document.getElementById('profile-upload-label').style.display = '';
                document.getElementById('gallery-upload-label').style.display = '';

                loadStudents();
                setTimeout(() => hideUploadStatus('create'), 3000);
            } catch (error) {
                console.error('Error creating student:', error);
                showUploadStatus('create', error.message || 'An error occurred', 'error');
            } finally {
                setSubmitLoading('create-submit-btn', false);
            }
        }

        // Tab switching functionality
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active', 'border-pink-500', 'text-pink-600');
                button.classList.add('border-transparent', 'text-gray-500');
            });
            
            // Show selected tab content
            document.getElementById(`${tabName}-content`).classList.remove('hidden');
            
            // Add active class to selected tab button
            const activeButton = document.getElementById(`${tabName}-tab`);
            activeButton.classList.add('active', 'border-pink-500', 'text-pink-600');
            activeButton.classList.remove('border-transparent', 'text-gray-500');
            
            // Load data for the selected tab
            if (tabName === 'meetings') {
                loadMeetings();
            } else if (tabName === 'volunteers') {
                loadVolunteers();
            }
        }
        
        // Load meetings data
        let allMeetingsData = [];

        async function loadMeetings() {
            try {
                const response = await window.TalkTimeAuth.makeAuthenticatedRequest('/api/v1/admin/meetings', {
                    method: 'GET'
                });

                if (response.ok) {
                    const data = await response.json();
                    allMeetingsData = data.meetings || [];
                    displayMeetings(allMeetingsData);
                } else {
                    console.error('Failed to load meetings:', response.status);
                    displayMeetingsError('Failed to load meetings');
                }
            } catch (error) {
                console.error('Error loading meetings:', error);
                displayMeetingsError('Network error loading meetings');
            }
        }
        
        // Display meetings in the table
        function displayMeetings(meetings) {
            const meetingsList = document.getElementById('meetings-list');
            
            if (!meetings || meetings.length === 0) {
                meetingsList.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-6 py-4 text-center text-sm text-gray-500">
                            No meetings found
                        </td>
                    </tr>
                `;
                return;
            }
            
            const meetingsHtml = meetings.map(meeting => {
                const scheduledDate = new Date(meeting.scheduled_time);
                const formattedDate = scheduledDate.toLocaleDateString();
                const formattedTime = scheduledDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                // Reschedule information
                const isRescheduled = meeting.is_rescheduled;
                const rescheduleCount = meeting.reschedule_count || 0;
                const lastRescheduledAt = meeting.last_rescheduled_at;
                
                let rescheduleInfo = '';
                if (isRescheduled) {
                    const rescheduleDate = new Date(lastRescheduledAt);
                    const rescheduleFormatted = rescheduleDate.toLocaleDateString();
                    
                    let originalTimeInfo = '';
                    if (meeting.original_scheduled_time) {
                        const originalDate = new Date(meeting.original_scheduled_time);
                        const originalFormatted = originalDate.toLocaleDateString();
                        const originalTime = originalDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                        originalTimeInfo = `<div class="text-xs text-gray-500 mt-1">Originally: ${originalFormatted} at ${originalTime}</div>`;
                    }
                    
                    rescheduleInfo = `
                        <div class="text-xs">
                            <span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full">
                                <i class="fas fa-sync-alt mr-1"></i>Rescheduled ${rescheduleCount}x
                            </span>
                            <div class="text-gray-600 mt-1">Last: ${rescheduleFormatted}</div>
                            ${meeting.rescheduled_by_name ? `<div class="text-blue-600 mt-1"><i class="fas fa-user mr-1"></i>By: ${meeting.rescheduled_by_name}</div>` : ''}
                            ${originalTimeInfo}
                        </div>
                    `;
                } else {
                    rescheduleInfo = '<span class="text-gray-400 text-xs"><i class="fas fa-calendar-check mr-1"></i>Original</span>';
                }
                
                // Status styling
                let statusClass = 'bg-gray-100 text-gray-800';
                if (meeting.status === 'scheduled') statusClass = 'bg-blue-100 text-blue-800';
                else if (meeting.status === 'completed') statusClass = 'bg-green-100 text-green-800';
                else if (meeting.status === 'canceled' || meeting.status === 'cancelled') statusClass = 'bg-red-100 text-red-800';
                else if (meeting.status === 'missed') statusClass = 'bg-yellow-100 text-yellow-800';
                
                return `
                    <tr class="${isRescheduled ? 'bg-yellow-50' : ''}">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                            #${meeting.id}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            <div class="font-medium">${meeting.student_name || 'Unknown Student'}</div>
                            <div class="text-xs text-gray-500">${meeting.student_admission || ''}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            <div class="font-medium">${meeting.volunteer_name || 'Unknown Volunteer'}</div>
                            <div class="text-xs text-gray-500">${meeting.volunteer_email || ''}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            <div class="font-medium">${formattedDate}</div>
                            <div class="text-xs text-gray-500">${formattedTime}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${statusClass}">
                                ${meeting.status}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            ${rescheduleInfo}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <div class="flex space-x-2">
                                <button onclick="viewMeetingDetails(${meeting.id})" class="text-blue-600 hover:text-blue-800 text-xs">
                                    <i class="fas fa-eye mr-1"></i>View
                                </button>
                                ${meeting.status === 'scheduled' ? `
                                    <button onclick="cancelMeeting(${meeting.id})" class="text-red-700 hover:text-red-900 text-xs">
                                        <i class="fas fa-times mr-1"></i>Cancel
                                    </button>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            meetingsList.innerHTML = meetingsHtml;
        }
        
        // Display meetings error
        function displayMeetingsError(message) {
            const meetingsList = document.getElementById('meetings-list');
            meetingsList.innerHTML = `
                <tr>
                    <td colspan="7" class="px-6 py-4 text-center text-sm text-red-500">
                        <i class="fas fa-exclamation-triangle mr-2"></i>${message}
                    </td>
                </tr>
            `;
        }
        
        function viewMeetingDetails(meetingId) {
            const meeting = allMeetingsData.find(m => m.id === meetingId);
            if (!meeting) return;

            const scheduled = new Date(meeting.scheduled_time);
            const created = new Date(meeting.created_at);

            // Status badge
            let statusBg = 'bg-gray-100 text-gray-800';
            if (meeting.status === 'scheduled') statusBg = 'bg-blue-100 text-blue-800';
            else if (meeting.status === 'completed') statusBg = 'bg-green-100 text-green-800';
            else if (meeting.status === 'canceled' || meeting.status === 'cancelled') statusBg = 'bg-red-100 text-red-800';
            else if (meeting.status === 'missed') statusBg = 'bg-yellow-100 text-yellow-800';
            else if (meeting.status === 'in_progress' || meeting.status === 'active') statusBg = 'bg-green-100 text-green-700';

            // Reschedule section
            let rescheduleHtml = '';
            if (meeting.is_rescheduled) {
                const lastRescheduled = meeting.last_rescheduled_at ? new Date(meeting.last_rescheduled_at).toLocaleString() : 'N/A';
                let originalHtml = '';
                if (meeting.original_scheduled_time) {
                    originalHtml = `
                        <div class="flex justify-between py-2 border-b border-gray-100">
                            <span class="text-sm text-gray-500">Original Time</span>
                            <span class="text-sm text-gray-900">${new Date(meeting.original_scheduled_time).toLocaleString()}</span>
                        </div>`;
                }
                rescheduleHtml = `
                    <div class="mt-4 p-3 bg-yellow-50 rounded-lg border border-yellow-200">
                        <div class="flex items-center gap-2 mb-2">
                            <i class="fas fa-sync-alt text-yellow-600 text-sm"></i>
                            <span class="text-sm font-medium text-yellow-800">Rescheduled ${meeting.reschedule_count || 1}x</span>
                        </div>
                        ${originalHtml}
                        <div class="flex justify-between py-2 border-b border-yellow-100">
                            <span class="text-sm text-gray-500">Last Rescheduled</span>
                            <span class="text-sm text-gray-900">${lastRescheduled}</span>
                        </div>
                        ${meeting.rescheduled_by_name ? `
                        <div class="flex justify-between py-2">
                            <span class="text-sm text-gray-500">Rescheduled By</span>
                            <span class="text-sm text-gray-900">${meeting.rescheduled_by_name}</span>
                        </div>` : ''}
                    </div>`;
            }

            document.getElementById('meeting-modal-title').textContent = `Meeting #${meeting.id}`;
            document.getElementById('meeting-modal-body').innerHTML = `
                <div class="flex items-center justify-between mb-4">
                    <span class="inline-flex px-3 py-1 text-xs font-semibold rounded-full ${statusBg}">${meeting.status}</span>
                    ${meeting.roomId ? `<span class="text-xs text-gray-400 font-mono">${meeting.roomId.substring(0, 8)}...</span>` : ''}
                </div>

                <div class="space-y-0">
                    <div class="flex justify-between py-2.5 border-b border-gray-100">
                        <span class="text-sm text-gray-500"><i class="fas fa-user-graduate mr-2 text-gray-400"></i>Student</span>
                        <div class="text-right">
                            <div class="text-sm font-medium text-gray-900">${meeting.student_name || 'Unknown'}</div>
                            ${meeting.student_admission ? `<div class="text-xs text-gray-500">${meeting.student_admission}</div>` : ''}
                        </div>
                    </div>
                    <div class="flex justify-between py-2.5 border-b border-gray-100">
                        <span class="text-sm text-gray-500"><i class="fas fa-hands-helping mr-2 text-gray-400"></i>Volunteer</span>
                        <div class="text-right">
                            <div class="text-sm font-medium text-gray-900">${meeting.volunteer_name || 'Unknown'}</div>
                            ${meeting.volunteer_email ? `<div class="text-xs text-gray-500">${meeting.volunteer_email}</div>` : ''}
                        </div>
                    </div>
                    <div class="flex justify-between py-2.5 border-b border-gray-100">
                        <span class="text-sm text-gray-500"><i class="fas fa-calendar mr-2 text-gray-400"></i>Scheduled</span>
                        <span class="text-sm text-gray-900">${scheduled.toLocaleString()}</span>
                    </div>
                    <div class="flex justify-between py-2.5 border-b border-gray-100">
                        <span class="text-sm text-gray-500"><i class="fas fa-clock mr-2 text-gray-400"></i>Duration</span>
                        <span class="text-sm text-gray-900">40 minutes</span>
                    </div>
                    <div class="flex justify-between py-2.5">
                        <span class="text-sm text-gray-500"><i class="fas fa-plus-circle mr-2 text-gray-400"></i>Created</span>
                        <span class="text-sm text-gray-900">${created.toLocaleString()}</span>
                    </div>
                </div>

                ${rescheduleHtml}
            `;

            // Show cancel button in footer if meeting is scheduled
            const footer = document.getElementById('meeting-modal-footer');
            if (meeting.status === 'scheduled') {
                footer.innerHTML = `
                    <button onclick="cancelMeeting(${meeting.id}); closeMeetingModal();" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700 transition-colors mr-2">
                        <i class="fas fa-times mr-1"></i>Cancel Meeting
                    </button>
                    <button onclick="closeMeetingModal()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 transition-colors">Close</button>
                `;
            } else {
                footer.innerHTML = `<button onclick="closeMeetingModal()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 transition-colors">Close</button>`;
            }

            document.getElementById('meeting-detail-modal').classList.remove('hidden');
        }

        function closeMeetingModal() {
            document.getElementById('meeting-detail-modal').classList.add('hidden');
        }

        // Cancel meeting
        async function cancelMeeting(meetingId) {
            // Use showConfirmation if available, otherwise fallback
            const confirmed = window.showConfirmation
                ? await window.showConfirmation('Are you sure you want to cancel this meeting?', { title: 'Cancel Meeting', confirmText: 'Cancel Meeting', cancelText: 'Keep Meeting', type: 'warning' })
                : confirm('Are you sure you want to cancel this meeting?');

            if (confirmed) {
                try {
                    const response = await window.TalkTimeAuth.makeAuthenticatedRequest(`/api/v1/meetings/${meetingId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ status: 'canceled' })
                    });

                    if (response.ok) {
                        if (window.showNotification) {
                            window.showNotification('Meeting has been canceled successfully.', 'success', { title: 'Meeting Canceled' });
                        }
                        loadMeetings(); // Refresh the meetings list
                    } else {
                        if (window.showNotification) {
                            window.showNotification('Failed to cancel meeting. Please try again.', 'error', { title: 'Error', autoClose: false });
                        }
                    }
                } catch (error) {
                    console.error('Error canceling meeting:', error);
                    if (window.showNotification) {
                        window.showNotification('An error occurred while canceling the meeting.', 'error', { title: 'Error', autoClose: false });
                    }
                }
            }
        }
        
        // Add event listeners for meeting filters
        document.addEventListener('DOMContentLoaded', function() {
            // Meeting status filter
            document.getElementById('meeting-status-filter')?.addEventListener('change', function() {
                // TODO: Implement filtering logic
                loadMeetings();
            });
            
            // Reschedule filter
            document.getElementById('reschedule-filter')?.addEventListener('change', function() {
                // TODO: Implement filtering logic
                loadMeetings();
            });
            
            // Refresh button
            document.getElementById('refresh-meetings')?.addEventListener('click', function() {
                loadMeetings();
            });
        });
        
        // ============================================
        // Volunteer Management Functions
        // ============================================

        async function loadVolunteers() {
            try {
                const response = await window.TalkTimeAuth.makeAuthenticatedRequest('/api/v1/admin/volunteers', {
                    method: 'GET'
                });

                if (response.ok) {
                    const data = await response.json();
                    displayVolunteers(data.volunteers || []);

                    // Show restriction alert if needed
                    const restrictionAlert = document.getElementById('restriction-alert');
                    const restrictedCount = document.getElementById('restricted-count');
                    if (data.restricted > 0) {
                        restrictedCount.textContent = data.restricted;
                        restrictionAlert.classList.remove('hidden');
                    } else {
                        restrictionAlert.classList.add('hidden');
                    }
                } else {
                    displayVolunteersError('Failed to load volunteers');
                }
            } catch (error) {
                console.error('Error loading volunteers:', error);
                displayVolunteersError('Network error loading volunteers');
            }
        }

        function displayVolunteers(volunteers) {
            const volunteersList = document.getElementById('volunteers-list');

            if (!volunteers || volunteers.length === 0) {
                volunteersList.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-6 py-4 text-center text-sm text-gray-500">
                            No volunteers found
                        </td>
                    </tr>
                `;
                return;
            }

            const html = volunteers.map(v => {
                const scoreColor = v.reputationScore >= 75 ? 'text-green-700' :
                                   v.reputationScore >= 50 ? 'text-yellow-600' :
                                   v.reputationScore >= 30 ? 'text-orange-600' : 'text-red-700';

                const statusBadge = v.isRestricted
                    ? '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800"><i class="fas fa-ban mr-1"></i>Restricted</span>'
                    : '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800"><i class="fas fa-check mr-1"></i>Active</span>';

                const clearBtn = v.isRestricted
                    ? `<button onclick="clearVolunteerRecord(${v.id}, '${v.fullName.replace(/'/g, "\\'")}')" class="text-blue-600 hover:text-blue-900 text-sm font-medium mr-3" title="Clear bad record">
                         <i class="fas fa-eraser mr-1"></i>Clear Record
                       </button>`
                    : '';

                return `
                    <tr class="${v.isRestricted ? 'bg-red-50' : ''}">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="h-10 w-10 rounded-full bg-gray-200 flex items-center justify-center overflow-hidden">
                                    ${v.profileImage
                                        ? `<img src="${v.profileImage}" alt="" class="h-10 w-10 rounded-full object-cover">`
                                        : `<i class="fas fa-user text-gray-400"></i>`}
                                </div>
                                <div class="ml-4">
                                    <div class="text-sm font-medium text-gray-900">${v.fullName}</div>
                                    <div class="text-sm text-gray-500">${v.email}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-green-700 font-medium">${v.completedCalls}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm ${v.cancelledRate >= 40 ? 'text-red-700 font-bold' : 'text-gray-700'}">${v.cancelledCalls} <span class="text-xs text-gray-400">(${v.cancelledRate}%)</span></td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm ${v.missedRate >= 30 ? 'text-red-700 font-bold' : 'text-gray-700'}">${v.missedCalls} <span class="text-xs text-gray-400">(${v.missedRate}%)</span></td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm ${scoreColor} font-bold">${v.reputationScore}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${statusBadge}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            ${clearBtn}
                            <button onclick="viewVolunteerPerformance(${v.id})" class="text-blue-600 hover:text-blue-900 text-sm font-medium" title="View details">
                                <i class="fas fa-chart-bar mr-1"></i>Details
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            volunteersList.innerHTML = html;
        }

        function displayVolunteersError(message) {
            const volunteersList = document.getElementById('volunteers-list');
            volunteersList.innerHTML = `
                <tr>
                    <td colspan="7" class="px-6 py-4 text-center text-sm text-red-500">
                        <i class="fas fa-exclamation-triangle mr-2"></i>${message}
                    </td>
                </tr>
            `;
        }

        // Store current volunteer data globally for tab switching
        let currentVolunteerData = null;
        let currentVolunteerActivity = null;

        async function viewVolunteerPerformance(volunteerId) {
            const modal = document.getElementById('volunteer-performance-modal');
            const content = document.getElementById('volunteer-modal-content');
            const footer = document.getElementById('volunteer-modal-footer');
            modal.classList.remove('hidden');
            footer.classList.add('hidden');
            content.innerHTML = '<p class="text-sm text-gray-500">Loading volunteer details...</p>';
            currentVolunteerData = null;
            currentVolunteerActivity = null;

            // Reset to profile tab
            switchModalTab('profile');

            try {
                const response = await window.TalkTimeAuth.makeAuthenticatedRequest(`/api/v1/admin/volunteers/${volunteerId}/details`, {
                    method: 'GET'
                });

                if (response.ok) {
                    const data = await response.json();
                    currentVolunteerData = data;
                    renderProfileTab(data);

                    // Show footer with delete button
                    footer.classList.remove('hidden');
                    const deleteBtn = document.getElementById('delete-volunteer-btn');
                    deleteBtn.onclick = () => showDeleteVolunteerConfirm(data.volunteer.id, data.volunteer.fullName);
                } else {
                    content.innerHTML = '<p class="text-sm text-red-500">Failed to load volunteer details.</p>';
                }
            } catch (error) {
                console.error('Error loading volunteer details:', error);
                content.innerHTML = '<p class="text-sm text-red-500">Network error loading volunteer details.</p>';
            }
        }

        function switchModalTab(tabName) {
            // Update tab button styling
            document.querySelectorAll('.modal-tab-btn').forEach(btn => {
                btn.classList.remove('border-red-600', 'text-red-700');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            const activeBtn = document.getElementById(`modal-tab-${tabName}`);
            if (activeBtn) {
                activeBtn.classList.remove('border-transparent', 'text-gray-500');
                activeBtn.classList.add('border-red-600', 'text-red-700');
            }

            if (!currentVolunteerData) return;

            if (tabName === 'profile') {
                renderProfileTab(currentVolunteerData);
            } else if (tabName === 'meetings') {
                renderMeetingsTab(currentVolunteerData);
            } else if (tabName === 'activity') {
                renderActivityTab(currentVolunteerData.volunteer.id);
            }
        }

        function renderProfileTab(data) {
            const content = document.getElementById('volunteer-modal-content');
            const v = data.volunteer;
            const p = data.performance;

            const scoreColor = p.reputationScore >= 75 ? 'text-green-700' :
                               p.reputationScore >= 50 ? 'text-yellow-600' : 'text-red-700';

            const memberSince = new Date(v.createdAt).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

            // Students worked with table
            let studentsHtml = '';
            if (data.studentsWorkedWith && data.studentsWorkedWith.length > 0) {
                const studentRows = data.studentsWorkedWith.map(s => {
                    const lastMeeting = s.lastMeeting ? new Date(s.lastMeeting).toLocaleDateString() : 'N/A';
                    return `<tr>
                        <td class="px-3 py-2 text-sm font-medium text-gray-900">${s.fullName}</td>
                        <td class="px-3 py-2 text-sm text-gray-600">${s.meetingCount}</td>
                        <td class="px-3 py-2 text-sm text-gray-500">${lastMeeting}</td>
                    </tr>`;
                }).join('');
                studentsHtml = `
                    <div class="mt-6">
                        <h4 class="text-sm font-medium text-gray-900 mb-2">Students Worked With (${data.studentsWorkedWith.length})</h4>
                        <div class="border rounded-lg overflow-hidden max-h-48 overflow-y-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50 sticky top-0">
                                    <tr>
                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Student</th>
                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Meetings</th>
                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Last Meeting</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">${studentRows}</tbody>
                            </table>
                        </div>
                    </div>
                `;
            }

            // Clearable meetings + clear button
            let clearableMeetingsHtml = '';
            if (data.clearableMeetings && data.clearableMeetings.length > 0 && p.isRestricted) {
                clearableMeetingsHtml = `
                    <div class="mt-4">
                        <button onclick="clearVolunteerRecord(${v.id}, '${v.fullName.replace(/'/g, "\\'")}')" class="w-full bg-blue-600 text-white px-4 py-2 rounded-md text-sm hover:bg-blue-700 transition-colors">
                            <i class="fas fa-eraser mr-2"></i>Clear Record (${data.clearableMeetings.length} meetings)
                        </button>
                    </div>
                `;
            }

            let clearedHtml = '';
            if (data.clearedMeetings && data.clearedMeetings.length > 0) {
                clearedHtml = `<p class="text-xs text-gray-400 mt-2">Previously cleared: ${data.clearedMeetings.length} meeting(s)</p>`;
            }

            content.innerHTML = `
                <!-- Volunteer Profile Header -->
                <div class="flex items-center mb-6">
                    <div class="h-14 w-14 rounded-full bg-gray-200 flex items-center justify-center overflow-hidden flex-shrink-0">
                        ${v.profileImage
                            ? `<img src="${v.profileImage}" alt="" class="h-14 w-14 rounded-full object-cover">`
                            : `<span class="text-xl font-bold text-gray-400">${v.fullName.charAt(0)}</span>`}
                    </div>
                    <div class="ml-4 flex-1">
                        <h4 class="text-lg font-medium text-gray-900">${v.fullName}</h4>
                        <p class="text-sm text-gray-500">${v.email}</p>
                        <p class="text-xs text-gray-400">Member since ${memberSince}</p>
                    </div>
                    ${p.isRestricted ? '<span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-800"><i class="fas fa-ban mr-1"></i>Restricted</span>' : '<span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800"><i class="fas fa-check mr-1"></i>Active</span>'}
                </div>

                <!-- Profile Info Grid -->
                <div class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-6 text-sm">
                    <div class="bg-gray-50 rounded-lg p-3">
                        <p class="text-xs text-gray-500">Type</p>
                        <p class="font-medium text-gray-900">${v.volunteerType || 'Standard'}</p>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-3">
                        <p class="text-xs text-gray-500">Phone</p>
                        <p class="font-medium text-gray-900">${v.phone || 'Not provided'}</p>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-3">
                        <p class="text-xs text-gray-500">Timezone</p>
                        <p class="font-medium text-gray-900">${v.timezone || 'Not set'}</p>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-3">
                        <p class="text-xs text-gray-500">Age</p>
                        <p class="font-medium text-gray-900">${v.age || 'N/A'}${v.isUnder18 ? ' (Minor)' : ''}</p>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-3">
                        <p class="text-xs text-gray-500">Gender</p>
                        <p class="font-medium text-gray-900">${v.gender || 'N/A'}</p>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-3">
                        <p class="text-xs text-gray-500">School</p>
                        <p class="font-medium text-gray-900">${v.schoolName || 'N/A'}</p>
                    </div>
                </div>

                <!-- Performance Metrics -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                    <div class="bg-green-50 rounded-lg p-3 text-center">
                        <div class="text-2xl font-bold text-green-700">${p.completedCalls}</div>
                        <div class="text-xs text-gray-500">Completed</div>
                    </div>
                    <div class="bg-red-50 rounded-lg p-3 text-center">
                        <div class="text-2xl font-bold text-red-700">${p.cancelledCalls}</div>
                        <div class="text-xs text-gray-500">Cancelled (${p.cancelledRate}%)</div>
                    </div>
                    <div class="bg-yellow-50 rounded-lg p-3 text-center">
                        <div class="text-2xl font-bold text-yellow-600">${p.missedCalls}</div>
                        <div class="text-xs text-gray-500">Missed (${p.missedRate}%)</div>
                    </div>
                    <div class="bg-blue-50 rounded-lg p-3 text-center">
                        <div class="text-2xl font-bold ${scoreColor}">${p.reputationScore}</div>
                        <div class="text-xs text-gray-500">Reputation</div>
                    </div>
                </div>

                <div class="bg-gray-50 rounded-lg p-3 mb-2">
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-600">Total Meetings</span>
                        <span class="font-medium">${p.totalScheduled}</span>
                    </div>
                    <div class="flex justify-between text-sm mt-1">
                        <span class="text-gray-600">Students Impacted</span>
                        <span class="font-medium">${p.studentsImpacted}</span>
                    </div>
                </div>

                ${studentsHtml}
                ${clearableMeetingsHtml}
                ${clearedHtml}
            `;
        }

        function renderMeetingsTab(data) {
            const content = document.getElementById('volunteer-modal-content');
            const meetings = data.meetings || [];

            if (meetings.length === 0) {
                content.innerHTML = '<p class="text-sm text-gray-500 text-center py-8">No meeting history found.</p>';
                return;
            }

            const rows = meetings.map(m => {
                const date = new Date(m.scheduledTime).toLocaleDateString();
                const time = new Date(m.scheduledTime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                let statusClass = 'bg-gray-100 text-gray-800';
                if (m.status === 'completed') statusClass = 'bg-green-100 text-green-800';
                else if (m.status === 'canceled' || m.status === 'cancelled') statusClass = 'bg-red-100 text-red-800';
                else if (m.status === 'missed') statusClass = 'bg-yellow-100 text-yellow-800';
                else if (m.status === 'scheduled') statusClass = 'bg-blue-100 text-blue-800';

                return `<tr${m.clearedByAdmin ? ' class="opacity-50"' : ''}>
                    <td class="px-3 py-2 text-sm text-gray-900">${date}</td>
                    <td class="px-3 py-2 text-sm text-gray-500">${time}</td>
                    <td class="px-3 py-2 text-sm font-medium text-gray-900">${m.studentName || 'Unknown'}</td>
                    <td class="px-3 py-2"><span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${statusClass}">${m.status}${m.clearedByAdmin ? ' (cleared)' : ''}</span></td>
                    <td class="px-3 py-2 text-sm text-gray-500">${m.isInstant ? 'Instant' : 'Scheduled'}</td>
                    <td class="px-3 py-2 text-sm text-gray-500">${m.rescheduleCount || 0}</td>
                </tr>`;
            }).join('');

            content.innerHTML = `
                <div class="border rounded-lg overflow-hidden">
                    <div class="max-h-96 overflow-y-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Time</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Student</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Reschedules</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">${rows}</tbody>
                        </table>
                    </div>
                </div>
                <p class="text-xs text-gray-400 mt-2">Showing last ${meetings.length} meetings</p>
            `;
        }

        async function renderActivityTab(volunteerId) {
            const content = document.getElementById('volunteer-modal-content');

            if (currentVolunteerActivity) {
                displayActivityFeed(currentVolunteerActivity);
                return;
            }

            content.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">Loading activity...</p>';

            try {
                const response = await window.TalkTimeAuth.makeAuthenticatedRequest(`/api/v1/admin/volunteers/${volunteerId}/activity?limit=50`, {
                    method: 'GET'
                });

                if (response.ok) {
                    const data = await response.json();
                    currentVolunteerActivity = data.activity;
                    displayActivityFeed(data.activity);
                } else {
                    content.innerHTML = '<p class="text-sm text-red-500">Failed to load activity.</p>';
                }
            } catch (error) {
                console.error('Error loading activity:', error);
                content.innerHTML = '<p class="text-sm text-red-500">Network error loading activity.</p>';
            }
        }

        function displayActivityFeed(activities) {
            const content = document.getElementById('volunteer-modal-content');

            if (!activities || activities.length === 0) {
                content.innerHTML = '<p class="text-sm text-gray-500 text-center py-8">No activity recorded.</p>';
                return;
            }

            const items = activities.map(a => {
                const date = new Date(a.created_at);
                const timeStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                let icon, color, label;

                if (a.source === 'meeting') {
                    if (a.action === 'completed') { icon = 'fa-check-circle'; color = 'text-green-700 bg-green-50'; label = 'Completed meeting'; }
                    else if (a.action === 'canceled' || a.action === 'cancelled') { icon = 'fa-times-circle'; color = 'text-red-700 bg-red-50'; label = 'Cancelled meeting'; }
                    else if (a.action === 'missed') { icon = 'fa-clock'; color = 'text-yellow-600 bg-yellow-50'; label = 'Missed meeting'; }
                    else if (a.action === 'scheduled') { icon = 'fa-calendar-plus'; color = 'text-blue-600 bg-blue-50'; label = 'Scheduled meeting'; }
                    else { icon = 'fa-calendar'; color = 'text-gray-600 bg-gray-50'; label = `Meeting ${a.action}`; }
                    const student = a.details?.studentName ? ` with ${a.details.studentName}` : '';
                    label += student;
                } else if (a.source === 'message') {
                    icon = 'fa-envelope';
                    color = 'text-blue-600 bg-blue-50';
                    label = `Sent message to ${a.details?.recipientName || 'user'}`;
                } else if (a.source === 'security') {
                    icon = 'fa-shield-alt';
                    color = 'text-gray-600 bg-gray-50';
                    label = a.action === 'login' ? 'Logged in' : a.action;
                } else {
                    icon = 'fa-circle';
                    color = 'text-gray-400 bg-gray-50';
                    label = a.action;
                }

                return `
                    <div class="flex items-start gap-3 py-3 border-b border-gray-100 last:border-0">
                        <div class="w-8 h-8 rounded-full ${color} flex items-center justify-center flex-shrink-0 mt-0.5">
                            <i class="fas ${icon} text-sm"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm text-gray-900">${label}</p>
                            <p class="text-xs text-gray-400">${timeStr}</p>
                        </div>
                    </div>
                `;
            }).join('');

            content.innerHTML = `
                <div class="max-h-96 overflow-y-auto">${items}</div>
                <p class="text-xs text-gray-400 mt-2">Showing ${activities.length} recent activities</p>
            `;
        }

        function showDeleteVolunteerConfirm(volunteerId, volunteerName) {
            const modal = document.getElementById('delete-volunteer-modal');
            const message = document.getElementById('delete-volunteer-message');
            const confirmBtn = document.getElementById('confirm-delete-volunteer');

            message.textContent = `Are you sure you want to permanently delete ${volunteerName}? All their meetings, messages, and settings will be removed. This cannot be undone.`;
            confirmBtn.onclick = () => deleteVolunteerAccount(volunteerId, volunteerName);
            modal.classList.remove('hidden');
        }

        async function deleteVolunteerAccount(volunteerId, volunteerName) {
            try {
                const response = await window.TalkTimeAuth.makeAuthenticatedRequest(`/api/v1/admin/volunteers/${volunteerId}`, {
                    method: 'DELETE'
                });

                document.getElementById('delete-volunteer-modal').classList.add('hidden');

                if (response.ok) {
                    const data = await response.json();
                    if (window.showNotification) {
                        window.showNotification(data.message, 'success', { title: 'Volunteer Deleted' });
                    }
                    closeVolunteerModal();
                    loadVolunteers();
                } else {
                    const error = await response.json();
                    if (window.showNotification) {
                        window.showNotification(error.error || 'Failed to delete volunteer', 'error', { title: 'Deletion Failed', autoClose: false });
                    }
                }
            } catch (error) {
                console.error('Error deleting volunteer:', error);
                document.getElementById('delete-volunteer-modal').classList.add('hidden');
                if (window.showNotification) {
                    window.showNotification('Network error while deleting volunteer', 'error', { title: 'Error' });
                }
            }
        }

        async function clearVolunteerRecord(volunteerId, volunteerName) {
            if (!confirm(`Clear the bad record for ${volunteerName}?\n\nThis will exclude their canceled and missed meetings from the restriction calculation. The meetings remain in history but will no longer count against their score.\n\nThe volunteer will be able to schedule new meetings again.`)) {
                return;
            }

            try {
                const response = await window.TalkTimeAuth.makeAuthenticatedRequest(`/api/v1/admin/volunteers/${volunteerId}/clear-record`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });

                if (response.ok) {
                    const data = await response.json();
                    if (window.showNotification) {
                        window.showNotification(`${data.message}`, 'success', { title: 'Record Cleared' });
                    }
                    loadVolunteers();
                    closeVolunteerModal();
                } else {
                    const error = await response.json();
                    if (window.showNotification) {
                        window.showNotification(error.error || 'Failed to clear record', 'error', { title: 'Error' });
                    }
                }
            } catch (error) {
                console.error('Error clearing volunteer record:', error);
                if (window.showNotification) {
                    window.showNotification('Network error while clearing record', 'error', { title: 'Error' });
                }
            }
        }

        function closeVolunteerModal() {
            document.getElementById('volunteer-performance-modal').classList.add('hidden');
        }

        // Navigation functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Profile dropdown
            const profileBtn = document.getElementById('profile-btn');
            const profileDropdown = document.getElementById('profile-dropdown');

            if (profileBtn && profileDropdown) {
                profileBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const isOpen = !profileDropdown.classList.contains('hidden');
                    if (isOpen) {
                        profileDropdown.classList.add('hidden', 'opacity-0', '-translate-y-2');
                    } else {
                        profileDropdown.classList.remove('hidden');
                        requestAnimationFrame(() => {
                            profileDropdown.classList.remove('opacity-0', '-translate-y-2');
                        });
                    }
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', function(e) {
                    if (!profileBtn.contains(e.target) && !profileDropdown.contains(e.target)) {
                        profileDropdown.classList.add('hidden', 'opacity-0', '-translate-y-2');
                    }
                });
            }

            // Logout event listener
            const logoutLink = document.getElementById('logout-link');
            if (logoutLink) {
                logoutLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    logout();
                });
            }
        });
        
        // Logout function
        function logout() {
            window.TalkTimeAuth.makeAuthenticatedRequest('/api/v1/jwt-auth/logout', {
                method: 'POST'
            })
            .then(() => {
                window.TalkTimeAuth.clearAuth();
                window.location.href = '/admin/login.html';
            })
            .catch(error => {
                console.error('Logout error:', error);
                window.TalkTimeAuth.clearAuth();
                window.location.href = '/admin/login.html';
            });
        }
    </script>
</body>
</html>
