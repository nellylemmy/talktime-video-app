# TalkTime Production Nginx Configuration - HTTP Only
# SSL termination handled by shared gateway

# Rate limiting zone
limit_req_zone $binary_remote_addr zone=talktime_api:10m rate=30r/s;

# Upstream backend
upstream talktime_backend {
    server backend:3001;
    keepalive 32;
}

# Upstream auth service (microservice)
upstream talktime_auth_service {
    server auth-service:3002;
    keepalive 16;
}

# Upstream meeting service (microservice)
upstream talktime_meeting_service {
    server meeting-service:3003;
    keepalive 16;
}

# Upstream notification service (microservice)
upstream talktime_notification_service {
    server talktime_notification_service:3005;
    keepalive 16;
}

# Upstream call service (microservice)
upstream talktime_call_service {
    server call-service:3004;
    keepalive 16;
}

# Upstream newsletter service (microservice)
upstream talktime_newsletter_service {
    server newsletter-service:3006;
    keepalive 16;
}

# Upstream analytics service (microservice)
upstream talktime_analytics_service {
    server analytics-service:3007;
    keepalive 16;
}

# HTTP server
server {
    listen 80 default_server;
    server_name talktime.adeafoundation.org localhost _;

    # Allow image uploads up to 30MB
    client_max_body_size 30m;

    root /var/www/frontend;
    index index.html;

    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml text/javascript;

    # Security headers (X-Forwarded-Proto will be https from gateway)
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # SEO: robots.txt
    location = /robots.txt {
        alias /var/www/frontend/robots.txt;
        access_log off;
    }

    # Auth Service routes (microservice)
    location /api/v1/auth/ {
        limit_req zone=talktime_api burst=50 nodelay;
        proxy_pass http://talktime_auth_service;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $http_x_forwarded_proto;
        proxy_set_header Connection "";
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }

    # Auth service internal endpoint (for service-to-service communication)
    location /internal/ {
        # Only allow internal network access
        allow 172.19.0.0/16;
        deny all;
        proxy_pass http://talktime_auth_service;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Connection "";
    }

    # Auth service health check
    location = /auth-health {
        proxy_pass http://talktime_auth_service/health;
        proxy_http_version 1.1;
    }

    # Meeting service health check
    location = /meeting-health {
        proxy_pass http://talktime_meeting_service/health;
        proxy_http_version 1.1;
    }

    # Notification service health check
    location = /notification-health {
        proxy_pass http://talktime_notification_service/health;
        proxy_http_version 1.1;
    }

    # Call service health check
    location = /call-health {
        proxy_pass http://talktime_call_service/health;
        proxy_http_version 1.1;
    }

    # Newsletter service health check
    location = /newsletter-health {
        proxy_pass http://talktime_newsletter_service/health;
        proxy_http_version 1.1;
    }

    # Analytics service health check
    location = /analytics-health {
        proxy_pass http://talktime_analytics_service/health;
        proxy_http_version 1.1;
    }

    # Notification Service routes (microservice)
    location /api/v1/notifications {
        limit_req zone=talktime_api burst=50 nodelay;
        proxy_pass http://talktime_notification_service;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $http_x_forwarded_proto;
        proxy_set_header Connection "";
    }

    # Meeting Service routes (microservice)
    location /api/v1/meetings {
        limit_req zone=talktime_api burst=50 nodelay;
        proxy_pass http://talktime_meeting_service;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $http_x_forwarded_proto;
        proxy_set_header Connection "";
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }

    # Call Service routes (microservice)
    # Routes Socket.IO traffic to the call service for WebRTC signaling
    location ^~ /call-socket.io/ {
        proxy_pass http://talktime_call_service/socket.io/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $http_x_forwarded_proto;
        proxy_read_timeout 86400;
    }

    # Call Service API routes
    location /api/v1/calls {
        limit_req zone=talktime_api burst=50 nodelay;
        proxy_pass http://talktime_call_service;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $http_x_forwarded_proto;
        proxy_set_header Connection "";
    }

    # Newsletter Service routes (microservice)
    location /api/v1/newsletter {
        limit_req zone=talktime_api burst=50 nodelay;
        proxy_pass http://talktime_newsletter_service;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $http_x_forwarded_proto;
        proxy_set_header Connection "";
    }

    # Analytics Service routes (microservice)
    location /api/v1/analytics {
        limit_req zone=talktime_api burst=50 nodelay;
        proxy_pass http://talktime_analytics_service;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $http_x_forwarded_proto;
        proxy_set_header Connection "";
    }

    # Uploads proxy (profile images, etc.) - use ^~ to prevent regex from intercepting
    location ^~ /uploads/ {
        proxy_pass http://talktime_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $http_x_forwarded_proto;
        expires 7d;
        add_header Cache-Control "public";
    }

    # API proxy
    location /api/ {
        limit_req zone=talktime_api burst=50 nodelay;
        proxy_pass http://talktime_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $http_x_forwarded_proto;
        proxy_set_header Connection "";
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # Socket.IO - use ^~ to prevent regex location from intercepting .js files
    location ^~ /socket.io/ {
        proxy_pass http://talktime_backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $http_x_forwarded_proto;
        proxy_read_timeout 86400;
    }

    # Admin portal
    location /admin/ {
        alias /var/www/frontend/admin/;
        try_files $uri $uri.html $uri/ /admin/index.html;
    }

    # Redirect /student/dashboard/ to /student/dashboard.html
    location = /student/dashboard/ {
        return 301 /student/dashboard.html;
    }

    # Redirect /student/ root to login page
    location = /student/ {
        return 301 /student/login.html;
    }

    # Student portal
    location /student/ {
        alias /var/www/frontend/student/;
        try_files $uri $uri/ /student/login.html;
    }

    # Redirect /call.html to /call/call.html (preserving query string)
    location = /call.html {
        return 301 /call/call.html$is_args$args;
    }

    # Call app
    location /call/ {
        alias /var/www/frontend/call/;
        try_files $uri $uri/ /call/index.html;
    }

    # Volunteer portal static assets with caching
    location ~ ^/volunteer/(.+\.(webp|jpg|jpeg|png|gif|ico|svg))$ {
        alias /var/www/frontend/$1;
        expires 30d;
        add_header Cache-Control "public, max-age=2592000, immutable" always;
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        etag on;
    }

    location ~ ^/volunteer/(.+\.(css|js))$ {
        alias /var/www/frontend/$1;
        expires -1;
        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
        add_header Pragma "no-cache" always;
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        etag off;
    }

    # LANDING PAGE BLOCK: Redirect volunteer landing page to login
    # Nobody should see the landing page - they should go to login or dashboard
    location = /volunteer/ {
        return 301 /volunteer/login.html;
    }

    location = /volunteer {
        return 301 /volunteer/login.html;
    }

    location = /volunteer/index.html {
        return 301 /volunteer/login.html;
    }

    # Volunteer dashboard directory redirect
    location = /volunteer/dashboard/ {
        return 301 /volunteer/dashboard/students.html;
    }

    location = /volunteer/dashboard {
        return 301 /volunteer/dashboard/students.html;
    }

    # Volunteer dashboard HTML files - NO CACHE (critical for real-time data)
    location ~ ^/volunteer/dashboard/(.+\.html)$ {
        alias /var/www/frontend/dashboard/$1;
        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
        add_header Pragma "no-cache" always;
        add_header Expires "0" always;
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        etag off;
        if_modified_since off;
    }

    # Volunteer portal - strip /volunteer prefix and serve from root
    location ~ ^/volunteer/(.*)$ {
        error_page 404 =404 /404.html;
        try_files /$1 /$1.html /$1/ =404;
    }

    # Shared HTML partials - no cache (they can change frequently)
    location ~ ^/shared/(.+\.html)$ {
        alias /var/www/frontend/shared/$1;
        add_header Cache-Control "no-cache, must-revalidate" always;
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        etag on;
    }

    # Shared static assets (CSS, JS) - no cache for rapid development
    location ~ ^/shared/(.+\.(css|js))$ {
        alias /var/www/frontend/shared/$1;
        expires -1;
        add_header Cache-Control "no-store, no-cache, must-revalidate, max-age=0" always;
        add_header Pragma "no-cache" always;
        etag off;
    }

    # Shared images - cache normally
    location /shared/ {
        alias /var/www/frontend/shared/;
        expires 7d;
        add_header Cache-Control "public, max-age=604800" always;
    }

    # Service workers
    location = /notification-sw.js {
        add_header Cache-Control "no-cache";
        add_header Service-Worker-Allowed "/";
    }

    location = /sw.js {
        add_header Cache-Control "no-cache";
        add_header Service-Worker-Allowed "/";
    }

    # Static assets caching with ETag validation
    location ~* \.(jpg|jpeg|png|gif|webp|ico|svg)$ {
        expires 30d;
        add_header Cache-Control "public, max-age=2592000, immutable";
        etag on;
        if_modified_since exact;
    }

    # CSS/JS - no cache for rapid development
    location ~* \.(css|js)$ {
        expires -1;
        add_header Cache-Control "no-store, no-cache, must-revalidate, max-age=0" always;
        add_header Pragma "no-cache" always;
        etag off;
    }

    # Fonts with long cache
    location ~* \.(woff|woff2|ttf|eot)$ {
        expires 365d;
        add_header Cache-Control "public, max-age=31536000, immutable";
    }

    # Frontend routes
    location / {
        try_files $uri $uri/ /index.html;
    }
}
