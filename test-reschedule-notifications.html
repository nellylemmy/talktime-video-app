<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Reschedule Notifications</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        button { background: #007cba; color: white; border: none; padding: 10px 20px; margin: 10px; border-radius: 5px; cursor: pointer; }
        button:hover { background: #005a87; }
        .result { margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px; background: #f9f9f9; }
        .error { border-color: #ff0000; background: #ffe6e6; }
        .success { border-color: #00cc00; background: #e6ffe6; }
    </style>
</head>
<body>
    <h1>🔔 Test Reschedule Notifications</h1>
    <p>This page tests the complete rescheduling notification flow including push notifications, bell badge updates, and notifications page integration.</p>
    
    <div>
        <button onclick="testRescheduleFlow()">📅 Test Meeting Reschedule</button>
        <button onclick="requestNotificationPermission()">🔔 Enable Push Notifications</button>
        <button onclick="checkNotifications()">📋 Check Notifications</button>
        <button onclick="clearResults()">🧹 Clear Results</button>
    </div>
    
    <div id="results"></div>

    <script>
        async function requestNotificationPermission() {
            const permission = await Notification.requestPermission();
            logResult(`🔔 Notification permission: ${permission}`, permission === 'granted' ? 'success' : 'error');
        }

        async function testRescheduleFlow() {
            logResult('🧪 Starting reschedule notification test...', 'info');
            
            try {
                const newScheduledTime = new Date(Date.now() + 3 * 60 * 60 * 1000); // 3 hours from now
                
                // Test without authentication first (will likely fail but shows the API structure)
                const response = await fetch('/api/v1/meetings/103', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        scheduledTime: newScheduledTime.toISOString(),
                        status: 'scheduled'
                    })
                });
                
                const responseText = await response.text();
                
                if (response.ok) {
                    logResult(`✅ Meeting rescheduled successfully! Status: ${response.status}`, 'success');
                    logResult(`📊 Response: ${responseText}`, 'info');
                    
                    // Wait a moment for notifications to process
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                    logResult('✅ Check for the following indicators:', 'success');
                    logResult('   1. 🔔 Push notification should have appeared', 'info');
                    logResult('   2. 🔴 Bell badge should show active notification', 'info');
                    logResult('   3. 📄 New notification in /volunteer/notifications.html', 'info');
                    
                } else {
                    logResult(`❌ API call failed: ${response.status} - ${responseText}`, 'error');
                    
                    if (response.status === 401 || response.status === 403) {
                        logResult('🔐 This is expected - authentication required. Try logging in as a volunteer first.', 'info');
                    }
                }
                
            } catch (error) {
                logResult(`❌ Test failed: ${error.message}`, 'error');
            }
        }

        async function checkNotifications() {
            try {
                const response = await fetch('/api/v1/notifications');
                const responseText = await response.text();
                
                if (response.ok) {
                    logResult(`📋 Notifications: ${responseText}`, 'success');
                } else {
                    logResult(`❌ Failed to fetch notifications: ${response.status} - ${responseText}`, 'error');
                }
            } catch (error) {
                logResult(`❌ Error checking notifications: ${error.message}`, 'error');
            }
        }

        function logResult(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        // Auto-request notification permission on load
        window.addEventListener('load', () => {
            logResult('🚀 Test page loaded. Ready to test reschedule notifications!', 'info');
            if ('Notification' in window && Notification.permission === 'default') {
                requestNotificationPermission();
            }
        });
    </script>
</body>
</html>
