networks:
  talktime_network:
    driver: bridge
    name: talktime_isolated
    ipam:
      config:
        - subnet: 172.19.0.0/16

services:
  # Nginx Service - HTTP only (SSL handled by shared gateway)
  nginx:
    image: nginx:alpine
    container_name: talktime_nginx
    # No external ports - accessed via shared gateway
    expose:
      - '80'
    volumes:
      - ./nginx/production-http.conf:/etc/nginx/conf.d/default.conf:ro
      - ./frontends/volunteer/public:/var/www/frontend
      - ./frontends/admin/public:/var/www/frontend/admin
      - ./frontends/student/public:/var/www/frontend/student
      - ./frontends/call:/var/www/frontend/call
      - ./frontends/shared:/var/www/frontend/shared
      - ./frontends/notification-sw.js:/var/www/frontend/notification-sw.js
      - ./frontends/sw.js:/var/www/frontend/sw.js:ro
    depends_on:
      - backend
    networks:
      talktime_network:
        ipv4_address: 172.19.0.20
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 256M

  # Backend Service
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: talktime_backend
    expose:
      - '3001'
    volumes:
      - ./backend/uploads:/usr/src/app/uploads
      - ./backend/logs:/usr/src/app/logs
    environment:
      NODE_ENV: production
      PORT: 3001
      DB_HOST: db
      DB_USER: talktime_user
      DB_PASSWORD: ${DB_PASSWORD:-talktime_secure_pass_2024}
      DB_DATABASE: talktimedb
      DB_PORT: 5432
      REDIS_URL: redis://redis:6379
      SESSION_SECRET: ${SESSION_SECRET:-prod-secret-key-change-this}
      FRONTEND_URL: https://talktime.adeafoundation.org
      CORS_ORIGINS: "https://talktime.adeafoundation.org"
      VAPID_SUBJECT: "mailto:support@talktime.app"
      VAPID_PUBLIC_KEY: ${VAPID_PUBLIC_KEY}
      VAPID_PRIVATE_KEY: ${VAPID_PRIVATE_KEY}
      NOTIFICATION_PERSISTENCE_ENABLED: "true"
      NOTIFICATION_ANALYTICS_ENABLED: "true"
      ADMIN_SECRET_CODE: "136767"
      ADMIN_SECRET_CODES: '["136767","101877","689131","146284","558802","961149","467494","886832","936221","259324"]'
      JWT_SECRET: ${JWT_SECRET:-change_this_jwt_secret_in_production}
      # Auth Service Integration (set USE_AUTH_SERVICE=true to enable)
      USE_AUTH_SERVICE: ${USE_AUTH_SERVICE:-false}
      AUTH_SERVICE_URL: http://auth-service:3002
      INTERNAL_API_KEY: ${INTERNAL_API_KEY:-talktime-internal-key-change-in-production}
      # Self-hosted coturn TURN server for WebRTC relay
      COTURN_SECRET: ${COTURN_SECRET:-}
      TURN_HOST: ${TURN_HOST:-62.72.3.138}
      TURN_PORT: ${TURN_PORT:-3478}
    depends_on:
      - db
      - redis
    networks:
      - talktime_network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.75'
          memory: 768M
        reservations:
          cpus: '0.25'
          memory: 256M

  # Database Service
  db:
    image: postgres:13-alpine
    container_name: talktime_db
    environment:
      POSTGRES_DB: talktimedb
      POSTGRES_USER: talktime_user
      POSTGRES_PASSWORD: ${DB_PASSWORD:-talktime_secure_pass_2024}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./db/init:/docker-entrypoint-initdb.d:ro
    networks:
      - talktime_network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 128M

  # Redis Service
  redis:
    image: redis:7-alpine
    container_name: talktime_redis
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    networks:
      - talktime_network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 256M
        reservations:
          cpus: '0.05'
          memory: 64M

  # coturn TURN server â€” WebRTC relay fallback for symmetric NAT
  coturn:
    image: coturn/coturn:4.6.3
    container_name: talktime_coturn
    restart: unless-stopped
    network_mode: host
    volumes:
      - ./coturn/turnserver.conf:/etc/coturn/turnserver.conf:ro
    command: -c /etc/coturn/turnserver.conf --static-auth-secret=${COTURN_SECRET:-change-this}
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M

  # Notification Service (Microservice)
  notification-service:
    build:
      context: ./services/notification-service
      dockerfile: Dockerfile
    container_name: talktime_notification_service
    expose:
      - '3005'
    environment:
      NODE_ENV: production
      PORT: 3005
      DB_HOST: db
      DB_USER: talktime_user
      DB_PASSWORD: ${DB_PASSWORD:-talktime_secure_pass_2024}
      DB_DATABASE: talktimedb
      DB_PORT: 5432
      REDIS_URL: redis://redis:6379
      CORS_ORIGIN: "https://talktime.adeafoundation.org"
    depends_on:
      - db
      - redis
    networks:
      - talktime_network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 384M
        reservations:
          cpus: '0.1'
          memory: 128M
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3005/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Meeting Service (Microservice)
  meeting-service:
    build:
      context: ./services/meeting-service
      dockerfile: Dockerfile
    container_name: talktime_meeting_service
    expose:
      - '3003'
    environment:
      NODE_ENV: production
      PORT: 3003
      DB_HOST: db
      DB_USER: talktime_user
      DB_PASSWORD: ${DB_PASSWORD:-talktime_secure_pass_2024}
      DB_DATABASE: talktimedb
      DB_PORT: 5432
      REDIS_URL: redis://redis:6379
      AUTH_SERVICE_URL: http://auth-service:3002
      INTERNAL_API_KEY: ${INTERNAL_API_KEY:-talktime-internal-key-change-in-production}
      CORS_ORIGIN: "https://talktime.adeafoundation.org"
    depends_on:
      - db
      - redis
      - auth-service
    networks:
      - talktime_network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 384M
        reservations:
          cpus: '0.1'
          memory: 128M
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3003/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Auth Service (Microservice)
  auth-service:
    build:
      context: ./services/auth-service
      dockerfile: Dockerfile
    container_name: talktime_auth_service
    expose:
      - '3002'
    environment:
      NODE_ENV: production
      PORT: 3002
      DB_HOST: db
      DB_USER: talktime_user
      DB_PASSWORD: ${DB_PASSWORD:-talktime_secure_pass_2024}
      DB_DATABASE: talktimedb
      DB_PORT: 5432
      JWT_SECRET: ${JWT_SECRET:-change_this_jwt_secret_in_production}
      JWT_EXPIRES_IN: 24h
      JWT_REFRESH_EXPIRES_IN: 7d
      ADMIN_SECRET_CODE: "136767"
      ADMIN_SECRET_CODES: '["136767","101877","689131","146284","558802","961149","467494","886832","936221","259324"]'
      INTERNAL_API_KEY: ${INTERNAL_API_KEY:-talktime-internal-key-change-in-production}
      CORS_ORIGIN: "https://talktime.adeafoundation.org"
    depends_on:
      - db
    networks:
      - talktime_network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 384M
        reservations:
          cpus: '0.1'
          memory: 128M
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Call Service (Microservice)
  call-service:
    build:
      context: ./services/call-service
      dockerfile: Dockerfile
    container_name: talktime_call_service
    expose:
      - '3004'
    environment:
      NODE_ENV: production
      PORT: 3004
      DB_HOST: db
      DB_USER: talktime_user
      DB_PASSWORD: ${DB_PASSWORD:-talktime_secure_pass_2024}
      DB_DATABASE: talktimedb
      DB_PORT: 5432
      REDIS_URL: redis://redis:6379
      AUTH_SERVICE_URL: http://auth-service:3002
      INTERNAL_API_KEY: ${INTERNAL_API_KEY:-talktime-internal-key-change-in-production}
      CORS_ORIGIN: "https://talktime.adeafoundation.org"
    depends_on:
      - db
      - redis
    networks:
      - talktime_network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 128M
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3004/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Newsletter Service (Microservice)
  newsletter-service:
    build:
      context: ./services/newsletter-service
      dockerfile: Dockerfile
    container_name: talktime_newsletter_service
    expose:
      - '3006'
    environment:
      NODE_ENV: production
      PORT: 3006
      DB_HOST: db
      DB_USER: talktime_user
      DB_PASSWORD: ${DB_PASSWORD:-talktime_secure_pass_2024}
      DB_DATABASE: talktimedb
      DB_PORT: 5432
      MAILCHIMP_API_KEY: ${MAILCHIMP_API_KEY:-}
      MAILCHIMP_SERVER_PREFIX: ${MAILCHIMP_SERVER_PREFIX:-}
      MAILCHIMP_LIST_ID: ${MAILCHIMP_LIST_ID:-}
      CORS_ORIGIN: "https://talktime.adeafoundation.org"
    depends_on:
      - db
    networks:
      - talktime_network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 256M
        reservations:
          cpus: '0.05'
          memory: 64M
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3006/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Analytics Service (Microservice)
  analytics-service:
    build:
      context: ./services/analytics-service
      dockerfile: Dockerfile
    container_name: talktime_analytics_service
    expose:
      - '3007'
    environment:
      NODE_ENV: production
      PORT: 3007
      DB_HOST: db
      DB_USER: talktime_user
      DB_PASSWORD: ${DB_PASSWORD:-talktime_secure_pass_2024}
      DB_DATABASE: talktimedb
      DB_PORT: 5432
      REDIS_URL: redis://redis:6379
      CORS_ORIGIN: "https://talktime.adeafoundation.org"
    depends_on:
      - db
      - redis
    networks:
      - talktime_network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 256M
        reservations:
          cpus: '0.05'
          memory: 64M
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3007/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

volumes:
  postgres_data:
    driver: local
  redis_data:
